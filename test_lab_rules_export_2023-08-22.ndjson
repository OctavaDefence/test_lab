{"id":"ce4e9af0-e802-11ed-b6f4-dfeac9073248","updated_at":"2023-05-01T14:52:34.139Z","updated_by":"burzhynskyyy","created_at":"2023-05-01T09:30:26.953Z","created_by":"burzhynskyyy","name":"Azure AD success login from occupied regions or russia","tags":["Octava","o365"],"interval":"5m","enabled":false,"description":"Azure AD success login from occupied regions or russia","risk_score":73,"severity":"high","license":"","output_index":"","meta":{"from":"1m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-360s","rule_id":"9c9fe859-69bd-4d56-99b2-b6098e1a7b28","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"event.module:\"o365\" and event.provider:\"AzureActiveDirectory\" and event.action:\"UserLoggedIn\" and user.name:* and (source.geo.region_name:\"Donetsk\" or source.geo.region_name:\"Luhansk\" or source.geo.country_name:\"Russia\" or source.geo.region_name:\"Zaporizhzhia\" and source.geo.region_name:\"Kherson Oblast\") and not source.geo.city_name:(\"Kramatorsk\" and \"Sloviansk\" and \"Druzhkivka\" and \"Zaporizhzhya\" and \"Kherson\")","filters":[],"throttle":"no_actions","actions":[]}
{"id":"52afd3a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T10:03:03.257Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.239Z","created_by":"chaykovskiyv","name":"Potential Antimalware Scan Interface Bypass via PowerShell [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","PowerShell"],"interval":"5m","enabled":false,"description":"Identifies the execution of PowerShell script with keywords related to different Antimalware Scan Interface (AMSI) bypasses. An adversary may attempt first to disable AMSI before executing further malicious powershell scripts to evade detection.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"5f2f4845-5da7-4fef-8bcb-4ca1198731d8","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/001/","name":"Disable or Modify Tools","id":"T1562.001"}],"id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category :\"process\" and \n (\n  powershell.file.script_block_text : \n        (System.Management.Automation.AmsiUtils or \n\t\t\t\t amsiInitFailed or \n\t\t\t\t Invoke-AmsiBypass or \n\t\t\t\t Bypass.AMSI or \n\t\t\t\t amsi.dll or \n\t\t\t\t AntimalwareProvider  or \n\t\t\t\t amsiSession or \n\t\t\t\t amsiContext or \n\t\t\t\t System.Management.Automation.ScriptBlock or \n\t\t\t\t AmsiInitialize or \n\t\t\t\t unloadobfuscated or \n\t\t\t\t unloadsilent or \n\t\t\t\t AmsiX64 or \n\t\t\t\t AmsiX32 or \n\t\t\t\t FindAmsiFun) or \n\t\n  powershell.file.script_block_text : (\"[System.Runtime.InteropServices.Marshal]::Copy\" and \"VirtualProtect\") or \n\n  powershell.file.script_block_text : (\"[Ref].Assembly.GetType(('System.Management.Automation\" and \".SetValue(\") \n )\n","throttle":"no_actions","actions":[]}
{"id":"4b6f9850-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T10:37:17.558Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.115Z","created_by":"chaykovskiyv","name":"External Alerts [Duplicate]","tags":["Elastic","Network","Windows","APM","macOS","Linux"],"interval":"5m","enabled":false,"description":"Generates a detection alert for each external alert written to the configured indices. Enabling this rule allows you to immediately begin investigating external alerts in the app.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","rule_name_override":"message","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-6m","rule_id":"5dd62610-dc85-40a1-986e-998a1f41976c","max_signals":10000,"risk_score_mapping":[{"field":"event.risk_score","value":"","operator":"equals"}],"severity_mapping":[{"severity":"low","field":"event.severity","value":"21","operator":"equals"},{"severity":"medium","field":"event.severity","value":"47","operator":"equals"},{"severity":"high","field":"event.severity","value":"73","operator":"equals"},{"severity":"critical","field":"event.severity","value":"99","operator":"equals"}],"threat":[],"to":"now","references":[],"version":100,"exceptions_list":[{"list_id":"6d0ab147-e946-46ba-8e19-aa3574407a3d","namespace_type":"single","id":"8fcf76a0-eb2c-11ed-b6f4-dfeac9073248","type":"rule_default"}],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["apm-*-transaction*","traces-apm*","auditbeat-*","filebeat-*","logs-*","packetbeat-*","winlogbeat-*"],"query":"event.kind:alert and not event.module:(endgame or endpoint)\n","throttle":"no_actions","actions":[]}
{"id":"a9a00090-bc7e-11ed-b6f4-dfeac9073248","updated_at":"2023-06-08T21:29:32.465Z","updated_by":"burzhynskyyy","created_at":"2023-03-07T00:26:12.085Z","created_by":"burzhynskyyy","name":"IPsec Remote VPN from two countries","tags":["Custom Rules"],"interval":"5m","enabled":false,"description":"One user connected by IPSec Remote VPN from two countries within 24 hours","risk_score":73,"severity":"high","license":"","output_index":"","timeline_id":"300afc76-072d-4261-864d-4149714bf3f1","timeline_title":"Comprehensive Network Timeline","meta":{"from":"24h","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-86700s","rule_id":"84b7fa77-d1ec-411c-9e2b-393cdd7dff61","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"fortinet.firewall.subtype:\"vpn\" and fortinet.firewall.action:\"tunnel-up\"","filters":[],"threshold":{"field":["fortinet.firewall.xauthuser"],"value":2,"cardinality":[{"field":"destination.geo.country_name","value":2}]},"throttle":"no_actions","actions":[]}
{"id":"31dd03f0-19e4-11ee-8f07-79710758f25a","updated_at":"2023-07-03T20:57:17.501Z","updated_by":"burzhynskyyy","created_at":"2023-07-03T20:57:17.501Z","created_by":"burzhynskyyy","name":"Enumeration of Kernel Modules","tags":["Domain: Endpoint","OS: Linux","Use Case: Threat Detection","Tactic: Discovery"],"interval":"5m","enabled":false,"description":"Loadable Kernel Modules (or LKMs) are pieces of code that can be loaded and unloaded into the kernel upon demand. They extend the functionality of the kernel without the need to reboot the system. This identifies attempts to enumerate information about a kernel module.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Security tools and device drivers may run these programs in order to enumerate kernel modules. Use of these programs by ordinary users is uncommon. These can be exempted by process name or username."],"from":"now-9m","rule_id":"2d8043ed-5bda-4caf-801c-c1feb7410504","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0007","name":"Discovery","reference":"https://attack.mitre.org/tactics/TA0007/"},"technique":[{"id":"T1082","name":"System Information Discovery","reference":"https://attack.mitre.org/techniques/T1082/"}]}],"to":"now","references":[],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[{"package":"endpoint","version":"^8.2.0"}],"required_fields":[{"ecs":true,"name":"event.type","type":"keyword"},{"ecs":true,"name":"host.os.type","type":"keyword"},{"ecs":true,"name":"process.args","type":"keyword"},{"ecs":true,"name":"process.group_leader.name","type":"keyword"},{"ecs":true,"name":"process.name","type":"keyword"},{"ecs":true,"name":"process.parent.name","type":"keyword"},{"ecs":true,"name":"process.parent.user.id","type":"keyword"}],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"process where host.os.type == \"linux\" and event.type == \"start\" and \n((process.name == \"kmod\" and process.args == \"list\") or (process.name == \"modinfo\" and process.parent.user.id != \"0\") or \n(process.name == \"depmod\" and process.args in (\"--all\", \"-a\") and process.parent.user.id != \"0\") \nor process.name == \"lsmod\") and not process.parent.name : (\"vboxmanage\", \"virtualbox\", \"prime-offload\", \"vboxdrv.sh\") and not \nprocess.group_leader.name : \"qualys-cloud-agent\"\n","throttle":"no_actions","actions":[]}
{"id":"31dd2b00-19e4-11ee-8f07-79710758f25a","updated_at":"2023-07-03T20:57:17.504Z","updated_by":"burzhynskyyy","created_at":"2023-07-03T20:57:17.504Z","created_by":"burzhynskyyy","name":"Interactive Terminal Spawned via Python","tags":["Domain: Endpoint","OS: Linux","Use Case: Threat Detection","Tactic: Execution","Data Source: Elastic Endgame"],"interval":"5m","enabled":false,"description":"Identifies when a terminal (tty) is spawned via Python. Attackers may upgrade a simple reverse shell to a fully interactive tty after obtaining initial access to a host.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","timeline_id":"e70679c2-6cde-4510-9764-4823df18f7db","timeline_title":"Comprehensive Process Timeline","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"d76b02ef-fc95-4001-9297-01cb7412232f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0002","name":"Execution","reference":"https://attack.mitre.org/tactics/TA0002/"},"technique":[{"id":"T1059","name":"Command and Scripting Interpreter","reference":"https://attack.mitre.org/techniques/T1059/","subtechnique":[{"id":"T1059.006","name":"Python","reference":"https://attack.mitre.org/techniques/T1059/006/"}]}]}],"to":"now","references":[],"version":105,"exceptions_list":[],"immutable":false,"related_integrations":[{"package":"endpoint","version":"^8.2.0"}],"required_fields":[{"ecs":true,"name":"event.type","type":"keyword"},{"ecs":true,"name":"host.os.type","type":"keyword"},{"ecs":true,"name":"process.entity_id","type":"keyword"},{"ecs":true,"name":"process.executable","type":"keyword"},{"ecs":true,"name":"process.name","type":"keyword"},{"ecs":true,"name":"process.parent.entity_id","type":"keyword"}],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"sequence with maxspan=1m\n  [process where host.os.type == \"linux\" and event.type == \"start\" and process.name : \"python*\"] by process.entity_id\n  [process where host.os.type == \"linux\" and event.type == \"start\" and \n   process.executable : \"/bin/*sh\"\n  ] by process.parent.entity_id\n","throttle":"no_actions","actions":[]}
{"id":"31de1560-19e4-11ee-8f07-79710758f25a","updated_at":"2023-07-03T20:57:17.507Z","updated_by":"burzhynskyyy","created_at":"2023-07-03T20:57:17.507Z","created_by":"burzhynskyyy","name":"Kernel Module Removal","tags":["Domain: Endpoint","OS: Linux","Use Case: Threat Detection","Tactic: Defense Evasion","Data Source: Elastic Endgame"],"interval":"5m","enabled":false,"description":"Kernel modules are pieces of code that can be loaded and unloaded into the kernel upon demand. They extend the functionality of the kernel without the need to reboot the system. This rule identifies attempts to remove a kernel module.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["There is usually no reason to remove modules, but some buggy modules require it. These can be exempted by username. Note that some Linux distributions are not built to support the removal of modules at all."],"from":"now-9m","rule_id":"cd66a5af-e34b-4bb0-8931-57d0a043f2ef","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0005","name":"Defense Evasion","reference":"https://attack.mitre.org/tactics/TA0005/"},"technique":[{"id":"T1562","name":"Impair Defenses","reference":"https://attack.mitre.org/techniques/T1562/","subtechnique":[{"id":"T1562.001","name":"Disable or Modify Tools","reference":"https://attack.mitre.org/techniques/T1562/001/"}]}]},{"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"},"technique":[{"id":"T1547","name":"Boot or Logon Autostart Execution","reference":"https://attack.mitre.org/techniques/T1547/","subtechnique":[{"id":"T1547.006","name":"Kernel Modules and Extensions","reference":"https://attack.mitre.org/techniques/T1547/006/"}]}]}],"to":"now","references":["http://man7.org/linux/man-pages/man8/modprobe.8.html"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[{"package":"endpoint","version":"^8.2.0"}],"required_fields":[{"ecs":true,"name":"event.action","type":"keyword"},{"ecs":true,"name":"host.os.type","type":"keyword"},{"ecs":true,"name":"process.args","type":"keyword"},{"ecs":true,"name":"process.name","type":"keyword"}],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","endgame-*"],"query":"process where host.os.type == \"linux\" and event.action == \"exec\" and process.name == \"rmmod\" or\n(process.name == \"modprobe\" and process.args in (\"--remove\", \"-r\"))\n","throttle":"no_actions","actions":[]}
{"id":"34e53ae0-19e4-11ee-8f07-79710758f25a","updated_at":"2023-07-03T20:57:22.580Z","updated_by":"burzhynskyyy","created_at":"2023-07-03T20:57:22.580Z","created_by":"burzhynskyyy","name":"First Time Seen AWS Secret Value Accessed in Secrets Manager","tags":["Domain: Cloud","Data Source: AWS","Data Source: Amazon Web Services","Tactic: Credential Access","Resources: Investigation Guide"],"interval":"10m","enabled":false,"description":"An adversary equipped with compromised credentials may attempt to access the secrets in secrets manager to steal certificates, credentials, or other sensitive material.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating First Time Seen AWS Secret Value Accessed in Secrets Manager\n\nAWS Secrets Manager is a service that enables the replacement of hardcoded credentials in code, including passwords, with an API call to Secrets Manager to retrieve the secret programmatically.\n\nThis rule looks for the retrieval of credentials using `GetSecretValue` action in Secrets Manager programmatically. This is a [New Terms](https://www.elastic.co/guide/en/security/master/rules-ui-create.html#create-new-terms-rule) rule indicating this is the first time a specific user identity has successfuly retrieved a secret value from Secrets Manager.\n\n#### Possible investigation steps\n\n- Identify the account and its role in the environment, and inspect the related policy.\n- Identify the applications that should use this account.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Investigate abnormal values in the `user_agent.original` field by comparing them with the intended and authorized usage and historical data. Suspicious user agent values include non-SDK, AWS CLI, custom user agents, etc.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences involving other users.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Review IAM permission policies for the user identity and specific secrets accessed.\n- Examine the request parameters. These might indicate the source of the program or the nature of its tasks.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- False positives may occur due to the intended usage of the service. Tuning is needed in order to have higher confidence. Consider adding exceptions — preferably with a combination of user agent and IP address conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Rotate secrets or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Nick Jones","Elastic"],"false_positives":["Verify whether the user identity, user agent, and/or hostname should be using GetSecretString API for the specified SecretId. If known behavior is causing false positives, it can be exempted from the rule."],"from":"now-60m","rule_id":"a00681e3-9ed6-447c-ab2c-be648821c622","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0006","name":"Credential Access","reference":"https://attack.mitre.org/tactics/TA0006/"},"technique":[{"id":"T1528","name":"Steal Application Access Token","reference":"https://attack.mitre.org/techniques/T1528/"}]}],"to":"now","references":["https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html","http://detectioninthe.cloud/credential_access/access_secret_in_secrets_manager/"],"version":206,"exceptions_list":[],"immutable":false,"related_integrations":[{"integration":"cloudtrail","package":"aws","version":"^1.5.0"}],"required_fields":[{"ecs":true,"name":"event.action","type":"keyword"},{"ecs":true,"name":"event.dataset","type":"keyword"},{"ecs":true,"name":"event.outcome","type":"keyword"},{"ecs":true,"name":"event.provider","type":"keyword"},{"ecs":true,"name":"user_agent.name","type":"keyword"}],"setup":"The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.","type":"new_terms","query":"event.dataset:aws.cloudtrail and event.provider:secretsmanager.amazonaws.com and\n    event.action:GetSecretValue and event.outcome:success and\n    not user_agent.name: (\"Chrome\" or \"Firefox\" or \"Safari\" or \"Edge\" or \"Brave\" or \"Opera\" or \"aws-cli\")\n","new_terms_fields":["aws.cloudtrail.user_identity.access_key_id","aws.cloudtrail.request_parameters"],"history_window_start":"now-15d","index":["filebeat-*","logs-aws*"],"language":"kuery","throttle":"no_actions","actions":[]}
{"id":"edfd2980-0fb6-11ee-8f07-79710758f25a","updated_at":"2023-07-05T08:27:30.794Z","updated_by":"analyst","created_at":"2023-06-20T22:08:05.328Z","created_by":"burzhynskyyy","name":"High Confidence Phish with disguised sender [3]","tags":["Custom Rules"],"interval":"5m","enabled":false,"description":"Зафіксовано лист, якому присвоєна категорія HighConfidencePhish, де відправник замаскований під домен vuso.","risk_score":73,"severity":"high","license":"","output_index":"","meta":{"from":"1m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-360s","rule_id":"9e6b23d3-9010-4d29-90d7-89ef3912b134","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"event.module:\"o365\" and event.provider:\"ThreatIntelligence\" and o365.audit.P2Sender:*vuso* and not o365.audit.P1Sender:*vuso* and not o365.audit.P1Sender:\"<>\"","filters":[],"threshold":{"field":["o365.audit.P2Sender"],"value":1,"cardinality":[]},"throttle":"no_actions","actions":[]}
{"id":"0805bf70-3052-11ee-8f07-79710758f25a","updated_at":"2023-08-01T09:58:58.333Z","updated_by":"lozovoydmitr","created_at":"2023-08-01T09:58:57.515Z","created_by":"lozovoydmitr","name":"Declination MFA request after Brute force attack","tags":["Octava","Custom rule","Custom","O365","MFA","test"],"interval":"5m","enabled":false,"description":"This rule detects two-factor authentication request rejection or ignore events that occurred after failed authorization events","risk_score":73,"severity":"high","license":"","output_index":"","meta":{"from":"60m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-3900s","rule_id":"e690e573-769e-4b5c-900f-80f51f32d9a3","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"sequence with maxspan=1h\n[authentication where event.module== \"o365\" and event.provider: \"AzureActiveDirectory\" and\nevent.action: \"UserLoginFailed\" \n] by o365.audit.UserId with runs=5\n[any where event.module== \"azure\" and\nazure.eventhub.properties.status.additionalDetails: \"MFA denied; user did not respond to mobile app notification\" or azure.eventhub.properties.status.additionalDetails: \"MFA denied; user declined the authentication\"\n] by azure.eventhub.properties.userPrincipalName","filters":[],"throttle":"no_actions","actions":[]}
{"id":"fb6dfb40-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-08-07T21:51:50.168Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.720Z","created_by":"burzhynskyyy","name":"Attempts to Brute Force a Microsoft 365 User Account [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Identity and Access"],"interval":"5m","enabled":false,"description":"Identifies attempts to brute force a Microsoft 365 user account. An adversary may attempt a brute force attack to obtain unauthorized access to user accounts.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","meta":{"from":"25m"},"author":["Elastic","Willem D'Haese","Austin Songer"],"false_positives":["Automated processes that attempt to authenticate using expired credentials and unbounded retries may lead to false positives."],"from":"now-1800s","rule_id":"12cbcdb3-2190-4047-a5e6-82ec7dac8cc7","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1110/","name":"Brute Force","subtechnique":[],"id":"T1110"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://blueteamblog.com/7-ways-to-monitor-your-office-365-logs-using-siem"],"version":103,"exceptions_list":[{"list_id":"283ec564-c59a-4387-9723-a01a43a9920a","namespace_type":"single","id":"de084660-cc8e-11ed-b6f4-dfeac9073248","type":"rule_default"}],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:(AzureActiveDirectory or Exchange) and\n  event.category:authentication and event.action:(UserLoginFailed or PasswordLogonInitialAuthUsingPassword) and\n  not o365.audit.LogonError:(UserAccountNotFound or EntitlementGrantsNotFound or UserStrongAuthEnrollmentRequired or\n                             UserStrongAuthClientAuthNRequired or InvalidReplyTo or UserStrongAuthClientAuthNRequiredInterrupt)\n","filters":[],"threshold":{"field":["user.id"],"value":20,"cardinality":[]},"throttle":"no_actions","actions":[]}
{"id":"4b6cb220-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.603Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.079Z","created_by":"chaykovskiyv","name":"Unusual Child Processes of RunDLL32 [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"30m","enabled":true,"description":"Identifies child processes of unusual instances of RunDLL32 where the command line parameters were suspicious. Misuse of RunDLL32 could indicate malicious activity.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-60m","rule_id":"c17bcc6a-81b0-4c4e-b235-76a49ef2c969","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1218/","name":"System Binary Proxy Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1218/011/","name":"Rundll32","id":"T1218.011"}],"id":"T1218"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"sequence with maxspan=1h\n  [process where event.type == \"start\" and\n     (process.name : \"rundll32.exe\" or process.pe.original_file_name == \"RUNDLL32.EXE\") and\n      process.args_count == 1\n  ] by process.entity_id\n  [process where event.type == \"start\" and process.parent.name : \"rundll32.exe\"\n  ] by process.parent.entity_id\n","throttle":"no_actions","actions":[]}
{"id":"52adfee0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.279Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.220Z","created_by":"chaykovskiyv","name":"Wireless Credential Dumping using Netsh Command [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Discovery","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies attempts to dump Wireless saved access keys in clear text using the Windows built-in utility Netsh.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"ecde0658-b7ed-4ad5-b844-76b75f21f188","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","id":"T1003"},{"reference":"https://attack.mitre.org/techniques/T1555/","name":"Credentials from Password Stores","id":"T1555"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1082/","name":"System Information Discovery","id":"T1082"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}}],"to":"now","references":["https://learn.microsoft.com/en-us/windows-server/networking/technologies/netsh/netsh-contexts","https://www.geeksforgeeks.org/how-to-find-the-wi-fi-password-using-cmd-in-windows/"],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n (process.name : \"netsh.exe\" or process.pe.original_file_name == \"netsh.exe\") and\n  process.args : \"wlan\" and process.args : \"key*clear\"\n","throttle":"no_actions","actions":[]}
{"id":"48285c90-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.152Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.585Z","created_by":"chaykovskiyv","name":"Credential Acquisition via Registry Hive Dumping [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies attempts to export a registry hive which may contain credentials using the Windows reg.exe tool.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Credential Acquisition via Registry Hive Dumping\n\nDumping registry hives is a common way to access credential information as some hives store credential material.\n\nFor example, the SAM hive stores locally cached credentials (SAM Secrets), and the SECURITY hive stores domain cached credentials (LSA secrets).\n\nDumping these hives in combination with the SYSTEM hive enables the attacker to decrypt these secrets.\n\nThis rule identifies the usage of `reg.exe` to dump SECURITY and/or SAM hives, which potentially indicates the compromise of the credentials stored in the host.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate if the credential material was exfiltrated or processed locally by other tools.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (e.g., 4624) to the target host.\n\n### False positive analysis\n\n- Administrators can export registry hives for backup purposes using command line tools like `reg.exe`. Check whether the user is legitamitely performing this kind of activity.\n\n### Related rules\n\n- Registry Hive File Creation via SMB - a4c7473a-5cb4-4bc1-9d06-e4a75adbc494\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system and restore compromised files to clean versions.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"bb4ac7ff-df0e-4347-a296-1d596baa1823","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/002/","name":"Security Account Manager","id":"T1003.002"},{"reference":"https://attack.mitre.org/techniques/T1003/004/","name":"LSA Secrets","id":"T1003.004"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://medium.com/threatpunter/detecting-attempts-to-steal-passwords-from-the-registry-7512674487f8","https://www.elastic.co/security-labs/detect-credential-access"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n process.pe.original_file_name == \"reg.exe\" and\n process.args : (\"save\", \"export\") and\n process.args : (\"hklm\\\\sam\", \"hklm\\\\security\")\n","throttle":"no_actions","actions":[]}
{"id":"4d554840-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.010Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.286Z","created_by":"chaykovskiyv","name":"Unusual Network Connection via RunDLL32 [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Command and Control","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies unusual instances of rundll32.exe making outbound network connections. This may indicate adversarial Command and Control activity.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Unusual Network Connection via RunDLL32\n\nRunDLL32 is a built-in Windows utility and also a vital component used by the operating system itself. The functionality provided by RunDLL32 to execute Dynamic Link Libraries (DLLs) is widely abused by attackers, because it makes it hard to differentiate malicious activity from normal operations.\n\nThis rule looks for external network connections established using RunDLL32 when the utility is being executed with no arguments, which can potentially indicate command and control activity.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the target host that RunDLL32 is communicating with.\n  - Check if the domain is newly registered or unexpected.\n  - Check the reputation of the domain or IP address.\n- Identify the target computer and its role in the IT environment.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"4f123fb3-c11c-49f0-9156-6046944cef98","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1218/","name":"System Binary Proxy Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1218/011/","name":"Rundll32","id":"T1218.011"}],"id":"T1218"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1071/","name":"Application Layer Protocol","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1071/001/","name":"Web Protocols","id":"T1071.001"}],"id":"T1071"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0011/","name":"Command and Control","id":"TA0011"}}],"to":"now","references":["https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml","https://redcanary.com/threat-detection-report/techniques/rundll32/"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by host.id, process.entity_id with maxspan=1m\n  [process where event.type == \"start\" and process.name : \"rundll32.exe\" and process.args_count == 1]\n  [network where process.name : \"rundll32.exe\" and\n   not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\")]\n","throttle":"no_actions","actions":[]}
{"id":"52af3761-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:33.357Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.234Z","created_by":"chaykovskiyv","name":"File Creation Time Changed [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Identifies modification of a file creation time. Adversaries may modify file time attributes to blend malicious content with existing files. Timestomping is a technique that modifies the timestamps of a file often to mimic files that are in trusted directories.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"50f95bfe-a51c-47a6-96d8-c7b011f8990b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1070/","name":"Indicator Removal","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1070/006/","name":"Timestomp","id":"T1070.006"}],"id":"T1070"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-windows.*"],"query":"file where event.code : \"2\" and \n\n /* Requires Sysmon EventID 2 - File creation time change */\n event.action : \"File creation time changed*\" and \n \n not process.executable : \n          (\"?:\\\\Program Files\\\\*\", \n           \"?:\\\\Program Files (x86)\\\\*\", \n           \"?:\\\\Windows\\\\system32\\\\msiexec.exe\", \n           \"?:\\\\Windows\\\\syswow64\\\\msiexec.exe\", \n           \"?:\\\\Windows\\\\system32\\\\svchost.exe\", \n           \"?:\\\\WINDOWS\\\\system32\\\\backgroundTaskHost.exe\",\n           \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\", \n           \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\slack\\\\app-*\\\\slack.exe\", \n           \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\GitHubDesktop\\\\app-*\\\\GitHubDesktop.exe\",\n           \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Teams\\\\current\\\\Teams.exe\", \n           \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\OneDrive.exe\") and \n not file.extension : (\"tmp\", \"~tmp\", \"xml\") and not user.name : (\"SYSTEM\", \"Local Service\", \"Network Service\")\n","throttle":"no_actions","actions":[]}
{"id":"fb761190-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-05-17T09:44:26.748Z","updated_by":"chaykovskiyv","created_at":"2023-02-26T21:10:22.776Z","created_by":"burzhynskyyy","name":"O365 Exchange Suspicious Mailbox Right Delegation [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Configuration Audit"],"interval":"5m","enabled":true,"description":"Identifies the assignment of rights to access content from another mailbox. An adversary may use the compromised account to send messages to other accounts in the network of the target organization while creating inbox rules, so messages can evade spam/phishing detection mechanisms.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic","Austin Songer"],"false_positives":["Assignment of rights to a service account."],"from":"now-6m","rule_id":"1dfa3de9-ad9d-43fc-aad9-62afa6b9c96c","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"},"technique":[{"reference":"https://attack.mitre.org/techniques/T1098/","name":"Account Manipulation","id":"T1098","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1098/002/","name":"Additional Email Delegate Permissions","id":"T1098.002"}]}]}],"to":"now","references":[],"version":101,"exceptions_list":[{"id":"68e831c0-f497-11ed-8f07-79710758f25a","list_id":"b58ea034-4fa3-44da-80cc-72465759c43c","type":"rule_default","namespace_type":"single"}],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:Exchange and event.action:Add-MailboxPermission and\no365.audit.Parameters.AccessRights:(FullAccess or SendAs or SendOnBehalf) and event.outcome:success and\nnot user.id : \"NT AUTHORITY\\SYSTEM (Microsoft.Exchange.Servicehost)\"\n","throttle":"no_actions","actions":[]}
{"id":"4d54d310-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.008Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.281Z","created_by":"chaykovskiyv","name":"Network Connection via Signed Binary [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Binaries signed with trusted digital certificates can execute on Windows systems protected by digital signature validation. Adversaries may use these binaries to 'live off the land' and execute malicious files that could bypass application allowlists and signature validation.","risk_score":21,"severity":"low","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"df281f59-a169-44da-81be-708db8638f20","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1218/","name":"System Binary Proxy Execution","id":"T1218"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}},{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by process.entity_id\n  [process where (process.name : \"expand.exe\" or process.name : \"extrac32.exe\" or\n                 process.name : \"ieexec.exe\" or process.name : \"makecab.exe\") and\n                 event.type == \"start\"]\n  [network where (process.name : \"expand.exe\" or process.name : \"extrac32.exe\" or\n                 process.name : \"ieexec.exe\" or process.name : \"makecab.exe\") and\n    not cidrmatch(destination.ip,\n      \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\",\n      \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\",\n      \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\n      \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\", \"FF00::/8\")]\n","throttle":"no_actions","actions":[]}
{"id":"4b6e11b0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.610Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.099Z","created_by":"chaykovskiyv","name":"Remote File Download via MpCmdRun [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Command and Control","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the Windows Defender configuration utility (MpCmdRun.exe) being used to download a remote file.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Remote File Download via MpCmdRun\n\nAttackers commonly transfer tooling or malware from external systems into a compromised environment using the command and control channel. However, they can also abuse signed utilities to drop these files.\n\nThe `MpCmdRun.exe` is a command-line tool part of Windows Defender and is used to manage various Microsoft Windows Defender Antivirus settings and perform certain tasks. It can also be abused by attackers to download remote files, including malware and offensive tooling. This rule looks for the patterns used to perform downloads using the utility.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check the reputation of the domain or IP address used to host the downloaded file.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"d97cb3b0-d48e-4f88-85f8-6d239bfe913e","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1105/","name":"Ingress Tool Transfer","id":"T1105"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0011/","name":"Command and Control","id":"TA0011"}}],"to":"now","references":["https://twitter.com/mohammadaskar2/status/1301263551638761477","https://www.bleepingcomputer.com/news/microsoft/microsoft-defender-can-ironically-be-used-to-download-malware/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  (process.name : \"MpCmdRun.exe\" or process.pe.original_file_name == \"MpCmdRun.exe\") and\n   process.args : \"-DownloadFile\" and process.args : \"-url\" and process.args : \"-path\"\n","throttle":"no_actions","actions":[]}
{"id":"50e2b4c0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.245Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.245Z","created_by":"chaykovskiyv","name":"Suspicious Execution from a Mounted Device [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Identifies when a script interpreter or signed binary is launched via a non-standard working directory. An attacker may use this technique to evade defenses.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"c8c7d9a4-48fc-4697-99c5-ca55fdf39f9d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1218/","name":"System Binary Proxy Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1218/005/","name":"Mshta","id":"T1218.005"},{"reference":"https://attack.mitre.org/techniques/T1218/010/","name":"Regsvr32","id":"T1218.010"},{"reference":"https://attack.mitre.org/techniques/T1218/011/","name":"Rundll32","id":"T1218.011"}],"id":"T1218"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://www.microsoft.com/security/blog/2021/05/27/new-sophisticated-email-based-attack-from-nobelium/","https://www.volexity.com/blog/2021/05/27/suspected-apt29-operation-launches-election-fraud-themed-phishing-campaigns/"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and process.executable : \"C:\\\\*\" and\n  (process.working_directory : \"?:\\\\\" and not process.working_directory: \"C:\\\\\") and\n  process.parent.name : \"explorer.exe\" and\n  process.name : (\"rundll32.exe\", \"mshta.exe\", \"powershell.exe\", \"pwsh.exe\", \"cmd.exe\", \"regsvr32.exe\",\n                  \"cscript.exe\", \"wscript.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"4831ab60-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.217Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.636Z","created_by":"chaykovskiyv","name":"Privilege Escalation via Named Pipe Impersonation [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Identifies a privilege escalation attempt via named pipe impersonation. An adversary may abuse this technique by utilizing a framework such Metasploit's meterpreter getsystem command.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"90575e31-c434-4cfe-90d4-b2031cd3efae","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1134/","name":"Access Token Manipulation","id":"T1134"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://www.ired.team/offensive-security/privilege-escalation/windows-namedpipes-privilege-escalation"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n process.pe.original_file_name in (\"Cmd.Exe\", \"PowerShell.EXE\") and\n process.args : \"echo\" and process.args : \">\" and process.args : \"\\\\\\\\.\\\\pipe\\\\*\"\n","throttle":"no_actions","actions":[]}
{"id":"52b292c0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:33.320Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.277Z","created_by":"chaykovskiyv","name":"Attempt to Install Kali Linux via WSL [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Detects attempts to install or use Kali Linux via Windows Subsystem for Linux. Adversaries may enable and use WSL for Linux to avoid detection.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"21de15cd-afbd-445a-8091-d0eecce4d74e","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1202/","name":"Indirect Command Execution","id":"T1202"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://learn.microsoft.com/en-us/windows/wsl/wsl-config"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and \n(\n (process.name : \"wsl.exe\" and process.args : (\"-d\", \"--distribution\", \"-i\", \"--install\") and process.args : \"kali*\") or \n process.executable : \n        (\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\packages\\\\kalilinux*\", \n         \"?:\\\\Users\\\\*\\\\AppDara\\\\Local\\\\Microsoft\\\\WindowsApps\\\\kali.exe\",\n         \"?:\\\\Program Files*\\\\WindowsApps\\\\KaliLinux.*\\\\kali.exe\")\n )\n","throttle":"no_actions","actions":[]}
{"id":"52b2e0e0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:33.324Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.281Z","created_by":"chaykovskiyv","name":"System Service Discovery through built-in Windows Utilities [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Detects the usage of commonly used system service discovery techniques, which attackers may use during the reconnaissance phase after compromising a system in order to gain a better understanding of the environment and/or escalate privileges.","risk_score":21,"severity":"low","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"bab22672-ded4-4f75-b840-1b7d30b77b69","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1007/","name":"System Service Discovery","id":"T1007"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}}],"to":"now","references":[],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  (\n  ((process.name: \"net.exe\" or process.pe.original_file_name == \"net.exe\" or (process.name : \"net1.exe\" and not process.parent.name : \"net.exe\")) and process.args : (\"start\", \"use\") and process.args_count == 2) or\n  ((process.name: \"sc.exe\" or process.pe.original_file_name == \"sc.exe\") and process.args: (\"query\", \"q*\")) or\n  ((process.name: \"tasklist.exe\" or process.pe.original_file_name == \"tasklist.exe\") and process.args: \"/svc\")\n  )\n","throttle":"no_actions","actions":[]}
{"id":"47bcf090-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.211Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:05.839Z","created_by":"chaykovskiyv","name":"Suspicious ImagePath Service Creation [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Identifies the creation of a suspicious ImagePath value. This could be an indication of an adversary attempting to stealthily persist or escalate privileges through abnormal service creation.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"017a63f0-f051-4292-92f1-835ddd27c48f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1543/","name":"Create or Modify System Process","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1543/003/","name":"Windows Service","id":"T1543.003"}],"id":"T1543"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"registry where registry.path : \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ImagePath\" and\n /* add suspicious registry ImagePath values here */\n registry.data.strings : (\"%COMSPEC%*\", \"*\\\\.\\\\pipe\\\\*\")\n","throttle":"no_actions","actions":[]}
{"id":"4f2b40c0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.146Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.376Z","created_by":"chaykovskiyv","name":"Parent Process PID Spoofing [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Identifies parent process spoofing used to thwart detection. Adversaries may spoof the parent process identifier (PPID) of a new process to evade process-monitoring defenses or to elevate privileges.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"5d1f9e42-05d6-4a51-bb3d-fb578b00bff7","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1134/","name":"Access Token Manipulation","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1134/004/","name":"Parent PID Spoofing","id":"T1134.004"}],"id":"T1134"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://blog.didierstevens.com/2017/03/20/"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"/* This rule is compatible with Elastic Endpoint only */\n\nsequence by host.id, user.id with maxspan=3m \n\n [process where event.type == \"start\" and \n  process.Ext.token.integrity_level_name != \"system\" and \n  (\n    process.pe.original_file_name : (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\", \"eqnedt32.exe\",\n                                     \"fltldr.exe\", \"mspub.exe\", \"msaccess.exe\", \"powershell.exe\", \"pwsh.exe\",\n                                     \"cscript.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\", \"msbuild.exe\",\n                                     \"mshta.exe\", \"wmic.exe\", \"cmstp.exe\", \"msxsl.exe\") or \n                                     \n    (process.executable : (\"?:\\\\Users\\\\*.exe\",\n                           \"?:\\\\ProgramData\\\\*.exe\",\n                           \"?:\\\\Windows\\\\Temp\\\\*.exe\",\n                           \"?:\\\\Windows\\\\Tasks\\\\*\") and \n      (process.code_signature.exists == false or process.code_signature.status : \"errorBadDigest\")) or \n                          \n    process.executable : \"?:\\\\Windows\\\\Microsoft.NET\\\\*.exe\"                      \n  ) and \n  \n  not process.executable : \n             (\"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\", \n              \"?:\\\\WINDOWS\\\\SysWOW64\\\\WerFaultSecure.exe\",\n              \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n              \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\")\n  ] by process.pid\n [process where event.type == \"start\" and \n  process.parent.Ext.real.pid > 0 and \n \n  /* process.parent.Ext.real.pid is only populated if the parent process pid doesn't match */\n  not (process.name : \"msedge.exe\" and process.parent.name : \"sihost.exe\") and \n  \n   not process.executable : \n             (\"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\", \n              \"?:\\\\WINDOWS\\\\SysWOW64\\\\WerFaultSecure.exe\",\n              \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n              \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\")\n ] by process.parent.Ext.real.pid\n","throttle":"no_actions","actions":[]}
{"id":"50e59af0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.267Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.284Z","created_by":"chaykovskiyv","name":"Multiple Vault Web Credentials Read [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access"],"interval":"5m","enabled":true,"description":"Windows Credential Manager allows you to create, view, or delete saved credentials for signing into websites, connected applications, and networks. An adversary may abuse this to list or dump credentials stored in the Credential Manager for saved usernames and passwords. This may also be performed in preparation of lateral movement.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"6f0bb1d6-684d-4ca6-b8d1-3b911ac5561f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","id":"T1003"},{"reference":"https://attack.mitre.org/techniques/T1555/","name":"Credentials from Password Stores","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1555/004/","name":"Windows Credential Manager","id":"T1555.004"}],"id":"T1555"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=5382","https://www.elastic.co/security-labs/detect-credential-access"],"version":4,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"sequence by winlog.computer_name, winlog.process.pid with maxspan=1s\n\n /* 2 consecutive vault reads from same pid for web creds */\n\n [any where event.code : \"5382\" and\n  (winlog.event_data.SchemaFriendlyName : \"Windows Web Password Credential\" or winlog.event_data.Resource : \"http*\") and\n  not winlog.event_data.SubjectLogonId : \"0x3e7\"]\n\n [any where event.code : \"5382\" and\n  (winlog.event_data.SchemaFriendlyName : \"Windows Web Password Credential\" or winlog.event_data.Resource : \"http*\") and\n  not winlog.event_data.SubjectLogonId : \"0x3e7\"]\n","throttle":"no_actions","actions":[]}
{"id":"48318450-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.173Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.634Z","created_by":"chaykovskiyv","name":"LSASS Memory Dump Creation [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the creation of a Local Security Authority Subsystem Service (lsass.exe) default memory dump. This may indicate a credential access attempt via trusted system utilities such as Task Manager (taskmgr.exe) and SQL Dumper (sqldumper.exe) or known pentesting tools such as Dumpert and AndrewSpecial.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timeline_id":"4d4c0b59-ea83-483f-b8c1-8c360ee53c5c","timeline_title":"Comprehensive File Timeline","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"cfa3b768-d582-482b-bf4b-a64ae4321415","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/001/","name":"LSASS Memory","id":"T1003.001"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://github.com/outflanknl/Dumpert","https://github.com/hoangprod/AndrewSpecial"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"file where file.name : (\"lsass*.dmp\", \"dumpert.dmp\", \"Andrew.dmp\", \"SQLDmpr*.mdmp\", \"Coredump.dmp\") and\n\n not (process.executable : (\"?:\\\\Program Files\\\\Microsoft SQL Server\\\\*\\\\Shared\\\\SqlDumper.exe\", \"?:\\\\Windows\\\\System32\\\\dllhost.exe\") and\n      file.path : (\"?:\\\\Program Files\\\\Microsoft SQL Server\\\\*\\\\Shared\\\\ErrorDumps\\\\SQLDmpr*.mdmp\",\n                   \"?:\\\\*\\\\Reporting Services\\\\Logfiles\\\\SQLDmpr*.mdmp\")) and\n\n not (process.executable : \"?:\\\\WINDOWS\\\\system32\\\\WerFault.exe\" and\n      file.path : \"?:\\\\Windows\\\\System32\\\\config\\\\systemprofile\\\\AppData\\\\Local\\\\CrashDumps\\\\lsass.exe.*.dmp\")\n","throttle":"no_actions","actions":[]}
{"id":"49b34250-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.201Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.185Z","created_by":"chaykovskiyv","name":"Remotely Started Services via RPC [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies remote execution of Windows services over remote procedure call (RPC). This could be indicative of lateral movement, but will be noisy if commonly done by administrators.\"","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Remotely Started Services via RPC\n\nThe Service Control Manager Remote Protocol is a client/server protocol used for configuring and controlling service programs running on a remote computer. A remote service management session begins with the client initiating the connection request to the server. If the server grants the request, the connection is established. The client can then make multiple requests to modify, query the configuration, or start and stop services on the server by using the same session until the session is terminated.\n\nThis rule detects the remote creation or start of a service by correlating a `services.exe` network connection and the spawn of a child process.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Review login events (e.g., 4624) in the alert timeframe to identify the account used to perform this action. Use the `source.address` field to help identify the source system.\n- Review network events from the source system using the source port identified on the alert and try to identify the program used to initiate the action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- Remote management software like SCCM may trigger this rule. If noisy on your environment, consider adding exceptions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"1b95265e-9557-4d2f-8d37-1083b5b61256","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":["https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-scmr/705b624a-13de-43cc-b8a2-99573da3635f"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"sequence with maxspan=1s\n   [network where process.name : \"services.exe\" and\n      network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n      source.port >= 49152 and destination.port >= 49152 and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n   ] by host.id, process.entity_id\n\n   [process where event.type == \"start\" and process.parent.name : \"services.exe\" and\n       not (process.name : \"svchost.exe\" and process.args : \"tiledatamodelsvc\") and\n       not (process.name : \"msiexec.exe\" and process.args : \"/V\") and\n       not process.executable :\n               (\"?:\\\\Windows\\\\ADCR_Agent\\\\adcrsvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\VSSVC.exe\",\n                \"?:\\\\Windows\\\\servicing\\\\TrustedInstaller.exe\",\n                \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n                \"?:\\\\Program Files (x86)\\\\*.exe\",\n                \"?:\\\\Program Files\\\\*.exe\",\n                \"?:\\\\Windows\\\\PSEXESVC.EXE\",\n                \"?:\\\\Windows\\\\System32\\\\sppsvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiApSrv.exe\",\n                \"?:\\\\WINDOWS\\\\RemoteAuditService.exe\",\n                \"?:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe\",\n                \"?:\\\\Windows\\\\VeeamLogShipper\\\\VeeamLogShipper.exe\",\n                \"?:\\\\Windows\\\\CAInvokerService.exe\",\n                \"?:\\\\Windows\\\\System32\\\\upfc.exe\",\n                \"?:\\\\Windows\\\\AdminArsenal\\\\PDQ*.exe\",\n                \"?:\\\\Windows\\\\System32\\\\vds.exe\",\n                \"?:\\\\Windows\\\\Veeam\\\\Backup\\\\VeeamDeploymentSvc.exe\",\n                \"?:\\\\Windows\\\\ProPatches\\\\Scheduler\\\\STSchedEx.exe\",\n                \"?:\\\\Windows\\\\System32\\\\certsrv.exe\",\n                \"?:\\\\Windows\\\\eset-remote-install-service.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\OSCToGPAutoService\\\\OSCToGPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Windows\\\\SysWOW64\\\\NwxExeSvc\\\\NwxExeSvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\taskhostex.exe\")\n   ] by host.id, process.parent.entity_id\n","throttle":"no_actions","actions":[]}
{"id":"fb6f5ad0-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.282Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.749Z","created_by":"burzhynskyyy","name":"Microsoft 365 Potential ransomware activity [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Configuration Audit"],"interval":"5m","enabled":true,"description":"Identifies when Microsoft Cloud App Security reports that a user has uploaded files to the cloud that might be infected with ransomware.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Austin Songer"],"false_positives":["If Cloud App Security identifies, for example, a high rate of file uploads or file deletion activities it may represent an adverse encryption process."],"from":"now-30m","rule_id":"39f8325f-7248-4ea5-9325-350a4ca2e6fc","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1486/","name":"Data Encrypted for Impact","id":"T1486"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0040/","name":"Impact","id":"TA0040"}}],"to":"now","references":["https://docs.microsoft.com/en-us/cloud-app-security/anomaly-detection-policy","https://docs.microsoft.com/en-us/cloud-app-security/policy-template-reference"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.category:web and event.action:\"Potential ransomware activity\" and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"fb3a6820-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.257Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.377Z","created_by":"burzhynskyyy","name":"Microsoft 365 Exchange DLP Policy Removed [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Configuration Audit"],"interval":"5m","enabled":true,"description":"Identifies when a Data Loss Prevention (DLP) policy is removed in Microsoft 365. An adversary may remove a DLP policy to evade existing DLP monitoring.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["A DLP policy may be removed by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."],"from":"now-30m","rule_id":"3b76d91e-e27f-4a24-9151-80ad7867f93d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://docs.microsoft.com/en-us/powershell/module/exchange/remove-dlppolicy?view=exchange-ps","https://docs.microsoft.com/en-us/microsoft-365/compliance/data-loss-prevention-policies?view=o365-worldwide"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"Remove-DlpPolicy\" and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"52b18150-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.335Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.265Z","created_by":"chaykovskiyv","name":"PowerShell Mailbox Collection Script [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Collection","PowerShell"],"interval":"5m","enabled":true,"description":"Detects PowerShell scripts that can be used to collect data from mailboxes. Adversaries may target user email to collect sensitive information.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"16b6aac7-855a-4554-9be1-2555c4da0e54","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1114/","name":"Email Collection","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1114/001/","name":"Local Email Collection","id":"T1114.001"},{"reference":"https://attack.mitre.org/techniques/T1114/002/","name":"Remote Email Collection","id":"T1114.002"}],"id":"T1114"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0009/","name":"Collection","id":"TA0009"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://github.com/dafthack/MailSniper/blob/master/MailSniper.ps1","https://github.com/center-for-threat-informed-defense/adversary_emulation_library/blob/master/apt29/Archive/CALDERA_DIY/evals/payloads/stepSeventeen_email.ps1"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and\n  (\n   powershell.file.script_block_text : (\n      \"Microsoft.Office.Interop.Outlook\" or\n      \"Interop.Outlook.olDefaultFolders\" or\n      \"::olFolderInBox\"\n   ) or\n   powershell.file.script_block_text : (\n      \"Microsoft.Exchange.WebServices.Data.Folder\" or\n      \"Microsoft.Exchange.WebServices.Data.FileAttachment\"\n   )\n   )\n","throttle":"no_actions","actions":[]}
{"id":"944d9e00-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.766Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.289Z","created_by":"chaykovskiyv","name":"Startup/Logon Script added to Group Policy Object [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Active Directory","Investigation Guide"],"interval":"5m","enabled":true,"description":"Detects the modification of Group Policy Objects (GPO) to add a startup/logon script to users or computer objects.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Scheduled Task Execution at Scale via GPO\n\nGroup Policy Objects (GPOs) can be used by attackers to instruct arbitrarily large groups of clients to execute specified commands at startup, logon, shutdown, and logoff. This is done by creating or modifying the `scripts.ini` or `psscripts.ini` files. The scripts are stored in the following paths:\n  - `<GPOPath>\\Machine\\Scripts\\`\n  - `<GPOPath>\\User\\Scripts\\`\n\n#### Possible investigation steps\n\n- This attack abuses a legitimate mechanism of Active Directory, so it is important to determine whether the activity is legitimate and the administrator is authorized to perform this operation.\n- Retrieve the contents of the `ScheduledTasks.xml` file, and check the `<Command>` and `<Arguments>` XML tags for any potentially malicious commands or binaries.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Scope which objects may be compromised by retrieving information about which objects are controlled by the GPO.\n\n### False positive analysis\n\n- Verify if the execution is legitimately authorized and executed under a change management process.\n\n### Related rules\n\n- Group Policy Abuse for Privilege Addition - b9554892-5e0e-424b-83a0-5aef95aa43bf\n- Scheduled Task Execution at Scale via GPO - 15a8ba77-1c13-4274-88fe-6bd14133861e\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- The investigation and containment must be performed in every computer controlled by the GPO, where necessary.\n- Remove the script from the GPO.\n- Check if other GPOs have suspicious scripts attached.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Legitimate Administrative Activity"],"from":"now-6m","rule_id":"bdf10bc7-9676-4755-ae01-db929d44b3ba","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1484/","name":"Domain Policy Modification","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1484/001/","name":"Group Policy Modification","id":"T1484.001"}],"id":"T1484"},{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0025_windows_audit_directory_service_changes.md","https://github.com/atc-project/atc-data/blob/f2bbb51ecf68e2c9f488e3c70dcdd3df51d2a46b/docs/Logging_Policies/LP_0029_windows_audit_detailed_file_share.md","https://labs.f-secure.com/tools/sharpgpoabuse"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"(\n event.code:5136 and winlog.event_data.AttributeLDAPDisplayName:(gPCMachineExtensionNames or gPCUserExtensionNames) and\n   winlog.event_data.AttributeValue:(*42B5FAAE-6536-11D2-AE5A-0000F87571E3* and\n                                      (*40B66650-4972-11D1-A7CA-0000F87571E3* or *40B6664F-4972-11D1-A7CA-0000F87571E3*))\n)\nor\n(\n event.code:5145 and winlog.event_data.ShareName:\\\\\\\\*\\\\SYSVOL and\n   winlog.event_data.RelativeTargetName:(*\\\\scripts.ini or *\\\\psscripts.ini) and\n   (message:WriteData or winlog.event_data.AccessList:*%%4417*)\n)\n","throttle":"no_actions","actions":[]}
{"id":"483ef1d0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.188Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.741Z","created_by":"chaykovskiyv","name":"Persistence via Microsoft Office AddIns [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Detects attempts to establish persistence on an endpoint by abusing Microsoft Office add-ins.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"1fabe40d-2e9d-4fc4-be68-9db4f814b130","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1137/","name":"Office Application Startup","id":"T1137"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://labs.mwrinfosecurity.com/blog/add-in-opportunities-for-office-persistence/"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"file where event.type != \"deletion\" and\n file.extension : (\"wll\",\"xll\",\"ppa\",\"ppam\",\"xla\",\"xlam\") and\n file.path :\n    (\n    \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Word\\\\Startup\\\\*\",\n    \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\AddIns\\\\*\",\n    \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Excel\\\\XLSTART\\\\*\"\n    )\n","throttle":"no_actions","actions":[]}
{"id":"fb3b0460-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.327Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.695Z","created_by":"burzhynskyyy","name":"Microsoft 365 Exchange Anti-Phish Policy Deletion [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Configuration Audit"],"interval":"5m","enabled":true,"description":"Identifies the deletion of an anti-phishing policy in Microsoft 365. By default, Microsoft 365 includes built-in features that help protect users from phishing attacks. Anti-phishing polices increase this protection by refining settings to better detect and prevent attacks.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["An anti-phishing policy may be deleted by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."],"from":"now-30m","rule_id":"7888c1e3-b844-4c36-b193-7f6d20108153","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1566/","name":"Phishing","id":"T1566"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":["https://docs.microsoft.com/en-us/powershell/module/exchange/remove-antiphishpolicy?view=exchange-ps","https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/set-up-anti-phishing-policies?view=o365-worldwide"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"Remove-AntiPhishPolicy\" and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"9451bcb0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.768Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.306Z","created_by":"chaykovskiyv","name":"Group Policy Abuse for Privilege Addition [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Active Directory","Investigation Guide"],"interval":"5m","enabled":true,"description":"Detects the first occurrence of a modification to Group Policy Object Attributes to add privileges to user accounts or use them to add users as local admins.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Group Policy Abuse for Privilege Addition\n\nGroup Policy Objects (GPOs) can be used to add rights and/or modify Group Membership on GPOs by changing the contents of an INF file named GptTmpl.inf, which is responsible for storing every setting under the Security Settings container in the GPO. This file is unique for each GPO, and only exists if the GPO contains security settings. Example Path: \"\\\\DC.com\\SysVol\\DC.com\\Policies\\{PolicyGUID}\\Machine\\Microsoft\\Windows NT\\SecEdit\\GptTmpl.inf\"\n\n#### Possible investigation steps\n\n- This attack abuses a legitimate mechanism of Active Directory, so it is important to determine whether the activity is legitimate and the administrator is authorized to perform this operation.\n- Retrieve the contents of the `GptTmpl.inf` file, and under the `Privilege Rights` section, look for potentially dangerous high privileges, for example: SeTakeOwnershipPrivilege, SeEnableDelegationPrivilege, etc.\n- Inspect the user security identifiers (SIDs) associated with these privileges, and if they should have these privileges.\n\n### False positive analysis\n\n- Inspect whether the user that has done the modifications should be allowed to. The user name can be found in the `winlog.event_data.SubjectUserName` field.\n\n### Related rules\n\n- Scheduled Task Execution at Scale via GPO - 15a8ba77-1c13-4274-88fe-6bd14133861e\n- Startup/Logon Script added to Group Policy Object - 16fac1a1-21ee-4ca6-b720-458e3855d046\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- The investigation and containment must be performed in every computer controlled by the GPO, where necessary.\n- Remove the script from the GPO.\n- Check if other GPOs have suspicious scripts attached.","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-6m","rule_id":"4d9f7886-a4de-43ba-9dfd-d657da9846af","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1484/","name":"Domain Policy Modification","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1484/001/","name":"Group Policy Modification","id":"T1484.001"}],"id":"T1484"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0025_windows_audit_directory_service_changes.md","https://labs.f-secure.com/tools/sharpgpoabuse"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.code: \"5136\" and winlog.event_data.AttributeLDAPDisplayName:\"gPCMachineExtensionNames\" and\nwinlog.event_data.AttributeValue:(*827D319E-6EAC-11D2-A4EA-00C04F79F83A* and *803E14A0-B4FB-11D0-A0D0-00A0C90F574B*)\n","throttle":"no_actions","actions":[]}
{"id":"f2802880-d2cc-11ed-b6f4-dfeac9073248","updated_at":"2023-06-08T21:31:14.592Z","updated_by":"burzhynskyyy","created_at":"2023-04-04T09:42:00.373Z","created_by":"burzhynskyyy","name":"Mass file downloaded from SharePoint by one user","tags":["Custom Rules"],"interval":"5m","enabled":true,"description":"Mass file downloaded from SharePoint by one user","risk_score":47,"severity":"medium","license":"","output_index":"","meta":{"from":"1h","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-3900s","rule_id":"630abbbe-ab05-4a1d-bb98-21837c903788","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":3,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"event.module:\"o365\" and event.provider:\"SharePoint\" and event.action:\"FileDownloaded\" and not url.original: *VUSOMEDIA/PhotoVideo/Забіг під каштанами 2023*","filters":[],"threshold":{"field":["user.name"],"value":50,"cardinality":[{"field":"file.name","value":50}]},"throttle":"no_actions","actions":[]}
{"id":"4d5632a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.017Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.295Z","created_by":"chaykovskiyv","name":"Svchost spawning Cmd [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies a suspicious parent child process relationship with cmd.exe descending from svchost.exe","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Svchost spawning Cmd\n\nThe Service Host process (SvcHost) is a system process that can host one, or multiple, Windows services in the Windows NT family of operating systems. Note that `Svchost.exe` is reserved for use by the operating system and should not be used by non-Windows services.\n\nThis rule looks for the creation of the `cmd.exe` process with `svchost.exe` as its parent process. This is an unusual behavior that can indicate the masquerading of a malicious process as `svchost.exe` or exploitation for privilege escalation.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timeline_id":"e70679c2-6cde-4510-9764-4823df18f7db","timeline_title":"Comprehensive Process Timeline","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"ef2ebcfc-bf6b-4a58-a81a-c74a8b6fe799","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://nasbench.medium.com/demystifying-the-svchost-exe-process-and-its-command-line-options-508e9114e747"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n\n  process.parent.name : \"svchost.exe\" and process.name : \"cmd.exe\" and\n\n  not process.args :\n         (\"??:\\\\Program Files\\\\Npcap\\\\CheckStatus.bat?\",\n          \"?:\\\\Program Files\\\\Npcap\\\\CheckStatus.bat\",\n          \"\\\\system32\\\\cleanmgr.exe\",\n          \"?:\\\\Windows\\\\system32\\\\silcollector.cmd\",\n          \"\\\\system32\\\\AppHostRegistrationVerifier.exe\",\n          \"\\\\system32\\\\ServerManagerLauncher.exe\",\n          \"dir\",\n          \"?:\\\\Program Files\\\\*\",\n          \"?:\\\\Program Files (x86)\\\\*\",\n          \"?:\\\\Windows\\\\LSDeployment\\\\Lspush.exe\",\n          \"(x86)\\\\FMAuditOnsite\\\\watchdog.bat\",\n          \"?:\\\\ProgramData\\\\chocolatey\\\\bin\\\\choco-upgrade-all.bat\",\n          \"Files\\\\Npcap\\\\CheckStatus.bat\") and\n\n   /* very noisy pattern - bat or cmd script executed via scheduled tasks */\n  not (process.parent.args : \"netsvcs\" and process.args : (\"?:\\\\*.bat\", \"?:\\\\*.cmd\"))\n","throttle":"no_actions","actions":[]}
{"id":"483d4420-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.184Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.723Z","created_by":"chaykovskiyv","name":"Suspicious SolarWinds Child Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Elastic Endgame"],"interval":"5m","enabled":true,"description":"A suspicious SolarWinds child process was detected, which may indicate an attempt to execute malicious programs.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Trusted SolarWinds child processes, verify process details such as network connections and file writes."],"from":"now-9m","rule_id":"92456d04-bb25-466a-9304-517de4baf435","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1106/","name":"Native API","id":"T1106"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1195/","name":"Supply Chain Compromise","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1195/002/","name":"Compromise Software Supply Chain","id":"T1195.002"}],"id":"T1195"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":["https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html","https://github.com/mandiant/sunburst_countermeasures/blob/main/rules/SUNBURST/hxioc/SUNBURST%20SUSPICIOUS%20CHILD%20PROCESSES%20(METHODOLOGY).ioc"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n process.parent.name: (\"SolarWinds.BusinessLayerHost.exe\", \"SolarWinds.BusinessLayerHostx64.exe\") and\n not process.name : (\n        \"APMServiceControl*.exe\",\n        \"ExportToPDFCmd*.Exe\",\n        \"SolarWinds.Credentials.Orion.WebApi*.exe\",\n        \"SolarWinds.Orion.Topology.Calculator*.exe\",\n        \"Database-Maint.exe\",\n        \"SolarWinds.Orion.ApiPoller.Service.exe\",\n        \"WerFault.exe\",\n        \"WerMgr.exe\",\n        \"SolarWinds.BusinessLayerHost.exe\",\n        \"SolarWinds.BusinessLayerHostx64.exe\") and\n not process.executable : (\"?:\\\\Windows\\\\SysWOW64\\\\ARP.EXE\", \"?:\\\\Windows\\\\SysWOW64\\\\lodctr.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\unlodctr.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"483db950-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.162Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.727Z","created_by":"chaykovskiyv","name":"Outbound Scheduled Task Activity via PowerShell [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution"],"interval":"5m","enabled":true,"description":"Identifies the PowerShell process loading the Task Scheduler COM DLL followed by an outbound RPC network connection within a short time period. This may indicate lateral movement or remote discovery via scheduled tasks.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":["Legitimate scheduled tasks may be created during installation of new software."],"from":"now-9m","rule_id":"4a12d4c6-29fb-48e1-945e-90bbca77efff","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1053/","name":"Scheduled Task/Job","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1053/005/","name":"Scheduled Task","id":"T1053.005"}],"id":"T1053"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breach-organizations/"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by host.id, process.entity_id with maxspan = 5s\n [any where (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  (dll.name : \"taskschd.dll\" or file.name : \"taskschd.dll\") and process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")]\n [network where process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and destination.port == 135 and not destination.address in (\"127.0.0.1\", \"::1\")]\n","throttle":"no_actions","actions":[]}
{"id":"483ad320-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.197Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.697Z","created_by":"chaykovskiyv","name":"Suspicious Print Spooler Point and Print DLL [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Detects attempts to exploit a privilege escalation vulnerability (CVE-2020-1030) related to the print spooler service. Exploitation involves chaining multiple primitives to load an arbitrary DLL into the print spooler process running as SYSTEM.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"cde833dd-f12c-4f60-a32c-3b4a2fe310b2","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1068/","name":"Exploitation for Privilege Escalation","id":"T1068"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://www.accenture.com/us-en/blogs/cyber-defense/discovering-exploiting-shutting-down-dangerous-windows-print-spooler-vulnerability","https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/blob/master/Privilege%20Escalation/privesc_sysmon_cve_20201030_spooler.evtx","https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2020-1030"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"sequence by host.id with maxspan=30s\n[registry where\n registry.path : \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\SpoolDirectory\" and\n registry.data.strings : \"C:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\4\"]\n[registry where\n registry.path : \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\CopyFiles\\\\Payload\\\\Module\" and\n registry.data.strings : \"C:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\4\\\\*\"]\n","throttle":"no_actions","actions":[]}
{"id":"4d56f5f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.032Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.304Z","created_by":"chaykovskiyv","name":"Potential Credential Access via Renamed COM+ Services DLL [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Sysmon Only"],"interval":"5m","enabled":true,"description":"Identifies suspicious renamed COMSVCS.DLL Image Load, which exports the MiniDump function that can be used to dump a process memory. This may indicate an attempt to dump LSASS memory while bypassing command-line based detection in preparation for credential access.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"f933d95c-b751-47db-8d71-644a27b51547","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/001/","name":"LSASS Memory","id":"T1003.001"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://modexp.wordpress.com/2019/08/30/minidumpwritedump-via-com-services-dll/"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-windows.*"],"query":"sequence by process.entity_id with maxspan=1m\n [process where event.category == \"process\" and\n    process.name : \"rundll32.exe\"]\n [process where event.category == \"process\" and event.dataset : \"windows.sysmon_operational\" and event.code == \"7\" and\n   (file.pe.original_file_name : \"COMSVCS.DLL\" or file.pe.imphash : \"EADBCCBB324829ACB5F2BBE87E5549A8\") and\n    /* renamed COMSVCS */\n    not file.name : \"COMSVCS.DLL\"]\n","throttle":"no_actions","actions":[]}
{"id":"4d5680c0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.018Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.299Z","created_by":"chaykovskiyv","name":"Network Connection via MsXsl [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Identifies msxsl.exe making a network connection. This may indicate adversarial activity as msxsl.exe is often leveraged by adversaries to execute malicious scripts and evade detection.","risk_score":21,"severity":"low","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"94422ef5-f3fe-4765-8f66-661ab3eb1128","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1220/","name":"XSL Script Processing","id":"T1220"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by process.entity_id\n  [process where process.name : \"msxsl.exe\" and event.type == \"start\"]\n  [network where process.name : \"msxsl.exe\" and\n     not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\")]\n","throttle":"no_actions","actions":[]}
{"id":"fb7638a0-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.326Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.778Z","created_by":"burzhynskyyy","name":"New or Modified Federation Domain [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Identity and Access"],"interval":"5m","enabled":true,"description":"Identifies a new or modified federation domain, which can be used to create a trust between O365 and an external identity provider.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Austin Songer"],"false_positives":[],"from":"now-6m","rule_id":"feeb8a5d-ddce-4518-976c-d91d36e56fbc","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1484/","name":"Domain Policy Modification","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1484/002/","name":"Domain Trust Modification","id":"T1484.002"}],"id":"T1484"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://docs.microsoft.com/en-us/powershell/module/exchange/remove-accepteddomain?view=exchange-ps","https://docs.microsoft.com/en-us/powershell/module/exchange/remove-federateddomain?view=exchange-ps","https://docs.microsoft.com/en-us/powershell/module/exchange/new-accepteddomain?view=exchange-ps","https://docs.microsoft.com/en-us/powershell/module/exchange/add-federateddomain?view=exchange-ps","https://docs.microsoft.com/en-us/powershell/module/exchange/set-accepteddomain?view=exchange-ps","https://docs.microsoft.com/en-us/powershell/module/msonline/set-msoldomainfederationsettings?view=azureadps-1.0"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:(\"Set-AcceptedDomain\" or\n\"Set-MsolDomainFederationSettings\" or \"Add-FederatedDomain\" or \"New-AcceptedDomain\" or \"Remove-AcceptedDomain\" or \"Remove-FederatedDomain\") and\nevent.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"8bf363a0-e868-11ed-b6f4-dfeac9073248","updated_at":"2023-06-08T21:31:14.591Z","updated_by":"burzhynskyyy","created_at":"2023-05-01T21:38:45.024Z","created_by":"burzhynskyyy","name":"HighConfidencePhish with disguised sender","tags":["Custom Rules"],"interval":"5m","enabled":true,"description":"Зафіксовано лист, якому присвоєна категорія HighConfidencePhish, де відправник замаскований під домен vuso.","risk_score":47,"severity":"medium","license":"","output_index":"","meta":{"from":"1m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-360s","rule_id":"8d1c43b5-9f14-4dc5-930f-3bf2d042ab59","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":4,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","data_view_id":"logs-*","query":"event.module:\"o365\" and event.provider:\"ThreatIntelligence\" and o365.audit.P2Sender:*vuso* and not o365.audit.P1Sender:*vuso* and not o365.audit.P1Sender:\"<>\"","filters":[],"throttle":"no_actions","actions":[]}
{"id":"4b6c8b10-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.601Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.077Z","created_by":"chaykovskiyv","name":"Unusual Network Activity from a Windows System Binary [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Identifies network activity from unexpected system applications. This may indicate adversarial activity as these applications are often leveraged by adversaries to execute code and evade detection.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"8973c80e-de29-4472-8bd4-42a4384f22cd","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1127/","name":"Trusted Developer Utilities Proxy Execution","id":"T1127"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"sequence by process.entity_id with maxspan=5m\n  [process where event.type == \"start\" and\n\n     /* known applocker bypasses */\n     (process.name : \"bginfo.exe\" or\n      process.name : \"cdb.exe\" or\n      process.name : \"control.exe\" or\n      process.name : \"cmstp.exe\" or\n      process.name : \"csi.exe\" or\n      process.name : \"dnx.exe\" or\n      process.name : \"fsi.exe\" or\n      process.name : \"ieexec.exe\" or\n      process.name : \"iexpress.exe\" or\n      process.name : \"installutil.exe\" or\n      process.name : \"Microsoft.Workflow.Compiler.exe\" or\n      process.name : \"MSBuild.exe\" or\n      process.name : \"msdt.exe\" or\n      process.name : \"mshta.exe\" or\n      process.name : \"msiexec.exe\" or\n      process.name : \"msxsl.exe\" or\n      process.name : \"odbcconf.exe\" or\n      process.name : \"rcsi.exe\" or\n      process.name : \"regsvr32.exe\" or\n      process.name : \"xwizard.exe\")]\n  [network where\n     (process.name : \"bginfo.exe\" or\n      process.name : \"cdb.exe\" or\n      process.name : \"control.exe\" or\n      process.name : \"cmstp.exe\" or\n      process.name : \"csi.exe\" or\n      process.name : \"dnx.exe\" or\n      process.name : \"fsi.exe\" or\n      process.name : \"ieexec.exe\" or\n      process.name : \"iexpress.exe\" or\n      process.name : \"installutil.exe\" or\n      process.name : \"Microsoft.Workflow.Compiler.exe\" or\n      process.name : \"MSBuild.exe\" or\n      process.name : \"msdt.exe\" or\n      process.name : \"mshta.exe\" or\n      (\n         process.name : \"msiexec.exe\" and not\n         dns.question.name : (\n            \"ocsp.digicert.com\", \"ocsp.verisign.com\", \"ocsp.comodoca.com\", \"ocsp.entrust.net\", \"ocsp.usertrust.com\",\n            \"ocsp.godaddy.com\", \"ocsp.camerfirma.com\", \"ocsp.globalsign.com\", \"ocsp.sectigo.com\", \"*.local\"\n         )\n      ) or\n      process.name : \"msxsl.exe\" or\n      process.name : \"odbcconf.exe\" or\n      process.name : \"rcsi.exe\" or\n      process.name : \"regsvr32.exe\" or\n      process.name : \"xwizard.exe\")]\n","throttle":"no_actions","actions":[]}
{"id":"49cbd360-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.548Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.282Z","created_by":"chaykovskiyv","name":"Suspicious Print Spooler SPL File Created [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Investigation Guide"],"interval":"5m","enabled":true,"description":"Detects attempts to exploit privilege escalation vulnerabilities related to the Print Spooler service including CVE-2020-1048 and CVE-2020-1337.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Suspicious Print Spooler SPL File Created\n\nPrint Spooler is a Windows service enabled by default in all Windows clients and servers. The service manages print jobs by loading printer drivers, receiving files to be printed, queuing them, scheduling, etc.\n\nThe Print Spooler service has some known vulnerabilities that attackers can abuse to escalate privileges to SYSTEM, like CVE-2020-1048 and CVE-2020-1337. This rule looks for unusual processes writing SPL files to the location `?:\\Windows\\System32\\spool\\PRINTERS\\`, which is an essential step in exploiting these vulnerabilities.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions — preferably with a combination of process executable and file conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Ensure that the machine has the latest security updates and is not running legacy Windows versions.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"ec74a812-4048-4121-af9f-82d579598cec","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1068/","name":"Exploitation for Privilege Escalation","id":"T1068"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://safebreach.com/Post/How-we-bypassed-CVE-2020-1048-Patch-and-got-CVE-2020-1337"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"file where event.type != \"deletion\" and\n  file.extension : \"spl\" and\n  file.path : \"?:\\\\Windows\\\\System32\\\\spool\\\\PRINTERS\\\\*\" and\n  not process.name : (\"spoolsv.exe\",\n                      \"printfilterpipelinesvc.exe\",\n                      \"PrintIsolationHost.exe\",\n                      \"splwow64.exe\",\n                      \"msiexec.exe\",\n                      \"poqexec.exe\") and\n  not user.id : \"S-1-5-18\" and\n  not process.executable :\n            (\"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n             \"\\\\Device\\\\Mup\\\\*.exe\",\n             \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n             \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n             \"?:\\\\Windows\\\\System32\\\\printui.exe\",\n             \"?:\\\\Windows\\\\System32\\\\mstsc.exe\",\n             \"?:\\\\Windows\\\\System32\\\\spool\\\\*.exe\",\n             \"?:\\\\Program Files\\\\*.exe\",\n             \"?:\\\\Program Files (x86)\\\\*.exe\",\n             \"?:\\\\PROGRA~1\\\\*.exe\",\n             \"?:\\\\PROGRA~2\\\\*.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"50e0e000-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.067Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.227Z","created_by":"chaykovskiyv","name":"Microsoft Exchange Server UM Writing Suspicious Files [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Initial Access"],"interval":"5m","enabled":true,"description":"Identifies suspicious files being written by the Microsoft Exchange Server Unified Messaging (UM) service. This activity has been observed exploiting CVE-2021-26858.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\nPositive hits can be checked against the established Microsoft [baselines](https://github.com/microsoft/CSS-Exchange/tree/main/Security/Baselines).\n\nMicrosoft highly recommends that the best course of action is patching, but this may not protect already compromised systems\nfrom existing intrusions. Other tools for detecting and mitigating can be found within their Exchange support\n[repository](https://github.com/microsoft/CSS-Exchange/tree/main/Security)","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic","Austin Songer"],"false_positives":["Files generated during installation will generate a lot of noise, so the rule should only be enabled after the fact.","This rule was tuned using the following baseline: https://raw.githubusercontent.com/microsoft/CSS-Exchange/main/Security/Baselines/baseline_15.2.792.5.csv from Microsoft. Depending on version, consult https://github.com/microsoft/CSS-Exchange/tree/main/Security/Baselines to help determine normalcy."],"from":"now-9m","rule_id":"7b7cdb63-a6ed-47d2-be87-a76836feaf27","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1190/","name":"Exploit Public-Facing Application","id":"T1190"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":["https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers","https://www.volexity.com/blog/2021/03/02/active-exploitation-of-microsoft-exchange-zero-day-vulnerabilities"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"file where event.type == \"creation\" and\n  process.name : (\"UMWorkerProcess.exe\", \"umservice.exe\") and\n  file.extension : (\"php\", \"jsp\", \"js\", \"aspx\", \"asmx\", \"asax\", \"cfm\", \"shtml\") and\n  (\n    file.path : \"?:\\\\inetpub\\\\wwwroot\\\\aspnet_client\\\\*\" or\n\n    (file.path : \"?:\\\\*\\\\Microsoft\\\\Exchange Server*\\\\FrontEnd\\\\HttpProxy\\\\owa\\\\auth\\\\*\" and\n       not (file.path : \"?:\\\\*\\\\Microsoft\\\\Exchange Server*\\\\FrontEnd\\\\HttpProxy\\\\owa\\\\auth\\\\version\\\\*\" or\n            file.name : (\"errorFE.aspx\", \"expiredpassword.aspx\", \"frowny.aspx\", \"GetIdToken.htm\", \"logoff.aspx\",\n                        \"logon.aspx\", \"OutlookCN.aspx\", \"RedirSuiteServiceProxy.aspx\", \"signout.aspx\"))) or\n\n    (file.path : \"?:\\\\*\\\\Microsoft\\\\Exchange Server*\\\\FrontEnd\\\\HttpProxy\\\\ecp\\\\auth\\\\*\" and\n       not file.name : \"TimeoutLogoff.aspx\")\n  )\n","throttle":"no_actions","actions":[]}
{"id":"4f2ec330-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.171Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.409Z","created_by":"chaykovskiyv","name":"Windows Firewall Disabled via PowerShell [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies when the Windows Firewall is disabled using PowerShell cmdlets, which can help attackers evade network constraints, like internet and network lateral communication restrictions.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Windows Firewall Disabled via PowerShell\n\nWindows Defender Firewall is a native component that provides host-based, two-way network traffic filtering for a device and blocks unauthorized network traffic flowing into or out of the local device.\n\nAttackers can disable the Windows firewall or its rules to enable lateral movement and command and control activity.\n\nThis rule identifies patterns related to disabling the Windows firewall or its rules using the `Set-NetFirewallProfile` PowerShell cmdlet.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Check whether the user is an administrator and is legitimately performing troubleshooting.\n- In case of an allowed benign true positive (B-TP), assess adding rules to allow needed traffic and re-enable the firewall.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Re-enable the firewall with its desired configurations.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Austin Songer"],"false_positives":["Windows Firewall can be disabled by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Windows Profile being disabled by unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule."],"from":"now-9m","rule_id":"37268a3b-647f-4baf-86aa-b925fad538e5","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/004/","name":"Disable or Modify System Firewall","id":"T1562.004"}],"id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://docs.microsoft.com/en-us/powershell/module/netsecurity/set-netfirewallprofile?view=windowsserver2019-ps","https://www.tutorialspoint.com/how-to-get-windows-firewall-profile-settings-using-powershell","http://powershellhelp.space/commands/set-netfirewallrule-psv5.php","http://woshub.com/manage-windows-firewall-powershell/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*","endgame-*"],"query":"process where event.action == \"start\" and\n  (process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or process.pe.original_file_name == \"PowerShell.EXE\") and\n   process.args : \"*Set-NetFirewallProfile*\" and\n  (process.args : \"*-Enabled*\" and process.args : \"*False*\") and\n  (process.args : \"*-All*\" or process.args : (\"*Public*\", \"*Domain*\", \"*Private*\"))\n","throttle":"no_actions","actions":[]}
{"id":"49b31b40-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.203Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.183Z","created_by":"chaykovskiyv","name":"Persistence via Hidden Run Key Detected [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Identifies a persistence mechanism that utilizes the NtSetValueKey native API to create a hidden (null terminated) registry key. An adversary may use this method to hide from system utilities such as the Registry Editor (regedit).","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"8d10ee2b-6810-46f8-8d3c-7dd2de99623d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1547/001/","name":"Registry Run Keys / Startup Folder","id":"T1547.001"}],"id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://github.com/outflanknl/SharpHide","https://github.com/ewhitehats/InvisiblePersistence/blob/master/InvisibleRegValues_Whitepaper.pdf"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"/* Registry Path ends with backslash */\nregistry where /* length(registry.data.strings) > 0 and */\n registry.path : (\"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKLM\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"HKU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\")\n","throttle":"no_actions","actions":[]}
{"id":"50de47f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.049Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.200Z","created_by":"chaykovskiyv","name":"New ActiveSyncAllowedDeviceID Added via PowerShell [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Identifies the use of the Exchange PowerShell cmdlet, Set-CASMailbox, to add a new ActiveSync allowed device. Adversaries may target user email to collect sensitive information.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Legitimate exchange system administration activity."],"from":"now-9m","rule_id":"a29360f7-5f9c-4e8a-9c7a-e6fdea53cfcd","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1098/","name":"Account Manipulation","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1098/002/","name":"Additional Email Delegate Permissions","id":"T1098.002"}],"id":"T1098"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breach-organizations/","https://docs.microsoft.com/en-us/powershell/module/exchange/set-casmailbox?view=exchange-ps"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  process.name: (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and process.args : \"Set-CASMailbox*ActiveSyncAllowedDeviceIDs*\"\n","throttle":"no_actions","actions":[]}
{"id":"48424d30-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.194Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.779Z","created_by":"chaykovskiyv","name":"Persistence via WMI Event Subscription [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"An adversary can use Windows Management Instrumentation (WMI) to install event filters, providers, consumers, and bindings that execute code when a defined event occurs. Adversaries may use the capabilities of WMI to subscribe to an event and execute arbitrary code when that event occurs, providing persistence on a system.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"2477aa8a-3297-48f1-a7bd-5e26f4688b9d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1546/","name":"Event Triggered Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1546/003/","name":"Windows Management Instrumentation Event Subscription","id":"T1546.003"}],"id":"T1546"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://www.elastic.co/security-labs/hunting-for-persistence-using-elastic-security-part-1"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  (process.name : \"wmic.exe\" or process.pe.original_file_name == \"wmic.exe\") and\n  process.args : \"create\" and\n  process.args : (\"ActiveScriptEventConsumer\", \"CommandLineEventConsumer\")\n","throttle":"no_actions","actions":[]}
{"id":"49b51710-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.529Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.205Z","created_by":"chaykovskiyv","name":"Startup Persistence by a Suspicious Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies files written to or modified in the startup folder by commonly abused processes. Adversaries may use this technique to maintain persistence.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Startup Persistence by a Suspicious Process\n\nThe Windows Startup folder is a special folder in Windows. Programs added to this folder are executed during account logon, without user interaction, providing an excellent way for attackers to maintain persistence.\n\nThis rule monitors for commonly abused processes writing to the Startup folder locations.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- Administrators may add programs to this mechanism via command-line shells. Before the further investigation, verify that this activity is not benign.\n\n### Related rules\n\n- Suspicious Startup Shell Folder Modification - c8b150f0-0164-475b-a75e-74b47800a9ff\n- Persistent Scripts in the Startup Directory - f7c4dc5a-a58d-491d-9f14-9b66507121c0\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"28c04f68-55c6-4850-b487-738d4818a72a","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1547/001/","name":"Registry Run Keys / Startup Folder","id":"T1547.001"}],"id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://www.elastic.co/security-labs/hunting-for-persistence-using-elastic-security-part-1"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"file where event.type != \"deletion\" and\n  user.domain != \"NT AUTHORITY\" and\n  file.path : (\"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\",\n               \"C:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\StartUp\\\\*\") and\n  process.name : (\"cmd.exe\",\n                  \"powershell.exe\",\n                  \"wmic.exe\",\n                  \"mshta.exe\",\n                  \"pwsh.exe\",\n                  \"cscript.exe\",\n                  \"wscript.exe\",\n                  \"regsvr32.exe\",\n                  \"RegAsm.exe\",\n                  \"rundll32.exe\",\n                  \"EQNEDT32.EXE\",\n                  \"WINWORD.EXE\",\n                  \"EXCEL.EXE\",\n                  \"POWERPNT.EXE\",\n                  \"MSPUB.EXE\",\n                  \"MSACCESS.EXE\",\n                  \"iexplore.exe\",\n                  \"InstallUtil.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"483f3ff0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.196Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.743Z","created_by":"chaykovskiyv","name":"AdFind Command Activity [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"This rule detects the Active Directory query tool, AdFind.exe. AdFind has legitimate purposes, but it is frequently leveraged by threat actors to perform post-exploitation Active Directory reconnaissance. The AdFind tool has been observed in Trickbot, Ryuk, Maze, and FIN6 campaigns. For Winlogbeat, this rule requires Sysmon.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating AdFind Command Activity\n\n[AdFind](http://www.joeware.net/freetools/tools/adfind/) is a freely available command-line tool used to retrieve information from Active Directory (AD). Network discovery and enumeration tools like `AdFind` are useful to adversaries in the same ways they are effective for network administrators. This tool provides quick ability to scope AD person/computer objects and understand subnets and domain information. There are many [examples](https://thedfirreport.com/category/adfind/) of this tool being adopted by ransomware and criminal groups and used in compromises.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Examine the command line to determine what information was retrieved by the tool.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- This rule has a high chance to produce false positives as it is a legitimate tool used by network administrators.\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n- Malicious behavior with `AdFind` should be investigated as part of a step within an attack chain. It doesn't happen in isolation, so reviewing previous logs/activity from impacted machines can be very telling.\n\n### Related rules\n\n- Windows Network Enumeration - 7b8bfc26-81d2-435e-965c-d722ee397ef1\n- Enumeration of Administrator Accounts - 871ea072-1b71-4def-b016-6278b505138d\n- Enumeration Command Spawned via WMIPrvSE - 770e0c4d-b998-41e5-a62e-c7901fd7f470\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"abb5cf4e-9044-46f3-b289-8bf30d75fe25","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1018/","name":"Remote System Discovery","id":"T1018"},{"reference":"https://attack.mitre.org/techniques/T1069/","name":"Permission Groups Discovery","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1069/002/","name":"Domain Groups","id":"T1069.002"}],"id":"T1069"},{"reference":"https://attack.mitre.org/techniques/T1087/","name":"Account Discovery","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1087/002/","name":"Domain Account","id":"T1087.002"}],"id":"T1087"},{"reference":"https://attack.mitre.org/techniques/T1482/","name":"Domain Trust Discovery","id":"T1482"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}}],"to":"now","references":["http://www.joeware.net/freetools/tools/adfind/","https://thedfirreport.com/2020/05/08/adfind-recon/","https://www.fireeye.com/blog/threat-research/2020/05/tactics-techniques-procedures-associated-with-maze-ransomware-incidents.html","https://www.cybereason.com/blog/dropping-anchor-from-a-trickbot-infection-to-the-discovery-of-the-anchor-malware","https://www.fireeye.com/blog/threat-research/2019/04/pick-six-intercepting-a-fin6-intrusion.html","https://usa.visa.com/dam/VCOM/global/support-legal/documents/fin6-cybercrime-group-expands-threat-To-ecommerce-merchants.pdf"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  (process.name : \"AdFind.exe\" or process.pe.original_file_name == \"AdFind.exe\") and\n  process.args : (\"objectcategory=computer\", \"(objectcategory=computer)\",\n                  \"objectcategory=person\", \"(objectcategory=person)\",\n                  \"objectcategory=subnet\", \"(objectcategory=subnet)\",\n                  \"objectcategory=group\", \"(objectcategory=group)\",\n                  \"objectcategory=organizationalunit\", \"(objectcategory=organizationalunit)\",\n                  \"objectcategory=attributeschema\", \"(objectcategory=attributeschema)\",\n                  \"domainlist\", \"dcmodes\", \"adinfo\", \"dclist\", \"computers_pwnotreqd\", \"trustdmp\")\n","throttle":"no_actions","actions":[]}
{"id":"94516e90-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.771Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.310Z","created_by":"chaykovskiyv","name":"Potential Privileged Escalation via SamAccountName Spoofing [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Privilege Escalation","Active Directory"],"interval":"5m","enabled":true,"description":"Identifies a suspicious computer account name rename event, which may indicate an attempt to exploit CVE-2021-42278 to elevate privileges from a standard domain user to a user with domain admin privileges. CVE-2021-42278 is a security vulnerability that allows potential attackers to impersonate a domain controller via samAccountName attribute spoofing.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"577bf233-510e-4a66-b191-1f1bb6b43ab6","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1078/","name":"Valid Accounts","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1078/002/","name":"Domain Accounts","id":"T1078.002"}],"id":"T1078"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1098/","name":"Account Manipulation","id":"T1098"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://support.microsoft.com/en-us/topic/kb5008102-active-directory-security-accounts-manager-hardening-changes-cve-2021-42278-5975b463-4c95-45e1-831a-d120004e258e","https://cloudbrothers.info/en/exploit-kerberos-samaccountname-spoofing/","https://github.com/cube0x0/noPac","https://twitter.com/exploitph/status/1469157138928914432","https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"iam where event.action == \"renamed-user-account\" and\n  /* machine account name renamed to user like account name */\n  winlog.event_data.OldTargetUserName : \"*$\" and not winlog.event_data.NewTargetUserName : \"*$\"\n","throttle":"no_actions","actions":[]}
{"id":"50e3ed40-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.252Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.263Z","created_by":"chaykovskiyv","name":"Elastic Agent Service Terminated [Duplicate]","tags":["Elastic","Host","Linux","Windows","macOS","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Identifies the Elastic endpoint agent has stopped and is no longer running on the host. Adversaries may attempt to disable security monitoring tools in an attempt to evade detection or prevention capabilities during an intrusion. This may also indicate an issue with the agent itself and should be addressed to ensure defensive measures are back in a stable state.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"fb885f56-ae64-43bb-a59f-36f1f71672e9","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/001/","name":"Disable or Modify Tools","id":"T1562.001"}],"id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"process where\n/* net, sc or wmic stopping or deleting Elastic Agent on Windows */\n(event.type == \"start\" and\n  process.name : (\"net.exe\", \"sc.exe\", \"wmic.exe\",\"powershell.exe\",\"taskkill.exe\",\"PsKill.exe\",\"ProcessHacker.exe\") and\n  process.args : (\"stopservice\",\"uninstall\", \"stop\", \"disabled\",\"Stop-Process\",\"terminate\",\"suspend\") and\n  process.args : (\"elasticendpoint\", \"Elastic Agent\",\"elastic-agent\",\"elastic-endpoint\"))\nor\n/* service or systemctl used to stop Elastic Agent on Linux */\n(event.type == \"end\" and\n  (process.name : (\"systemctl\", \"service\") and\n    process.args : \"elastic-agent\" and\n    process.args : \"stop\")\n  or\n  /* Unload Elastic Agent extension on MacOS */\n  (process.name : \"kextunload\" and\n    process.args : \"com.apple.iokit.EndpointSecurity\" and\n    event.action : \"end\"))\n","throttle":"no_actions","actions":[]}
{"id":"52b35610-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:33.332Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.284Z","created_by":"chaykovskiyv","name":"Suspicious Antimalware Scan Interface DLL [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the creation of the Antimalware Scan Interface (AMSI) DLL in an unusual location. This may indicate an attempt to bypass AMSI by loading a rogue AMSI module instead of the legit one.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"72b3b6f5-cee6-476b-86dc-deac8ab9df36","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/001/","name":"Disable or Modify Tools","id":"T1562.001"}],"id":"T1562"},{"reference":"https://attack.mitre.org/techniques/T1574/","name":"Hijack Execution Flow","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1574/001/","name":"DLL Search Order Hijacking","id":"T1574.001"}],"id":"T1574"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"file where event.action != \"deletion\" and file.path != null and \n file.name : (\"amsi.dll\", \"amsi\") and not file.path : (\"?:\\\\Windows\\\\system32\\\\amsi.dll\", \"?:\\\\Windows\\\\Syswow64\\\\amsi.dll\")\n","throttle":"no_actions","actions":[]}
{"id":"4b6bc7c0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.595Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.071Z","created_by":"chaykovskiyv","name":"Renamed AutoIt Scripts Interpreter [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies a suspicious AutoIt process execution. Malware written as an AutoIt script tends to rename the AutoIt executable to avoid detection.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"0fe42658-49c4-4f3f-8000-7c8b7be1b547","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1036/","name":"Masquerading","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1036/003/","name":"Rename System Utilities","id":"T1036.003"}],"id":"T1036"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.pe.original_file_name : \"AutoIt*.exe\" and not process.name : \"AutoIt*.exe\"\n","throttle":"no_actions","actions":[]}
{"id":"50e091e0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.059Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.222Z","created_by":"chaykovskiyv","name":"Potential Port Monitor or Print Processor Registration Abuse [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Identifies port monitor and print processor registry modifications. Adversaries may abuse port monitor and print processors to run malicious DLLs during system boot that will be executed as SYSTEM for privilege escalation and/or persistence, if permissions allow writing a fully-qualified pathname for that DLL.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"84e0cb6a-0bb5-4053-b4fb-2c400fad3f30","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1547/010/","name":"Port Monitors","id":"T1547.010"}],"id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1547/010/","name":"Port Monitors","id":"T1547.010"}],"id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://www.welivesecurity.com/2020/05/21/no-game-over-winnti-group/"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"registry where event.type in (\"creation\", \"change\") and\n  registry.path : (\"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Print\\\\Monitors\\\\*\",\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Print\\\\Environments\\\\Windows*\\\\Print Processors\\\\*\") and\n  registry.data.strings : \"*.dll\" and\n  /* exclude SYSTEM SID - look for changes by non-SYSTEM user */\n  not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"4b6ab650-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.534Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.057Z","created_by":"chaykovskiyv","name":"Suspicious WerFault Child Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"A suspicious WerFault child process was detected, which may indicate an attempt to run via the SilentProcessExit registry key manipulation. Verify process details such as command line, network connections and file writes.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Custom Windows error reporting debugger or applications restarted by WerFault after a crash."],"from":"now-9m","rule_id":"b9d3340a-0eee-4f18-be26-bbfe3fdf92d5","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1036/","name":"Masquerading","id":"T1036"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://www.hexacorn.com/blog/2019/09/19/silentprocessexit-quick-look-under-the-hood/","https://www.hexacorn.com/blog/2019/09/20/werfault-command-line-switches-v0-1/","https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/blob/master/Persistence/persistence_SilentProcessExit_ImageHijack_sysmon_13_1.evtx","https://blog.menasec.net/2021/01/"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and \n\n  process.parent.name : \"WerFault.exe\" and \n  \n  /* args -s and -t used to execute a process via SilentProcessExit mechanism */\n  (process.parent.args : \"-s\" and process.parent.args : \"-t\" and process.parent.args : \"-c\") and \n  \n  not process.executable : (\"?:\\\\Windows\\\\SysWOW64\\\\Initcrypt.exe\", \"?:\\\\Program Files (x86)\\\\Heimdal\\\\Heimdal.Guard.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"49b4f000-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.530Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.203Z","created_by":"chaykovskiyv","name":"Unusual Persistence via Services Registry [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Identifies processes modifying the services registry key directly, instead of through the expected Windows APIs. This could be an indication of an adversary attempting to stealthily persist through abnormal service creation or modification of an existing service.","risk_score":21,"severity":"low","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"38bf123b-c03e-4cbf-bd52-cc4a3d396ab4","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1543/","name":"Create or Modify System Process","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1543/003/","name":"Windows Service","id":"T1543.003"}],"id":"T1543"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"registry where registry.path : (\"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ServiceDLL\", \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ImagePath\") and\n  not registry.data.strings : (\"?:\\\\windows\\\\system32\\\\Drivers\\\\*.sys\",\n                               \"\\\\SystemRoot\\\\System32\\\\drivers\\\\*.sys\",\n                               \"\\\\??\\\\?:\\\\Windows\\\\system32\\\\Drivers\\\\*.SYS\",\n                               \"system32\\\\DRIVERS\\\\USBSTOR\") and\n  not (process.name : \"procexp??.exe\" and registry.data.strings : \"?:\\\\*\\\\procexp*.sys\") and\n  not process.executable : (\"?:\\\\Program Files\\\\*.exe\",\n                            \"?:\\\\Program Files (x86)\\\\*.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n                            \"?:\\\\Windows\\\\winsxs\\\\*\\\\TiWorker.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\drvinst.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\services.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\regsvr32.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"4f2bb5f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.150Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.381Z","created_by":"chaykovskiyv","name":"DNS-over-HTTPS Enabled via Registry [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies when a user enables DNS-over-HTTPS. This can be used to hide internet activity or the process of exfiltrating data. With this enabled, an organization will lose visibility into data such as query type, response, and originating IP, which are used to determine bad actors.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Austin Songer"],"false_positives":[],"from":"now-9m","rule_id":"252f9090-aa50-457e-ba09-5212776d008b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://www.tenforums.com/tutorials/151318-how-enable-disable-dns-over-https-doh-microsoft-edge.html","https://chromeenterprise.google/policies/?policy=DnsOverHttpsMode"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"registry where event.type in (\"creation\", \"change\") and\n  (registry.path : \"*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Edge\\\\BuiltInDnsClientEnabled\" and\n  registry.data.strings : \"1\") or\n  (registry.path : \"*\\\\SOFTWARE\\\\Google\\\\Chrome\\\\DnsOverHttpsMode\" and\n  registry.data.strings : \"secure\") or\n  (registry.path : \"*\\\\SOFTWARE\\\\Policies\\\\Mozilla\\\\Firefox\\\\DNSOverHTTPS\" and\n  registry.data.strings : \"1\")\n","throttle":"no_actions","actions":[]}
{"id":"50dfa780-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.058Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.215Z","created_by":"chaykovskiyv","name":"SIP Provider Modification [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies modifications to the registered Subject Interface Package (SIP) providers. SIP providers are used by the Windows cryptographic system to validate file signatures on the system. This may be an attempt to bypass signature validation checks or inject code into critical processes.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"038450a3-f4d5-4498-8c13-ecafae1eb3b3","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1553/","name":"Subvert Trust Controls","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1553/003/","name":"SIP and Trust Provider Hijacking","id":"T1553.003"}],"id":"T1553"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://github.com/mattifestation/PoCSubjectInterfacePackage"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","endgame-*"],"query":"registry where event.type:\"change\" and\n  registry.path: (\n    \"*\\\\SOFTWARE\\\\Microsoft\\\\Cryptography\\\\OID\\\\EncodingType 0\\\\CryptSIPDllPutSignedDataMsg\\\\{*}\\\\Dll\",\n    \"*\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Cryptography\\\\OID\\\\EncodingType 0\\\\CryptSIPDllPutSignedDataMsg\\\\{*}\\\\Dll\",\n    \"*\\\\SOFTWARE\\\\Microsoft\\\\Cryptography\\\\Providers\\\\Trust\\\\FinalPolicy\\\\{*}\\\\$Dll\",\n    \"*\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Cryptography\\\\Providers\\\\Trust\\\\FinalPolicy\\\\{*}\\\\$Dll\"\n    ) and\n  registry.data.strings:\"*.dll\"\n","throttle":"no_actions","actions":[]}
{"id":"49af23a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.550Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.133Z","created_by":"chaykovskiyv","name":"Execution via local SxS Shared Module [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the creation, change, or deletion of a DLL module within a Windows SxS local folder. Adversaries may abuse shared modules to execute malicious payloads by instructing the Windows module loader to load DLLs from arbitrary local paths.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\nThe SxS DotLocal folder is a legitimate feature that can be abused to hijack standard modules loading order by forcing an executable on the same application.exe.local folder to load a malicious DLL module from the same directory.","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"b49282fd-9f3a-4390-9532-f89104ba7916","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1129/","name":"Shared Modules","id":"T1129"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-redirection"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"file where file.extension : \"dll\" and file.path : \"C:\\\\*\\\\*.exe.local\\\\*.dll\"\n","throttle":"no_actions","actions":[]}
{"id":"52affab0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.299Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.241Z","created_by":"chaykovskiyv","name":"Suspicious Module Loaded by LSASS [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access"],"interval":"5m","enabled":true,"description":"Identifies LSASS loading an unsigned or untrusted DLL. Windows Security Support Provider (SSP) DLLs are loaded into LSSAS process at system start. Once loaded into the LSA, SSP DLLs have access to encrypted and plaintext passwords that are stored in Windows, such as any logged-on user's Domain password or smart card PINs.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"579156a0-acf7-4541-a616-c886a5143684","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/001/","name":"LSASS Memory","id":"T1003.001"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://blog.xpnsec.com/exploring-mimikatz-part-2/","https://github.com/jas502n/mimikat_ssp"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"library where process.executable : \"?:\\\\Windows\\\\System32\\\\lsass.exe\" and\n  not (dll.code_signature.subject_name :\n               (\"Microsoft Windows\",\n                \"Microsoft Corporation\",\n                \"Microsoft Windows Publisher\",\n                \"Microsoft Windows Software Compatibility Publisher\",\n                \"Microsoft Windows Hardware Compatibility Publisher\",\n                \"McAfee, Inc.\",\n                \"SecMaker AB\",\n                \"HID Global Corporation\",\n                \"HID Global\",\n                \"Apple Inc.\",\n                \"Citrix Systems, Inc.\",\n                \"Dell Inc\",\n                \"Hewlett-Packard Company\",\n                \"Symantec Corporation\",\n                \"National Instruments Corporation\",\n                \"DigitalPersona, Inc.\",\n                \"Novell, Inc.\",\n                \"gemalto\",\n                \"EasyAntiCheat Oy\",\n                \"Entrust Datacard Corporation\",\n                \"AuriStor, Inc.\",\n                \"LogMeIn, Inc.\",\n                \"VMware, Inc.\",\n                \"Istituto Poligrafico e Zecca dello Stato S.p.A.\",\n                \"Nubeva Technologies Ltd\",\n                \"Micro Focus (US), Inc.\",\n                \"Yubico AB\",\n                \"GEMALTO SA\",\n                \"Secure Endpoints, Inc.\",\n                \"Sophos Ltd\",\n                \"Morphisec Information Security 2014 Ltd\",\n                \"Entrust, Inc.\",\n                \"Nubeva Technologies Ltd\",\n                \"Micro Focus (US), Inc.\",\n                \"F5 Networks Inc\",\n                \"Bit4id\",\n                \"Thales DIS CPL USA, Inc.\",\n                \"Micro Focus International plc\",\n                \"HYPR Corp\",\n                \"Intel(R) Software Development Products\",\n                \"PGP Corporation\",\n                \"Parallels International GmbH\",\n                \"FrontRange Solutions Deutschland GmbH\",\n                \"SecureLink, Inc.\",\n                \"Tidexa OU\",\n                \"Amazon Web Services, Inc.\",\n                \"SentryBay Limited\",\n                \"Audinate Pty Ltd\",\n                \"CyberArk Software Ltd.\",\n                \"McAfeeSysPrep\",\n                \"NVIDIA Corporation PE Sign v2016\") and\n       dll.code_signature.status : (\"trusted\", \"errorExpired\", \"errorCode_endpoint*\", \"errorChaining\")) and\n\n     not dll.hash.sha256 :\n                (\"811a03a5d7c03802676d2613d741be690b3461022ea925eb6b2651a5be740a4c\",\n                 \"1181542d9cfd63fb00c76242567446513e6773ea37db6211545629ba2ecf26a1\",\n                 \"ed6e735aa6233ed262f50f67585949712f1622751035db256811b4088c214ce3\",\n                 \"26be2e4383728eebe191c0ab19706188f0e9592add2e0bf86b37442083ae5e12\",\n                 \"9367e78b84ef30cf38ab27776605f2645e52e3f6e93369c674972b668a444faa\",\n                 \"d46cc934765c5ecd53867070f540e8d6f7701e834831c51c2b0552aba871921b\",\n                 \"0f77a3826d7a5cd0533990be0269d951a88a5c277bc47cff94553330b715ec61\",\n                 \"4aca034d3d85a9e9127b5d7a10882c2ef4c3e0daa3329ae2ac1d0797398695fb\",\n                 \"86031e69914d9d33c34c2f4ac4ae523cef855254d411f88ac26684265c981d95\")\n","throttle":"no_actions","actions":[]}
{"id":"50df3250-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.051Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.206Z","created_by":"chaykovskiyv","name":"Executable File Creation with Multiple Extensions [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Masquerading can allow an adversary to evade defenses and better blend in with the environment. One way it occurs is when the name or location of a file is manipulated as a means of tricking a user into executing what they think is a benign file type but is actually executable code.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"3eab2d56-cab0-45c7-ac53-51c10921662b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1036/","name":"Masquerading","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1036/007/","name":"Double File Extension","id":"T1036.007"}],"id":"T1036"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1204/","name":"User Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1204/002/","name":"Malicious File","id":"T1204.002"}],"id":"T1204"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"file where event.type == \"creation\" and file.extension : \"exe\" and\n  file.name regex~ \"\"\".*\\.(vbs|vbe|bat|js|cmd|wsh|ps1|pdf|docx?|xlsx?|pptx?|txt|rtf|gif|jpg|png|bmp|hta|txt|img|iso)\\.exe\"\"\" and\n  not (process.executable : (\"?:\\\\Windows\\\\System32\\\\msiexec.exe\", \"C:\\\\Users\\\\*\\\\QGIS_SCCM\\\\Files\\\\QGIS-OSGeo4W-*-Setup-x86_64.exe\") and\n       file.path : \"?:\\\\Program Files\\\\QGIS *\\\\apps\\\\grass\\\\*.exe\") and\n  not process.executable : (\"/bin/sh\", \"/usr/sbin/MailScanner\", \"/usr/bin/perl\")\n","throttle":"no_actions","actions":[]}
{"id":"0e4db0c0-d2cb-11ed-b6f4-dfeac9073248","updated_at":"2023-06-08T21:29:33.491Z","updated_by":"burzhynskyyy","created_at":"2023-04-04T09:28:28.023Z","created_by":"burzhynskyyy","name":"Files deleted from recycle bin on SharePoint","tags":["Custom Rules"],"interval":"5m","enabled":true,"description":"Files deleted from recycle bin on SharePoint","risk_score":47,"severity":"medium","license":"","output_index":"","meta":{"from":"25m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-1800s","rule_id":"def2d8cd-0f62-415b-9900-bc1047498723","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"event.module:\"o365\" and event.provider:\"SharePoint\" and event.action:\"FileDeletedFirstStageRecycleBin\"","filters":[],"throttle":"no_actions","actions":[]}
{"id":"4d545de0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.266Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.275Z","created_by":"chaykovskiyv","name":"Clearing Windows Event Logs [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies attempts to clear or disable Windows event log stores using Windows wevetutil command. This is often done by attackers in an attempt to evade detection or destroy forensic evidence on a system.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Clearing Windows Event Logs\n\nWindows event logs are a fundamental data source for security monitoring, forensics, and incident response. Adversaries can tamper, clear, and delete this data to break SIEM detections, cover their tracks, and slow down incident response.\n\nThis rule looks for the execution of the `wevtutil.exe` utility or the `Clear-EventLog` cmdlet to clear event logs.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Verify if any other anti-forensics behaviors were observed.\n- Investigate the event logs prior to the action for suspicious behaviors that an attacker may be trying to cover up.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and there are justifications for this action.\n- Analyze whether the cleared event log is pertinent to security and general monitoring. Administrators can clear non-relevant event logs using this mechanism. If this activity is expected and noisy in your environment, consider adding exceptions — preferably with a combination of user and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - This activity is potentially done after the adversary achieves its objectives on the host. Ensure that previous actions, if any, are investigated accordingly with their response playbooks.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"4b7e664c-d16d-4b86-a453-71335542ed70","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1070/","name":"Indicator Removal","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1070/001/","name":"Clear Windows Event Logs","id":"T1070.001"}],"id":"T1070"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n(\n  (\n    (process.name : \"wevtutil.exe\" or process.pe.original_file_name == \"wevtutil.exe\") and\n    process.args : (\"/e:false\", \"cl\", \"clear-log\")\n  ) or\n  (\n    process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n    process.args : \"Clear-EventLog\"\n  )\n)\n","throttle":"no_actions","actions":[]}
{"id":"4b70f7e0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.639Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.130Z","created_by":"chaykovskiyv","name":"Volume Shadow Copy Deleted or Resized via VssAdmin [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Impact","Credential Access","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies use of vssadmin.exe for shadow copy deletion or resizing on endpoints. This commonly occurs in tandem with ransomware or other destructive attacks.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Volume Shadow Copy Deleted or Resized via VssAdmin\n\nThe Volume Shadow Copy Service (VSS) is a Windows feature that enables system administrators to take snapshots of volumes that can later be restored or mounted to recover specific files or folders.\n\nA typical step in the playbook of an attacker attempting to deploy ransomware is to delete Volume Shadow Copies to ensure that victims have no alternative to paying the ransom, making any action that deletes shadow copies worth monitoring.\n\nThis rule monitors the execution of Vssadmin.exe to either delete or resize shadow copies.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- In the case of a resize operation, check if the resize value is equal to suspicious values, like 401MB.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- If unsigned files are found on the process tree, retrieve them and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Use process name, command line, and file hash to search for occurrences in other hosts.\n- Check if any files on the host machine have been encrypted.\n\n\n### False positive analysis\n\n- This rule may produce benign true positives (B-TPs). If this activity is expected and noisy in your environment, consider adding exceptions — preferably with a combination of user and command line conditions.\n\n### Related rules\n\n- Volume Shadow Copy Deleted or Resized via VssAdmin - b5ea4bfe-a1b2-421f-9d47-22a75a6f2921\n- Volume Shadow Copy Deletion via PowerShell - d99a037b-c8e2-47a5-97b9-170d076827c4\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- Priority should be given due to the advanced stage of this activity on the attack.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- If data was encrypted, deleted, or modified, activate your data recovery plan.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Perform data recovery locally or restore the backups from replicated copies (cloud, other servers, etc.).\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"7329cd32-aa20-4177-801c-010040f894bd","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1490/","name":"Inhibit System Recovery","id":"T1490"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0040/","name":"Impact","id":"TA0040"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/003/","name":"NTDS","id":"T1003.003"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":[],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\"\n  and (process.name : \"vssadmin.exe\" or process.pe.original_file_name == \"VSSADMIN.EXE\") and\n  process.args in (\"delete\", \"resize\") and process.args : \"shadows*\"\n","throttle":"no_actions","actions":[]}
{"id":"48304bd0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.153Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.579Z","created_by":"chaykovskiyv","name":"Port Forwarding Rule Addition [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Command and Control","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the creation of a new port forwarding rule. An adversary may abuse this technique to bypass network segmentation restrictions.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Port Forwarding Rule Addition\n\nNetwork port forwarding is a mechanism to redirect incoming TCP connections (IPv4 or IPv6) from the local TCP port to any other port number, or even to a port on a remote computer.\n\nAttackers may configure port forwarding rules to bypass network segmentation restrictions, using the host as a jump box to access previously unreachable systems.\n\nThis rule monitors the modifications to the `HKLM\\SYSTEM\\*ControlSet*\\Services\\PortProxy\\v4tov4\\` subkeys.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Identify the target host IP address, check the connections originating from the host where the modification occurred, and inspect the credentials used.\n  - Investigate suspicious login activity, such as unauthorized access and logins from outside working hours and unusual locations.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the Administrator is aware of the activity and there are justifications for this configuration.\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Delete the port forwarding rule.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"90216f08-43f8-41cc-8874-2420b65d79ef","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1572/","name":"Protocol Tunneling","id":"T1572"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0011/","name":"Command and Control","id":"TA0011"}}],"to":"now","references":["https://www.fireeye.com/blog/threat-research/2019/01/bypassing-network-restrictions-through-rdp-tunneling.html"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"registry where registry.path : (\n  \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\PortProxy\\\\v4tov4\\\\*\",\n  \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\PortProxy\\\\v4tov4\\\\*\"\n)\n","throttle":"no_actions","actions":[]}
{"id":"52b1a860-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:33.318Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.266Z","created_by":"chaykovskiyv","name":"Code Signing Policy Modification Through Built-in tools [Duplicate]","tags":["Elastic","Host","Windows","macOS","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies attempts to disable/modify the code signing policy through system native utilities. Code signing provides authenticity on a program, and grants the user with the ability to check whether the program has been tampered with. By allowing the execution of unsigned or self-signed code, threat actors can craft and execute malicious code.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"f9ac85ca-72b3-43cf-a9b1-b7f5d8240b72","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1553/","name":"Subvert Trust Controls","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1553/006/","name":"Code Signing Policy Modification","id":"T1553.006"}],"id":"T1553"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and \n(\n  /* Windows */\n  ((process.name: \"bcdedit.exe\" or process.pe.original_file_name == \"bcdedit.exe\") and   process.args: (\"-set\", \"/set\") and \n  process.args: (\"TESTSIGNING\", \"nointegritychecks\", \"loadoptions\", \"DISABLE_INTEGRITY_CHECKS\")) or\n  \n  /* MacOS */\n  (process.executable: \"/usr/bin/csrutil\" and process.args: \"disable\")\n)\n","throttle":"no_actions","actions":[]}
{"id":"52b307f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:33.329Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.282Z","created_by":"chaykovskiyv","name":"Host Files System Changes via Windows Subsystem for Linux [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Detects files creation and modification on the host system from the the Windows Subsystem for Linux. Adversaries may enable and use WSL for Linux to avoid detection.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"66eba1db-e082-4095-b3c3-a80c674ccaa3","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1202/","name":"Indirect Command Execution","id":"T1202"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://github.com/microsoft/WSL"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"sequence by process.entity_id with maxspan=5m\n [process where event.type == \"start\" and \n  process.name : \"dllhost.exe\" and \n   /* Plan9FileSystem CLSID - WSL Host File System Worker */\n  process.command_line : \"*{DFB65C4C-B34F-435D-AFE9-A86218684AA8}*\"]\n [file where process.name : \"dllhost.exe\" and not file.path : \"?:\\\\Users\\\\*\\\\Downloads\\\\*\"]\n","throttle":"no_actions","actions":[]}
{"id":"4841b0f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.205Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.776Z","created_by":"chaykovskiyv","name":"Windows Network Enumeration [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies attempts to enumerate hosts in a network using the built-in Windows net.exe tool.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Windows Network Enumeration\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `net` utility to enumerate servers in the environment that hosts shared drives or printers. This information is useful to attackers as they can identify targets for lateral movements and search for valuable shared data.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"20328c47-1ded-4905-b737-9b8a26b020b2","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1018/","name":"Remote System Discovery","id":"T1018"},{"reference":"https://attack.mitre.org/techniques/T1135/","name":"Network Share Discovery","id":"T1135"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  ((process.name : \"net.exe\" or process.pe.original_file_name == \"net.exe\") or\n   ((process.name : \"net1.exe\" or process.pe.original_file_name == \"net1.exe\") and\n       not process.parent.name : \"net.exe\")) and\n  (process.args : \"view\" or (process.args : \"time\" and process.args : \"\\\\\\\\*\"))\n\n\n  /* expand when ancestry is available\n  and not descendant of [process where event.type == \"start\" and process.name : \"cmd.exe\" and\n                           ((process.parent.name : \"userinit.exe\") or\n                            (process.parent.name : \"gpscript.exe\") or\n                            (process.parent.name : \"explorer.exe\" and\n                               process.args : \"C:\\\\*\\\\Start Menu\\\\Programs\\\\Startup\\\\*.bat*\"))]\n  */\n","throttle":"no_actions","actions":[]}
{"id":"944e3a40-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.774Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.317Z","created_by":"chaykovskiyv","name":"Sensitive Privilege SeEnableDelegationPrivilege assigned to a User [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Active Directory","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies the assignment of the SeEnableDelegationPrivilege sensitive \"user right\" to a user. The SeEnableDelegationPrivilege \"user right\" enables computer and user accounts to be trusted for delegation. Attackers can abuse this right to compromise Active Directory accounts and elevate their privileges.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Sensitive Privilege SeEnableDelegationPrivilege assigned to a User\n\nKerberos delegation is an Active Directory feature that allows user and computer accounts to impersonate other accounts, act on their behalf, and use their privileges. Delegation (constrained and unconstrained) can be configured for user and computer objects.\n\nEnabling unconstrained delegation for a computer causes the computer to store the ticket-granting ticket (TGT) in memory at any time an account connects to the computer, so it can be used by the computer for impersonation when needed. Risk is heightened if an attacker compromises computers with unconstrained delegation enabled, as they could extract TGTs from memory and then replay them to move laterally on the domain. If the attacker coerces a privileged user to connect to the server, or if the user does so routinely, the account will be compromised and the attacker will be able to pass-the-ticket to privileged assets.\n\nSeEnableDelegationPrivilege is a user right that is controlled within the Local Security Policy of a domain controller and is managed through Group Policy. This setting is named **Enable computer and user accounts to be trusted for delegation**.\n\nIt is critical to control the assignment of this privilege. A user with this privilege and write access to a computer can control delegation settings, perform the attacks described above, and harvest TGTs from any user that connects to the system.\n\n#### Possible investigation steps\n\n- Investigate how the privilege was assigned to the user and who assigned it.\n- Investigate other potentially malicious activity that was performed by the user that assigned the privileges using the `user.id` and `winlog.activity_id` fields as a filter during the past 48 hours.\n- Investigate other alerts associated with the users/host during the past 48 hours.\n\n### False positive analysis\n\n- The SeEnableDelegationPrivilege privilege should not be assigned to users. If this rule is triggered in your environment legitimately, the security team should notify the administrators about the risks of using it.\n\n### Related rules\n\n- KRBTGT Delegation Backdoor - e052c845-48d0-4f46-8a13-7d0aba05df82\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Remove the privilege from the account.\n- Review the privileges of the administrator account that performed the action.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"7baa64ec-28cc-4a07-b937-f4ae19c681fd","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}},{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://blog.harmj0y.net/activedirectory/the-most-dangerous-user-right-you-probably-have-never-heard-of/","https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_alert_active_directory_user_control.yml","https://twitter.com/_nwodtuhs/status/1454049485080907776","https://www.thehacker.recipes/ad/movement/kerberos/delegations","https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0105_windows_audit_authorization_policy_change.md"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.action: \"Authorization Policy Change\" and event.code:4704 and winlog.event_data.PrivilegeList:\"SeEnableDelegationPrivilege\"\n","throttle":"no_actions","actions":[]}
{"id":"50e01cb0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.062Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.218Z","created_by":"chaykovskiyv","name":"Unusual File Creation - Alternate Data Stream [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies suspicious creation of Alternate Data Streams on highly targeted files. This is uncommon for legitimate files and sometimes done by adversaries to hide malware.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Unusual File Creation - Alternate Data Stream\n\nAlternate Data Streams (ADS) are file attributes only found on the NTFS file system. In this file system, files are built up from a couple of attributes; one of them is $Data, also known as the data attribute.\n\nThe regular data stream, also referred to as the unnamed data stream since the name string of this attribute is empty, contains the data inside the file. So any data stream that has a name is considered an alternate data stream.\n\nAttackers can abuse these alternate data streams to hide malicious files, string payloads, etc. This rule detects the creation of alternate data streams on highly targeted file types.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Retrieve the contents of the alternate data stream, and analyze it for potential maliciousness. Analysts can use the following PowerShell cmdlet to accomplish this:\n  - `Get-Content C:\\Path\\To\\file.exe -stream SampleAlternateDataStreamName`\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions — preferably with a combination of process executable and file conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"782100f9-d1bf-4128-8c22-5c0d361e5619","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1564/","name":"Hide Artifacts","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1564/004/","name":"NTFS File Attributes","id":"T1564.004"}],"id":"T1564"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"file where event.type == \"creation\" and\n\n  file.path : \"C:\\\\*:*\" and\n  not file.path : \"C:\\\\*:zone.identifier*\" and\n\n  not process.executable :\n          (\"?:\\\\windows\\\\System32\\\\svchost.exe\",\n           \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\",\n           \"?:\\\\Windows\\\\explorer.exe\",\n           \"?:\\\\Windows\\\\System32\\\\sihost.exe\",\n           \"?:\\\\Windows\\\\System32\\\\PickerHost.exe\",\n           \"?:\\\\Windows\\\\System32\\\\SearchProtocolHost.exe\",\n           \"?:\\\\Program Files (x86)\\\\Dropbox\\\\Client\\\\Dropbox.exe\",\n           \"?:\\\\Program Files\\\\Rivet Networks\\\\SmartByte\\\\SmartByteNetworkService.exe\",\n           \"?:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\",\n           \"?:\\\\Program Files\\\\ExpressConnect\\\\ExpressConnectNetworkService.exe\",\n           \"?:\\\\Program Files (x86)\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n           \"?:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n           \"?:\\\\Program Files\\\\Mozilla Firefox\\\\firefox.exe\") and\n\n  file.extension :\n    (\n      \"pdf\",\n      \"dll\",\n      \"png\",\n      \"exe\",\n      \"dat\",\n      \"com\",\n      \"bat\",\n      \"cmd\",\n      \"sys\",\n      \"vbs\",\n      \"ps1\",\n      \"hta\",\n      \"txt\",\n      \"vbe\",\n      \"js\",\n      \"wsh\",\n      \"docx\",\n      \"doc\",\n      \"xlsx\",\n      \"xls\",\n      \"pptx\",\n      \"ppt\",\n      \"rtf\",\n      \"gif\",\n      \"jpg\",\n      \"png\",\n      \"bmp\",\n      \"img\",\n      \"iso\"\n    )\n","throttle":"no_actions","actions":[]}
{"id":"4d4f54d0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.172Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.226Z","created_by":"chaykovskiyv","name":"Suspicious MS Outlook Child Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Initial Access","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies suspicious child processes of Microsoft Outlook. These child processes are often associated with spear phishing activity.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Suspicious MS Outlook Child Process\n\nMicrosoft Outlook is an email client that provides contact, email calendar, and task management features. Outlook is widely used, either standalone or as part of the Office suite.\n\nThis rule looks for suspicious processes spawned by MS Outlook, which can be the result of the execution of malicious documents and/or exploitation for initial access.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve recently opened files received via email and opened by the user that could cause this behavior. Common locations include but are not limited to, the Downloads and Document folders and the folder configured at the email client.\n- Determine if the collected files are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"3e4aec8d-eebe-4d65-9ced-35d8990824f1","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1566/","name":"Phishing","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1566/001/","name":"Spearphishing Attachment","id":"T1566.001"}],"id":"T1566"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  process.parent.name : \"outlook.exe\" and\n  process.name : (\"Microsoft.Workflow.Compiler.exe\", \"arp.exe\", \"atbroker.exe\", \"bginfo.exe\", \"bitsadmin.exe\",\n                  \"cdb.exe\", \"certutil.exe\", \"cmd.exe\", \"cmstp.exe\", \"cscript.exe\", \"csi.exe\", \"dnx.exe\", \"dsget.exe\",\n                  \"dsquery.exe\", \"forfiles.exe\", \"fsi.exe\", \"ftp.exe\", \"gpresult.exe\", \"hostname.exe\", \"ieexec.exe\",\n                  \"iexpress.exe\", \"installutil.exe\", \"ipconfig.exe\", \"mshta.exe\", \"msxsl.exe\", \"nbtstat.exe\", \"net.exe\",\n                  \"net1.exe\", \"netsh.exe\", \"netstat.exe\", \"nltest.exe\", \"odbcconf.exe\", \"ping.exe\", \"powershell.exe\",\n                  \"pwsh.exe\", \"qprocess.exe\", \"quser.exe\", \"qwinsta.exe\", \"rcsi.exe\", \"reg.exe\", \"regasm.exe\",\n                  \"regsvcs.exe\", \"regsvr32.exe\", \"sc.exe\", \"schtasks.exe\", \"systeminfo.exe\", \"tasklist.exe\",\n                  \"tracert.exe\", \"whoami.exe\", \"wmic.exe\", \"wscript.exe\", \"xwizard.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"fb799400-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.320Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.790Z","created_by":"burzhynskyyy","name":"Microsoft 365 Unusual Volume of File Deletion [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Configuration Audit"],"interval":"5m","enabled":true,"description":"Identifies that a user has deleted an unusually large volume of files as reported by Microsoft Cloud App Security.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Austin Songer"],"false_positives":["Users or System Administrator cleaning out folders."],"from":"now-30m","rule_id":"431a0b3d-6a6b-4b85-9613-0b53cb79562a","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1485/","name":"Data Destruction","id":"T1485"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0040/","name":"Impact","id":"TA0040"}}],"to":"now","references":["https://docs.microsoft.com/en-us/cloud-app-security/anomaly-detection-policy","https://docs.microsoft.com/en-us/cloud-app-security/policy-template-reference"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.category:web and event.action:\"Unusual volume of file deletion\" and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"52b26bb0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:33.316Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.275Z","created_by":"chaykovskiyv","name":"Execution via Windows Subsystem for Linux [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Detects attempts to execute a program on the host from the Windows Subsystem for Linux. Adversaries may enable and use WSL for Linux to avoid detection.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"a56cc684-e646-492d-ba21-14e4857cbacc","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1202/","name":"Indirect Command Execution","id":"T1202"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://learn.microsoft.com/en-us/windows/wsl/wsl-config"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type : \"start\" and \n process.parent.executable : \n    (\"?:\\\\Windows\\\\System32\\\\wsl.exe\", \n     \"?:\\\\Program Files*\\\\WindowsApps\\\\MicrosoftCorporationII.WindowsSubsystemForLinux_*\\\\wsl.exe\", \n     \"?:\\\\Windows\\\\System32\\\\wslhost.exe\", \n     \"?:\\\\Program Files*\\\\WindowsApps\\\\MicrosoftCorporationII.WindowsSubsystemForLinux_*\\\\wslhost.exe\") and \n  not process.executable : \n           (\"?:\\\\Windows\\\\System32\\\\conhost.exe\", \n            \"?:\\\\Windows\\\\System32\\\\lxss\\\\wslhost.exe\", \n            \"?:\\\\Windows\\\\Sys*\\\\wslconfig.exe\", \n            \"?:\\\\Program Files*\\\\WindowsApps\\\\MicrosoftCorporationII.WindowsSubsystemForLinux_*\\\\wsl*.exe\", \n            \"?:\\\\Windows\\\\System32\\\\WerFault.exe\", \n            \"?:\\\\Program Files\\\\*\", \n            \"?:\\\\Program Files (x86)\\\\*\")\n","throttle":"no_actions","actions":[]}
{"id":"4d539a90-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.210Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.270Z","created_by":"chaykovskiyv","name":"Suspicious PDF Reader Child Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies suspicious child processes of PDF reader applications. These child processes are often launched via exploitation of PDF applications or social engineering.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Suspicious PDF Reader Child Process\n\nPDF is a common file type used in corporate environments and most machines have software to handle these files. This creates a vector where attackers can exploit the engines and technology behind this class of software for initial access or privilege escalation.\n\nThis rule looks for commonly abused built-in utilities spawned by a PDF reader process, which is likely a malicious behavior.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve PDF documents received and opened by the user that could cause this behavior. Common locations include, but are not limited to, the Downloads and Document folders and the folder configured at the email client.\n- Determine if the collected files are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell `Get-FileHash` cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"2dbd47d4-eaaf-4433-adaf-7ebd17471dea","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1204/","name":"User Execution","id":"T1204"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.parent.name : (\"AcroRd32.exe\",\n                         \"Acrobat.exe\",\n                         \"FoxitPhantomPDF.exe\",\n                         \"FoxitReader.exe\") and\n  process.name : (\"arp.exe\", \"dsquery.exe\", \"dsget.exe\", \"gpresult.exe\", \"hostname.exe\", \"ipconfig.exe\", \"nbtstat.exe\",\n                  \"net.exe\", \"net1.exe\", \"netsh.exe\", \"netstat.exe\", \"nltest.exe\", \"ping.exe\", \"qprocess.exe\",\n                  \"quser.exe\", \"qwinsta.exe\", \"reg.exe\", \"sc.exe\", \"systeminfo.exe\", \"tasklist.exe\", \"tracert.exe\",\n                  \"whoami.exe\", \"bginfo.exe\", \"cdb.exe\", \"cmstp.exe\", \"csi.exe\", \"dnx.exe\", \"fsi.exe\", \"ieexec.exe\",\n                  \"iexpress.exe\", \"installutil.exe\", \"Microsoft.Workflow.Compiler.exe\", \"msbuild.exe\", \"mshta.exe\",\n                  \"msxsl.exe\", \"odbcconf.exe\", \"rcsi.exe\", \"regsvr32.exe\", \"xwizard.exe\", \"atbroker.exe\",\n                  \"forfiles.exe\", \"schtasks.exe\", \"regasm.exe\", \"regsvcs.exe\", \"cmd.exe\", \"cscript.exe\",\n                  \"powershell.exe\", \"pwsh.exe\", \"wmic.exe\", \"wscript.exe\", \"bitsadmin.exe\", \"certutil.exe\", \"ftp.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"fb6dd430-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.277Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.722Z","created_by":"burzhynskyyy","name":"Microsoft 365 Teams Custom Application Interaction Allowed [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Configuration Audit","Persistence"],"interval":"5m","enabled":true,"description":"Identifies when custom applications are allowed in Microsoft Teams. If an organization requires applications other than those available in the Teams app store, custom applications can be developed as packages and uploaded. An adversary may abuse this behavior to establish persistence in an environment.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Custom applications may be allowed by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."],"from":"now-30m","rule_id":"2dfee987-6d59-4b5a-8652-f5749a103e4d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://docs.microsoft.com/en-us/microsoftteams/platform/concepts/deploy-and-publish/apps-upload"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:MicrosoftTeams and\nevent.category:web and event.action:TeamsTenantSettingChanged and\no365.audit.Name:\"Allow sideloading and interaction of custom apps\" and\no365.audit.NewValue:True and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"50e302e0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.246Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.254Z","created_by":"chaykovskiyv","name":"User Added to Privileged Group [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Investigation Guide","Active Directory"],"interval":"5m","enabled":true,"description":"Identifies a user being added to a privileged group in Active Directory. Privileged accounts and groups in Active Directory are those to which powerful rights, privileges, and permissions are granted that allow them to perform nearly any action in Active Directory and on domain-joined systems.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating User Added to Privileged Group in Active Directory\n\nPrivileged accounts and groups in Active Directory are those to which powerful rights, privileges, and permissions are granted that allow them to perform nearly any action in Active Directory and on domain-joined systems.\n\nAttackers can add users to privileged groups to maintain a level of access if their other privileged accounts are uncovered by the security team. This allows them to keep operating after the security team discovers abused accounts.\n\nThis rule monitors events related to a user being added to a privileged group.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should manage members of this group.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- This attack abuses a legitimate Active Directory mechanism, so it is important to determine whether the activity is legitimate, if the administrator is authorized to perform this operation, and if there is a need to grant the account this level of privilege.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the admin is not aware of the operation, activate your Active Directory incident response plan.\n- If the user does not need the administrator privileges, remove the account from the privileged group.\n- Review the privileges of the administrator account that performed the action.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic","Skoetting"],"false_positives":[],"from":"now-9m","rule_id":"2f304c8f-a10e-44b7-aeb6-8d6e17b659bb","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1098/","name":"Account Manipulation","id":"T1098"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-b--privileged-accounts-and-groups-in-active-directory"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"iam where event.action == \"added-member-to-group\" and\n  group.name : (\"Admin*\",\n                \"Local Administrators\",\n                \"Domain Admins\",\n                \"Enterprise Admins\",\n                \"Backup Admins\",\n                \"Schema Admins\",\n                \"DnsAdmins\",\n                \"Exchange Organization Administrators\")\n","throttle":"no_actions","actions":[]}
{"id":"52b048d0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.300Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.244Z","created_by":"chaykovskiyv","name":"Exchange Mailbox Export via PowerShell [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Collection","Investigation Guide","PowerShell"],"interval":"5m","enabled":true,"description":"Identifies the use of the Exchange PowerShell cmdlet, New-MailBoxExportRequest, to export the contents of a primary mailbox or archive to a .pst file. Adversaries may target user email to collect sensitive information.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Exchange Mailbox Export via PowerShell\n\nThe `New-MailBoxExportRequest` cmdlet is used to begin the process of exporting contents of a primary mailbox or archive to a .pst file. Note that this is done on a per-mailbox basis and this cmdlet is available only in on-premises Exchange.\nAttackers can abuse this functionality in preparation for exfiltrating contents, which is likely to contain sensitive and strategic data.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the export operation:\n  - Identify the user account that performed the action and whether it should perform this kind of action.\n  - Contact the account owner and confirm whether they are aware of this activity.\n  - Check if this operation was approved and performed according to the organization's change management policy.\n  - Retrieve the operation status and use the `Get-MailboxExportRequest` cmdlet to review previous requests.\n  - By default, no group in Exchange has the privilege to import or export mailboxes. Investigate administrators that assigned the \"Mailbox Import Export\" privilege for abnormal activity.\n- Investigate if there is a significant quantity of export requests in the alert timeframe. This operation is done on a per-mailbox basis and can be part of a mass export.\n- If the operation was completed successfully:\n  - Check if the file is on the path specified in the command.\n  - Investigate if the file was compressed, archived, or retrieved by the attacker for exfiltration.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and it is done with proper approval.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the involved host is not the Exchange server, isolate the host to prevent further post-compromise behavior.\n- Use the `Remove-MailboxExportRequest` cmdlet to remove fully or partially completed export requests.\n- Prioritize cases that involve personally identifiable information (PII) or other classified data.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges of users with the \"Mailbox Import Export\" privilege to ensure that the least privilege principle is being followed.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Legitimate exchange system administration activity."],"from":"now-9m","rule_id":"798a54ac-c58f-4b12-bca9-5c741418b264","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1114/","name":"Email Collection","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1114/001/","name":"Local Email Collection","id":"T1114.001"},{"reference":"https://attack.mitre.org/techniques/T1114/002/","name":"Remote Email Collection","id":"T1114.002"}],"id":"T1114"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0009/","name":"Collection","id":"TA0009"}}],"to":"now","references":["https://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breach-organizations/","https://docs.microsoft.com/en-us/powershell/module/exchange/new-mailboxexportrequest?view=exchange-ps","https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and powershell.file.script_block_text : \"New-MailboxExportRequest\"\n","throttle":"no_actions","actions":[]}
{"id":"fb307d10-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.260Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.359Z","created_by":"burzhynskyyy","name":"Microsoft 365 Exchange DKIM Signing Configuration Disabled [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Data Protection","Persistence"],"interval":"5m","enabled":true,"description":"Identifies when a DomainKeys Identified Mail (DKIM) signing configuration is disabled in Microsoft 365. With DKIM in Microsoft 365, messages that are sent from Exchange Online will be cryptographically signed. This will allow the receiving email system to validate that the messages were generated by a server that the organization authorized and were not spoofed.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Disabling a DKIM configuration may be done by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."],"from":"now-30m","rule_id":"0fafed37-fb1e-4d0c-9edc-2f2c910a59b1","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1556/","name":"Modify Authentication Process","id":"T1556"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://docs.microsoft.com/en-us/powershell/module/exchange/set-dkimsigningconfig?view=exchange-ps"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"Set-DkimSigningConfig\" and o365.audit.Parameters.Enabled:False and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"50e85a10-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.271Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.291Z","created_by":"chaykovskiyv","name":"Persistence via PowerShell profile [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Identifies the creation or modification of a PowerShell profile. PowerShell profile is a script that is executed when PowerShell starts to customize the user environment, which can be abused by attackers to persist in a environment where PowerShell is common.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"62ea0bc2-5df7-40c6-ba66-6d376fd28fa6","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1546/","name":"Event Triggered Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1546/013/","name":"PowerShell Profile","id":"T1546.013"}],"id":"T1546"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_profiles","https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/"],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"file where event.type != \"deletion\" and\n  file.path : (\"?:\\\\Users\\\\*\\\\Documents\\\\WindowsPowerShell\\\\*\",\n               \"?:\\\\Users\\\\*\\\\Documents\\\\PowerShell\\\\*\",\n               \"?:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\*\") and\n  file.name : (\"profile.ps1\", \"Microsoft.Powershell_profile.ps1\")\n","throttle":"no_actions","actions":[]}
{"id":"94520ad0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.798Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.326Z","created_by":"chaykovskiyv","name":"Access to a Sensitive LDAP Attribute [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Active Directory"],"interval":"5m","enabled":true,"description":"Identify access to sensitive Active Directory object attributes that contains credentials and decryption keys such as unixUserPassword, ms-PKI-AccountCredentials and msPKI-CredentialRoamingTokens.","risk_score":47,"severity":"medium","note":"The 'Audit Directory Service Changes' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success,Failure)\n```","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"6c8da5a8-4a42-4982-8dda-5e3bfa6f7628","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://www.mandiant.com/resources/blog/apt29-windows-credential-roaming","https://social.technet.microsoft.com/wiki/contents/articles/11483.windows-credential-roaming.aspx","https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-5136"],"version":3,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"any where event.action == \"Directory Service Access\" and event.code == \"4662\" and\n\n  not winlog.event_data.SubjectUserSid : \"S-1-5-18\" and\n\n  winlog.event_data.Properties : (\n   /* unixUserPassword */\n  \"*612cb747-c0e8-4f92-9221-fdd5f15b550d*\",\n\n  /* ms-PKI-AccountCredentials */\n  \"*b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7*\",\n\n  /*  ms-PKI-DPAPIMasterKeys */\n  \"*b3f93023-9239-4f7c-b99c-6745d87adbc2*\",\n\n  /* msPKI-CredentialRoamingTokens */\n  \"*b7ff5a38-0818-42b0-8110-d3d154c97f24*\"\n  ) and\n\n  /*\n   Excluding noisy AccessMasks\n   0x0 undefined and 0x100 Control Access\n   https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4662\n   */\n  not winlog.event_data.AccessMask in (\"0x0\", \"0x100\")\n","throttle":"no_actions","actions":[]}
{"id":"4f2cee70-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.162Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.394Z","created_by":"chaykovskiyv","name":"Suspicious Process Access via Direct System Call [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Sysmon Only"],"interval":"5m","enabled":true,"description":"Identifies suspicious process access events from an unknown memory region. Endpoint security solutions usually hook userland Windows APIs in order to decide if the code that is being executed is malicious or not. It's possible to bypass hooked functions by writing malicious functions that call syscalls directly.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Suspicious Process Access via Direct System Call\n\nEndpoint security solutions usually hook userland Windows APIs in order to decide if the code that is being executed is malicious or not. It's possible to bypass hooked functions by writing malicious functions that call syscalls directly.\n\nMore context and technical details can be found in this [research blog](https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/).\n\nThis rule identifies suspicious process access events from an unknown memory region. Attackers can use direct system calls to bypass security solutions that rely on hooks.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This detection may be triggered by certain applications that install root certificates for the purpose of inspecting SSL traffic. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove the malicious certificate from the root certificate store.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"dcb1d536-a761-4d70-a99a-3c7755cdc7df","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1055/","name":"Process Injection","id":"T1055"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://twitter.com/SBousseaden/status/1278013896440324096","https://www.ired.team/offensive-security/defense-evasion/using-syscalls-directly-from-visual-studio-to-bypass-avs-edrs"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-windows.*"],"query":"process where event.code == \"10\" and\n length(winlog.event_data.CallTrace) > 0 and\n\n /* Sysmon CallTrace starting with unknown memory module instead of ntdll which host Windows NT Syscalls */\n not winlog.event_data.CallTrace :\n            (\"?:\\\\WINDOWS\\\\SYSTEM32\\\\ntdll.dll*\",\n             \"?:\\\\WINDOWS\\\\SysWOW64\\\\ntdll.dll*\",\n             \"?:\\\\Windows\\\\System32\\\\wow64cpu.dll*\",\n             \"?:\\\\WINDOWS\\\\System32\\\\wow64win.dll*\",\n             \"?:\\\\Windows\\\\System32\\\\win32u.dll*\") and\n\n not winlog.event_data.TargetImage :\n            (\"?:\\\\Program Files (x86)\\\\Malwarebytes Anti-Exploit\\\\mbae-svc.exe\",\n             \"?:\\\\Program Files\\\\Cisco\\\\AMP\\\\*\\\\sfc.exe\",\n             \"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeWebView\\\\Application\\\\*\\\\msedgewebview2.exe\",\n             \"?:\\\\Program Files\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\*\\\\AcroCEF.exe\") and\n\n not (process.executable : (\"?:\\\\Program Files\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\Acrobat.exe\",\n                            \"?:\\\\Program Files (x86)\\\\World of Warcraft\\\\_classic_\\\\WowClassic.exe\") and\n      not winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"4f1ee4b0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-29T11:40:43.953Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.309Z","created_by":"chaykovskiyv","name":"Scheduled Task Execution at Scale via GPO [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Active Directory","Investigation Guide"],"interval":"5m","enabled":true,"description":"Detects the modification of Group Policy Object attributes to execute a scheduled task in the objects controlled by the GPO.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Scheduled Task Execution at Scale via GPO\n\nGroup Policy Objects (GPOs) can be used by attackers to execute scheduled tasks at scale to compromise objects controlled by a given GPO. This is done by changing the contents of the `<GPOPath>\\Machine\\Preferences\\ScheduledTasks\\ScheduledTasks.xml` file.\n\n#### Possible investigation steps\n\n- This attack abuses a legitimate mechanism of Active Directory, so it is important to determine whether the activity is legitimate and the administrator is authorized to perform this operation.\n- Retrieve the contents of the `ScheduledTasks.xml` file, and check the `<Command>` and `<Arguments>` XML tags for any potentially malicious commands or binaries.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Scope which objects may be compromised by retrieving information about which objects are controlled by the GPO.\n\n### False positive analysis\n\n- Verify if the execution is allowed and done under change management, and if the execution is legitimate.\n\n### Related rules\n\n- Group Policy Abuse for Privilege Addition - b9554892-5e0e-424b-83a0-5aef95aa43bf\n- Startup/Logon Script added to Group Policy Object - 16fac1a1-21ee-4ca6-b720-458e3855d046\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- The investigation and containment must be performed in every computer controlled by the GPO, where necessary.\n- Remove the script from the GPO.\n- Check if other GPOs have suspicious scheduled tasks attached.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-6m","rule_id":"aa24659c-b061-4264-85fd-c977c0e5a373","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"},"technique":[{"reference":"https://attack.mitre.org/techniques/T1053/","name":"Scheduled Task/Job","id":"T1053","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1053/005/","name":"Scheduled Task","id":"T1053.005"}]},{"reference":"https://attack.mitre.org/techniques/T1484/","name":"Domain Policy Modification","id":"T1484","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1484/001/","name":"Group Policy Modification","id":"T1484.001"}]}]}],"to":"now","references":["https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0025_windows_audit_directory_service_changes.md","https://github.com/atc-project/atc-data/blob/f2bbb51ecf68e2c9f488e3c70dcdd3df51d2a46b/docs/Logging_Policies/LP_0029_windows_audit_detailed_file_share.md","https://labs.f-secure.com/tools/sharpgpoabuse","https://twitter.com/menasec1/status/1106899890377052160","https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_gpo_scheduledtasks.yml"],"version":104,"exceptions_list":[{"id":"a43ca6c0-fe15-11ed-8f07-79710758f25a","list_id":"7d488d95-bda1-4476-9d5c-fc8bf1c3a001","type":"rule_default","namespace_type":"single"}],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"(event.code: \"5136\" and winlog.event_data.AttributeLDAPDisplayName:(\"gPCMachineExtensionNames\" or \"gPCUserExtensionNames\") and\n   winlog.event_data.AttributeValue:(*CAB54552-DEEA-4691-817E-ED4A4D1AFC72* and *AADCED64-746C-4633-A97C-D61349046527*))\nor\n(event.code: \"5145\" and winlog.event_data.ShareName: \"\\\\\\\\*\\\\SYSVOL\" and winlog.event_data.RelativeTargetName: *ScheduledTasks.xml and\n  (message: WriteData or winlog.event_data.AccessList: *%%4417*))\n","throttle":"no_actions","actions":[]}
{"id":"4f2d1580-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T11:27:04.306Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.399Z","created_by":"chaykovskiyv","name":"PowerShell Suspicious Discovery Related Windows API Functions [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Investigation Guide","PowerShell"],"interval":"5m","enabled":true,"description":"This rule detects the use of discovery-related Windows API functions in PowerShell Scripts. Attackers can use these functions to perform various situational awareness related activities, like enumerating users, shares, sessions, domain trusts, groups, etc.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating PowerShell Suspicious Discovery Related Windows API Functions\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can use PowerShell to interact with the Win32 API to bypass command line based detections, using libraries like PSReflect or Get-ProcAddress Cmdlet.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Check for additional PowerShell and command-line logs that indicate that imported functions were run.\n\n### False positive analysis\n\n- Discovery activities themselves are not inherently malicious if occurring in isolation, as long as the script does not contain other capabilities, and there are no other alerts related to the user or host; such alerts can be dismissed. However, analysts should keep in mind that this is not a common way of getting information, making it suspicious.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Legitimate PowerShell scripts that make use of these functions."],"from":"now-9m","rule_id":"257f7a5f-91cb-4417-b881-4ffa8e6b3177","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"},"technique":[{"reference":"https://attack.mitre.org/techniques/T1069/","name":"Permission Groups Discovery","id":"T1069","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1069/001/","name":"Local Groups","id":"T1069.001"}]},{"reference":"https://attack.mitre.org/techniques/T1087/","name":"Account Discovery","id":"T1087","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1087/001/","name":"Local Account","id":"T1087.001"}]},{"reference":"https://attack.mitre.org/techniques/T1482/","name":"Domain Trust Discovery","id":"T1482"},{"reference":"https://attack.mitre.org/techniques/T1135/","name":"Network Share Discovery","id":"T1135"}]},{"framework":"MITRE ATT&CK","tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"},"technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","id":"T1059","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}]},{"reference":"https://attack.mitre.org/techniques/T1106/","name":"Native API","id":"T1106"}]}],"to":"now","references":["https://github.com/BC-SECURITY/Empire/blob/9259e5106986847d2bb770c4289c0c0f1adf2344/data/module_source/situational_awareness/network/powerview.ps1#L21413","https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"],"version":105,"exceptions_list":[{"id":"c2721b20-eb37-11ed-b6f4-dfeac9073248","list_id":"1cb3d640-74ab-498f-9dce-9d902260b0ea","type":"rule_default","namespace_type":"single"}],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and\n  powershell.file.script_block_text : (\n    NetShareEnum or\n    NetWkstaUserEnum or\n    NetSessionEnum or\n    NetLocalGroupEnum or\n    NetLocalGroupGetMembers or\n    DsGetSiteName or\n    DsEnumerateDomainTrusts or\n    WTSEnumerateSessionsEx or\n    WTSQuerySessionInformation or\n    LsaGetLogonSessionData or\n    QueryServiceObjectSecurity or\n    GetComputerNameEx or\n    NetWkstaGetInfo or\n    GetUserNameEx or\n    NetUserEnum or\n    NetUserGetInfo or\n    NetGroupEnum or\n    NetGroupGetInfo or\n    NetGroupGetUsers or\n    NetWkstaTransportEnum or\n    NetServerGetInfo or\n    LsaEnumerateTrustedDomains  or\n    NetScheduleJobEnum or\n    NetUserModalsGet\n  ) and not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"50e0b8f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.063Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.224Z","created_by":"chaykovskiyv","name":"Creation or Modification of Root Certificate [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the creation or modification of a local trusted root certificate in Windows. The install of a malicious root certificate would allow an attacker the ability to masquerade malicious files as valid signed components from any entity (for example, Microsoft). It could also allow an attacker to decrypt SSL traffic.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Creation or Modification of Root Certificate\n\nRoot certificates are the primary level of certifications that tell a browser that the communication is trusted and legitimate. This verification is based upon the identification of a certification authority. Windows adds several trusted root certificates so browsers can use them to communicate with websites.\n\n[Check out this post](https://www.thewindowsclub.com/what-are-root-certificates-windows) for more details on root certificates and the involved cryptography.\n\nThis rule identifies the creation or modification of a root certificate by monitoring registry modifications. The installation of a malicious root certificate would allow an attacker the ability to masquerade malicious files as valid signed components from any entity (for example, Microsoft). It could also allow an attacker to decrypt SSL traffic.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate abnormal behaviors observed by the subject process such as network connections, other registry or file modifications, and any spawned child processes.\n- If one of the processes is suspicious, retrieve it and determine if it is malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell `Get-FileHash` cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This detection may be triggered by certain applications that install root certificates for the purpose of inspecting SSL traffic. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove the malicious certificate from the root certificate store.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Certain applications may install root certificates for the purpose of inspecting SSL traffic."],"from":"now-9m","rule_id":"43836df4-821d-490f-86ca-d02203e9da8f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1553/","name":"Subvert Trust Controls","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1553/004/","name":"Install Root Certificate","id":"T1553.004"}],"id":"T1553"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://posts.specterops.io/code-signing-certificate-cloning-attacks-and-defenses-6f98657fc6ec","https://www.ired.team/offensive-security/persistence/t1130-install-root-certificate"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"registry where event.type in (\"creation\", \"change\") and\n  registry.path :\n    (\n      \"HKLM\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"HKLM\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\"\n    ) and\n  not process.executable :\n              (\"?:\\\\Program Files\\\\*.exe\",\n               \"?:\\\\Program Files (x86)\\\\*.exe\",\n               \"?:\\\\Windows\\\\System32\\\\*.exe\",\n               \"?:\\\\Windows\\\\SysWOW64\\\\*.exe\",\n               \"?:\\\\Windows\\\\Sysmon64.exe\",\n               \"?:\\\\Windows\\\\Sysmon.exe\",\n               \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n               \"?:\\\\Windows\\\\WinSxS\\\\*.exe\",\n               \"?:\\\\Windows\\\\UUS\\\\amd64\\\\MoUsoCoreWorker.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"49b53e20-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.532Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.206Z","created_by":"chaykovskiyv","name":"Persistent Scripts in the Startup Directory [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies script engines creating files in the Startup folder, or the creation of script files in the Startup folder. Adversaries may abuse this technique to maintain persistence in an environment.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Persistent Scripts in the Startup Directory\n\nThe Windows Startup folder is a special folder in Windows. Programs added to this folder are executed during account logon, without user interaction, providing an excellent way for attackers to maintain persistence.\n\nThis rule looks for shortcuts created by wscript.exe or cscript.exe, or js/vbs scripts created by any process.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- Suspicious Startup Shell Folder Modification - c8b150f0-0164-475b-a75e-74b47800a9ff\n- Startup Folder Persistence via Unsigned Process - 2fba96c0-ade5-4bce-b92f-a5df2509da3f\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"613acabe-feee-46a9-aecf-311f1b39c528","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1547/001/","name":"Registry Run Keys / Startup Folder","id":"T1547.001"}],"id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"file where event.type != \"deletion\" and user.domain != \"NT AUTHORITY\" and\n\n  /* detect shortcuts created by wscript.exe or cscript.exe */\n  (file.path : \"C:\\\\*\\\\Programs\\\\Startup\\\\*.lnk\" and\n     process.name : (\"wscript.exe\", \"cscript.exe\")) or\n\n  /* detect vbs or js files created by any process */\n  file.path : (\"C:\\\\*\\\\Programs\\\\Startup\\\\*.vbs\",\n               \"C:\\\\*\\\\Programs\\\\Startup\\\\*.vbe\",\n               \"C:\\\\*\\\\Programs\\\\Startup\\\\*.wsh\",\n               \"C:\\\\*\\\\Programs\\\\Startup\\\\*.wsf\",\n               \"C:\\\\*\\\\Programs\\\\Startup\\\\*.js\")\n","throttle":"no_actions","actions":[]}
{"id":"4d512990-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.184Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.240Z","created_by":"chaykovskiyv","name":"Unusual Parent-Child Relationship [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies Windows programs run from unexpected parent processes. This could indicate masquerading or other strange activity on a system.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Unusual Parent-Child Relationship\n\nWindows internal/system processes have some characteristics that can be used to spot suspicious activities. One of these characteristics is parent-child relationships. These relationships can be used to baseline the typical behavior of the system and then alert on occurrences that don't comply with the baseline.\n\nThis rule uses this information to spot suspicious parent and child processes.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"bd706456-baae-4f24-8f5c-2a22df482c21","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1055/","name":"Process Injection","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1055/012/","name":"Process Hollowing","id":"T1055.012"}],"id":"T1055"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://github.com/sbousseaden/Slides/blob/master/Hunting%20MindMaps/PNG/Windows%20Processes%20TH.map.png","https://www.andreafortuna.org/2017/06/15/standard-windows-processes-a-brief-reference/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\nprocess.parent.name != null and\n (\n   /* suspicious parent processes */\n   (process.name:\"autochk.exe\" and not process.parent.name:\"smss.exe\") or\n   (process.name:(\"fontdrvhost.exe\", \"dwm.exe\") and not process.parent.name:(\"wininit.exe\", \"winlogon.exe\")) or\n   (process.name:(\"consent.exe\", \"RuntimeBroker.exe\", \"TiWorker.exe\") and not process.parent.name:\"svchost.exe\") or\n   (process.name:\"SearchIndexer.exe\" and not process.parent.name:\"services.exe\") or\n   (process.name:\"SearchProtocolHost.exe\" and not process.parent.name:(\"SearchIndexer.exe\", \"dllhost.exe\")) or\n   (process.name:\"dllhost.exe\" and not process.parent.name:(\"services.exe\", \"svchost.exe\")) or\n   (process.name:\"smss.exe\" and not process.parent.name:(\"System\", \"smss.exe\")) or\n   (process.name:\"csrss.exe\" and not process.parent.name:(\"smss.exe\", \"svchost.exe\")) or\n   (process.name:\"wininit.exe\" and not process.parent.name:\"smss.exe\") or\n   (process.name:\"winlogon.exe\" and not process.parent.name:\"smss.exe\") or\n   (process.name:(\"lsass.exe\", \"LsaIso.exe\") and not process.parent.name:\"wininit.exe\") or\n   (process.name:\"LogonUI.exe\" and not process.parent.name:(\"wininit.exe\", \"winlogon.exe\")) or\n   (process.name:\"services.exe\" and not process.parent.name:\"wininit.exe\") or\n   (process.name:\"svchost.exe\" and not process.parent.name:(\"MsMpEng.exe\", \"services.exe\")) or\n   (process.name:\"spoolsv.exe\" and not process.parent.name:\"services.exe\") or\n   (process.name:\"taskhost.exe\" and not process.parent.name:(\"services.exe\", \"svchost.exe\")) or\n   (process.name:\"taskhostw.exe\" and not process.parent.name:(\"services.exe\", \"svchost.exe\")) or\n   (process.name:\"userinit.exe\" and not process.parent.name:(\"dwm.exe\", \"winlogon.exe\")) or\n   (process.name:(\"wmiprvse.exe\", \"wsmprovhost.exe\", \"winrshost.exe\") and not process.parent.name:\"svchost.exe\") or\n   /* suspicious child processes */\n   (process.parent.name:(\"SearchProtocolHost.exe\", \"taskhost.exe\", \"csrss.exe\") and not process.name:(\"werfault.exe\", \"wermgr.exe\", \"WerFaultSecure.exe\")) or\n   (process.parent.name:\"autochk.exe\" and not process.name:(\"chkdsk.exe\", \"doskey.exe\", \"WerFault.exe\")) or\n   (process.parent.name:\"smss.exe\" and not process.name:(\"autochk.exe\", \"smss.exe\", \"csrss.exe\", \"wininit.exe\", \"winlogon.exe\", \"setupcl.exe\", \"WerFault.exe\")) or\n   (process.parent.name:\"wermgr.exe\" and not process.name:(\"WerFaultSecure.exe\", \"wermgr.exe\", \"WerFault.exe\")) or\n   (process.parent.name:\"conhost.exe\" and not process.name:(\"mscorsvw.exe\", \"wermgr.exe\", \"WerFault.exe\", \"WerFaultSecure.exe\"))\n  )\n","throttle":"no_actions","actions":[]}
{"id":"52b244a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:33.323Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.273Z","created_by":"chaykovskiyv","name":"Code Signing Policy Modification Through Registry [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies attempts to disable/modify the code signing policy through the registry. Code signing provides authenticity on a program, and grants the user with the ability to check whether the program has been tampered with. By allowing the execution of unsigned or self-signed code, threat actors can craft and execute malicious code.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"73c20a22-df62-4ec4-974b-59326ac4119a","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1553/","name":"Subvert Trust Controls","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1553/006/","name":"Code Signing Policy Modification","id":"T1553.006"}],"id":"T1553"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"registry where event.type : (\"creation\", \"change\") and\n(\n  registry.path : \"HKEY_USERS\\\\*\\\\Software\\\\Policies\\\\Microsoft\\\\Windows NT\\\\Driver Signing\\\\BehaviorOnFailedVerify\" and\n  registry.value: \"BehaviorOnFailedVerify\" and\n  registry.data.strings : (\"0\", \"0x00000000\", \"1\", \"0x00000001\")\n)\n","throttle":"no_actions","actions":[]}
{"id":"4b70a9c0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.637Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.128Z","created_by":"chaykovskiyv","name":"Deleting Backup Catalogs with Wbadmin [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Impact","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies use of the wbadmin.exe to delete the backup catalog. Ransomware and other malware may do this to prevent system recovery.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Deleting Backup Catalogs with Wbadmin\n\nWindows Server Backup stores the details about your backups (what volumes are backed up and where the backups are located) in a file called a backup catalog, which ransomware victims can use to recover corrupted backup files. Deleting these files is a common step in threat actor playbooks.\n\nThis rule identifies the deletion of the backup catalog using the `wbadmin.exe` utility.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Check if any files on the host machine have been encrypted.\n\n### False positive analysis\n\n- Administrators can use this command to delete corrupted catalogs, but overall the activity is unlikely to be legitimate.\n\n### Related rules\n\n- Third-party Backup Files Deleted via Unexpected Process - 11ea6bec-ebde-4d71-a8e9-784948f8e3e9\n- Volume Shadow Copy Deleted or Resized via VssAdmin - b5ea4bfe-a1b2-421f-9d47-22a75a6f2921\n- Volume Shadow Copy Deletion via PowerShell - d99a037b-c8e2-47a5-97b9-170d076827c4\n- Volume Shadow Copy Deletion via WMIC - dc9c1f74-dac3-48e3-b47f-eb79db358f57\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If any other destructive action was identified on the host, it is recommended to prioritize the investigation and look for ransomware preparation and execution activities.\n- If any backups were affected:\n  - Perform data recovery locally or restore the backups from replicated copies (cloud, other servers, etc.).\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"34a887af-ed09-4a9e-9c84-322d0c158411","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1490/","name":"Inhibit System Recovery","id":"T1490"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0040/","name":"Impact","id":"TA0040"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  (process.name : \"wbadmin.exe\" or process.pe.original_file_name == \"WBADMIN.EXE\") and\n  process.args : \"catalog\" and process.args : \"delete\"\n","throttle":"no_actions","actions":[]}
{"id":"944e1330-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.762Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.285Z","created_by":"chaykovskiyv","name":"Service Creation via Local Kerberos Authentication [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Credential Access","Active Directory"],"interval":"5m","enabled":true,"description":"Identifies a suspicious local successful logon event where the Logon Package is Kerberos, the remote address is set to localhost, followed by a sevice creation from the same LogonId. This may indicate an attempt to leverage a Kerberos relay attack variant that can be used to elevate privilege locally from a domain joined user to local System privileges.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"f007d01e-0202-4f3e-ac32-c9a60f4ae05a","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1543/","name":"Create or Modify System Process","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1543/003/","name":"Windows Service","id":"T1543.003"}],"id":"T1543"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1558/","name":"Steal or Forge Kerberos Tickets","id":"T1558"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://github.com/Dec0ne/KrbRelayUp","https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html","https://github.com/cube0x0/KrbRelay","https://gist.github.com/tyranid/c24cfd1bd141d14d4925043ee7e03c82"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"sequence by winlog.computer_name with maxspan=5m\n [authentication where\n\n  /* event 4624 need to be logged */\n  event.action == \"logged-in\" and event.outcome == \"success\" and\n\n  /* authenticate locally using relayed kerberos Ticket */\n  winlog.event_data.AuthenticationPackageName :\"Kerberos\" and winlog.logon.type == \"Network\" and\n  cidrmatch(source.ip, \"127.0.0.0/8\", \"::1\") and source.port > 0] by winlog.event_data.TargetLogonId\n\n  [any where\n   /* event 4697 need to be logged */\n   event.action : \"service-installed\"] by winlog.event_data.SubjectLogonId\n","throttle":"no_actions","actions":[]}
{"id":"263c5970-e225-11ed-b6f4-dfeac9073248","updated_at":"2023-06-08T21:29:33.487Z","updated_by":"burzhynskyyy","created_at":"2023-04-23T22:21:10.591Z","created_by":"burzhynskyyy","name":"Potential spam flood by one user 30 mails in 30 minutes","tags":["Custom Rules"],"interval":"5m","enabled":true,"description":"30 emails have been sent by one user in the last 30 minutes","risk_score":73,"severity":"high","license":"","output_index":"","meta":{"from":"30m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-2100s","rule_id":"7bf81276-3d58-4301-844c-7c146468dfd9","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"event.module:\"o365\" and event.provider:\"Exchange\" and event.action:\"Send\"","filters":[],"threshold":{"field":["user.name"],"value":30,"cardinality":[{"field":"event.id","value":30}]},"throttle":"no_actions","actions":[]}
{"id":"52ae7410-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.283Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.223Z","created_by":"chaykovskiyv","name":"Access to a Sensitive LDAP Attribute [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Active Directory"],"interval":"5m","enabled":true,"description":"Identify access to sensitive Active Directory object attributes that contains credentials and decryption keys such as unixUserPassword, ms-PKI-AccountCredentials and msPKI-CredentialRoamingTokens.","risk_score":47,"severity":"medium","note":"The 'Audit Directory Service Changes' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success,Failure)\n```","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"f46fe9f4-f435-43db-a85d-3223805070da","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://www.mandiant.com/resources/blog/apt29-windows-credential-roaming","https://social.technet.microsoft.com/wiki/contents/articles/11483.windows-credential-roaming.aspx","https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-5136"],"version":3,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"any where event.action == \"Directory Service Access\" and event.code == \"4662\" and\n\n  not winlog.event_data.SubjectUserSid : \"S-1-5-18\" and\n\n  winlog.event_data.Properties : (\n   /* unixUserPassword */\n  \"*612cb747-c0e8-4f92-9221-fdd5f15b550d*\",\n\n  /* ms-PKI-AccountCredentials */\n  \"*b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7*\",\n\n  /*  ms-PKI-DPAPIMasterKeys */\n  \"*b3f93023-9239-4f7c-b99c-6745d87adbc2*\",\n\n  /* msPKI-CredentialRoamingTokens */\n  \"*b7ff5a38-0818-42b0-8110-d3d154c97f24*\"\n  ) and\n\n  /*\n   Excluding noisy AccessMasks\n   0x0 undefined and 0x100 Control Access\n   https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4662\n   */\n  not winlog.event_data.AccessMask in (\"0x0\", \"0x100\")\n","throttle":"no_actions","actions":[]}
{"id":"4d5659b0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.029Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.297Z","created_by":"chaykovskiyv","name":"Direct Outbound SMB Connection [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies unexpected processes making network connections over port 445. Windows File Sharing is typically implemented over Server Message Block (SMB), which communicates between hosts using port 445. When legitimate, these network connections are established by the kernel. Processes making 445/tcp connections may be port scanners, exploits, or suspicious user-level processes moving laterally.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Direct Outbound SMB Connection\n\nThis rule looks for unexpected processes making network connections over port 445. Windows file sharing is typically implemented over Server Message Block (SMB), which communicates between hosts using port 445. When legitimate, these network connections are established by the kernel (PID 4). Occurrences of non-system processes using this port can indicate port scanners, exploits, and tools used to move laterally on the environment.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"870b366c-f549-451b-90e7-7f3813710cd8","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1021/002/","name":"SMB/Windows Admin Shares","id":"T1021.002"}],"id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by process.entity_id\n  [process where event.type == \"start\" and host.os.name == \"Windows\" and process.pid != 4 and\n   not (process.executable : \"D:\\\\EnterpriseCare\\\\tools\\\\jre.1\\\\bin\\\\java.exe\" and process.args : \"com.emeraldcube.prism.launcher.Invoker\") and\n   not (process.executable : \"C:\\\\Docusnap 11\\\\Tools\\\\nmap\\\\nmap.exe\" and process.args : \"smb-os-discovery.nse\") and\n   not process.executable :\n              (\"?:\\\\Program Files\\\\SentinelOne\\\\Sentinel Agent *\\\\Ranger\\\\SentinelRanger.exe\",\n               \"?:\\\\Program Files\\\\Ivanti\\\\Security Controls\\\\ST.EngineHost.exe\",\n               \"?:\\\\Program Files (x86)\\\\Fortinet\\\\FSAE\\\\collectoragent.exe\",\n               \"?:\\\\Program Files (x86)\\\\Nmap\\\\nmap.exe\",\n               \"?:\\\\Program Files\\\\Azure Advanced Threat Protection Sensor\\\\*\\\\Microsoft.Tri.Sensor.exe\",\n               \"?:\\\\Program Files\\\\CloudMatters\\\\auvik\\\\AuvikService-release-*\\\\AuvikService.exe\",\n               \"?:\\\\Program Files\\\\uptime software\\\\uptime\\\\UptimeDataCollector.exe\",\n               \"?:\\\\Program Files\\\\CloudMatters\\\\auvik\\\\AuvikAgentService.exe\",\n               \"?:\\\\Program Files\\\\Rumble\\\\rumble-agent-*.exe\")]\n  [network where destination.port == 445 and process.pid != 4 and\n     not cidrmatch(destination.ip, \"127.0.0.1\", \"::1\")]\n","throttle":"no_actions","actions":[]}
{"id":"50e35100-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.248Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.258Z","created_by":"chaykovskiyv","name":"Service Creation via Local Kerberos Authentication [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Credential Access","Active Directory"],"interval":"5m","enabled":true,"description":"Identifies a suspicious local successful logon event where the Logon Package is Kerberos, the remote address is set to localhost, followed by a sevice creation from the same LogonId. This may indicate an attempt to leverage a Kerberos relay attack variant that can be used to elevate privilege locally from a domain joined user to local System privileges.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"3bce6076-a5a8-4649-a4f3-d9e978248d57","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1543/","name":"Create or Modify System Process","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1543/003/","name":"Windows Service","id":"T1543.003"}],"id":"T1543"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1558/","name":"Steal or Forge Kerberos Tickets","id":"T1558"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://github.com/Dec0ne/KrbRelayUp","https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html","https://github.com/cube0x0/KrbRelay","https://gist.github.com/tyranid/c24cfd1bd141d14d4925043ee7e03c82"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"sequence by winlog.computer_name with maxspan=5m\n [authentication where\n\n  /* event 4624 need to be logged */\n  event.action == \"logged-in\" and event.outcome == \"success\" and\n\n  /* authenticate locally using relayed kerberos Ticket */\n  winlog.event_data.AuthenticationPackageName :\"Kerberos\" and winlog.logon.type == \"Network\" and\n  cidrmatch(source.ip, \"127.0.0.0/8\", \"::1\") and source.port > 0] by winlog.event_data.TargetLogonId\n\n  [any where\n   /* event 4697 need to be logged */\n   event.action : \"service-installed\"] by winlog.event_data.SubjectLogonId\n","throttle":"no_actions","actions":[]}
{"id":"fb6e9780-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.269Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.732Z","created_by":"burzhynskyyy","name":"Microsoft 365 Global Administrator Role Assigned [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Identity and Access"],"interval":"5m","enabled":true,"description":"In Azure Active Directory (Azure AD), permissions to manage resources are assigned using roles. The Global Administrator is a role that enables users to have access to all administrative features in Azure AD and services that use Azure AD identities like the Microsoft 365 Defender portal, the Microsoft 365 compliance center, Exchange, SharePoint Online, and Skype for Business Online. Attackers can add users as Global Administrators to maintain access and manage all subscriptions and their settings and resources.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-25m","rule_id":"af66738a-5786-442c-85cc-1ea5c4ff590b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1098/","name":"Account Manipulation","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1098/003/","name":"Additional Cloud Roles","id":"T1098.003"}],"id":"T1098"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#global-administrator"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.code:\"AzureActiveDirectory\" and event.action:\"Add member to role.\" and\no365.audit.ModifiedProperties.Role_DisplayName.NewValue:\"Global Administrator\"\n","throttle":"no_actions","actions":[]}
{"id":"49b03510-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.156Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.145Z","created_by":"chaykovskiyv","name":"Kerberos Traffic from Unusual Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies network connections to the standard Kerberos port from an unusual process. On Windows, the only process that normally performs Kerberos traffic from a domain joined host is lsass.exe.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Kerberos Traffic from Unusual Process\n\nKerberos is the default authentication protocol in Active Directory, designed to provide strong authentication for client/server applications by using secret-key cryptography.\n\nDomain-joined hosts usually perform Kerberos traffic using the `lsass.exe` process. This rule detects the occurrence of traffic on the Kerberos port (88) by processes other than `lsass.exe` to detect the unusual request and usage of Kerberos tickets.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check if the Destination IP is related to a Domain Controller.\n- Review event ID 4769 for suspicious ticket requests.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This rule uses a Kerberos-related port but does not identify the protocol used on that port. HTTP traffic on a non-standard port or destination IP address unrelated to Domain controllers can create false positives.\n- Exceptions can be added for noisy/frequent connections.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n  - Ticket requests can be used to investigate potentially compromised accounts.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["HTTP traffic on a non standard port. Verify that the destination IP address is not related to a Domain Controller."],"from":"now-9m","rule_id":"df5462a2-0f36-4230-a5d2-c51e6003d9db","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1558/","name":"Steal or Forge Kerberos Tickets","id":"T1558"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"network where event.type == \"start\" and network.direction : (\"outgoing\", \"egress\") and\n destination.port == 88 and source.port >= 49152 and process.pid != 4 and \n not process.executable :\n            (\"?:\\\\Windows\\\\System32\\\\lsass.exe\",\n             \"System\",\n             \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n             \"?:\\\\Program Files\\\\Puppet Labs\\\\Puppet\\\\puppet\\\\bin\\\\ruby.exe\",\n             \"\\\\device\\\\harddiskvolume?\\\\windows\\\\system32\\\\lsass.exe\",\n             \"?:\\\\Program Files\\\\rapid7\\\\nexpose\\\\nse\\\\.DLLCACHE\\\\nseserv.exe\",\n             \"?:\\\\Program Files (x86)\\\\GFI\\\\LanGuard 12 Agent\\\\lnsscomm.exe\",\n             \"?:\\\\Program Files (x86)\\\\SuperScan\\\\scanner.exe\",\n             \"?:\\\\Program Files (x86)\\\\Nmap\\\\nmap.exe\",\n             \"?:\\\\Program Files\\\\Tenable\\\\Nessus\\\\nessusd.exe\",\n             \"\\\\device\\\\harddiskvolume?\\\\program files (x86)\\\\nmap\\\\nmap.exe\",\n             \"?:\\\\Program Files\\\\Docker\\\\Docker\\\\resources\\\\vpnkit.exe\",\n             \"?:\\\\Program Files\\\\Docker\\\\Docker\\\\resources\\\\com.docker.vpnkit.exe\",\n             \"?:\\\\Program Files\\\\VMware\\\\VMware View\\\\Server\\\\bin\\\\ws_TomcatService.exe\",\n             \"?:\\\\Program Files (x86)\\\\DesktopCentral_Agent\\\\bin\\\\dcpatchscan.exe\",\n             \"\\\\device\\\\harddiskvolume?\\\\program files (x86)\\\\nmap oem\\\\nmap.exe\",\n             \"?:\\\\Program Files (x86)\\\\Nmap OEM\\\\nmap.exe\",\n             \"?:\\\\Program Files (x86)\\\\Zscaler\\\\ZSATunnel\\\\ZSATunnel.exe\",\n             \"?:\\\\Program Files\\\\JetBrains\\\\PyCharm Community Edition*\\\\bin\\\\pycharm64.exe\",\n             \"?:\\\\Program Files (x86)\\\\Advanced Port Scanner\\\\advanced_port_scanner.exe\",\n             \"?:\\\\Program Files (x86)\\\\nwps\\\\NetScanTools Pro\\\\NSTPRO.exe\",\n             \"?:\\\\Program Files\\\\BlackBerry\\\\UEM\\\\Proxy Server\\\\bin\\\\prunsrv.exe\",\n             \"?:\\\\Program Files (x86)\\\\Microsoft Silverlight\\\\sllauncher.exe\",\n             \"?:\\\\Windows\\\\System32\\\\MicrosoftEdgeCP.exe\",\n             \"?:\\\\Windows\\\\SystemApps\\\\Microsoft.MicrosoftEdge_*\\\\MicrosoftEdge.exe\", \n             \"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeUpdate\\\\MicrosoftEdgeUpdate.exe\",\n             \"?:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\", \n             \"?:\\\\Program Files (x86)\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\", \n             \"?:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\", \n             \"?:\\\\Program Files\\\\Mozilla Firefox\\\\firefox.exe\", \n             \"?:\\\\Program Files\\\\Internet Explorer\\\\iexplore.exe\",\n             \"?:\\\\Program Files (x86)\\\\Internet Explorer\\\\iexplore.exe\"\n             ) and\n destination.address != \"127.0.0.1\" and destination.address != \"::1\"\n","throttle":"no_actions","actions":[]}
{"id":"52b13330-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.304Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.260Z","created_by":"chaykovskiyv","name":"Group Policy Discovery via Microsoft GPResult Utility [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Detects the usage of gpresult.exe to query group policy objects. Attackers may query group policy objects during the reconnaissance phase after compromising a system to gain a better understanding of the active directory environment and possible methods to escalate privileges or move laterally.","risk_score":21,"severity":"low","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"f049a6b1-0874-4e66-a24d-ec8f29c2830e","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1615/","name":"Group Policy Discovery","id":"T1615"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}}],"to":"now","references":[],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n(process.name: \"gpresult.exe\" or process.pe.original_file_name == \"gprslt.exe\") and process.args: (\"/z\", \"/v\", \"/r\", \"/x\")\n","throttle":"no_actions","actions":[]}
{"id":"4b6c3cf0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.556Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.073Z","created_by":"chaykovskiyv","name":"InstallUtil Process Making Network Connections [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Identifies InstallUtil.exe making outbound network connections. This may indicate adversarial activity as InstallUtil is often leveraged by adversaries to execute code and evade detection.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"6361615c-450c-4132-9509-8881cb64550c","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1218/","name":"System Binary Proxy Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1218/004/","name":"InstallUtil","id":"T1218.004"}],"id":"T1218"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"/* the benefit of doing this as an eql sequence vs kql is this will limit to alerting only on the first network connection */\n\nsequence by process.entity_id\n  [process where event.type == \"start\" and process.name : \"installutil.exe\"]\n  [network where process.name : \"installutil.exe\" and network.direction : (\"outgoing\", \"egress\")]\n","throttle":"no_actions","actions":[]}
{"id":"50e15530-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.068Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.231Z","created_by":"chaykovskiyv","name":"Suspicious Startup Shell Folder Modification [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies suspicious startup shell folder modifications to change the default Startup directory in order to bypass detections monitoring file creation in the Windows Startup folder.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Suspicious Startup Shell Folder Modification\n\nTechniques used within malware and by adversaries often leverage the Windows registry to store malicious programs for persistence. Startup shell folders are often targeted as they are not as prevalent as normal Startup folder paths so this behavior may evade existing AV/EDR solutions. These programs may also run with higher privileges which can be ideal for an attacker.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Review the source process and related file tied to the Windows Registry entry.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- There is a high possibility of benign legitimate programs being added to shell folders. This activity could be based on new software installations, patches, or other network administrator activity. Before undertaking further investigation, it should be verified that this activity is not benign.\n\n### Related rules\n\n- Startup or Run Key Registry Modification - 97fc44d3-8dae-4019-ae83-298c3015600f\n- Persistent Scripts in the Startup Directory - f7c4dc5a-a58d-491d-9f14-9b66507121c0\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- If the malicious file was delivered via phishing:\n  - Block the email sender from sending future emails.\n  - Block the malicious web pages.\n  - Remove emails from the sender from mailboxes.\n  - Consider improvements to the security awareness program.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"198c116f-8d67-4505-b005-2f9395b8c7b1","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1547/001/","name":"Registry Run Keys / Startup Folder","id":"T1547.001"}],"id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"registry where\n registry.path : (\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Common Startup\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Common Startup\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Startup\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Startup\"\n     ) and\n  registry.data.strings != null and\n  /* Normal Startup Folder Paths */\n  not registry.data.strings : (\n           \"C:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\",\n           \"%ProgramData%\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\",\n           \"%USERPROFILE%\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\",\n           \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\"\n           )\n","throttle":"no_actions","actions":[]}
{"id":"4d501820-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.178Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.233Z","created_by":"chaykovskiyv","name":"Potential Modification of Accessibility Binaries [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Investigation Guide"],"interval":"5m","enabled":true,"description":"Windows contains accessibility features that may be launched with a key combination before a user has logged in. An adversary can modify the way these programs are launched to get a command prompt or backdoor without logging in to the system.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Potential Modification of Accessibility Binaries\n\nAdversaries may establish persistence and/or elevate privileges by executing malicious content triggered by accessibility features. Windows contains accessibility features that may be launched with a key combination before a user has logged in (ex: when the user is on the Windows logon screen). An adversary can modify the way these programs are launched to get a command prompt or backdoor without logging in to the system.\n\nMore details can be found [here](https://attack.mitre.org/techniques/T1546/008/).\n\nThis rule looks for the execution of supposed accessibility binaries that don't match any of the accessibility features binaries' original file names, which is likely a custom binary deployed by the attacker.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity should not happen legitimately. The security team should address any potential benign true positive (B-TP), as this configuration can put the user and the domain at risk.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"4b1844fb-189b-4606-b91a-71fed5354b4a","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1546/","name":"Event Triggered Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1546/008/","name":"Accessibility Features","id":"T1546.008"}],"id":"T1546"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1546/","name":"Event Triggered Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1546/008/","name":"Accessibility Features","id":"T1546.008"}],"id":"T1546"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://www.elastic.co/blog/practical-security-engineering-stateful-detection"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n process.parent.name : (\"Utilman.exe\", \"winlogon.exe\") and user.name == \"SYSTEM\" and\n process.args :\n    (\n    \"C:\\\\Windows\\\\System32\\\\osk.exe\",\n    \"C:\\\\Windows\\\\System32\\\\Magnify.exe\",\n    \"C:\\\\Windows\\\\System32\\\\Narrator.exe\",\n    \"C:\\\\Windows\\\\System32\\\\Sethc.exe\",\n    \"utilman.exe\",\n    \"ATBroker.exe\",\n    \"DisplaySwitch.exe\",\n    \"sethc.exe\"\n    )\n and not process.pe.original_file_name in\n    (\n    \"osk.exe\",\n    \"sethc.exe\",\n    \"utilman2.exe\",\n    \"DisplaySwitch.exe\",\n    \"ATBroker.exe\",\n    \"ScreenMagnifier.exe\",\n    \"SR.exe\",\n    \"Narrator.exe\",\n    \"magnify.exe\",\n    \"MAGNIFY.EXE\"\n    )\n\n/* uncomment once in winlogbeat to avoid bypass with rogue process with matching pe original file name */\n/* and process.code_signature.subject_name == \"Microsoft Windows\" and process.code_signature.status == \"trusted\" */\n","throttle":"no_actions","actions":[]}
{"id":"4d4fa2f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.173Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.228Z","created_by":"chaykovskiyv","name":"Service Control Spawned via Script Interpreter [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies Service Control (sc.exe) spawning from script interpreter processes to create, modify, or start services. This could be indicative of adversary lateral movement but will be noisy if commonly done by admins.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"a404e015-db59-4c52-9dad-f49de88ceadd","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","logs-system.*","winlogbeat-*","logs-windows.*"],"query":"/* This rule is not compatible with Sysmon due to user.id issues */\n\nprocess where event.type == \"start\" and\n  (process.name : \"sc.exe\" or process.pe.original_file_name == \"sc.exe\") and\n  process.parent.name : (\"cmd.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\",\n                         \"wmic.exe\", \"mshta.exe\",\"powershell.exe\", \"pwsh.exe\") and\n  process.args:(\"config\", \"create\", \"start\", \"delete\", \"stop\", \"pause\") and\n  /* exclude SYSTEM SID - look for service creations by non-SYSTEM user */\n  not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"48429b50-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.202Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.790Z","created_by":"chaykovskiyv","name":"UAC Bypass Attempt via Privileged IFileOperation COM Interface [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Identifies attempts to bypass User Account Control (UAC) via DLL side-loading. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"3e629ce8-1444-4ff3-a308-b2c3eceeae23","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1548/","name":"Abuse Elevation Control Mechanism","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1548/002/","name":"Bypass User Account Control","id":"T1548.002"}],"id":"T1548"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://github.com/hfiref0x/UACME","https://www.elastic.co/security-labs/exploring-windows-uac-bypasses-techniques-and-detection-strategies"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"file where event.type : \"change\" and process.name : \"dllhost.exe\" and\n  /* Known modules names side loaded into process running with high or system integrity level for UAC Bypass, update here for new modules */\n  file.name : (\"wow64log.dll\", \"comctl32.dll\", \"DismCore.dll\", \"OskSupport.dll\", \"duser.dll\", \"Accessibility.ni.dll\") and\n  /* has no impact on rule logic just to avoid OS install related FPs */\n  not file.path : (\"C:\\\\Windows\\\\SoftwareDistribution\\\\*\", \"C:\\\\Windows\\\\WinSxS\\\\*\")\n","throttle":"no_actions","actions":[]}
{"id":"4d4f2dc0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.045Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.224Z","created_by":"chaykovskiyv","name":"Suspicious MS Office Child Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Initial Access","Investigation Guide","Execution"],"interval":"5m","enabled":true,"description":"Identifies suspicious child processes of frequently targeted Microsoft Office applications (Word, PowerPoint, Excel). These child processes are often launched during exploitation of Office applications or from documents with malicious macros.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Suspicious MS Office Child Process\n\nMicrosoft Office (MS Office) is a suite of applications designed to help with productivity and completing common tasks on a computer. You can create and edit documents containing text and images, work with data in spreadsheets and databases, and create presentations and posters. As it is some of the most-used software across companies, MS Office is frequently targeted for initial access. It also has a wide variety of capabilities that attackers can take advantage of.\n\nThis rule looks for suspicious processes spawned by MS Office programs. This is generally the result of the execution of malicious documents.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve MS Office documents received and opened by the user that could cause this behavior. Common locations include, but are not limited to, the Downloads and Document folders and the folder configured at the email client.\n- Determine if the collected files are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"3789be29-aaa8-4cdc-b976-11a854daf57a","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1566/","name":"Phishing","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1566/001/","name":"Spearphishing Attachment","id":"T1566.001"}],"id":"T1566"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/003/","name":"Windows Command Shell","id":"T1059.003"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://www.elastic.co/blog/vulnerability-summary-follina"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  process.parent.name : (\"eqnedt32.exe\", \"excel.exe\", \"fltldr.exe\", \"msaccess.exe\", \"mspub.exe\", \"powerpnt.exe\", \"winword.exe\", \"outlook.exe\") and\n  process.name : (\"Microsoft.Workflow.Compiler.exe\", \"arp.exe\", \"atbroker.exe\", \"bginfo.exe\", \"bitsadmin.exe\", \"cdb.exe\", \"certutil.exe\",\n                \"cmd.exe\", \"cmstp.exe\", \"control.exe\", \"cscript.exe\", \"csi.exe\", \"dnx.exe\", \"dsget.exe\", \"dsquery.exe\", \"forfiles.exe\",\n                \"fsi.exe\", \"ftp.exe\", \"gpresult.exe\", \"hostname.exe\", \"ieexec.exe\", \"iexpress.exe\", \"installutil.exe\", \"ipconfig.exe\",\n                \"mshta.exe\", \"msxsl.exe\", \"nbtstat.exe\", \"net.exe\", \"net1.exe\", \"netsh.exe\", \"netstat.exe\", \"nltest.exe\", \"odbcconf.exe\",\n                \"ping.exe\", \"powershell.exe\", \"pwsh.exe\", \"qprocess.exe\", \"quser.exe\", \"qwinsta.exe\", \"rcsi.exe\", \"reg.exe\", \"regasm.exe\",\n                \"regsvcs.exe\", \"regsvr32.exe\", \"sc.exe\", \"schtasks.exe\", \"systeminfo.exe\", \"tasklist.exe\", \"tracert.exe\", \"whoami.exe\",\n                \"wmic.exe\", \"wscript.exe\", \"xwizard.exe\", \"explorer.exe\", \"rundll32.exe\", \"hh.exe\", \"msdt.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"50debd20-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.050Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.204Z","created_by":"chaykovskiyv","name":"Windows Defender Disabled via Registry Modification [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies modifications to the Windows Defender registry settings to disable the service or set the service to be started manually.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Windows Defender Disabled via Registry Modification\n\nMicrosoft Windows Defender is an antivirus product built into Microsoft Windows, which makes it popular across multiple environments. Disabling it is a common step in threat actor playbooks.\n\nThis rule monitors the registry for configurations that disable Windows Defender or the start of its service.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check if this operation was approved and performed according to the organization's change management policy.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity, the configuration is justified (for example, it is being used to deploy other security solutions or troubleshooting), and no other suspicious activity has been observed.\n\n### Related rules\n\n- Disabling Windows Defender Security Settings via PowerShell - c8cccb06-faf2-4cd5-886e-2c9636cfcb87\n- Microsoft Windows Defender Tampering - fe794edd-487f-4a90-b285-3ee54f2af2d3\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Re-enable Windows Defender and restore the service configurations to automatic start.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"fd44986e-6439-4fea-b5e4-3defd48d216f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/001/","name":"Disable or Modify Tools","id":"T1562.001"},{"reference":"https://attack.mitre.org/techniques/T1562/006/","name":"Indicator Blocking","id":"T1562.006"}],"id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://thedfirreport.com/2020/12/13/defender-control/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"registry where event.type in (\"creation\", \"change\") and\n  (\n    (\n      registry.path: (\n        \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\DisableAntiSpyware\",\n        \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\DisableAntiSpyware\"\n      ) and\n      registry.data.strings: (\"1\", \"0x00000001\")\n   ) or\n   (\n      registry.path: (\n        \"HKLM\\\\System\\\\*ControlSet*\\\\Services\\\\WinDefend\\\\Start\",\n        \"\\\\REGISTRY\\\\MACHINE\\\\System\\\\*ControlSet*\\\\Services\\\\WinDefend\\\\Start\"\n      ) and\n      registry.data.strings in (\"3\", \"4\", \"0x00000003\", \"0x00000004\")\n   )\n  ) and\n\n  not process.executable :\n           (\"?:\\\\WINDOWS\\\\system32\\\\services.exe\",\n            \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n            \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\Security Agent\\\\NTRmv.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"94512070-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-29T13:33:26.648Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.313Z","created_by":"chaykovskiyv","name":"Scheduled Task Execution at Scale via GPO [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Active Directory","Investigation Guide"],"interval":"5m","enabled":true,"description":"Detects the modification of Group Policy Object attributes to execute a scheduled task in the objects controlled by the GPO.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Scheduled Task Execution at Scale via GPO\n\nGroup Policy Objects (GPOs) can be used by attackers to execute scheduled tasks at scale to compromise objects controlled by a given GPO. This is done by changing the contents of the `<GPOPath>\\Machine\\Preferences\\ScheduledTasks\\ScheduledTasks.xml` file.\n\n#### Possible investigation steps\n\n- This attack abuses a legitimate mechanism of Active Directory, so it is important to determine whether the activity is legitimate and the administrator is authorized to perform this operation.\n- Retrieve the contents of the `ScheduledTasks.xml` file, and check the `<Command>` and `<Arguments>` XML tags for any potentially malicious commands or binaries.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Scope which objects may be compromised by retrieving information about which objects are controlled by the GPO.\n\n### False positive analysis\n\n- Verify if the execution is allowed and done under change management, and if the execution is legitimate.\n\n### Related rules\n\n- Group Policy Abuse for Privilege Addition - b9554892-5e0e-424b-83a0-5aef95aa43bf\n- Startup/Logon Script added to Group Policy Object - 16fac1a1-21ee-4ca6-b720-458e3855d046\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- The investigation and containment must be performed in every computer controlled by the GPO, where necessary.\n- Remove the script from the GPO.\n- Check if other GPOs have suspicious scheduled tasks attached.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-6m","rule_id":"068c5e19-521a-4d18-84e6-04368a61e4b5","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"},"technique":[{"reference":"https://attack.mitre.org/techniques/T1053/","name":"Scheduled Task/Job","id":"T1053","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1053/005/","name":"Scheduled Task","id":"T1053.005"}]},{"reference":"https://attack.mitre.org/techniques/T1484/","name":"Domain Policy Modification","id":"T1484","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1484/001/","name":"Group Policy Modification","id":"T1484.001"}]}]}],"to":"now","references":["https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0025_windows_audit_directory_service_changes.md","https://github.com/atc-project/atc-data/blob/f2bbb51ecf68e2c9f488e3c70dcdd3df51d2a46b/docs/Logging_Policies/LP_0029_windows_audit_detailed_file_share.md","https://labs.f-secure.com/tools/sharpgpoabuse","https://twitter.com/menasec1/status/1106899890377052160","https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_gpo_scheduledtasks.yml"],"version":104,"exceptions_list":[{"id":"633eab90-fe25-11ed-8f07-79710758f25a","list_id":"146b4114-e1e0-4af7-9bc6-3ff64b9286fb","type":"rule_default","namespace_type":"single"}],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"(event.code: \"5136\" and winlog.event_data.AttributeLDAPDisplayName:(\"gPCMachineExtensionNames\" or \"gPCUserExtensionNames\") and\n   winlog.event_data.AttributeValue:(*CAB54552-DEEA-4691-817E-ED4A4D1AFC72* and *AADCED64-746C-4633-A97C-D61349046527*))\nor\n(event.code: \"5145\" and winlog.event_data.ShareName: \"\\\\\\\\*\\\\SYSVOL\" and winlog.event_data.RelativeTargetName: *ScheduledTasks.xml and\n  (message: WriteData or winlog.event_data.AccessList: *%%4417*))\n","throttle":"no_actions","actions":[]}
{"id":"483e2e80-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.161Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.730Z","created_by":"chaykovskiyv","name":"Unusual Service Host Child Process - Childless Service [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Identifies unusual child processes of Service Host (svchost.exe) that traditionally do not spawn any child processes. This may indicate a code injection or an equivalent form of exploitation.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Changes to Windows services or a rarely executed child process."],"from":"now-9m","rule_id":"657eeaee-4865-4d4d-a654-5d71319ee17f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1055/","name":"Process Injection","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1055/012/","name":"Process Hollowing","id":"T1055.012"}],"id":"T1055"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1055/","name":"Process Injection","id":"T1055"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"process where event.type == \"start\" and\n     process.parent.name : \"svchost.exe\" and\n\n     /* based on svchost service arguments -s svcname where the service is known to be childless */\n\n    process.parent.args : (\"WdiSystemHost\",\"LicenseManager\",\n      \"StorSvc\",\"CDPSvc\",\"cdbhsvc\",\"BthAvctpSvc\",\"SstpSvc\",\"WdiServiceHost\",\n      \"imgsvc\",\"TrkWks\",\"WpnService\",\"IKEEXT\",\"PolicyAgent\",\"CryptSvc\",\n      \"netprofm\",\"ProfSvc\",\"StateRepository\",\"camsvc\",\"LanmanWorkstation\",\n      \"NlaSvc\",\"EventLog\",\"hidserv\",\"DisplayEnhancementService\",\"ShellHWDetection\",\n      \"AppHostSvc\",\"fhsvc\",\"CscService\",\"PushToInstall\") and\n\n      /* unknown FPs can be added here */\n\n     not process.name : (\"WerFault.exe\",\"WerFaultSecure.exe\",\"wermgr.exe\") and\n     not (process.executable : \"?:\\\\Windows\\\\System32\\\\RelPost.exe\" and process.parent.args : \"WdiSystemHost\") and\n     not (process.name : \"rundll32.exe\" and\n          process.args : \"?:\\\\WINDOWS\\\\System32\\\\winethc.dll,ForceProxyDetectionOnNextRun\" and process.parent.args : \"WdiServiceHost\") and\n     not (process.executable : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\", \"?:\\\\Windows\\\\System32\\\\Kodak\\\\kds_i4x50\\\\lib\\\\lexexe.exe\") and\n          process.parent.args : \"imgsvc\")\n","throttle":"no_actions","actions":[]}
{"id":"4b71e240-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.643Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.136Z","created_by":"chaykovskiyv","name":"Windows Script Executing PowerShell [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Initial Access","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies a PowerShell process launched by either cscript.exe or wscript.exe. Observing Windows scripting processes executing a PowerShell script, may be indicative of malicious activity.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Windows Script Executing PowerShell\n\nThe Windows Script Host (WSH) is an Windows automation technology, which is ideal for non-interactive scripting needs, such as logon scripting, administrative scripting, and machine automation.\n\nAttackers commonly use WSH scripts as their initial access method, acting like droppers for second stage payloads, but can also use them to download tools and utilities needed to accomplish their goals.\n\nThis rule looks for the spawn of the `powershell.exe` process with `cscript.exe` or `wscript.exe` as its parent process.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate commands executed by the spawned PowerShell process.\n- If unsigned files are found on the process tree, retrieve them and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Determine how the script file was delivered (email attachment, dropped by other processes, etc.).\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- The usage of these script engines by regular users is unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- If the malicious file was delivered via phishing:\n  - Block the email sender from sending future emails.\n  - Block the malicious web pages.\n  - Remove emails from the sender from mailboxes.\n  - Consider improvements to the security awareness program.\n- Reimage the host operating system and restore compromised files to clean versions.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"e964b4bc-bd1e-4bc2-a3e7-eb66bd4dda5f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1566/","name":"Phishing","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1566/001/","name":"Spearphishing Attachment","id":"T1566.001"}],"id":"T1566"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  process.parent.name : (\"cscript.exe\", \"wscript.exe\") and process.name : \"powershell.exe\"\n","throttle":"no_actions","actions":[]}
{"id":"52b3a430-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:33.335Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.292Z","created_by":"chaykovskiyv","name":"Temporarily Scheduled Task Creation [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Indicates the creation and deletion of a scheduled task within a short time interval. Adversaries can use these to proxy malicious execution via the schedule service and perform clean up.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":["Legitimate scheduled tasks may be created during installation of new software."],"from":"now-9m","rule_id":"e0e96b16-0448-47f6-b399-705ff5b4fb0b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1053/","name":"Scheduled Task/Job","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1053/005/","name":"Scheduled Task","id":"T1053.005"}],"id":"T1053"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4698"],"version":3,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"sequence by winlog.computer_name, winlog.event_data.TaskName with maxspan=5m\n   [iam where event.action == \"scheduled-task-created\" and not user.name : \"*$\"]\n   [iam where event.action == \"scheduled-task-deleted\" and not user.name : \"*$\"]\n","throttle":"no_actions","actions":[]}
{"id":"4b6e5fd0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.616Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.101Z","created_by":"chaykovskiyv","name":"External IP Lookup from Non-Browser Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies domains commonly used by adversaries for post-exploitation IP lookups. It is common for adversaries to test for Internet access and acquire their external IP address after they have gained access to a system. Among others, this has been observed in campaigns leveraging the information stealer, Trickbot.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating External IP Lookup from Non-Browser Process\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for connections to known IP lookup services through non-browser processes or non-installed programs. Using only the IP address of the compromised system, attackers can obtain valuable information such as the system's geographic location, the company that owns the IP, whether the system is cloud-hosted, and more.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate abnormal behaviors observed by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Use the data collected through the analysis to investigate other machines affected in the environment.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["If the domains listed in this rule are used as part of an authorized workflow, this rule will be triggered by those events. Validate that this is expected activity and tune the rule to fit your environment variables."],"from":"now-9m","rule_id":"1c985352-9b8d-4105-980b-d01d4c8d2d57","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1016/","name":"System Network Configuration Discovery","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1016/001/","name":"Internet Connection Discovery","id":"T1016.001"}],"id":"T1016"},{"reference":"https://attack.mitre.org/techniques/T1614/","name":"System Location Discovery","id":"T1614"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}}],"to":"now","references":["https://community.jisc.ac.uk/blogs/csirt/article/trickbot-analysis-and-mitigation","https://www.cybereason.com/blog/dropping-anchor-from-a-trickbot-infection-to-the-discovery-of-the-anchor-malware"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"network where network.protocol == \"dns\" and\n    process.name != null and user.id not in (\"S-1-5-19\", \"S-1-5-20\") and\n    event.action == \"lookup_requested\" and\n    /* Add new external IP lookup services here */\n    dns.question.name :\n    (\n        \"*api.ipify.org\",\n        \"*freegeoip.app\",\n        \"*checkip.amazonaws.com\",\n        \"*checkip.dyndns.org\",\n        \"*freegeoip.app\",\n        \"*icanhazip.com\",\n        \"*ifconfig.*\",\n        \"*ipecho.net\",\n        \"*ipgeoapi.com\",\n        \"*ipinfo.io\",\n        \"*ip.anysrc.net\",\n        \"*myexternalip.com\",\n        \"*myipaddress.com\",\n        \"*showipaddress.com\",\n        \"*whatismyipaddress.com\",\n        \"*wtfismyip.com\",\n        \"*ipapi.co\",\n        \"*ip-lookup.net\",\n        \"*ipstack.com\"\n    ) and\n    /* Insert noisy false positives here */\n    not process.executable :\n    (\n      \"?:\\\\Program Files\\\\*.exe\",\n      \"?:\\\\Program Files (x86)\\\\*.exe\",\n      \"?:\\\\Windows\\\\System32\\\\WWAHost.exe\",\n      \"?:\\\\Windows\\\\System32\\\\smartscreen.exe\",\n      \"?:\\\\Windows\\\\System32\\\\MicrosoftEdgeCP.exe\",\n      \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Fiddler\\\\Fiddler.exe\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Microsoft VS Code\\\\Code.exe\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\OneDrive.exe\"\n    )\n","throttle":"no_actions","actions":[]}
{"id":"e75e3870-d2c7-11ed-b6f4-dfeac9073248","updated_at":"2023-06-08T21:29:33.489Z","updated_by":"burzhynskyyy","created_at":"2023-04-04T09:05:54.434Z","created_by":"burzhynskyyy","name":"Mass folder recycled events by one user","tags":["Custom Rules"],"interval":"5m","enabled":true,"description":"Масове переміщення папок до корзини одним юзером за 30 хвилин.","risk_score":47,"severity":"medium","license":"","output_index":"","meta":{"from":"25m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-1800s","rule_id":"5b1b1d22-f855-48e6-8edb-6427693c6f1b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"event.module:\"o365\" and event.provider:\"SharePoint\" and event.action:\"FolderRecycled\"","filters":[],"threshold":{"field":["user.name"],"value":10,"cardinality":[{"field":"file.name","value":10}]},"throttle":"no_actions","actions":[]}
{"id":"49b11f70-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.178Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.156Z","created_by":"chaykovskiyv","name":"Connection to Commonly Abused Web Services [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Command and Control","Investigation Guide"],"interval":"5m","enabled":true,"description":"Adversaries may implement command and control (C2) communications that use common web services to hide their activity. This attack technique is typically targeted at an organization and uses web services common to the victim network, which allows the adversary to blend into legitimate traffic activity. These popular services are typically targeted since they have most likely been used before compromise, which helps malicious traffic blend in.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Connection to Commonly Abused Web Services\n\nAdversaries may use an existing, legitimate external Web service as a means for relaying data to/from a compromised system. Popular websites and social media acting as a mechanism for C2 may give a significant amount of cover due to the likelihood that hosts within a network are already communicating with them prior to a compromise.\n\nThis rule looks for processes outside known legitimate program locations communicating with a list of services that can be abused for exfiltration or command and control.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Verify whether the digital signature exists in the executable.\n- Identify the operation type (upload, download, tunneling, etc.).\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This rule has a high chance to produce false positives because it detects communication with legitimate services. Noisy false positives can be added as exceptions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"658a1268-170f-40a3-bb48-6bb582577a79","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1102/","name":"Web Service","id":"T1102"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0011/","name":"Command and Control","id":"TA0011"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1567/","name":"Exfiltration Over Web Service","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1567/001/","name":"Exfiltration to Code Repository","id":"T1567.001"},{"reference":"https://attack.mitre.org/techniques/T1567/002/","name":"Exfiltration to Cloud Storage","id":"T1567.002"}],"id":"T1567"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0010/","name":"Exfiltration","id":"TA0010"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"network where network.protocol == \"dns\" and\n    process.name != null and user.id not in (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n    /* Add new WebSvc domains here */\n    dns.question.name :\n    (\n        \"raw.githubusercontent.*\",\n        \"*.pastebin.*\",\n        \"*drive.google.*\",\n        \"*docs.live.*\",\n        \"*api.dropboxapi.*\",\n        \"*dropboxusercontent.*\",\n        \"*onedrive.*\",\n        \"*4shared.*\",\n        \"*.file.io\",\n        \"*filebin.net\",\n        \"*slack-files.com\",\n        \"*ghostbin.*\",\n        \"*ngrok.*\",\n        \"*portmap.*\",\n        \"*serveo.net\",\n        \"*localtunnel.me\",\n        \"*pagekite.me\",\n        \"*localxpose.io\",\n        \"*notabug.org\",\n        \"rawcdn.githack.*\",\n        \"paste.nrecom.net\",\n        \"zerobin.net\",\n        \"controlc.com\",\n        \"requestbin.net\",\n        \"cdn.discordapp.com\",\n        \"discordapp.com\",\n        \"discord.com\",\n        \"script.google.com\",\n        \"script.googleusercontent.com\"\n    ) and\n    /* Insert noisy false positives here */\n    not process.executable :\n    (\n      \"?:\\\\Program Files\\\\*.exe\",\n      \"?:\\\\Program Files (x86)\\\\*.exe\",\n      \"?:\\\\Windows\\\\System32\\\\WWAHost.exe\",\n      \"?:\\\\Windows\\\\System32\\\\smartscreen.exe\",\n      \"?:\\\\Windows\\\\System32\\\\MicrosoftEdgeCP.exe\",\n      \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Fiddler\\\\Fiddler.exe\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Microsoft VS Code\\\\Code.exe\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\OneDrive.exe\",\n      \"?:\\\\Windows\\\\system32\\\\mobsync.exe\",\n      \"?:\\\\Windows\\\\SysWOW64\\\\mobsync.exe\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Discord\\\\app-*\\\\Discord.exe\"\n    )\n","throttle":"no_actions","actions":[]}
{"id":"4842e970-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.215Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.794Z","created_by":"chaykovskiyv","name":"UAC Bypass Attempt via Windows Directory Masquerading [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies an attempt to bypass User Account Control (UAC) by masquerading as a Microsoft trusted Windows directory. Attackers may bypass UAC to stealthily execute code with elevated permissions.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating UAC Bypass Attempt via Windows Directory Masquerading\n\nWindows User Account Control (UAC) allows a program to elevate its privileges (tracked as low to high integrity levels) to perform a task under administrator-level permissions, possibly by prompting the user for confirmation. UAC can deny an operation under high-integrity enforcement, or allow the user to perform the action if they are in the local administrators group and enter an administrator password when prompted.\n\nFor more information about the UAC and how it works, check the [official Microsoft docs page](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works).\n\nThis rule identifies an attempt to bypass User Account Control (UAC) by masquerading as a Microsoft trusted Windows directory. Attackers may bypass UAC to stealthily execute code with elevated permissions.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze any suspicious spawned processes using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"822cfa90-b8b7-4b1b-8d4f-33569e3cdb16","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1548/","name":"Abuse Elevation Control Mechanism","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1548/002/","name":"Bypass User Account Control","id":"T1548.002"}],"id":"T1548"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://medium.com/tenable-techblog/uac-bypass-by-mocking-trusted-directories-24a96675f6e"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  process.args : (\"C:\\\\Windows \\\\system32\\\\*.exe\", \"C:\\\\Windows \\\\SysWOW64\\\\*.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"52af3760-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:33.334Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.232Z","created_by":"chaykovskiyv","name":"Suspicious Lsass Process Access [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Sysmon Only"],"interval":"5m","enabled":true,"description":"Identifies access attempts to LSASS handle, this may indicate an attempt to dump credentials from Lsass memory.","risk_score":47,"severity":"medium","note":"## Setup","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"b2e3cffc-d552-45a4-8007-c785eb9cceb4","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/001/","name":"LSASS Memory","id":"T1003.001"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1003.001/T1003.001.md"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-windows.*"],"query":"process where event.code == \"10\" and\n  winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\" and\n  not winlog.event_data.GrantedAccess : \n                (\"0x1000\", \"0x1400\", \"0x101400\", \"0x101000\", \"0x101001\", \"0x100000\", \"0x100040\", \"0x3200\", \"0x40\", \"0x3200\") and \n  not process.name : (\"procexp64.exe\", \"procmon.exe\", \"procexp.exe\", \"Microsoft.Identity.AadConnect.Health.AadSync.Host.ex\") and \n  not process.executable : \n            (\"?:\\\\Windows\\\\System32\\\\lsm.exe\", \n             \"?:\\\\Program Files\\\\*\", \n             \"?:\\\\Program Files (x86)\\\\*\", \n             \"?:\\\\Windows\\\\System32\\\\msiexec.exe\", \n             \"?:\\\\Windows\\\\CCM\\\\CcmExec.exe\", \n             \"?:\\\\Windows\\\\system32\\\\csrss.exe\", \n             \"?:\\\\Windows\\\\system32\\\\wininit.exe\", \n             \"?:\\\\Windows\\\\system32\\\\wbem\\\\wmiprvse.exe\", \n             \"?:\\\\Windows\\\\system32\\\\MRT.exe\", \n             \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\platform\\\\*\", \n             \"?:\\\\ProgramData\\\\WebEx\\\\webex\\\\*\", \n             \"?:\\\\Windows\\\\LTSvc\\\\LTSVC.exe\") and \n   not winlog.event_data.CallTrace : (\"*mpengine.dll*\", \"*appresolver.dll*\", \"*sysmain.dll*\") \n","throttle":"no_actions","actions":[]}
{"id":"48315d40-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.156Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.612Z","created_by":"chaykovskiyv","name":"Incoming Execution via PowerShell Remoting [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies remote execution via Windows PowerShell remoting. Windows PowerShell remoting allows a user to run any Windows PowerShell command on one or more remote computers. This could be an indication of lateral movement.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":["PowerShell remoting is a dual-use protocol that can be used for benign or malicious activity. It's important to baseline your environment to determine the amount of noise to expect from this tool."],"from":"now-9m","rule_id":"a291d898-0573-4573-9a64-a60e4b3c772e","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1021/006/","name":"Windows Remote Management","id":"T1021.006"}],"id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":["https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/running-remote-commands?view=powershell-7.1"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by host.id with maxspan = 30s\n   [network where network.direction : (\"incoming\", \"ingress\") and destination.port in (5985, 5986) and\n    network.protocol == \"http\" and source.ip != \"127.0.0.1\" and source.ip != \"::1\"]\n   [process where event.type == \"start\" and process.parent.name : \"wsmprovhost.exe\" and not process.name : \"conhost.exe\"]\n","throttle":"no_actions","actions":[]}
{"id":"fb6ce9d0-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.268Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.724Z","created_by":"burzhynskyyy","name":"Microsoft 365 Teams Guest Access Enabled [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Configuration Audit"],"interval":"5m","enabled":true,"description":"Identifies when guest access is enabled in Microsoft Teams. Guest access in Teams allows people outside the organization to access teams and channels. An adversary may enable guest access to maintain persistence in an environment.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Teams guest access may be enabled by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."],"from":"now-30m","rule_id":"d6b577af-581f-4100-b2f7-fd00d150f81e","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1098/","name":"Account Manipulation","id":"T1098"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://docs.microsoft.com/en-us/powershell/module/skype/get-csteamsclientconfiguration?view=skype-ps"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:(SkypeForBusiness or MicrosoftTeams) and\nevent.category:web and event.action:\"Set-CsTeamsClientConfiguration\" and\no365.audit.Parameters.AllowGuestUser:True and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"50e573e0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.265Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.282Z","created_by":"chaykovskiyv","name":"A scheduled task was updated [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Indicates the update of a scheduled task using Windows event logs. Adversaries can use these to establish persistence, by changing the configuration of a legit scheduled task. Some changes such as disabling or enabling a scheduled task are common and may may generate noise.","risk_score":21,"severity":"low","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Legitimate scheduled tasks may be created during installation of new software."],"from":"now-9m","rule_id":"7a0e0fd6-e45b-4616-82f5-37d21ad29e82","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1053/","name":"Scheduled Task/Job","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1053/005/","name":"Scheduled Task","id":"T1053.005"}],"id":"T1053"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4698"],"version":4,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"iam where event.action == \"scheduled-task-updated\" and\n\n /* excluding tasks created by the computer account */\n not user.name : \"*$\" and\n not winlog.event_data.TaskName :\n          (\"\\\\User_Feed_Synchronization-*\",\n           \"\\\\OneDrive Reporting Task-S-1-5-21*\",\n           \"\\\\OneDrive Reporting Task-S-1-12-1-*\",\n           \"\\\\Hewlett-Packard\\\\HP Web Products Detection\",\n           \"\\\\Hewlett-Packard\\\\HPDeviceCheck\")\n","throttle":"no_actions","actions":[]}
{"id":"fb6cc2c0-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.267Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.725Z","created_by":"burzhynskyyy","name":"Microsoft 365 Exchange Transport Rule Modification [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Configuration Audit"],"interval":"5m","enabled":true,"description":"Identifies when a transport rule has been disabled or deleted in Microsoft 365. Mail flow rules (also known as transport rules) are used to identify and take action on messages that flow through your organization. An adversary or insider threat may modify a transport rule to exfiltrate data or evade defenses.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["A transport rule may be modified by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."],"from":"now-30m","rule_id":"28fb5a67-16fd-41fd-992b-272ec2c74c1d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1537/","name":"Transfer Data to Cloud Account","id":"T1537"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0010/","name":"Exfiltration","id":"TA0010"}}],"to":"now","references":["https://docs.microsoft.com/en-us/powershell/module/exchange/remove-transportrule?view=exchange-ps","https://docs.microsoft.com/en-us/powershell/module/exchange/disable-transportrule?view=exchange-ps","https://docs.microsoft.com/en-us/exchange/security-and-compliance/mail-flow-rules/mail-flow-rules"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:(\"Remove-TransportRule\" or \"Disable-TransportRule\") and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"50e54cd0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T13:14:41.512Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.279Z","created_by":"chaykovskiyv","name":"A scheduled task was created [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Indicates the creation of a scheduled task using Windows event logs. Adversaries can use these to establish persistence, move laterally, and/or escalate privileges.","risk_score":21,"severity":"low","license":"Elastic License v2","output_index":"","meta":{"from":"4m"},"timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Legitimate scheduled tasks may be created during installation of new software."],"from":"now-540s","rule_id":"64d248e3-6999-4b34-91a6-1a1836b561f1","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"},"technique":[{"reference":"https://attack.mitre.org/techniques/T1053/","name":"Scheduled Task/Job","id":"T1053","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1053/005/","name":"Scheduled Task","id":"T1053.005"}]}]}],"to":"now","references":["https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4698"],"version":5,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"iam where event.action == \"scheduled-task-created\" and\n\n /* excluding tasks created by the computer account */\n not user.name : \"*$\" and\n\n /* TaskContent is not parsed, exclude by full taskname noisy ones */\n not winlog.event_data.TaskName :\n             (\"\\\\OneDrive Standalone Update Task-S-1-5-21*\",\n              \"\\\\OneDrive Standalone Update Task-S-1-12-1-*\",\n              \"\\\\Hewlett-Packard\\\\HP Web Products Detection\",\n              \"\\\\Hewlett-Packard\\\\HPDeviceCheck\",\n               \"\\\\Microsoft\\\\Windows\\\\RemoteApp and Desktop Connections Update*\")","filters":[],"throttle":"no_actions","actions":[]}
{"id":"4b6b0471-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.544Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.062Z","created_by":"chaykovskiyv","name":"Privileged Account Brute Force [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access"],"interval":"5m","enabled":true,"description":"Identifies multiple consecutive logon failures targeting an Admin account from the same source address and within a short time interval. Adversaries will often brute force login attempts across multiple users with a common or known password, in an attempt to gain access to accounts.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n#### Possible investigation steps\n\n- Investigate the logon failure reason code and the targeted user names.\n- Investigate the source IP address of the failed Network Logon attempts.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Identify the source and the target computer and their roles in the IT environment.\n\n### False positive analysis\n\n- Authentication misconfiguration or obsolete credentials.\n- Service account password expired.\n- Trust relationship between the primary domain and the trusted domain issue.\n- Infrastructure or availability issue.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the host is a domain controller (DC):\n  - Activate your incident response plan for total Active Directory compromise.\n  - Review the privileges assigned to users that can access the DCs, to ensure that the least privilege principle is being followed and to reduce the attack surface.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"c9672b83-d777-45e9-a891-c3cac7621ab5","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1110/","name":"Brute Force","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1110/001/","name":"Password Guessing","id":"T1110.001"},{"reference":"https://attack.mitre.org/techniques/T1110/003/","name":"Password Spraying","id":"T1110.003"}],"id":"T1110"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4625"],"version":3,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"sequence by winlog.computer_name, source.ip with maxspan=10s\n  [authentication where event.action == \"logon-failed\" and\n    winlog.logon.type : \"Network\" and\n    source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and user.name : \"*admin*\" and\n\n    /* noisy failure status codes often associated to authentication misconfiguration */\n    not winlog.event_data.Status : (\"0xC000015B\", \"0XC000005E\", \"0XC0000133\", \"0XC0000192\")] with runs=5\n","throttle":"no_actions","actions":[]}
{"id":"49b56530-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.533Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.208Z","created_by":"chaykovskiyv","name":"Component Object Model Hijacking [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies Component Object Model (COM) hijacking via registry modification. Adversaries may establish persistence by executing malicious content triggered by hijacked references to COM objects.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Component Object Model Hijacking\n\nAdversaries can insert malicious code that can be executed in place of legitimate software through hijacking the COM references and relationships as a means of persistence.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Retrieve the file referenced in the registry and determine if it is malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- Some Microsoft executables will reference the LocalServer32 registry key value for the location of external COM objects.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"6e3eae40-91fa-4ff2-b52d-3a37134d4162","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1546/","name":"Event Triggered Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1546/015/","name":"Component Object Model Hijacking","id":"T1546.015"}],"id":"T1546"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://bohops.com/2018/08/18/abusing-the-com-registry-structure-part-2-loading-techniques-for-evasion-and-persistence/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"registry where\n /* not necessary but good for filtering privileged installations */\n user.domain != \"NT AUTHORITY\" and\n\n(\n (registry.path : \"HK*\\\\InprocServer32\\\\\" and registry.data.strings: (\"scrobj.dll\", \"C:\\\\*\\\\scrobj.dll\") and\n  not registry.path : \"*\\\\{06290BD*-48AA-11D2-8432-006008C3FBFC}\\\\*\") or\n\n /* in general COM Registry changes on Users Hive is less noisy and worth alerting */\n (registry.path : (\"HKEY_USERS\\\\*\\\\InprocServer32\\\\*\",\n                   \"HKEY_USERS\\\\*\\\\LocalServer32\\\\*\",\n                   \"HKEY_USERS\\\\*\\\\DelegateExecute\\\\*\",\n                   \"HKEY_USERS\\\\*\\\\TreatAs\\\\*\",\n                   \"HKEY_USERS\\\\*\\\\ScriptletURL\\\\*\") and\n not (process.executable : \"?:\\\\Program Files*\\\\Veeam\\\\Backup and Replication\\\\Console\\\\veeam.backup.shell.exe\" and\n      registry.path : \"HKEY_USERS\\\\S-1-*_Classes\\\\CLSID\\\\*\\\\LocalServer32\\\\\")) or\n\n (registry.path : \"HKLM\\\\*\\\\InProcServer32\\\\*\" and registry.data.strings : (\"*\\\\Users\\\\*\", \"*\\\\ProgramData\\\\*\"))\n\n) and\n\n /* removes false-positives generated by OneDrive and Teams */\n not process.name : (\"OneDrive.exe\",\"OneDriveSetup.exe\",\"FileSyncConfig.exe\",\"Teams.exe\") and\n\n /* Teams DLL loaded by regsvr */\n not (process.name: \"regsvr32.exe\" and registry.data.strings : \"*Microsoft.Teams.*.dll\")\n","throttle":"no_actions","actions":[]}
{"id":"49b1bbb0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.189Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.168Z","created_by":"chaykovskiyv","name":"Process Termination followed by Deletion [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies a process termination event quickly followed by the deletion of its executable file. Malware tools and other non-native files dropped or created on a system by an adversary may leave traces to indicate to what occurred. Removal of these files can occur during an intrusion, or as part of a post-intrusion process to minimize the adversary's footprint.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"2aefc800-f42b-4c11-af72-4e68ac9a291d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1070/","name":"Indicator Removal","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1070/004/","name":"File Deletion","id":"T1070.004"}],"id":"T1070"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","endgame-*"],"query":"sequence by host.id with maxspan=5s\n   [process where event.type == \"end\" and\n    process.code_signature.trusted != true and\n    not process.executable : (\"C:\\\\Windows\\\\SoftwareDistribution\\\\*.exe\", \"C:\\\\Windows\\\\WinSxS\\\\*.exe\")\n   ] by process.executable\n   [file where event.type == \"deletion\" and file.extension : (\"exe\", \"scr\", \"com\") and\n    not process.executable :\n             (\"?:\\\\Program Files\\\\*.exe\",\n              \"?:\\\\Program Files (x86)\\\\*.exe\",\n              \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n              \"?:\\\\Windows\\\\System32\\\\drvinst.exe\") and\n    not file.path : (\"?:\\\\Program Files\\\\*.exe\", \"?:\\\\Program Files (x86)\\\\*.exe\")\n   ] by file.path\n","throttle":"no_actions","actions":[]}
{"id":"4836b470-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.189Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.640Z","created_by":"chaykovskiyv","name":"Potential Credential Access via Windows Utilities [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the execution of known Windows utilities often abused to dump LSASS memory or the Active Directory database (NTDS.dit) in preparation for credential access.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Potential Credential Access via Windows Utilities\n\nLocal Security Authority Server Service (LSASS) is a process in Microsoft Windows operating systems that is responsible for enforcing security policy on the system. It verifies users logging on to a Windows computer or server, handles password changes, and creates access tokens.\n\nThe `Ntds.dit` file is a database that stores Active Directory data, including information about user objects, groups, and group membership.\n\nThis rule looks for the execution of utilities that can extract credential data from the LSASS memory and Active Directory `Ntds.dit` file.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate abnormal behaviors observed by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the command line to identify what information was targeted.\n- Identify the target computer and its role in the IT environment.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the host is a domain controller (DC):\n  - Activate your incident response plan for total Active Directory compromise.\n  - Review the privileges assigned to users that can access the DCs, to ensure that the least privilege principle is being followed and to reduce the attack surface.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"87dc9494-58f8-4cd3-9239-59dc608d2f13","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/001/","name":"LSASS Memory","id":"T1003.001"},{"reference":"https://attack.mitre.org/techniques/T1003/003/","name":"NTDS","id":"T1003.003"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://lolbas-project.github.io/"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n(\n  /* update here with any new lolbas with dump capability */\n  (process.pe.original_file_name == \"procdump\" and process.args : \"-ma\") or\n  (process.name : \"ProcessDump.exe\" and not process.parent.executable regex~ \"\"\"C:\\\\Program Files( \\  (x86\\))?\\\\Cisco Systems\\\\.*\"\"\") or\n  (process.pe.original_file_name == \"WriteMiniDump.exe\" and not process.parent.executable regex~  \"\"\"C:\\\\Program Files( \\(x86\\))?\\\\Steam\\\\.*\"\"\") or\n  (process.pe.original_file_name == \"RUNDLL32.EXE\" and (process.args : \"MiniDump*\" or process.  command_line : \"*comsvcs.dll*#24*\")) or\n  (process.pe.original_file_name == \"RdrLeakDiag.exe\" and process.args : \"/fullmemdmp\") or\n  (process.pe.original_file_name == \"SqlDumper.exe\" and process.args : \"0x01100*\") or\n  (process.pe.original_file_name == \"TTTracer.exe\" and process.args : \"-dumpFull\" and process.args  : \"-attach\") or\n  (process.pe.original_file_name == \"ntdsutil.exe\" and process.args : \"create*full*\") or\n  (process.pe.original_file_name == \"diskshadow.exe\" and process.args : \"/s\")\n)\n","throttle":"no_actions","actions":[]}
{"id":"49b00e00-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.157Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.143Z","created_by":"chaykovskiyv","name":"Peripheral Device Discovery [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies use of the Windows file system utility (fsutil.exe) to gather information about attached peripheral devices and components connected to a computer system.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Peripheral Device Discovery\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `fsutil` utility with the `fsinfo` subcommand to enumerate drives attached to the computer, which can be used to identify secondary drives used for backups, mapped network drives, and removable media. These devices can contain valuable information for attackers.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Determine whether this activity was followed by suspicious file access/copy operations or uploads to file storage services.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"3c3f5a59-cf63-4354-9d3a-ca3e02232245","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1120/","name":"Peripheral Device Discovery","id":"T1120"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  (process.name : \"fsutil.exe\" or process.pe.original_file_name == \"fsutil.exe\") and\n  process.args : \"fsinfo\" and process.args : \"drives\"\n","throttle":"no_actions","actions":[]}
{"id":"4b697dd0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.513Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.044Z","created_by":"chaykovskiyv","name":"UAC Bypass via DiskCleanup Scheduled Task Hijack [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Identifies User Account Control (UAC) bypass via hijacking DiskCleanup Scheduled Task. Attackers bypass UAC to stealthily execute code with elevated permissions.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"2efb4b71-8054-4660-ac28-38009e22441b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1548/","name":"Abuse Elevation Control Mechanism","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1548/002/","name":"Bypass User Account Control","id":"T1548.002"}],"id":"T1548"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n process.args : \"/autoclean\" and process.args : \"/d\" and\n not process.executable : (\"C:\\\\Windows\\\\System32\\\\cleanmgr.exe\",\n                           \"C:\\\\Windows\\\\SysWOW64\\\\cleanmgr.exe\",\n                           \"C:\\\\Windows\\\\System32\\\\taskhostw.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"47bc7b60-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.192Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:05.847Z","created_by":"chaykovskiyv","name":"Incoming Execution via WinRM Remote Shell [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies remote execution via Windows Remote Management (WinRM) remote shell on a target host. This could be an indication of lateral movement.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":["WinRM is a dual-use protocol that can be used for benign or malicious activity. It's important to baseline your environment to determine the amount of noise to expect from this tool."],"from":"now-9m","rule_id":"47b7e9e6-0e30-4ef6-a0ce-90c69bfc3542","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1021/006/","name":"Windows Remote Management","id":"T1021.006"}],"id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by host.id with maxspan=30s\n   [network where process.pid == 4 and network.direction : (\"incoming\", \"ingress\") and\n    destination.port in (5985, 5986) and network.protocol == \"http\" and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n   ]\n   [process where event.type == \"start\" and process.parent.name : \"winrshost.exe\" and not process.name : \"conhost.exe\"]\n","throttle":"no_actions","actions":[]}
{"id":"4f2d63a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.163Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.397Z","created_by":"chaykovskiyv","name":"Potential LSASS Memory Dump via PssCaptureSnapShot [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Sysmon Only"],"interval":"5m","enabled":true,"description":"Identifies suspicious access to an LSASS handle via PssCaptureSnapShot where two successive process accesses are performed by the same process and target two different instances of LSASS. This may indicate an attempt to evade detection and dump LSASS memory for credential access.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"82be2d45-0ef4-4850-83cf-7e08f8a5e21e","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/001/","name":"LSASS Memory","id":"T1003.001"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://www.matteomalvica.com/blog/2019/12/02/win-defender-atp-cred-bypass/","https://twitter.com/sbousseaden/status/1280619931516747777?lang=en"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and event.code:10 and\n winlog.event_data.TargetImage:(\"C:\\\\Windows\\\\system32\\\\lsass.exe\" or\n                                 \"c:\\\\Windows\\\\system32\\\\lsass.exe\" or\n                                 \"c:\\\\Windows\\\\System32\\\\lsass.exe\")\n","threshold":{"field":["process.entity_id"],"value":2,"cardinality":[{"field":"winlog.event_data.TargetProcessId","value":2}]},"throttle":"no_actions","actions":[]}
{"id":"fb30f240-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.262Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.356Z","created_by":"burzhynskyyy","name":"Microsoft 365 Exchange Safe Attachment Rule Disabled [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Configuration Audit"],"interval":"5m","enabled":true,"description":"Identifies when a safe attachment rule is disabled in Microsoft 365. Safe attachment rules can extend malware protections to include routing all messages and attachments without a known malware signature to a special hypervisor environment. An adversary or insider threat may disable a safe attachment rule to exfiltrate data or evade defenses.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["A safe attachment rule may be disabled by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."],"from":"now-30m","rule_id":"216a1fa7-352d-4908-93b8-568fa7ab0a07","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://docs.microsoft.com/en-us/powershell/module/exchange/disable-safeattachmentrule?view=exchange-ps"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"Disable-SafeAttachmentRule\" and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"fb39f2f0-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.263Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.381Z","created_by":"burzhynskyyy","name":"Microsoft 365 Exchange Malware Filter Rule Modification [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Configuration Audit"],"interval":"5m","enabled":true,"description":"Identifies when a malware filter rule has been deleted or disabled in Microsoft 365. An adversary or insider threat may want to modify a malware filter rule to evade detection.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["A malware filter rule may be deleted by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."],"from":"now-30m","rule_id":"1317d548-5692-4d83-89b4-a1dbf0d12dfc","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://docs.microsoft.com/en-us/powershell/module/exchange/remove-malwarefilterrule?view=exchange-ps","https://docs.microsoft.com/en-us/powershell/module/exchange/disable-malwarefilterrule?view=exchange-ps"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:(\"Remove-MalwareFilterRule\" or \"Disable-MalwareFilterRule\") and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"49b27f00-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.200Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.177Z","created_by":"chaykovskiyv","name":"Windows Event Logs Cleared [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies attempts to clear Windows event log stores. This is often done by attackers in an attempt to evade detection or destroy forensic evidence on a system.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Windows Event Logs Cleared\n\nWindows event logs are a fundamental data source for security monitoring, forensics, and incident response. Adversaries can tamper, clear, and delete this data to break SIEM detections, cover their tracks, and slow down incident response.\n\nThis rule looks for the occurrence of clear actions on the `security` event log.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Verify if any other anti-forensics behaviors were observed.\n- Investigate the event logs prior to the action for suspicious behaviors that an attacker may be trying to cover up.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - This activity is potentially done after the adversary achieves its objectives on the host. Ensure that previous actions, if any, are investigated accordingly with their response playbooks.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic","Anabella Cristaldi"],"false_positives":[],"from":"now-9m","rule_id":"194a3bce-182a-4f7d-b785-493f94831abc","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1070/","name":"Indicator Removal","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1070/001/","name":"Clear Windows Event Logs","id":"T1070.001"}],"id":"T1070"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.action:(\"audit-log-cleared\" or \"Log clear\")\n","throttle":"no_actions","actions":[]}
{"id":"4f1e9690-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.167Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.306Z","created_by":"chaykovskiyv","name":"Group Policy Abuse for Privilege Addition [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Active Directory","Investigation Guide"],"interval":"5m","enabled":true,"description":"Detects the first occurrence of a modification to Group Policy Object Attributes to add privileges to user accounts or use them to add users as local admins.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Group Policy Abuse for Privilege Addition\n\nGroup Policy Objects (GPOs) can be used to add rights and/or modify Group Membership on GPOs by changing the contents of an INF file named GptTmpl.inf, which is responsible for storing every setting under the Security Settings container in the GPO. This file is unique for each GPO, and only exists if the GPO contains security settings. Example Path: \"\\\\DC.com\\SysVol\\DC.com\\Policies\\{PolicyGUID}\\Machine\\Microsoft\\Windows NT\\SecEdit\\GptTmpl.inf\"\n\n#### Possible investigation steps\n\n- This attack abuses a legitimate mechanism of Active Directory, so it is important to determine whether the activity is legitimate and the administrator is authorized to perform this operation.\n- Retrieve the contents of the `GptTmpl.inf` file, and under the `Privilege Rights` section, look for potentially dangerous high privileges, for example: SeTakeOwnershipPrivilege, SeEnableDelegationPrivilege, etc.\n- Inspect the user security identifiers (SIDs) associated with these privileges, and if they should have these privileges.\n\n### False positive analysis\n\n- Inspect whether the user that has done the modifications should be allowed to. The user name can be found in the `winlog.event_data.SubjectUserName` field.\n\n### Related rules\n\n- Scheduled Task Execution at Scale via GPO - 15a8ba77-1c13-4274-88fe-6bd14133861e\n- Startup/Logon Script added to Group Policy Object - 16fac1a1-21ee-4ca6-b720-458e3855d046\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- The investigation and containment must be performed in every computer controlled by the GPO, where necessary.\n- Remove the script from the GPO.\n- Check if other GPOs have suspicious scripts attached.","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-6m","rule_id":"ea7c4e59-5137-4efc-85eb-c7f277ac36f9","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1484/","name":"Domain Policy Modification","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1484/001/","name":"Group Policy Modification","id":"T1484.001"}],"id":"T1484"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0025_windows_audit_directory_service_changes.md","https://labs.f-secure.com/tools/sharpgpoabuse"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.code: \"5136\" and winlog.event_data.AttributeLDAPDisplayName:\"gPCMachineExtensionNames\" and\nwinlog.event_data.AttributeValue:(*827D319E-6EAC-11D2-A4EA-00C04F79F83A* and *803E14A0-B4FB-11D0-A0D0-00A0C90F574B*)\n","throttle":"no_actions","actions":[]}
{"id":"49b08330-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.155Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.148Z","created_by":"chaykovskiyv","name":"WebServer Access Logs Deleted [Duplicate]","tags":["Elastic","Host","Linux","Windows","macOS","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Identifies the deletion of WebServer access logs. This may indicate an attempt to evade detection or destroy forensic evidence on a system.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"6e4cd69c-2948-414c-8b69-380667c41b61","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1070/","name":"Indicator Removal","id":"T1070"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["auditbeat-*","winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"file where event.type == \"deletion\" and\n  file.path : (\"C:\\\\inetpub\\\\logs\\\\LogFiles\\\\*.log\",\n               \"/var/log/apache*/access.log\",\n               \"/etc/httpd/logs/access_log\",\n               \"/var/log/httpd/access_log\",\n               \"/var/www/*/logs/access.log\")\n","throttle":"no_actions","actions":[]}
{"id":"4b69a4e0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.516Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.048Z","created_by":"chaykovskiyv","name":"Microsoft IIS Connection Strings Decryption [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies use of aspnet_regiis to decrypt Microsoft IIS connection strings. An attacker with Microsoft IIS web server access via a webshell or alike can decrypt and dump any hardcoded connection strings, such as the MSSQL service account password using aspnet_regiis command.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"681dd41f-0e74-4d97-bcd9-26bc9066786e","max_signals":33,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://blog.netspi.com/decrypting-iis-passwords-to-break-out-of-the-dmz-part-1/","https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/greenbug-espionage-telco-south-asia"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  (process.name : \"aspnet_regiis.exe\" or process.pe.original_file_name == \"aspnet_regiis.exe\") and\n  process.args : \"connectionStrings\" and process.args : \"-pdf\"\n","throttle":"no_actions","actions":[]}
{"id":"fb7686c0-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.322Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.782Z","created_by":"burzhynskyyy","name":"Microsoft 365 Inbox Forwarding Rule Created [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Configuration Audit"],"interval":"5m","enabled":true,"description":"Identifies when a new Inbox forwarding rule is created in Microsoft 365. Inbox rules process messages in the Inbox based on conditions and take actions. In this case, the rules will forward the emails to a defined address. Attackers can abuse Inbox Rules to intercept and exfiltrate email data without making organization-wide configuration changes or having the corresponding privileges.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic","Gary Blackwell","Austin Songer"],"false_positives":["Users and Administrators can create inbox rules for legitimate purposes. Verify if it complies with the company policy and done with the user's consent. Exceptions can be added to this rule to filter expected behavior."],"from":"now-30m","rule_id":"04ecab82-5255-4ae8-bb5b-e01730844fbb","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1114/","name":"Email Collection","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1114/003/","name":"Email Forwarding Rule","id":"T1114.003"}],"id":"T1114"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0009/","name":"Collection","id":"TA0009"}}],"to":"now","references":["https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/responding-to-a-compromised-email-account?view=o365-worldwide","https://docs.microsoft.com/en-us/powershell/module/exchange/new-inboxrule?view=exchange-ps","https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/detect-and-remediate-outlook-rules-forms-attack?view=o365-worldwide","https://raw.githubusercontent.com/PwC-IR/Business-Email-Compromise-Guide/main/Extractor%20Cheat%20Sheet.pdf"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:Exchange and\nevent.category:web and event.action:(\"New-InboxRule\" or \"Set-InboxRule\") and\n    (\n        o365.audit.Parameters.ForwardTo:* or\n        o365.audit.Parameters.ForwardAsAttachmentTo:* or\n        o365.audit.Parameters.RedirectTo:*\n    )\n    and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"483c0ba0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.155Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.707Z","created_by":"chaykovskiyv","name":"High Number of Process and/or Service Terminations [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Impact","Investigation Guide"],"interval":"5m","enabled":true,"description":"This rule identifies a high number (10) of process terminations (stop, delete, or suspend) from the same host within a short time period.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating High Number of Process and/or Service Terminations\n\nAttackers can stop services and kill processes for a variety of purposes. For example, they can stop services associated with business applications and databases to release the lock on files used by these applications so they may be encrypted, or stop security and backup solutions, etc.\n\nThis rule identifies a high number (10) of service and/or process terminations (stop, delete, or suspend) from the same host within a short time period.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check if any files on the host machine have been encrypted.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further destructive behavior, which is commonly associated with this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system or restore it to the operational state.\n- If any other destructive action was identified on the host, it is recommended to prioritize the investigation and look for ransomware preparation and execution activities.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"25054d41-50da-4856-bbdb-4542311128ae","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1489/","name":"Service Stop","id":"T1489"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0040/","name":"Impact","id":"TA0040"}}],"to":"now","references":["https://www.elastic.co/security-labs/luna-ransomware-attack-pattern"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"event.category:process and event.type:start and process.name:(net.exe or sc.exe or taskkill.exe) and\n process.args:(stop or pause or delete or \"/PID\" or \"/IM\" or \"/T\" or \"/F\" or \"/t\" or \"/f\" or \"/im\" or \"/pid\")\n","threshold":{"field":["host.id"],"value":10},"throttle":"no_actions","actions":[]}
{"id":"4b6cd930-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.604Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.081Z","created_by":"chaykovskiyv","name":"Suspicious Script Object Execution [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Identifies scrobj.dll loaded into unusual Microsoft processes. This usually means a malicious scriptlet is being executed in the target process.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"b0a0b52e-4309-4ddc-a33f-352799899152","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1218/","name":"System Binary Proxy Execution","id":"T1218"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"sequence by process.entity_id with maxspan=2m\n  [process where event.type == \"start\"\n   and (process.code_signature.subject_name in (\"Microsoft Corporation\", \"Microsoft Windows\") and\n   process.code_signature.trusted == true) and\n     not process.executable : (\n       \"?:\\\\Windows\\\\System32\\\\cscript.exe\",\n       \"?:\\\\Windows\\\\SysWOW64\\\\cscript.exe\",\n       \"?:\\\\Program Files (x86)\\\\Internet Explorer\\\\iexplore.exe\",\n       \"?:\\\\Program Files\\\\Internet Explorer\\\\iexplore.exe\",\n       \"?:\\\\Windows\\\\SystemApps\\\\Microsoft.MicrosoftEdge_*\\\\MicrosoftEdge.exe\",\n       \"?:\\\\Windows\\\\system32\\\\msiexec.exe\",\n       \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n       \"?:\\\\Windows\\\\System32\\\\smartscreen.exe\",\n       \"?:\\\\Windows\\\\system32\\\\taskhostw.exe\",\n       \"?:\\\\windows\\\\system32\\\\inetsrv\\\\w3wp.exe\",\n       \"?:\\\\windows\\\\SysWOW64\\\\inetsrv\\\\w3wp.exe\",\n       \"?:\\\\Windows\\\\system32\\\\wscript.exe\",\n       \"?:\\\\Windows\\\\SysWOW64\\\\wscript.exe\",\n       \"?:\\\\Windows\\\\system32\\\\mobsync.exe\",\n       \"?:\\\\Windows\\\\SysWOW64\\\\mobsync.exe\",\n       \"?:\\\\Windows\\\\System32\\\\cmd.exe\",\n       \"?:\\\\Windows\\\\SysWOW64\\\\cmd.exe\")]\n  [library where event.type == \"start\" and dll.name : \"scrobj.dll\"]\n","throttle":"no_actions","actions":[]}
{"id":"4d55bd70-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.015Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.291Z","created_by":"chaykovskiyv","name":"Whoami Process Activity [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies suspicious use of whoami.exe which displays user, group, and privileges information for the user who is currently logged on to the local system.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Whoami Process Activity\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `whoami` utility. Attackers commonly use this utility to measure their current privileges, discover the current user, determine if a privilege escalation was successful, etc.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Related rules\n\n- Account Discovery Command via SYSTEM Account - 2856446a-34e6-435b-9fb5-f8f040bfa7ed\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Some normal use of this program, at varying levels of frequency, may originate from scripts, automation tools and frameworks. Usage by non-engineers and ordinary users is unusual."],"from":"now-9m","rule_id":"73fdef3b-db13-48c3-8d95-70f52b37b1eb","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1033/","name":"System Owner/User Discovery","id":"T1033"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}}],"to":"now","references":[],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","logs-system.*","endgame-*"],"query":"process where event.type == \"start\" and process.name : \"whoami.exe\" and\n(\n\n (/* scoped for whoami execution under system privileges */\n  (user.domain : (\"NT AUTHORITY\", \"NT-AUTORITÄT\", \"AUTORITE NT\", \"IIS APPPOOL\") or user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\")) and\n\n   not (process.parent.name : \"cmd.exe\" and\n        process.parent.args : (\"chcp 437>nul 2>&1 & C:\\\\WINDOWS\\\\System32\\\\whoami.exe  /groups\",\n                               \"chcp 437>nul 2>&1 & %systemroot%\\\\system32\\\\whoami /user\",\n                               \"C:\\\\WINDOWS\\\\System32\\\\whoami.exe /groups\",\n                               \"*WINDOWS\\\\system32\\\\config\\\\systemprofile*\")) and\n   not (process.parent.executable : \"C:\\\\Windows\\\\system32\\\\inetsrv\\\\appcmd.exe\" and process.parent.args : \"LIST\") and\n   not process.parent.executable : (\"C:\\\\Program Files\\\\Microsoft Monitoring Agent\\\\Agent\\\\MonitoringHost.exe\",\n                                    \"C:\\\\Program Files\\\\Cohesity\\\\cohesity_windows_agent_service.exe\")) or\n\n  process.parent.name : (\"wsmprovhost.exe\", \"w3wp.exe\", \"wmiprvse.exe\", \"rundll32.exe\", \"regsvr32.exe\")\n\n)\n","throttle":"no_actions","actions":[]}
{"id":"4b69f300-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.529Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.051Z","created_by":"chaykovskiyv","name":"Unusual Child Process from a System Virtual Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies a suspicious child process of the Windows virtual system process, which could indicate code injection.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"2c687bfb-bec2-46d1-8a42-fa293b29da8c","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1055/","name":"Process Injection","id":"T1055"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.parent.pid == 4 and\n  not process.executable : (\"Registry\", \"MemCompression\", \"?:\\\\Windows\\\\System32\\\\smss.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"483b4850-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.179Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.701Z","created_by":"chaykovskiyv","name":"Potential Command and Control via Internet Explorer [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Command and Control"],"interval":"5m","enabled":true,"description":"Identifies instances of Internet Explorer (iexplore.exe) being started via the Component Object Model (COM) making unusual network connections. Adversaries could abuse Internet Explorer via COM to avoid suspicious processes making network connections and bypass host-based firewall restrictions.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":["Processes such as MS Office using IEproxy to render HTML content."],"from":"now-9m","rule_id":"e2b9f243-372e-4686-ae0e-9dd0a86ee617","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1071/","name":"Application Layer Protocol","id":"T1071"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0011/","name":"Command and Control","id":"TA0011"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1559/","name":"Inter-Process Communication","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1559/001/","name":"Component Object Model","id":"T1559.001"}],"id":"T1559"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by host.id, user.name with maxspan = 5s\n  [library where dll.name : \"IEProxy.dll\" and process.name : (\"rundll32.exe\", \"regsvr32.exe\")]\n  [process where event.type == \"start\" and process.parent.name : \"iexplore.exe\" and process.parent.args : \"-Embedding\"]\n  /* IE started via COM in normal conditions makes few connections, mainly to Microsoft and OCSP related domains, add FPs here */\n  [network where network.protocol == \"dns\" and process.name : \"iexplore.exe\" and\n   not dns.question.name :\n   (\n    \"*.microsoft.com\",\n    \"*.digicert.com\",\n    \"*.msocsp.com\",\n    \"*.windowsupdate.com\",\n    \"*.bing.com\",\n    \"*.identrust.com\",\n    \"*.sharepoint.com\",\n    \"*.office365.com\",\n    \"*.office.com\"\n    )\n  ] /* with runs=5 */\n","throttle":"no_actions","actions":[]}
{"id":"50e63730-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.272Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.294Z","created_by":"chaykovskiyv","name":"Process Creation via Secondary Logon [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Identifies process creation with alternate credentials. Adversaries may create a new process with a different token to escalate privileges and bypass access controls.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"9c270fa0-9407-481e-8f3f-10423ad658ed","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1134/","name":"Access Token Manipulation","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1134/002/","name":"Create Process with Token","id":"T1134.002"},{"reference":"https://attack.mitre.org/techniques/T1134/003/","name":"Make and Impersonate Token","id":"T1134.003"}],"id":"T1134"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://attack.mitre.org/techniques/T1134/002/"],"version":4,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"sequence by winlog.computer_name with maxspan=1m\n\n[authentication where event.action:\"logged-in\" and\n event.outcome == \"success\" and user.id : (\"S-1-5-21-*\", \"S-1-12-1-*\") and\n\n /* seclogon service */\n process.name == \"svchost.exe\" and\n winlog.event_data.LogonProcessName : \"seclogo*\" and source.ip == \"::1\" ] by winlog.event_data.TargetLogonId\n\n[process where event.type == \"start\"] by winlog.event_data.TargetLogonId\n","throttle":"no_actions","actions":[]}
{"id":"4d580760-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.038Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.321Z","created_by":"chaykovskiyv","name":"Suspicious Process Creation CallTrace [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Sysmon Only"],"interval":"5m","enabled":true,"description":"Identifies when a process is created and immediately accessed from an unknown memory code region and by the same parent process. This may indicate a code injection attempt.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Suspicious Process Creation CallTrace\n\nAttackers may inject code into child processes' memory to hide their actual activity, evade detection mechanisms, and decrease discoverability during forensics. This rule looks for a spawned process by Microsoft Office, scripting, and command line applications, followed by a process access event for an unknown memory region by the parent process, which can indicate a code injection attempt.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Create a memory dump of the child process for analysis.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"4f3535fe-10fd-4d10-816a-22c1aa4925d5","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1055/","name":"Process Injection","id":"T1055"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-windows.*"],"query":"sequence by host.id with maxspan=1m\n  [process where event.code == \"1\" and\n   /* sysmon process creation */\n   process.parent.name : (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\", \"eqnedt32.exe\", \"fltldr.exe\",\n                          \"mspub.exe\", \"msaccess.exe\",\"cscript.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\",\n                          \"mshta.exe\", \"wmic.exe\", \"cmstp.exe\", \"msxsl.exe\") and\n\n   /* noisy FP patterns */\n   not (process.parent.name : \"EXCEL.EXE\" and process.executable : \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\Office*\\\\ADDINS\\\\*.exe\") and\n   not (process.executable : \"?:\\\\Windows\\\\splwow64.exe\" and process.args in (\"8192\", \"12288\") and process.parent.name : (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\")) and\n   not (process.parent.name : \"rundll32.exe\" and process.parent.args : (\"?:\\\\WINDOWS\\\\Installer\\\\MSI*.tmp,zzzzInvokeManagedCustomActionOutOfProc\", \"--no-sandbox\")) and\n   not (process.executable :\n            (\"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeWebView\\\\Application\\\\*\\\\msedgewebview2.exe\",\n             \"?:\\\\Program Files\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\Acrobat.exe\",\n             \"?:\\\\Windows\\\\SysWOW64\\\\DWWIN.EXE\") and\n        process.parent.name : (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\")) and\n   not (process.parent.name : \"regsvr32.exe\" and process.parent.args : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\"))\n   ] by process.parent.entity_id, process.entity_id\n  [process where event.code == \"10\" and\n   /* Sysmon process access event from unknown module */\n   winlog.event_data.CallTrace : \"*UNKNOWN*\"] by process.entity_id, winlog.event_data.TargetProcessGUID\n","throttle":"no_actions","actions":[]}
{"id":"52b32f00-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:33.331Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.286Z","created_by":"chaykovskiyv","name":"Ingress Transfer via Windows BITS [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Command and Control"],"interval":"5m","enabled":true,"description":"Identifies downloads of executable and archive files via the Windows Background Intelligent Transfer Service (BITS). Adversaries could leverage Windows BITS transfer jobs to download remote payloads.","risk_score":21,"severity":"low","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"72c48d5d-bccc-4616-a196-127889675c2a","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1105/","name":"Ingress Tool Transfer","id":"T1105"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0011/","name":"Command and Control","id":"TA0011"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1197/","name":"BITS Jobs","id":"T1197"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://attack.mitre.org/techniques/T1197/"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"file where event.action == \"rename\" and \n\nprocess.name : \"svchost.exe\" and file.Ext.original.name : \"BIT*.tmp\" and \n (file.extension :(\"exe\", \"zip\", \"rar\", \"bat\", \"dll\", \"ps1\", \"vbs\", \"wsh\", \"js\", \"vbe\", \"pif\", \"scr\", \"cmd\", \"cpl\") or file.Ext.header_bytes : \"4d5a*\") and \n \n /* noisy paths, for hunting purposes you can use the same query without the following exclusions */\n not file.path : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\", \"?:\\\\Windows\\\\*\", \"?:\\\\ProgramData\\\\*\\\\*\") and \n \n /* lot of third party SW use BITS to download executables with a long file name */\n not length(file.name) > 30\n","throttle":"no_actions","actions":[]}
{"id":"49b0aa40-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.184Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.150Z","created_by":"chaykovskiyv","name":"Incoming DCOM Lateral Movement via MSHTA [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies the use of Distributed Component Object Model (DCOM) to execute commands from a remote host, which are launched via the HTA Application COM Object. This behavior may indicate an attacker abusing a DCOM application to move laterally while attempting to evade detection.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"06ec6c97-10bb-4e8d-ae70-d4494c142145","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1021/003/","name":"Distributed Component Object Model","id":"T1021.003"}],"id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1218/","name":"System Binary Proxy Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1218/005/","name":"Mshta","id":"T1218.005"}],"id":"T1218"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://codewhitesec.blogspot.com/2018/07/lethalhta.html"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence with maxspan=1m\n  [process where event.type == \"start\" and\n     process.name : \"mshta.exe\" and process.args : \"-Embedding\"\n  ] by host.id, process.entity_id\n  [network where event.type == \"start\" and process.name : \"mshta.exe\" and\n     network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n     source.port > 49151 and destination.port > 49151 and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n  ] by host.id, process.entity_id\n","throttle":"no_actions","actions":[]}
{"id":"4840eda0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.193Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.751Z","created_by":"chaykovskiyv","name":"Privilege Escalation via Windir Environment Variable [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Identifies a privilege escalation attempt via a rogue Windows directory (Windir) environment variable. This is a known primitive that is often combined with other vulnerabilities to elevate privileges.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"49a6d330-e876-42b9-be5a-8596fbe0fb3b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1574/","name":"Hijack Execution Flow","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1574/007/","name":"Path Interception by PATH Environment Variable","id":"T1574.007"}],"id":"T1574"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://www.tiraniddo.dev/2017/05/exploiting-environment-variables-in.html"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"registry where registry.path : (\"HKEY_USERS\\\\*\\\\Environment\\\\windir\", \"HKEY_USERS\\\\*\\\\Environment\\\\systemroot\") and\n not registry.data.strings : (\"C:\\\\windows\", \"%SystemRoot%\")\n","throttle":"no_actions","actions":[]}
{"id":"94528000-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.839Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.335Z","created_by":"chaykovskiyv","name":"FirstTime Seen Account Performing DCSync [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Active Directory"],"interval":"5m","enabled":true,"description":"This rule identifies when a User Account starts the Active Directory Replication Process for the first time. Attackers can use the DCSync technique to get credential information of individual accounts or the entire domain, thus compromising the entire domain.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"3e72e13f-7ca3-416c-b48e-752442e3b11b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/006/","name":"DCSync","id":"T1003.006"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://threathunterplaybook.com/notebooks/windows/06_credential_access/WIN-180815210510.html","https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing","https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_ad_replication_non_machine_account.yml","https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0027_windows_audit_directory_service_access.md","https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync","https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"new_terms","query":"event.action : \"Directory Service Access\" and event.code : \"4662\" and \n winlog.event_data.Properties : (*DS-Replication-Get-Changes* or *DS-Replication-Get-Changes-All* or *DS-Replication-Get-Changes-In-Filtered-Set* or *1131f6ad-9c07-11d1-f79f-00c04fc2dcd2* or *1131f6aa-9c07-11d1-f79f-00c04fc2dcd2* or *89e95b76-444d-4c62-991a-0facbeda640c*) and \n not winlog.event_data.SubjectUserName : (*$ or MSOL_*)\n","new_terms_fields":["winlog.event_data.SubjectUserName"],"history_window_start":"now-15d","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"language":"kuery","throttle":"no_actions","actions":[]}
{"id":"e3735630-d265-11ed-b6f4-dfeac9073248","updated_at":"2023-06-08T21:29:33.488Z","updated_by":"burzhynskyyy","created_at":"2023-04-03T21:24:17.808Z","created_by":"burzhynskyyy","name":"Mass file deletion detected","tags":["Custom Rules"],"interval":"5m","enabled":true,"description":"Зафіксовано видалення 10 або більше файлів одним користувачем за останні 30 хвилин","risk_score":47,"severity":"medium","license":"","output_index":"","meta":{"from":"25m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-1800s","rule_id":"024bb4c9-92e3-4ee1-a7a3-ff65e417f201","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"event.module:\"o365\" and  event.provider:\"SharePoint\" and event.action:\"FileDeleted\"","filters":[],"threshold":{"field":["user.id"],"value":10,"cardinality":[{"field":"file.name","value":10}]},"throttle":"no_actions","actions":[]}
{"id":"945258f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.840Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.332Z","created_by":"chaykovskiyv","name":"Potential Credential Access via DCSync [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Active Directory","Investigation Guide"],"interval":"5m","enabled":true,"description":"This rule identifies when a User Account starts the Active Directory Replication Process. Attackers can use the DCSync technique to get credential information of individual accounts or the entire domain, thus compromising the entire domain.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Potential Credential Access via DCSync\n\nActive Directory replication is the process by which the changes that originate on one domain controller are automatically transferred to other domain controllers that store the same data.\n\nActive Directory data consists of objects that have properties, or attributes. Each object is an instance of an object class, and object classes and their respective attributes are defined in the Active Directory schema. Objects are defined by the values of their attributes, and changes to attribute values must be transferred from the domain controller on which they occur to every other domain controller that stores a replica of an affected object.\n\nAdversaries can use the DCSync technique that uses Windows Domain Controller's API to simulate the replication process from a remote domain controller, compromising major credential material such as the Kerberos krbtgt keys used legitimately for tickets creation, but also tickets forging by attackers. This attack requires some extended privileges to succeed (DS-Replication-Get-Changes and DS-Replication-Get-Changes-All), which are granted by default to members of the Administrators, Domain Admins, Enterprise Admins, and Domain Controllers groups. Privileged accounts can be abused to grant controlled objects the right to DCsync/Replicate.\n\nMore details can be found on [Threat Hunter Playbook](https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing) and [The Hacker Recipes](https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync).\n\nThis rule monitors for Event ID 4662 (Operation was performed on an Active Directory object) and identifies events that use the access mask 0x100 (Control Access) and properties that contain at least one of the following or their equivalent: Schema-Id-GUID (DS-Replication-Get-Changes, DS-Replication-Get-Changes-All, DS-Replication-Get-Changes-In-Filtered-Set). It also filters out events that use computer accounts and also Azure AD Connect MSOL accounts (more details [here](https://techcommunity.microsoft.com/t5/microsoft-defender-for-identity/ad-connect-msol-user-suspected-dcsync-attack/m-p/788028)).\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Correlate security events 4662 and 4624 (Logon Type 3) by their Logon ID (`winlog.logon.id`) on the Domain Controller (DC) that received the replication request. This will tell you where the AD replication request came from, and if it came from another DC or not.\n- Scope which credentials were compromised (for example, whether all accounts were replicated or specific ones).\n\n### False positive analysis\n\n- Administrators may use custom accounts on Azure AD Connect, investigate if it is the case, and if it is properly secured. If noisy in your environment due to expected activity, consider adding the corresponding account as a exception.\n- Although replicating Active Directory (AD) data to non-Domain Controllers is not a common practice and is generally not recommended from a security perspective, some software vendors may require it for their products to function correctly. If this rule is noisy in your environment due to expected activity, consider adding the corresponding account as a exception.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If specific credentials were compromised:\n  - Reset the password for these accounts and other potentially compromised credentials, like email, business systems, and web services.\n- If the entire domain or the `krbtgt` user were compromised:\n  - Activate your incident response plan for total Active Directory compromise which should include, but not be limited to, a password reset (twice) of the `krbtgt` user.\n- Investigate how the attacker escalated privileges and identify systems they used to conduct lateral movement. Use this information to scope ways that the attacker could use to regain access to the environment.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"da4814ac-af1b-4a93-aff5-d39b2dc20785","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/006/","name":"DCSync","id":"T1003.006"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://threathunterplaybook.com/notebooks/windows/06_credential_access/WIN-180815210510.html","https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing","https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_ad_replication_non_machine_account.yml","https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0027_windows_audit_directory_service_access.md","https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync","https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"any where event.action == \"Directory Service Access\" and\n  event.code == \"4662\" and winlog.event_data.Properties : (\n\n    /* Control Access Rights/Permissions Symbol */\n\n    \"*DS-Replication-Get-Changes*\",\n    \"*DS-Replication-Get-Changes-All*\",\n    \"*DS-Replication-Get-Changes-In-Filtered-Set*\",\n\n    /* Identifying GUID used in ACE */\n\n    \"*1131f6ad-9c07-11d1-f79f-00c04fc2dcd2*\",\n    \"*1131f6aa-9c07-11d1-f79f-00c04fc2dcd2*\",\n    \"*89e95b76-444d-4c62-991a-0facbeda640c*\")\n\n    /* The right to perform an operation controlled by an extended access right. */\n\n    and winlog.event_data.AccessMask : \"0x100\" and\n    not winlog.event_data.SubjectUserName : (\"*$\", \"MSOL_*\", \"OpenDNS_Connector\")\n\n    /* The Umbrella AD Connector uses the OpenDNS_Connector account to perform replication */\n","throttle":"no_actions","actions":[]}
{"id":"49cbac50-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.546Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.280Z","created_by":"chaykovskiyv","name":"Suspicious PrintSpooler Service Executable File Creation [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Detects attempts to exploit privilege escalation vulnerabilities related to the Print Spooler service. For more information refer to the following CVE's - CVE-2020-1048, CVE-2020-1337 and CVE-2020-1300 and verify that the impacted system is patched.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"fa5fc66b-5033-4d7c-a367-d01867467ba2","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1068/","name":"Exploitation for Privilege Escalation","id":"T1068"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://voidsec.com/cve-2020-1337-printdemon-is-dead-long-live-printdemon/","https://www.thezdi.com/blog/2020/7/8/cve-2020-1300-remote-code-execution-through-microsoft-windows-cab-files"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"file where event.type == \"creation\" and\n  process.name : \"spoolsv.exe\" and file.extension : \"dll\" and\n  file.path : (\"?:\\\\Windows\\\\System32\\\\*\", \"?:\\\\Windows\\\\SysWOW64\\\\*\") and\n  not file.path :\n          (\"?:\\\\WINDOWS\\\\SysWOW64\\\\PrintConfig.dll\",\n           \"?:\\\\WINDOWS\\\\system32\\\\x5lrs.dll\",\n           \"?:\\\\WINDOWS\\\\sysWOW64\\\\x5lrs.dll\",\n           \"?:\\\\WINDOWS\\\\system32\\\\PrintConfig.dll\")\n","throttle":"no_actions","actions":[]}
{"id":"4d53e8b0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.270Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.273Z","created_by":"chaykovskiyv","name":"Suspicious DLL Loaded for Persistence or Privilege Escalation [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Privilege Escalation","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies the loading of a non Microsoft signed DLL that is missing on a default Windows install (phantom DLL) or one that can be loaded from a different location by a native Windows process. This may be abused to persist or elevate privileges via privileged file write vulnerabilities.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Suspicious DLL Loaded for Persistence or Privilege Escalation\n\nAttackers can execute malicious code by abusing missing modules that processes try to load, enabling them to escalate privileges or gain persistence. This rule identifies the loading of a non-Microsoft-signed DLL that is missing on a default Windows installation or one that can be loaded from a different location by a native Windows process.\n\n#### Possible investigation steps\n\n- Examine the DLL signature and identify the process that created it.\n  - Investigate any abnormal behaviors by the process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve the DLL and determine if it is malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"8ee68cae-4ad8-48af-850d-4dab13bc40b3","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1574/","name":"Hijack Execution Flow","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1574/002/","name":"DLL Side-Loading","id":"T1574.002"}],"id":"T1574"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1574/","name":"Hijack Execution Flow","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1574/001/","name":"DLL Search Order Hijacking","id":"T1574.001"}],"id":"T1574"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://itm4n.github.io/windows-dll-hijacking-clarified/","http://remoteawesomethoughts.blogspot.com/2019/05/windows-10-task-schedulerservice.html","https://googleprojectzero.blogspot.com/2018/04/windows-exploitation-tricks-exploiting.html","https://shellz.club/2020/10/16/edgegdi-dll-for-persistence-and-lateral-movement.html","https://windows-internals.com/faxing-your-way-to-system/","http://waleedassar.blogspot.com/2013/01/wow64logdll.html"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"any where\n (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n (\n  /* compatible with Elastic Endpoint Library Events */\n  (dll.name : (\"wlbsctrl.dll\", \"wbemcomn.dll\", \"WptsExtensions.dll\", \"Tsmsisrv.dll\", \"TSVIPSrv.dll\", \"Msfte.dll\",\n               \"wow64log.dll\", \"WindowsCoreDeviceInfo.dll\", \"Ualapi.dll\", \"wlanhlp.dll\", \"phoneinfo.dll\", \"EdgeGdi.dll\",\n               \"cdpsgshims.dll\", \"windowsperformancerecordercontrol.dll\", \"diagtrack_win.dll\", \"oci.dll\", \"TPPCOIPW32.dll\", \n               \"tpgenlic.dll\", \"thinmon.dll\", \"fxsst.dll\", \"msTracer.dll\")\n   and (dll.code_signature.trusted == false or dll.code_signature.exists == false)) or\n\n  /* compatible with Sysmon EventID 7 - Image Load */\n  (file.name : (\"wlbsctrl.dll\", \"wbemcomn.dll\", \"WptsExtensions.dll\", \"Tsmsisrv.dll\", \"TSVIPSrv.dll\", \"Msfte.dll\",\n               \"wow64log.dll\", \"WindowsCoreDeviceInfo.dll\", \"Ualapi.dll\", \"wlanhlp.dll\", \"phoneinfo.dll\", \"EdgeGdi.dll\",\n               \"cdpsgshims.dll\", \"windowsperformancerecordercontrol.dll\", \"diagtrack_win.dll\", \"oci.dll\", \"TPPCOIPW32.dll\", \n               \"tpgenlic.dll\", \"thinmon.dll\", \"fxsst.dll\", \"msTracer.dll\")\n   and not file.code_signature.status == \"Valid\")\n  )\n","throttle":"no_actions","actions":[]}
{"id":"4f2a0840-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.132Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.354Z","created_by":"chaykovskiyv","name":"Potential Remote Credential Access via Registry [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement","Credential Access","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies remote access to the registry to potentially dump credential data from the Security Account Manager (SAM) registry hive in preparation for credential access and privileges elevation.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Potential Remote Credential Access via Registry\n\nDumping registry hives is a common way to access credential information. Some hives store credential material, such as the SAM hive, which stores locally cached credentials (SAM secrets), and the SECURITY hive, which stores domain cached credentials (LSA secrets). Dumping these hives in combination with the SYSTEM hive enables the attacker to decrypt these secrets.\n\nAttackers can use tools like secretsdump.py or CrackMapExec to dump the registry hives remotely, and use dumped credentials to access other systems in the domain.\n\n#### Possible investigation steps\n\n- Identify the specifics of the involved assets, such as their role, criticality, and associated users.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Determine the privileges of the compromised accounts.\n- Investigate other alerts associated with the user/source host during the past 48 hours.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (e.g., 4624) to the target host.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Related rules\n\n- Credential Acquisition via Registry Hive Dumping - a7e7bfa3-088e-4f13-b29e-3986e0e756b8\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine if other hosts were compromised.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Ensure that the machine has the latest security updates and is not running unsupported Windows versions.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"e4868cdb-76b1-4d20-add5-479d2f2db24c","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/002/","name":"Security Account Manager","id":"T1003.002"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":["https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py","https://www.elastic.co/security-labs/detect-credential-access"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-endpoint.events.*"],"query":"sequence by host.id, user.id with maxspan=1m\n [authentication where\n   event.outcome == \"success\" and event.action == \"logged-in\" and\n   winlog.logon.type == \"Network\" and not user.name == \"ANONYMOUS LOGON\" and\n   not user.domain == \"NT AUTHORITY\" and source.ip != \"127.0.0.1\" and source.ip !=\"::1\"]\n [file where event.action == \"creation\" and process.name : \"svchost.exe\" and\n  file.Ext.header_bytes : \"72656766*\" and user.id : (\"S-1-5-21-*\", \"S-1-12-1-*\") and file.size >= 30000 and\n  not file.path :\n           (\"?:\\\\Windows\\\\system32\\\\HKEY_LOCAL_MACHINE_SOFTWARE_Microsoft_*.registry\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\UsrClass.dat.LOG?\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\UsrClass.dat\",\n            \"?:\\\\Users\\\\*\\\\ntuser.dat.LOG?\",\n            \"?:\\\\Users\\\\*\\\\NTUSER.DAT\")]\n","throttle":"no_actions","actions":[]}
{"id":"484114b0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.178Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.767Z","created_by":"chaykovskiyv","name":"Remote File Download via Script Interpreter [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Command and Control","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies built-in Windows script interpreters (cscript.exe or wscript.exe) being used to download an executable file from a remote destination.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Remote File Download via Script Interpreter\n\nThe Windows Script Host (WSH) is a Windows automation technology, which is ideal for non-interactive scripting needs, such as logon scripting, administrative scripting, and machine automation.\n\nAttackers commonly use WSH scripts as their initial access method, acting like droppers for second stage payloads, but can also use them to download tools and utilities needed to accomplish their goals.\n\nThis rule looks for DLLs and executables downloaded using `cscript.exe` or `wscript.exe`.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze both the script and the executable involved using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- The usage of these script engines by regular users is unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"3b483407-fcdd-4741-8398-7f9f9e38e3d1","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1105/","name":"Ingress Tool Transfer","id":"T1105"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0011/","name":"Command and Control","id":"TA0011"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by host.id, process.entity_id\n  [network where process.name : (\"wscript.exe\", \"cscript.exe\") and network.protocol != \"dns\" and\n   network.direction : (\"outgoing\", \"egress\") and network.type == \"ipv4\" and destination.ip != \"127.0.0.1\"\n  ]\n  [file where event.type == \"creation\" and file.extension : (\"exe\", \"dll\")]\n","throttle":"no_actions","actions":[]}
{"id":"49b4c8f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.527Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.199Z","created_by":"chaykovskiyv","name":"Startup or Run Key Registry Modification [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies run key or startup key registry modifications. In order to survive reboots and other system interrupts, attackers will modify run keys within the registry or leverage startup folder items as a form of persistence.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Startup or Run Key Registry Modification\n\nAdversaries may achieve persistence by referencing a program with a registry run key. Adding an entry to the run keys in the registry will cause the program referenced to be executed when a user logs in. These programs will executed under the context of the user and will have the account's permissions. This rule looks for this behavior by monitoring a range of registry run keys.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- There is a high possibility of benign legitimate programs being added to registry run keys. This activity could be based on new software installations, patches, or any kind of network administrator related activity. Before undertaking further investigation, verify that this activity is not benign.\n\n### Related rules\n\n- Suspicious Startup Shell Folder Modification - c8b150f0-0164-475b-a75e-74b47800a9ff\n- Persistent Scripts in the Startup Directory - f7c4dc5a-a58d-491d-9f14-9b66507121c0\n- Startup Folder Persistence via Unsigned Process - 2fba96c0-ade5-4bce-b92f-a5df2509da3f\n- Startup Persistence by a Suspicious Process - 440e2db4-bc7f-4c96-a068-65b78da59bde\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","timeline_id":"3e47ef71-ebfc-4520-975c-cb27fc090799","timeline_title":"Comprehensive Registry Timeline","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"37a65b44-f5a2-4677-86cd-f53ba1df647d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1547/001/","name":"Registry Run Keys / Startup Folder","id":"T1547.001"}],"id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"registry where registry.data.strings != null and\n registry.path : (\n     /* Machine Hive */\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\\\\*\",\n     /* Users Hive */\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\\\\*\"\n     ) and\n  /* add common legitimate changes without being too restrictive as this is one of the most abused AESPs */\n  not registry.data.strings : \"ctfmon.exe /n\" and\n  not (registry.value : \"Application Restart #*\" and process.name : \"csrss.exe\") and\n  user.id not in (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n  not registry.data.strings : (\"?:\\\\Program Files\\\\*.exe\", \"?:\\\\Program Files (x86)\\\\*.exe\") and\n  not process.executable : (\"?:\\\\Windows\\\\System32\\\\msiexec.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\") and\n  not (process.name : \"OneDriveSetup.exe\" and\n       registry.value : (\"Delete Cached Standalone Update Binary\", \"Delete Cached Update Binary\", \"amd64\", \"Uninstall *\") and\n       registry.data.strings : \"?:\\\\Windows\\\\system32\\\\cmd.exe /q /c * \\\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\*\\\"\")\n","throttle":"no_actions","actions":[]}
{"id":"49b69db0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.543Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.230Z","created_by":"chaykovskiyv","name":"Suspicious Process Execution via Renamed PsExec Executable [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies suspicious psexec activity which is executing from the psexec service that has been renamed, possibly to evade detection.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"aa17a117-7784-4b6d-8f03-382749cb4c85","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1569/","name":"System Services","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1569/002/","name":"Service Execution","id":"T1569.002"}],"id":"T1569"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.pe.original_file_name : \"psexesvc.exe\" and not process.name : \"PSEXESVC.exe\"\n","throttle":"no_actions","actions":[]}
{"id":"50e61020-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-17T10:28:00.505Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.288Z","created_by":"chaykovskiyv","name":"Suspicious service was installed in the system [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Identifies the creation of a new Windows service with suspicious Service command values. Windows services typically run as SYSTEM and can be used for privilege escalation and persistence.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify how the service was created or modified. Look for registry changes events or Windows events related to service activities (for example, 4697 and/or 7045).\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n\n### False positive analysis\n\n- Certain services such as PSEXECSVC may happen legitimately. The security team should address any potential benign true positive (B-TP) by excluding the relevant FP by pattern.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service or restore it to the original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","meta":{"from":"4m"},"timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-540s","rule_id":"be321e21-a96d-46ad-a9a2-6c1ccff54418","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"},"technique":[{"reference":"https://attack.mitre.org/techniques/T1543/","name":"Create or Modify System Process","id":"T1543","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1543/003/","name":"Windows Service","id":"T1543.003"}]}]}],"to":"now","references":[],"version":8,"exceptions_list":[{"id":"af17c330-eb29-11ed-b6f4-dfeac9073248","list_id":"551d0770-b7d8-4bec-aa5b-53dc5d6a89a0","type":"rule_default","namespace_type":"single"}],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"any where\n  (event.code : \"4697\" and\n   (winlog.event_data.ServiceFileName : \n           (\"*COMSPEC*\", \"*\\\\172.0.0.1*\", \"*Admin$*\", \"*powershell*\", \"*rundll32*\", \"*cmd.exe*\", \"*PSEXESVC*\", \n            \"*echo*\", \"*RemComSvc*\", \"*.bat*\", \"*.cmd*\", \"*certutil*\", \"*vssadmin*\", \"*certmgr*\", \"*bitsadmin*\", \n            \"*\\\\Users\\\\*\", \"*\\\\ProgramData\\\\*\", \"*\\\\Windows\\\\Temp\\\\*\", \"*\\\\Windows\\\\Tasks\\\\*\", \"*\\\\PerfLogs\\\\*\", \n            \"*\\\\Intel\\\\*\", \"*\\\\Windows\\\\Debug\\\\*\", \"*:\\\\HP\\\\*\", \"*.sys*\", \"*regsvr32*\", \"*msbuild*\", \"*svchost*\") or\n   winlog.event_data.ServiceFileName regex~ \"\"\"%systemroot%\\\\[a-z0-9]+\\.exe\"\"\") and not winlog.event_data.ServiceFileName: \"*Defender\\\\*\" and service.name:\"MpK*\") or\n\n  (event.code : \"7045\" and\n   winlog.event_data.ImagePath : (\"*COMSPEC*\", \"*\\\\172.0.0.1*\", \"*Admin$*\", \"*powershell*\", \"*rundll32*\", \"*cmd.exe*\", \"*svchost*\", \n                                  \"*PSEXESVC*\", \"*echo*\", \"*RemComSvc*\", \"*.bat*\", \"*.cmd*\", \"*certutil*\", \"*vssadmin*\", \"*certmgr*\", \n                                  \"*bitsadmin*\", \"*\\\\Users\\\\*\", \"*\\\\ProgramData\\\\*\", \"*\\\\Windows\\\\Temp\\\\*\", \"*\\\\Windows\\\\Tasks\\\\*\", \n                                  \"*\\\\PerfLogs\\\\*\", \"*\\\\Intel\\\\*\", \"*\\\\Windows\\\\Debug\\\\*\", \"*:\\\\HP\\\\*\", \"*.sys*\", \"*regsvr32*\", \"*msbuild*\") and not winlog.event_data.ImagePath:\"*Defender\\\\*\" and not winlog.event_data.ServiceName:\"MpK*\") \n","filters":[],"throttle":"no_actions","actions":[]}
{"id":"49afe6f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.160Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.141Z","created_by":"chaykovskiyv","name":"Execution from Unusual Directory - Command Line [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies process execution from suspicious default Windows directories. This may be abused by adversaries to hide malware in trusted paths.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Execution from Unusual Directory - Command Line\n\nThis rule looks for the execution of scripts from unusual directories. Attackers can use system or application paths to hide malware and make the execution less suspicious.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the command line to determine which commands or scripts were executed.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions — preferably with a combination of parent process executable and command line conditions.\n\n### Related rules\n\n- Process Execution from an Unusual Directory - ebfe1448-7fac-4d59-acea-181bd89b1f7f\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"54e0fc20-51ff-45fe-9d6b-c6086ff51c9f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/003/","name":"Windows Command Shell","id":"T1059.003"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1036/","name":"Masquerading","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1036/005/","name":"Match Legitimate Name or Location","id":"T1036.005"}],"id":"T1036"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.name : (\"wscript.exe\",\n                  \"cscript.exe\",\n                  \"rundll32.exe\",\n                  \"regsvr32.exe\",\n                  \"cmstp.exe\",\n                  \"RegAsm.exe\",\n                  \"installutil.exe\",\n                  \"mshta.exe\",\n                  \"RegSvcs.exe\",\n                  \"powershell.exe\",\n                  \"pwsh.exe\",\n                  \"cmd.exe\") and\n\n  /* add suspicious execution paths here */\n  process.args : (\"C:\\\\PerfLogs\\\\*\",\n                  \"C:\\\\Users\\\\Public\\\\*\",\n                  \"C:\\\\Windows\\\\Tasks\\\\*\",\n                  \"C:\\\\Intel\\\\*\",\n                  \"C:\\\\AMD\\\\Temp\\\\*\",\n                  \"C:\\\\Windows\\\\AppReadiness\\\\*\",\n                  \"C:\\\\Windows\\\\ServiceState\\\\*\",\n                  \"C:\\\\Windows\\\\security\\\\*\",\n                  \"C:\\\\Windows\\\\IdentityCRL\\\\*\",\n                  \"C:\\\\Windows\\\\Branding\\\\*\",\n                  \"C:\\\\Windows\\\\csc\\\\*\",\n                  \"C:\\\\Windows\\\\DigitalLocker\\\\*\",\n                  \"C:\\\\Windows\\\\en-US\\\\*\",\n                  \"C:\\\\Windows\\\\wlansvc\\\\*\",\n                  \"C:\\\\Windows\\\\Prefetch\\\\*\",\n                  \"C:\\\\Windows\\\\Fonts\\\\*\",\n                  \"C:\\\\Windows\\\\diagnostics\\\\*\",\n                  \"C:\\\\Windows\\\\TAPI\\\\*\",\n                  \"C:\\\\Windows\\\\INF\\\\*\",\n                  \"C:\\\\Windows\\\\System32\\\\Speech\\\\*\",\n                  \"C:\\\\windows\\\\tracing\\\\*\",\n                  \"c:\\\\windows\\\\IME\\\\*\",\n                  \"c:\\\\Windows\\\\Performance\\\\*\",\n                  \"c:\\\\windows\\\\intel\\\\*\",\n                  \"c:\\\\windows\\\\ms\\\\*\",\n                  \"C:\\\\Windows\\\\dot3svc\\\\*\",\n                  \"C:\\\\Windows\\\\panther\\\\*\",\n                  \"C:\\\\Windows\\\\RemotePackages\\\\*\",\n                  \"C:\\\\Windows\\\\OCR\\\\*\",\n                  \"C:\\\\Windows\\\\appcompat\\\\*\",\n                  \"C:\\\\Windows\\\\apppatch\\\\*\",\n                  \"C:\\\\Windows\\\\addins\\\\*\",\n                  \"C:\\\\Windows\\\\Setup\\\\*\",\n                  \"C:\\\\Windows\\\\Help\\\\*\",\n                  \"C:\\\\Windows\\\\SKB\\\\*\",\n                  \"C:\\\\Windows\\\\Vss\\\\*\",\n                  \"C:\\\\Windows\\\\servicing\\\\*\",\n                  \"C:\\\\Windows\\\\CbsTemp\\\\*\",\n                  \"C:\\\\Windows\\\\Logs\\\\*\",\n                  \"C:\\\\Windows\\\\WaaS\\\\*\",\n                  \"C:\\\\Windows\\\\twain_32\\\\*\",\n                  \"C:\\\\Windows\\\\ShellExperiences\\\\*\",\n                  \"C:\\\\Windows\\\\ShellComponents\\\\*\",\n                  \"C:\\\\Windows\\\\PLA\\\\*\",\n                  \"C:\\\\Windows\\\\Migration\\\\*\",\n                  \"C:\\\\Windows\\\\debug\\\\*\",\n                  \"C:\\\\Windows\\\\Cursors\\\\*\",\n                  \"C:\\\\Windows\\\\Containers\\\\*\",\n                  \"C:\\\\Windows\\\\Boot\\\\*\",\n                  \"C:\\\\Windows\\\\bcastdvr\\\\*\",\n                  \"C:\\\\Windows\\\\TextInput\\\\*\",\n                  \"C:\\\\Windows\\\\security\\\\*\",\n                  \"C:\\\\Windows\\\\schemas\\\\*\",\n                  \"C:\\\\Windows\\\\SchCache\\\\*\",\n                  \"C:\\\\Windows\\\\Resources\\\\*\",\n                  \"C:\\\\Windows\\\\rescache\\\\*\",\n                  \"C:\\\\Windows\\\\Provisioning\\\\*\",\n                  \"C:\\\\Windows\\\\PrintDialog\\\\*\",\n                  \"C:\\\\Windows\\\\PolicyDefinitions\\\\*\",\n                  \"C:\\\\Windows\\\\media\\\\*\",\n                  \"C:\\\\Windows\\\\Globalization\\\\*\",\n                  \"C:\\\\Windows\\\\L2Schemas\\\\*\",\n                  \"C:\\\\Windows\\\\LiveKernelReports\\\\*\",\n                  \"C:\\\\Windows\\\\ModemLogs\\\\*\",\n                  \"C:\\\\Windows\\\\ImmersiveControlPanel\\\\*\",\n                  \"C:\\\\$Recycle.Bin\\\\*\") and\n\n  /* noisy FP patterns */\n\n  not process.parent.executable : (\"C:\\\\WINDOWS\\\\System32\\\\DriverStore\\\\FileRepository\\\\*\\\\igfxCUIService*.exe\",\n                                   \"C:\\\\Windows\\\\System32\\\\spacedeskService.exe\",\n                                   \"C:\\\\Program Files\\\\Dell\\\\SupportAssistAgent\\\\SRE\\\\SRE.exe\") and\n  not (process.name : \"rundll32.exe\" and\n       process.args : (\"uxtheme.dll,#64\",\n                       \"PRINTUI.DLL,PrintUIEntry\",\n                       \"?:\\\\Windows\\\\System32\\\\FirewallControlPanel.dll,ShowNotificationDialog\",\n                       \"?:\\\\WINDOWS\\\\system32\\\\Speech\\\\SpeechUX\\\\sapi.cpl\",\n                       \"?:\\\\Windows\\\\system32\\\\shell32.dll,OpenAs_RunDLL\")) and\n\n  not (process.name : \"cscript.exe\" and process.args : \"?:\\\\WINDOWS\\\\system32\\\\calluxxprovider.vbs\") and\n\n  not (process.name : \"cmd.exe\" and process.args : \"?:\\\\WINDOWS\\\\system32\\\\powercfg.exe\" and process.args : \"?:\\\\WINDOWS\\\\inf\\\\PowerPlan.log\") and\n\n  not (process.name : \"regsvr32.exe\" and process.args : \"?:\\\\Windows\\\\Help\\\\OEM\\\\scripts\\\\checkmui.dll\") and\n\n  not (process.name : \"cmd.exe\" and\n       process.parent.executable : (\"?:\\\\Windows\\\\System32\\\\oobe\\\\windeploy.exe\",\n                                    \"?:\\\\Program Files (x86)\\\\ossec-agent\\\\wazuh-agent.exe\",\n                                    \"?:\\\\Windows\\\\System32\\\\igfxCUIService.exe\",\n                                    \"?:\\\\Windows\\\\Temp\\\\IE*.tmp\\\\IE*-support\\\\ienrcore.exe\"))\n","throttle":"no_actions","actions":[]}
{"id":"80be7ef0-f373-11ed-8f07-79710758f25a","updated_at":"2023-06-08T21:31:14.593Z","updated_by":"burzhynskyyy","created_at":"2023-05-15T22:54:52.730Z","created_by":"burzhynskyyy","name":"o365 MFA request declined by user","tags":["Custom Rules"],"interval":"5m","enabled":true,"description":"o365 MFA request declined by user","risk_score":73,"severity":"high","license":"","output_index":"","meta":{"from":"1m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-360s","rule_id":"6dec63b8-432a-43d8-9c8f-13228d70a188","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"azure.eventhub.properties.authenticationRequirement:\"multiFactorAuthentication\" and azure.eventhub.properties.status.additionalDetails:\"MFA denied; user declined the authentication\" ","filters":[],"throttle":"no_actions","actions":[]}
{"id":"4b6908a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.640Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.038Z","created_by":"chaykovskiyv","name":"Microsoft IIS Service Account Password Dumped [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the Internet Information Services (IIS) command-line tool, AppCmd, being used to list passwords. An attacker with IIS web server access via a web shell can decrypt and dump the IIS AppPool service account password using AppCmd.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"e9f221b9-3b08-4a12-9c50-9940210ca03c","max_signals":33,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://blog.netspi.com/decrypting-iis-passwords-to-break-out-of-the-dmz-part-1/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n   (process.name : \"appcmd.exe\" or process.pe.original_file_name == \"appcmd.exe\") and\n   process.args : \"/list\" and process.args : \"/text*password\"\n","throttle":"no_actions","actions":[]}
{"id":"49b3de90-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.508Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.192Z","created_by":"chaykovskiyv","name":"Suspicious Image Load (taskschd.dll) from MS Office [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Identifies a suspicious image load (taskschd.dll) from Microsoft Office processes. This behavior may indicate adversarial activity where a scheduled task is configured via Windows Component Object Model (COM). This technique can be used to configure persistence and evade monitoring by avoiding the usage of the traditional Windows binary (schtasks.exe) used to manage scheduled tasks.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"111779ed-40fc-4c36-aac8-f6f39a980045","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1053/","name":"Scheduled Task/Job","id":"T1053"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://medium.com/threatpunter/detecting-adversary-tradecraft-with-image-load-event-logging-and-eql-8de93338c16","https://www.clearskysec.com/wp-content/uploads/2020/10/Operation-Quicksand.pdf"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"any where\n (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  process.name : (\"WINWORD.EXE\", \"EXCEL.EXE\", \"POWERPNT.EXE\", \"MSPUB.EXE\", \"MSACCESS.EXE\") and\n  (dll.name : \"taskschd.dll\" or file.name : \"taskschd.dll\")\n","throttle":"no_actions","actions":[]}
{"id":"4f1f32d0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.169Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.311Z","created_by":"chaykovskiyv","name":"Clearing Windows Console History [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies when a user attempts to clear console history. An adversary may clear the command history of a compromised account to conceal the actions undertaken during an intrusion.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Clearing Windows Console History\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can try to cover their tracks by clearing PowerShell console history. PowerShell has two different ways of logging commands: the built-in history and the command history managed by the PSReadLine module. This rule looks for the execution of commands that can clear the built-in PowerShell logs or delete the `ConsoleHost_history.txt` file.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Verify if any other anti-forensics behaviors were observed.\n- Investigate the PowerShell logs on the SIEM to determine if there was suspicious behavior that an attacker may be trying to cover up.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n  - Ensure that PowerShell auditing policies and log collection are in place to grant future visibility.","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Austin Songer"],"false_positives":[],"from":"now-9m","rule_id":"1598b2b3-bf32-4c9f-8352-7becbe97dc02","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1070/","name":"Indicator Removal","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1070/003/","name":"Clear Command History","id":"T1070.003"}],"id":"T1070"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://stefanos.cloud/kb/how-to-clear-the-powershell-command-history/","https://www.shellhacks.com/clear-history-powershell/","https://community.sophos.com/sophos-labs/b/blog/posts/powershell-command-history-forensics"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  (process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or process.pe.original_file_name == \"PowerShell.EXE\") and\n     (process.args : \"*Clear-History*\" or\n     (process.args : (\"*Remove-Item*\", \"rm\") and process.args : (\"*ConsoleHost_history.txt*\", \"*(Get-PSReadlineOption).HistorySavePath*\")) or\n     (process.args : \"*Set-PSReadlineOption*\" and process.args : \"*SaveNothing*\"))\n","throttle":"no_actions","actions":[]}
{"id":"8b766810-b9dc-11ed-b6f4-dfeac9073248","updated_at":"2023-06-08T21:31:14.590Z","updated_by":"burzhynskyyy","created_at":"2023-03-03T16:00:40.818Z","created_by":"burzhynskyyy","name":"SSL Remote VPN from two countries","tags":["Custom Rules"],"interval":"5m","enabled":true,"description":"SSL Remote VPN from two countries","risk_score":73,"severity":"high","license":"","output_index":"","meta":{"from":"24h","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-86700s","rule_id":"b915a512-44e2-4b38-b31b-d344ce6baa15","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":3,"exceptions_list":[{"id":"63563840-f09d-11ed-8f07-79710758f25a","list_id":"b13dae89-da27-49e8-9ae5-9d497d8a404b","type":"rule_default","namespace_type":"single"}],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"fortinet.firewall.subtype:\"vpn\" and fortinet.firewall.action:\"tunnel-up\" and not destination.as.organization.name: (\"Kyivstar PJSC\" or \"PrJSC VF UKRAINE\" or \"Limited Liability Company lifecell\" or \"CLOUDFLARENET\" )","filters":[],"threshold":{"field":["source.user.name"],"value":2,"cardinality":[{"field":"destination.geo.country_name","value":2}]},"throttle":"no_actions","actions":[]}
{"id":"4d574410-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.034Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.312Z","created_by":"chaykovskiyv","name":"Account Password Reset Remotely [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Identifies an attempt to reset a potentially privileged account password remotely. Adversaries may manipulate account passwords to maintain access or evade password duration policies and preserve compromised credentials.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":["Legitimate remote account administration."],"from":"now-9m","rule_id":"d5181053-3dd2-4921-955b-425c3ecb373d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1098/","name":"Account Manipulation","id":"T1098"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4724","https://stealthbits.com/blog/manipulating-user-passwords-with-mimikatz/","https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/blob/master/Credential%20Access/remote_pwd_reset_rpc_mimikatz_postzerologon_target_DC.evtx","https://www.elastic.co/security-labs/detect-credential-access"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"sequence by winlog.computer_name with maxspan=5m\n  [authentication where event.action == \"logged-in\" and\n    /* event 4624 need to be logged */\n    winlog.logon.type : \"Network\" and event.outcome == \"success\" and source.ip != null and\n    source.ip != \"127.0.0.1\" and source.ip != \"::1\"] by winlog.event_data.TargetLogonId\n   /* event 4724 need to be logged */\n  [iam where event.action == \"reset-password\" and\n   (\n    /*\n       This rule is very noisy if not scoped to privileged accounts, duplicate the\n       rule and add your own naming convention and accounts of interest here.\n     */\n    winlog.event_data.TargetUserName: (\"*Admin*\", \"*super*\", \"*SVC*\", \"*DC0*\", \"*service*\", \"*DMZ*\", \"*ADM*\") or\n    winlog.event_data.TargetSid : (\"S-1-5-21-*-500\", \"S-1-12-1-*-500\")\n    )\n  ] by winlog.event_data.SubjectLogonId\n","throttle":"no_actions","actions":[]}
{"id":"50e1ca60-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.070Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.233Z","created_by":"chaykovskiyv","name":"Persistence via WMI Standard Registry Provider [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Identifies use of the Windows Management Instrumentation StdRegProv (registry provider) to modify commonly abused registry locations for persistence.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"00f90b18-fdb1-41f7-90dc-51604fe22600","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1543/","name":"Create or Modify System Process","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1543/003/","name":"Windows Service","id":"T1543.003"}],"id":"T1543"},{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1547/001/","name":"Registry Run Keys / Startup Folder","id":"T1547.001"}],"id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1047/","name":"Windows Management Instrumentation","id":"T1047"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://docs.microsoft.com/en-us/previous-versions/windows/desktop/regprov/stdregprov","https://www.elastic.co/security-labs/hunting-for-persistence-using-elastic-security-part-1"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"registry where\n registry.data.strings != null and process.name : \"WmiPrvSe.exe\" and\n registry.path : (\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"HKLM\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n                  \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ServiceDLL\",\n                  \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ImagePath\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\\\\*\",\n                  \"HKEY_USERS\\\\*\\\\Environment\\\\UserInitMprLogonScript\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Load\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\"\n                  )\n","throttle":"no_actions","actions":[]}
{"id":"4b700d80-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.632Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.121Z","created_by":"chaykovskiyv","name":"Network Connection via Compiled HTML File [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution"],"interval":"5m","enabled":true,"description":"Compiled HTML files (.chm) are commonly distributed as part of the Microsoft HTML Help system. Adversaries may conceal malicious code in a CHM file and deliver it to a victim for execution. CHM content is loaded by the HTML Help executable program (hh.exe).","risk_score":21,"severity":"low","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"4630b3ce-7b65-49cc-bd50-f62c774ade24","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1204/","name":"User Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1204/002/","name":"Malicious File","id":"T1204.002"}],"id":"T1204"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1218/","name":"System Binary Proxy Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1218/001/","name":"Compiled HTML File","id":"T1218.001"}],"id":"T1218"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by process.entity_id\n  [process where process.name : \"hh.exe\" and event.type == \"start\"]\n  [network where process.name : \"hh.exe\" and\n     not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\")]\n","throttle":"no_actions","actions":[]}
{"id":"4b6f4a30-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.626Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.113Z","created_by":"chaykovskiyv","name":"Hosts File Modified [Duplicate]","tags":["Elastic","Host","Linux","Windows","macOS","Threat Detection","Impact","Investigation Guide"],"interval":"5m","enabled":true,"description":"The hosts file on endpoints is used to control manual IP address to hostname resolutions. The hosts file is the first point of lookup for DNS hostname resolution so if adversaries can modify the endpoint hosts file, they can route traffic to malicious infrastructure. This rule detects modifications to the hosts file on Microsoft Windows, Linux (Ubuntu or RHEL) and macOS systems.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Hosts File Modified\n\nOperating systems use the hosts file to map a connection between an IP address and domain names before going to domain name servers. Attackers can abuse this mechanism to route traffic to malicious infrastructure or disrupt security that depends on server communications. For example, Russian threat actors modified this file on a domain controller to redirect Duo MFA calls to localhost instead of the Duo server, which prevented the MFA service from contacting its server to validate MFA login. This effectively disabled MFA for active domain accounts because the default policy of Duo for Windows is to \"Fail open\" if the MFA server is unreachable. This can happen in any MFA implementation and is not exclusive to Duo. Find more details in this [CISA Alert](https://www.cisa.gov/uscert/ncas/alerts/aa22-074a).\n\nThis rule identifies modifications in the hosts file across multiple operating systems using process creation events for Linux and file events in Windows and macOS.\n\n#### Possible investigation steps\n\n- Identify the specifics of the involved assets, such as role, criticality, and associated users.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the changes to the hosts file by comparing it against file backups, volume shadow copies, and other restoration mechanisms.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and the configuration was justified.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges of the administrator account that performed the action.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timeline_id":"4d4c0b59-ea83-483f-b8c1-8c360ee53c5c","timeline_title":"Comprehensive File Timeline","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"6461d0f8-b4da-499d-81ca-bdc8c78d9c96","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1565/","name":"Data Manipulation","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1565/001/","name":"Stored Data Manipulation","id":"T1565.001"}],"id":"T1565"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0040/","name":"Impact","id":"TA0040"}}],"to":"now","references":["https://www.elastic.co/guide/en/beats/auditbeat/current/auditbeat-reference-yml.html"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["auditbeat-*","winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"any where\n\n  /* file events for creation; file change events are not captured by some of the included sources for linux and so may\n     miss this, which is the purpose of the process + command line args logic below */\n  (\n   event.category == \"file\" and event.type in (\"change\", \"creation\") and\n     file.path : (\"/private/etc/hosts\", \"/etc/hosts\", \"?:\\\\Windows\\\\System32\\\\drivers\\\\etc\\\\hosts\")\n  )\n  or\n\n  /* process events for change targeting linux only */\n  (\n   event.category == \"process\" and event.type in (\"start\") and\n     process.name in (\"nano\", \"vim\", \"vi\", \"emacs\", \"echo\", \"sed\") and\n     process.args : (\"/etc/hosts\")\n  )\n","throttle":"no_actions","actions":[]}
{"id":"49b194a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.185Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.166Z","created_by":"chaykovskiyv","name":"Remote File Copy to a Hidden Share [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies a remote file copy attempt to a hidden network share. This may indicate lateral movement or data staging activity.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"044d8a58-b0d6-4697-8249-4d7352915dc9","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1021/002/","name":"SMB/Windows Admin Shares","id":"T1021.002"}],"id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  process.name : (\"cmd.exe\", \"powershell.exe\", \"robocopy.exe\", \"xcopy.exe\") and\n  process.args : (\"copy*\", \"move*\", \"cp\", \"mv\") and process.args : \"*$*\"\n","throttle":"no_actions","actions":[]}
{"id":"52b0e510-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.308Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.252Z","created_by":"chaykovskiyv","name":"FirstTime Seen Account Performing DCSync [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Active Directory"],"interval":"5m","enabled":true,"description":"This rule identifies when a User Account starts the Active Directory Replication Process for the first time. Attackers can use the DCSync technique to get credential information of individual accounts or the entire domain, thus compromising the entire domain.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"3bf8c997-7fa2-424d-a719-6af7ab5c4a21","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/006/","name":"DCSync","id":"T1003.006"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://threathunterplaybook.com/notebooks/windows/06_credential_access/WIN-180815210510.html","https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing","https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_ad_replication_non_machine_account.yml","https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0027_windows_audit_directory_service_access.md","https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync","https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"new_terms","query":"event.action : \"Directory Service Access\" and event.code : \"4662\" and \n winlog.event_data.Properties : (*DS-Replication-Get-Changes* or *DS-Replication-Get-Changes-All* or *DS-Replication-Get-Changes-In-Filtered-Set* or *1131f6ad-9c07-11d1-f79f-00c04fc2dcd2* or *1131f6aa-9c07-11d1-f79f-00c04fc2dcd2* or *89e95b76-444d-4c62-991a-0facbeda640c*) and \n not winlog.event_data.SubjectUserName : (*$ or MSOL_*)\n","new_terms_fields":["winlog.event_data.SubjectUserName"],"history_window_start":"now-15d","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"language":"kuery","throttle":"no_actions","actions":[]}
{"id":"4b6eadf0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.620Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.106Z","created_by":"chaykovskiyv","name":"Execution via TSClient Mountpoint [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies execution from the Remote Desktop Protocol (RDP) shared mountpoint tsclient on the target host. This may indicate a lateral movement attempt.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"75fd2348-2b6f-461e-9fda-306a35441f58","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":["https://posts.specterops.io/revisiting-remote-desktop-lateral-movement-8fb905cb46c3"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"process where event.type == \"start\" and process.executable : \"\\\\Device\\\\Mup\\\\tsclient\\\\*.exe\"\n","throttle":"no_actions","actions":[]}
{"id":"4b69a4e1-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.524Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.046Z","created_by":"chaykovskiyv","name":"Unusual Executable File Creation by a System Critical Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies an unexpected executable file being created or modified by a Windows system critical process, which may indicate activity related to remote code execution or other forms of exploitation.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Unusual Executable File Creation by a System Critical Process\n\nWindows internal/system processes have some characteristics that can be used to spot suspicious activities. One of these characteristics is file operations.\n\nThis rule looks for the creation of executable files done by system-critical processes. This can indicate the exploitation of a vulnerability or a malicious process masquerading as a system-critical process.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"ef9e174f-c400-4669-a6ec-8a11a6d6a4cf","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1211/","name":"Exploitation for Defense Evasion","id":"T1211"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"file where event.type != \"deletion\" and\n  file.extension : (\"exe\", \"dll\") and\n  process.name : (\"smss.exe\",\n                  \"autochk.exe\",\n                  \"csrss.exe\",\n                  \"wininit.exe\",\n                  \"services.exe\",\n                  \"lsass.exe\",\n                  \"winlogon.exe\",\n                  \"userinit.exe\",\n                  \"LogonUI.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"49af98d0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.161Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.139Z","created_by":"chaykovskiyv","name":"Process Execution from an Unusual Directory [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies process execution from suspicious default Windows directories. This is sometimes done by adversaries to hide malware in trusted paths.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"aa2d651a-88c6-4ab4-b855-ee990dd529ee","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1036/","name":"Masquerading","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1036/005/","name":"Match Legitimate Name or Location","id":"T1036.005"}],"id":"T1036"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n /* add suspicious execution paths here */\nprocess.executable : (\"C:\\\\PerfLogs\\\\*.exe\",\"C:\\\\Users\\\\Public\\\\*.exe\",\"C:\\\\Windows\\\\Tasks\\\\*.exe\",\"C:\\\\Intel\\\\*.exe\",\"C:\\\\AMD\\\\Temp\\\\*.exe\",\"C:\\\\Windows\\\\AppReadiness\\\\*.exe\",\n\"C:\\\\Windows\\\\ServiceState\\\\*.exe\",\"C:\\\\Windows\\\\security\\\\*.exe\",\"C:\\\\Windows\\\\IdentityCRL\\\\*.exe\",\"C:\\\\Windows\\\\Branding\\\\*.exe\",\"C:\\\\Windows\\\\csc\\\\*.exe\",\n \"C:\\\\Windows\\\\DigitalLocker\\\\*.exe\",\"C:\\\\Windows\\\\en-US\\\\*.exe\",\"C:\\\\Windows\\\\wlansvc\\\\*.exe\",\"C:\\\\Windows\\\\Prefetch\\\\*.exe\",\"C:\\\\Windows\\\\Fonts\\\\*.exe\",\n \"C:\\\\Windows\\\\diagnostics\\\\*.exe\",\"C:\\\\Windows\\\\TAPI\\\\*.exe\",\"C:\\\\Windows\\\\INF\\\\*.exe\",\"C:\\\\Windows\\\\System32\\\\Speech\\\\*.exe\",\"C:\\\\windows\\\\tracing\\\\*.exe\",\n \"c:\\\\windows\\\\IME\\\\*.exe\",\"c:\\\\Windows\\\\Performance\\\\*.exe\",\"c:\\\\windows\\\\intel\\\\*.exe\",\"c:\\\\windows\\\\ms\\\\*.exe\",\"C:\\\\Windows\\\\dot3svc\\\\*.exe\",\n \"C:\\\\Windows\\\\panther\\\\*.exe\",\"C:\\\\Windows\\\\RemotePackages\\\\*.exe\",\"C:\\\\Windows\\\\OCR\\\\*.exe\",\"C:\\\\Windows\\\\appcompat\\\\*.exe\",\"C:\\\\Windows\\\\apppatch\\\\*.exe\",\"C:\\\\Windows\\\\addins\\\\*.exe\",\n \"C:\\\\Windows\\\\Setup\\\\*.exe\",\"C:\\\\Windows\\\\Help\\\\*.exe\",\"C:\\\\Windows\\\\SKB\\\\*.exe\",\"C:\\\\Windows\\\\Vss\\\\*.exe\",\"C:\\\\Windows\\\\Web\\\\*.exe\",\"C:\\\\Windows\\\\servicing\\\\*.exe\",\"C:\\\\Windows\\\\CbsTemp\\\\*.exe\",\n \"C:\\\\Windows\\\\Logs\\\\*.exe\",\"C:\\\\Windows\\\\WaaS\\\\*.exe\",\"C:\\\\Windows\\\\ShellExperiences\\\\*.exe\",\"C:\\\\Windows\\\\ShellComponents\\\\*.exe\",\"C:\\\\Windows\\\\PLA\\\\*.exe\",\n \"C:\\\\Windows\\\\Migration\\\\*.exe\",\"C:\\\\Windows\\\\debug\\\\*.exe\",\"C:\\\\Windows\\\\Cursors\\\\*.exe\",\"C:\\\\Windows\\\\Containers\\\\*.exe\",\"C:\\\\Windows\\\\Boot\\\\*.exe\",\"C:\\\\Windows\\\\bcastdvr\\\\*.exe\",\n \"C:\\\\Windows\\\\assembly\\\\*.exe\",\"C:\\\\Windows\\\\TextInput\\\\*.exe\",\"C:\\\\Windows\\\\security\\\\*.exe\",\"C:\\\\Windows\\\\schemas\\\\*.exe\",\"C:\\\\Windows\\\\SchCache\\\\*.exe\",\"C:\\\\Windows\\\\Resources\\\\*.exe\",\n \"C:\\\\Windows\\\\rescache\\\\*.exe\",\"C:\\\\Windows\\\\Provisioning\\\\*.exe\",\"C:\\\\Windows\\\\PrintDialog\\\\*.exe\",\"C:\\\\Windows\\\\PolicyDefinitions\\\\*.exe\",\"C:\\\\Windows\\\\media\\\\*.exe\",\n \"C:\\\\Windows\\\\Globalization\\\\*.exe\",\"C:\\\\Windows\\\\L2Schemas\\\\*.exe\",\"C:\\\\Windows\\\\LiveKernelReports\\\\*.exe\",\"C:\\\\Windows\\\\ModemLogs\\\\*.exe\",\"C:\\\\Windows\\\\ImmersiveControlPanel\\\\*.exe\") and\n not process.name : (\"SpeechUXWiz.exe\",\"SystemSettings.exe\",\"TrustedInstaller.exe\",\"PrintDialog.exe\",\"MpSigStub.exe\",\"LMS.exe\",\"mpam-*.exe\") and\n not process.executable :\n           (\"?:\\\\Intel\\\\Wireless\\\\WUSetupLauncher.exe\",\n            \"?:\\\\Intel\\\\Wireless\\\\Setup.exe\",\n            \"?:\\\\Intel\\\\Move Mouse.exe\",\n            \"?:\\\\windows\\\\Panther\\\\DiagTrackRunner.exe\",\n            \"?:\\\\Windows\\\\servicing\\\\GC64\\\\tzupd.exe\",\n            \"?:\\\\Users\\\\Public\\\\res\\\\RemoteLite.exe\",\n            \"?:\\\\Users\\\\Public\\\\IBM\\\\ClientSolutions\\\\*.exe\",\n            \"?:\\\\Users\\\\Public\\\\Documents\\\\syspin.exe\",\n            \"?:\\\\Users\\\\Public\\\\res\\\\FileWatcher.exe\")\n /* uncomment once in winlogbeat */\n /* and not (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true) */\n","throttle":"no_actions","actions":[]}
{"id":"4b6b0470-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.541Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.060Z","created_by":"chaykovskiyv","name":"Potential Windows Error Manager Masquerading [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Identifies suspicious instances of the Windows Error Reporting process (WerFault.exe or Wermgr.exe) with matching command-line and process executable values performing outgoing network connections. This may be indicative of a masquerading attempt to evade suspicious child process behavior detections.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":["Legit Application Crash with rare Werfault commandline value"],"from":"now-9m","rule_id":"11eb9f3a-db55-4ee4-a9a6-42e06e3b2841","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1036/","name":"Masquerading","id":"T1036"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://twitter.com/SBousseaden/status/1235533224337641473","https://www.hexacorn.com/blog/2019/09/20/werfault-command-line-switches-v0-1/","https://app.any.run/tasks/26051d84-b68e-4afb-8a9a-76921a271b81/"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by host.id, process.entity_id with maxspan = 5s\n  [process where event.type:\"start\" and process.name : (\"wermgr.exe\", \"WerFault.exe\") and process.args_count == 1]\n  [network where process.name : (\"wermgr.exe\", \"WerFault.exe\") and network.protocol != \"dns\" and\n    network.direction : (\"outgoing\", \"egress\") and destination.ip !=\"::1\" and destination.ip !=\"127.0.0.1\"\n  ]\n","throttle":"no_actions","actions":[]}
{"id":"169033c0-bc78-11ed-b6f4-dfeac9073248","updated_at":"2023-08-09T11:54:33.942Z","updated_by":"tyshchenkoo","created_at":"2023-03-06T23:39:08.769Z","created_by":"burzhynskyyy","name":"One Port Scanning Detected","tags":["Custom Rules"],"interval":"5m","enabled":true,"description":"Network scanning detected of multiple hosts toward one port","risk_score":47,"severity":"medium","license":"","output_index":"","meta":{"from":"6m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-660s","rule_id":"e6cdff07-d0ea-4ee8-8fc6-d63d76040986","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":11,"exceptions_list":[{"id":"2ea4fe20-36a6-11ee-8f07-79710758f25a","list_id":"9a69ef66-d000-41ed-a74b-600a0326ee2c","type":"rule_default","namespace_type":"single"}],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"fortinet.firewall.type:\"traffic\" and source.ip:(10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16) and destination.port < 10000 and not (source.ip:(172.20.11.11 or 192.168.5.5 or 192.168.5.9 or 172.20.11.50) and destination.port:(135 or 137 or 3389 or 445 or 161)) and not (destination.as.organization.name : (MICROSOFT-CORP-MSN-AS-BLOCK or AMAZON-* or CLOUDFLARENET or GOOGLE or \"Hosting Ukraine LTD\") or (destination.as.organization.name: \"Private Joint-stock Company farlep-invest\" and destination.port: \"161\"))","filters":[],"threshold":{"field":["source.ip","destination.port"],"value":50,"cardinality":[{"field":"destination.ip","value":50}]},"throttle":"no_actions","actions":[]}
{"id":"4b6beed0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.553Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.069Z","created_by":"chaykovskiyv","name":"Remote File Copy via TeamViewer [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Command and Control","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies an executable or script file remotely downloaded via a TeamViewer transfer session.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Remote File Copy via TeamViewer\n\nAttackers commonly transfer tooling or malware from external systems into a compromised environment using the command and control channel. However, they can also abuse legitimate utilities to drop these files.\n\nTeamViewer is a remote access and remote control tool used by helpdesks and system administrators to perform various support activities. It is also frequently used by attackers and scammers to deploy malware interactively and other malicious activities. This rule looks for the TeamViewer process creating files with suspicious extensions.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Contact the user to gather information about who and why was conducting the remote access.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check whether the company uses TeamViewer for the support activities and if there is a support ticket related to this access.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the company relies on TeamViewer to conduct remote access and the triage has not identified suspicious or malicious files.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"35181782-c314-4034-a89e-c81b292b2ebf","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1105/","name":"Ingress Tool Transfer","id":"T1105"},{"reference":"https://attack.mitre.org/techniques/T1219/","name":"Remote Access Software","id":"T1219"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0011/","name":"Command and Control","id":"TA0011"}}],"to":"now","references":["https://blog.menasec.net/2019/11/hunting-for-suspicious-use-of.html"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"file where event.type == \"creation\" and process.name : \"TeamViewer.exe\" and\n  file.extension : (\"exe\", \"dll\", \"scr\", \"com\", \"bat\", \"ps1\", \"vbs\", \"vbe\", \"js\", \"wsh\", \"hta\")\n","throttle":"no_actions","actions":[]}
{"id":"49b64f90-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.539Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.217Z","created_by":"chaykovskiyv","name":"Creation or Modification of Domain Backup DPAPI private key [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the creation or modification of Domain Backup private keys. Adversaries may extract the Data Protection API (DPAPI) domain backup key from a Domain Controller (DC) to be able to decrypt any domain user master key file.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\nDomain DPAPI Backup keys are stored on domain controllers and can be dumped remotely with tools such as Mimikatz. The resulting .pvk private key can be used to decrypt ANY domain user masterkeys, which then can be used to decrypt any secrets protected by those keys.","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"834ced17-ad7e-4c23-8d8d-65526fdf916d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1552/","name":"Unsecured Credentials","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1552/004/","name":"Private Keys","id":"T1552.004"}],"id":"T1552"},{"reference":"https://attack.mitre.org/techniques/T1555/","name":"Credentials from Password Stores","id":"T1555"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://www.dsinternals.com/en/retrieving-dpapi-backup-keys-from-active-directory/","https://posts.specterops.io/operational-guidance-for-offensive-user-dpapi-abuse-1fb7fac8b107"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"file where event.type != \"deletion\" and file.name : (\"ntds_capi_*.pfx\", \"ntds_capi_*.pvk\")\n","throttle":"no_actions","actions":[]}
{"id":"4b6e38c0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.619Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.104Z","created_by":"chaykovskiyv","name":"Suspicious Zoom Child Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"A suspicious Zoom child process was detected, which may indicate an attempt to run unnoticed. Verify process details such as command line, network connections, file writes and associated file signature details as well.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"07690e69-88ee-40a5-9caa-6f9f21631bd3","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1036/","name":"Masquerading","id":"T1036"},{"reference":"https://attack.mitre.org/techniques/T1055/","name":"Process Injection","id":"T1055"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n process.parent.name : \"Zoom.exe\" and process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"4f237890-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.190Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.340Z","created_by":"chaykovskiyv","name":"Potential Credential Access via DCSync [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Active Directory","Investigation Guide"],"interval":"5m","enabled":true,"description":"This rule identifies when a User Account starts the Active Directory Replication Process. Attackers can use the DCSync technique to get credential information of individual accounts or the entire domain, thus compromising the entire domain.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Potential Credential Access via DCSync\n\nActive Directory replication is the process by which the changes that originate on one domain controller are automatically transferred to other domain controllers that store the same data.\n\nActive Directory data consists of objects that have properties, or attributes. Each object is an instance of an object class, and object classes and their respective attributes are defined in the Active Directory schema. Objects are defined by the values of their attributes, and changes to attribute values must be transferred from the domain controller on which they occur to every other domain controller that stores a replica of an affected object.\n\nAdversaries can use the DCSync technique that uses Windows Domain Controller's API to simulate the replication process from a remote domain controller, compromising major credential material such as the Kerberos krbtgt keys used legitimately for tickets creation, but also tickets forging by attackers. This attack requires some extended privileges to succeed (DS-Replication-Get-Changes and DS-Replication-Get-Changes-All), which are granted by default to members of the Administrators, Domain Admins, Enterprise Admins, and Domain Controllers groups. Privileged accounts can be abused to grant controlled objects the right to DCsync/Replicate.\n\nMore details can be found on [Threat Hunter Playbook](https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing) and [The Hacker Recipes](https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync).\n\nThis rule monitors for Event ID 4662 (Operation was performed on an Active Directory object) and identifies events that use the access mask 0x100 (Control Access) and properties that contain at least one of the following or their equivalent: Schema-Id-GUID (DS-Replication-Get-Changes, DS-Replication-Get-Changes-All, DS-Replication-Get-Changes-In-Filtered-Set). It also filters out events that use computer accounts and also Azure AD Connect MSOL accounts (more details [here](https://techcommunity.microsoft.com/t5/microsoft-defender-for-identity/ad-connect-msol-user-suspected-dcsync-attack/m-p/788028)).\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Correlate security events 4662 and 4624 (Logon Type 3) by their Logon ID (`winlog.logon.id`) on the Domain Controller (DC) that received the replication request. This will tell you where the AD replication request came from, and if it came from another DC or not.\n- Scope which credentials were compromised (for example, whether all accounts were replicated or specific ones).\n\n### False positive analysis\n\n- Administrators may use custom accounts on Azure AD Connect, investigate if it is the case, and if it is properly secured. If noisy in your environment due to expected activity, consider adding the corresponding account as a exception.\n- Although replicating Active Directory (AD) data to non-Domain Controllers is not a common practice and is generally not recommended from a security perspective, some software vendors may require it for their products to function correctly. If this rule is noisy in your environment due to expected activity, consider adding the corresponding account as a exception.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If specific credentials were compromised:\n  - Reset the password for these accounts and other potentially compromised credentials, like email, business systems, and web services.\n- If the entire domain or the `krbtgt` user were compromised:\n  - Activate your incident response plan for total Active Directory compromise which should include, but not be limited to, a password reset (twice) of the `krbtgt` user.\n- Investigate how the attacker escalated privileges and identify systems they used to conduct lateral movement. Use this information to scope ways that the attacker could use to regain access to the environment.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"e362be6c-913b-4f4c-82cb-68e5b29352b4","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/006/","name":"DCSync","id":"T1003.006"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://threathunterplaybook.com/notebooks/windows/06_credential_access/WIN-180815210510.html","https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing","https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_ad_replication_non_machine_account.yml","https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0027_windows_audit_directory_service_access.md","https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync","https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"any where event.action == \"Directory Service Access\" and\n  event.code == \"4662\" and winlog.event_data.Properties : (\n\n    /* Control Access Rights/Permissions Symbol */\n\n    \"*DS-Replication-Get-Changes*\",\n    \"*DS-Replication-Get-Changes-All*\",\n    \"*DS-Replication-Get-Changes-In-Filtered-Set*\",\n\n    /* Identifying GUID used in ACE */\n\n    \"*1131f6ad-9c07-11d1-f79f-00c04fc2dcd2*\",\n    \"*1131f6aa-9c07-11d1-f79f-00c04fc2dcd2*\",\n    \"*89e95b76-444d-4c62-991a-0facbeda640c*\")\n\n    /* The right to perform an operation controlled by an extended access right. */\n\n    and winlog.event_data.AccessMask : \"0x100\" and\n    not winlog.event_data.SubjectUserName : (\"*$\", \"MSOL_*\", \"OpenDNS_Connector\")\n\n    /* The Umbrella AD Connector uses the OpenDNS_Connector account to perform replication */\n","throttle":"no_actions","actions":[]}
{"id":"483b2140-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.166Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.699Z","created_by":"chaykovskiyv","name":"Windows Script Interpreter Executing Process via WMI [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Initial Access","Execution"],"interval":"5m","enabled":true,"description":"Identifies use of the built-in Windows script interpreters (cscript.exe or wscript.exe) being used to execute a process via Windows Management Instrumentation (WMI). This may be indicative of malicious activity.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"1a94cbb3-51e0-421b-b2c3-55a44b9c5bde","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1566/","name":"Phishing","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1566/001/","name":"Spearphishing Attachment","id":"T1566.001"}],"id":"T1566"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1047/","name":"Windows Management Instrumentation","id":"T1047"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by host.id with maxspan = 5s\n    [any where (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n     (dll.name : \"wmiutils.dll\" or file.name : \"wmiutils.dll\") and process.name : (\"wscript.exe\", \"cscript.exe\")]\n    [process where event.type == \"start\" and\n     process.parent.name : \"wmiprvse.exe\" and\n     user.domain != \"NT AUTHORITY\" and\n     (process.pe.original_file_name :\n        (\n          \"cscript.exe\",\n          \"wscript.exe\",\n          \"PowerShell.EXE\",\n          \"Cmd.Exe\",\n          \"MSHTA.EXE\",\n          \"RUNDLL32.EXE\",\n          \"REGSVR32.EXE\",\n          \"MSBuild.exe\",\n          \"InstallUtil.exe\",\n          \"RegAsm.exe\",\n          \"RegSvcs.exe\",\n          \"msxsl.exe\",\n          \"CONTROL.EXE\",\n          \"EXPLORER.EXE\",\n          \"Microsoft.Workflow.Compiler.exe\",\n          \"msiexec.exe\"\n        ) or\n      process.executable : (\"C:\\\\Users\\\\*.exe\", \"C:\\\\ProgramData\\\\*.exe\")\n     )\n    ]\n","throttle":"no_actions","actions":[]}
{"id":"483ecac0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.214Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.738Z","created_by":"chaykovskiyv","name":"Enumeration of Privileged Local Groups Membership [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies instances of an unusual process enumerating built-in Windows privileged local groups membership like Administrators or Remote Desktop users.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Enumeration of Privileged Local Groups Membership\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the enumeration of privileged local groups' membership by suspicious processes, and excludes known legitimate utilities and programs installed. Attackers can use this information to decide the next steps of the attack, such as mapping targets for credential compromise and other post-exploitation activities.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Identify the process, host and user involved on the event.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\nThe 'Audit Security Group Management' audit policy must be configured (Success).\nSteps to implement the logging policy with with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nAccount Management >\nAudit Security Group Management (Success)\n```\n\nMicrosoft introduced the [event used](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4799) in this detection rule on Windows 10 and Windows Server 2016 or later operating systems.\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2, events will not define `event.ingested` and default fallback for EQL rules was not added until 8.2, so you will need to add a custom pipeline to populate `event.ingested` to @timestamp for this rule to work.","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"5207d7a8-4f15-474b-acdd-19e0580dee68","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1069/","name":"Permission Groups Discovery","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1069/001/","name":"Local Groups","id":"T1069.001"}],"id":"T1069"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}}],"to":"now","references":[],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"iam where event.action == \"user-member-enumerated\" and\n\n  /* excluding machine account */\n  not winlog.event_data.SubjectUserName: (\"*$\", \"LOCAL SERVICE\", \"NETWORK SERVICE\") and\n\n  /* noisy and usual legit processes excluded */\n  not winlog.event_data.CallerProcessName:\n               (\"-\",\n                \"?:\\\\Windows\\\\System32\\\\VSSVC.exe\",\n                \"?:\\\\Windows\\\\System32\\\\SearchIndexer.exe\",\n                \"?:\\\\Windows\\\\System32\\\\CompatTelRunner.exe\",\n                \"?:\\\\Windows\\\\System32\\\\oobe\\\\msoobe.exe\",\n                \"?:\\\\Windows\\\\System32\\\\net1.exe\",\n                \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n                \"?:\\\\Windows\\\\System32\\\\Netplwiz.exe\",\n                \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n                \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n                \"?:\\\\Windows\\\\System32\\\\CloudExperienceHostBroker.exe\",\n                \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiPrvSE.exe\",\n                \"?:\\\\Windows\\\\System32\\\\SrTasks.exe\",\n                \"?:\\\\Windows\\\\System32\\\\lsass.exe\",\n                \"?:\\\\Windows\\\\System32\\\\diskshadow.exe\",\n                \"?:\\\\Windows\\\\System32\\\\dfsrs.exe\",\n                \"?:\\\\Program Files\\\\*.exe\",\n                \"?:\\\\Program Files (x86)\\\\*.exe\",\n                \"?:\\\\WindowsAzure\\\\*\\\\WaAppAgent.exe\",\n                \"?:\\\\Windows\\\\System32\\\\vssadmin.exe\",\n                \"?:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe\",\n                \"?:\\\\Windows\\\\System32\\\\dllhost.exe\",\n                \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\SettingSyncHost.exe\",\n                \"?:\\\\Windows\\\\ImmersiveControlPanel\\\\SystemSettings.exe\",\n                \"?:\\\\Windows\\\\System32\\\\SystemSettingsAdminFlows.exe\",\n                \"?:\\\\Windows\\\\Temp\\\\rubrik_vmware???\\\\snaptool.exe\",\n                \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\",\n                \"?:\\\\$WINDOWS.~BT\\\\Sources\\\\*.exe\",\n                \"?:\\\\Windows\\\\System32\\\\wsmprovhost.exe\",\n                \"?:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\3\\\\x3jobt3?.exe\",\n                \"?:\\\\Windows\\\\System32\\\\mstsc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\esentutl.exe\",\n                \"?:\\\\Windows\\\\System32\\\\RecoveryDrive.exe\",\n                \"?:\\\\Windows\\\\System32\\\\SystemPropertiesComputerName.exe\") and\n\n  /* privileged local groups */\n  (group.name:(\"*admin*\",\"RemoteDesktopUsers\") or\n   winlog.event_data.TargetSid:(\"S-1-5-32-544\",\"S-1-5-32-555\"))\n","throttle":"no_actions","actions":[]}
{"id":"4b703490-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-06-09T08:40:44.801Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.125Z","created_by":"chaykovskiyv","name":"PsExec Network Connection [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies use of the SysInternals tool PsExec.exe making a network connection. This could be an indication of lateral movement.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating PsExec Network Connection\n\nPsExec is a remote administration tool that enables the execution of commands with both regular and SYSTEM privileges on Windows systems. Microsoft develops it as part of the Sysinternals Suite. Although commonly used by administrators, PsExec is frequently used by attackers to enable lateral movement and execute commands as SYSTEM to disable defenses and bypass security protections.\n\nThis rule identifies PsExec execution by looking for the creation of `PsExec.exe`, the default name for the utility, followed by a network connection done by the process.\n\n#### Possible investigation steps\n\n- Check if the usage of this tool complies with the organization's administration policy.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Identify the target computer and its role in the IT environment.\n- Investigate what commands were run, and assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. As long as the analyst did not identify suspicious activity related to the user or involved hosts, and the tool is allowed by the organization's policy, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - Prioritize accordingly with the role of the servers and users involved.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","meta":{"from":"4m"},"author":["Elastic"],"false_positives":["PsExec is a dual-use tool that can be used for benign or malicious activity. It's important to baseline your environment to determine the amount of noise to expect from this tool."],"from":"now-540s","rule_id":"92c52625-a1eb-4111-b8e0-f6e91843c9b0","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"},"technique":[{"reference":"https://attack.mitre.org/techniques/T1569/","name":"System Services","id":"T1569","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1569/002/","name":"Service Execution","id":"T1569.002"}]}]},{"framework":"MITRE ATT&CK","tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"},"technique":[]}],"to":"now","references":[],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","data_view_id":"security-solution-default","query":"sequence by process.entity_id\n  [process where process.name : \"PsExec.exe\" and event.type == \"start\" and\n\n   /* This flag suppresses the display of the license dialog and may\n      indicate that psexec executed for the first time in the machine */\n   process.args : \"-accepteula\" and\n\n   not process.executable : (\"?:\\\\ProgramData\\\\Docusnap\\\\Discovery\\\\discovery\\\\plugins\\\\17\\\\Bin\\\\psexec.exe\",\n                             \"?:\\\\Docusnap 11\\\\Bin\\\\psexec.exe\",\n                             \"?:\\\\Program Files\\\\Docusnap X\\\\Bin\\\\psexec.exe\",\n                             \"?:\\\\Program Files\\\\Docusnap X\\\\Tools\\\\dsDNS.exe\") and\n   not process.parent.executable : \"?:\\\\Program Files (x86)\\\\Cynet\\\\Cynet Scanner\\\\CynetScanner.exe\"]\n  [network where process.name : \"PsExec.exe\"]\n","filters":[],"throttle":"no_actions","actions":[]}
{"id":"49b2cd20-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.192Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.179Z","created_by":"chaykovskiyv","name":"Suspicious Execution - Short Program Name [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies process execution with a single character process name. This is often done by adversaries while staging or executing temporary utilities.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"154d9f38-7d00-4d78-b876-1b23fffce2fa","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1036/","name":"Masquerading","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1036/003/","name":"Rename System Utilities","id":"T1036.003"}],"id":"T1036"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and length(process.name) > 0 and\n length(process.name) == 5 and host.os.name == \"Windows\" and length(process.pe.original_file_name) > 5\n","throttle":"no_actions","actions":[]}
{"id":"4b7082b0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.636Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.127Z","created_by":"chaykovskiyv","name":"Process Activity via Compiled HTML File [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Compiled HTML files (.chm) are commonly distributed as part of the Microsoft HTML Help system. Adversaries may conceal malicious code in a CHM file and deliver it to a victim for execution. CHM content is loaded by the HTML Help executable program (hh.exe).","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["The HTML Help executable program (hh.exe) runs whenever a user clicks a compiled help (.chm) file or menu item that opens the help file inside the Help Viewer. This is not always malicious, but adversaries may abuse this technology to conceal malicious code."],"from":"now-9m","rule_id":"98a012a8-98e4-46fd-9b03-eed3cd9fc56c","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1204/","name":"User Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1204/002/","name":"Malicious File","id":"T1204.002"}],"id":"T1204"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1218/","name":"System Binary Proxy Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1218/001/","name":"Compiled HTML File","id":"T1218.001"}],"id":"T1218"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n process.parent.name : \"hh.exe\" and\n process.name : (\"mshta.exe\", \"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"cscript.exe\", \"wscript.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"49cdf640-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.552Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.290Z","created_by":"chaykovskiyv","name":"Persistence via TelemetryController Scheduled Task Hijack [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Detects the successful hijack of Microsoft Compatibility Appraiser scheduled task to establish persistence with an integrity level of system.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"369f7949-4dba-4054-8ae3-3f394ee0528f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1053/","name":"Scheduled Task/Job","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1053/005/","name":"Scheduled Task","id":"T1053.005"}],"id":"T1053"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://www.trustedsec.com/blog/abusing-windows-telemetry-for-persistence/?utm_content=131234033&utm_medium=social&utm_source=twitter&hss_channel=tw-403811306"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  process.parent.name : \"CompatTelRunner.exe\" and process.args : \"-cv*\" and\n  not process.name : (\"conhost.exe\",\n                      \"DeviceCensus.exe\",\n                      \"CompatTelRunner.exe\",\n                      \"DismHost.exe\",\n                      \"rundll32.exe\",\n                      \"powershell.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"4842c260-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.206Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.792Z","created_by":"chaykovskiyv","name":"Security Software Discovery using WMIC [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the use of Windows Management Instrumentation Command (WMIC) to discover certain System Security Settings such as AntiVirus or Host Firewall details.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Security Software Discovery using WMIC\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `wmic` utility with arguments compatible to the enumeration of the security software installed on the host. Attackers can use this information to decide whether or not to infect a system, disable protections, use bypasses, etc.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"b83b7ce2-a7c6-4238-a96e-605676b84c32","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1518/","name":"Software Discovery","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1518/001/","name":"Security Software Discovery","id":"T1518.001"}],"id":"T1518"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n   (process.name:\"wmic.exe\" or process.pe.original_file_name:\"wmic.exe\") and\n    process.args:\"/namespace:\\\\\\\\root\\\\SecurityCenter2\" and process.args:\"Get\"\n","throttle":"no_actions","actions":[]}
{"id":"fb314060-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.314Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.322Z","created_by":"burzhynskyyy","name":"Microsoft 365 Exchange Management Group Role Assignment [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Identity and Access"],"interval":"5m","enabled":true,"description":"Identifies when a new role is assigned to a management group in Microsoft 365. An adversary may attempt to add a role in order to maintain persistence in an environment.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["A new role may be assigned to a management group by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."],"from":"now-30m","rule_id":"5bfc5a8b-62b4-47f2-a296-9edbfa9440ce","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1098/","name":"Account Manipulation","id":"T1098"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://docs.microsoft.com/en-us/powershell/module/exchange/new-managementroleassignment?view=exchange-ps","https://docs.microsoft.com/en-us/microsoft-365/admin/add-users/about-admin-roles?view=o365-worldwide"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"New-ManagementRoleAssignment\" and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"ab31ae80-0969-11ee-8f07-79710758f25a","updated_at":"2023-07-05T12:45:25.699Z","updated_by":"analyst","created_at":"2023-06-12T21:39:55.198Z","created_by":"burzhynskyyy","name":"High Confidence Phish with disguised sender","tags":["Custom Rules"],"interval":"5m","enabled":true,"description":"Зафіксовано лист, якому присвоєна категорія HighConfidencePhish, де відправник замаскований під домен vuso.","risk_score":73,"severity":"high","license":"","output_index":"","meta":{"from":"10m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-900s","rule_id":"bb48986c-dfce-4b83-9704-5671be7bcf40","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":5,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"web where event.module:\"o365\" and event.provider:\"ThreatIntelligence\" and o365.audit.P2Sender:\"*vuso*\" and not o365.audit.P1Sender:\"*vuso*\" and not o365.audit.P1Sender:\"<>\"","filters":[],"throttle":"no_actions","actions":[]}
{"id":"49b36960-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.213Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.186Z","created_by":"chaykovskiyv","name":"Suspicious WMI Image Load from MS Office [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies a suspicious image load (wmiutils.dll) from Microsoft Office processes. This behavior may indicate adversarial activity where child processes are spawned via Windows Management Instrumentation (WMI). This technique can be used to execute code and evade traditional parent/child processes spawned from Microsoft Office products.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"bbb943cd-1bb6-43b3-aeec-f8e322750a76","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1047/","name":"Windows Management Instrumentation","id":"T1047"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://medium.com/threatpunter/detecting-adversary-tradecraft-with-image-load-event-logging-and-eql-8de93338c16"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"any where\n (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  process.name : (\"WINWORD.EXE\", \"EXCEL.EXE\", \"POWERPNT.EXE\", \"MSPUB.EXE\", \"MSACCESS.EXE\") and\n  (dll.name : \"wmiutils.dll\" or file.name : \"wmiutils.dll\")\n","throttle":"no_actions","actions":[]}
{"id":"4b6fbf60-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.627Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.117Z","created_by":"chaykovskiyv","name":"Unusual Child Process of dns.exe [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Initial Access","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies an unexpected process spawning from dns.exe, the process responsible for Windows DNS server services, which may indicate activity related to remote code execution or other forms of exploitation.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Unusual Child Process of dns.exe\n\nSIGRed (CVE-2020-1350) is a wormable, critical vulnerability in the Windows DNS server that affects Windows Server versions 2003 to 2019 and can be triggered by a malicious DNS response. Because the service is running in elevated privileges (SYSTEM), an attacker that successfully exploits it is granted Domain Administrator rights. This can effectively compromise the entire corporate infrastructure.\n\nThis rule looks for unusual children of the `dns.exe` process, which can indicate the exploitation of the SIGRed or a similar remote code execution vulnerability in the DNS server.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes.\n  - Any suspicious or abnormal child process spawned from dns.exe should be carefully reviewed and investigated. It's impossible to predict what an adversary may deploy as the follow-on process after the exploit, but built-in discovery/enumeration utilities should be top of mind (`whoami.exe`, `netstat.exe`, `systeminfo.exe`, `tasklist.exe`).\n  - Built-in Windows programs that contain capabilities used to download and execute additional payloads should also be considered. This is not an exhaustive list, but ideal candidates to start out would be: `mshta.exe`, `powershell.exe`, `regsvr32.exe`, `rundll32.exe`, `wscript.exe`, `wmic.exe`.\n  - If a denial-of-service (DoS) exploit is successful and DNS Server service crashes, be mindful of potential child processes related to `werfault.exe` occurring.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the host during the past 48 hours.\n- Check whether the server is vulnerable to CVE-2020-1350.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system or restore the compromised server to a clean state.\n- Install the latest patches on systems that run Microsoft DNS Server.\n- Consider the implementation of a patch management system, such as the Windows Server Update Services (WSUS).\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Werfault.exe will legitimately spawn when dns.exe crashes, but the DNS service is very stable and so this is a low occurring event. Denial of Service (DoS) attempts by intentionally crashing the service will also cause werfault.exe to spawn."],"from":"now-9m","rule_id":"fba1111b-aea9-49dd-b80f-aabb2dbf30bf","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1133/","name":"External Remote Services","id":"T1133"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":["https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/","https://msrc-blog.microsoft.com/2020/07/14/july-2020-security-update-cve-2020-1350-vulnerability-in-windows-domain-name-system-dns-server/","https://github.com/maxpl0it/CVE-2020-1350-DoS","https://www.elastic.co/security-labs/detection-rules-for-sigred-vulnerability"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and process.parent.name : \"dns.exe\" and\n  not process.name : \"conhost.exe\"\n","throttle":"no_actions","actions":[]}
{"id":"49b58c40-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.535Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.210Z","created_by":"chaykovskiyv","name":"Suspicious RDP ActiveX Client Loaded [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies suspicious Image Loading of the Remote Desktop Services ActiveX Client (mstscax), this may indicate the presence of RDP lateral movement capability.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"729152ae-3f4d-42fd-b464-5240f28de9fc","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":["https://posts.specterops.io/revisiting-remote-desktop-lateral-movement-8fb905cb46c3"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"any where (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n (dll.name : \"mstscax.dll\" or file.name : \"mstscax.dll\") and\n   /* depending on noise in your env add here extra paths  */\n  process.executable :\n    (\n    \"C:\\\\Windows\\\\*\",\n    \"C:\\\\Users\\\\Public\\\\*\",\n    \"C:\\\\Users\\\\Default\\\\*\",\n    \"C:\\\\Intel\\\\*\",\n    \"C:\\\\PerfLogs\\\\*\",\n    \"C:\\\\ProgramData\\\\*\",\n    \"\\\\Device\\\\Mup\\\\*\",\n    \"\\\\\\\\*\"\n    ) and\n    /* add here FPs */\n  not process.executable : (\"C:\\\\Windows\\\\System32\\\\mstsc.exe\", \"C:\\\\Windows\\\\SysWOW64\\\\mstsc.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"c8127b60-d2c8-11ed-b6f4-dfeac9073248","updated_at":"2023-06-08T21:29:33.490Z","updated_by":"burzhynskyyy","created_at":"2023-04-04T09:12:11.596Z","created_by":"burzhynskyyy","name":"Mass file recycled by one user","tags":["Custom Rules"],"interval":"5m","enabled":true,"description":"Масове переміщення файлів у корзину за короткий проміжок часу одним юзером.","risk_score":47,"severity":"medium","license":"","output_index":"","meta":{"from":"25m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-1800s","rule_id":"24d8cd01-e9ee-4f0d-8cbd-2023d91444fd","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"event.module:\"o365\" and event.provider:\"SharePoint\" and event.action:\"FileRecycled\" and user.name:\"starovoit.o\"","filters":[],"threshold":{"field":["user.name"],"value":10,"cardinality":[{"field":"file.name","value":10}]},"throttle":"no_actions","actions":[]}
{"id":"4b6d9c80-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.614Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.090Z","created_by":"chaykovskiyv","name":"Installation of Custom Shim Databases [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Identifies the installation of custom Application Compatibility Shim databases. This Windows functionality has been abused by attackers to stealthily gain persistence and arbitrary code execution in legitimate Windows processes.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"1e941bd2-1f96-4023-a5e8-b483267841c3","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1546/","name":"Event Triggered Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1546/011/","name":"Application Shimming","id":"T1546.011"}],"id":"T1546"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"sequence by process.entity_id with maxspan = 5m\n  [process where event.type == \"start\" and\n    not (process.name : \"sdbinst.exe\" and process.parent.name : \"msiexec.exe\")]\n  [registry where event.type in (\"creation\", \"change\") and\n    registry.path : \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\AppCompatFlags\\\\Custom\\\\*.sdb\"]\n","throttle":"no_actions","actions":[]}
{"id":"483de060-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.203Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.729Z","created_by":"chaykovskiyv","name":"Remote Desktop Enabled in Windows Firewall by Netsh [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies use of the network shell utility (netsh.exe) to enable inbound Remote Desktop Protocol (RDP) connections in the Windows Firewall.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Remote Desktop Enabled in Windows Firewall by Netsh\n\nMicrosoft Remote Desktop Protocol (RDP) is a proprietary Microsoft protocol that enables remote connections to other computers, typically over TCP port 3389.\n\nAttackers can use RDP to conduct their actions interactively. Ransomware operators frequently use RDP to access victim servers, often using privileged accounts.\n\nThis rule detects the creation of a Windows Firewall inbound rule that would allow inbound RDP traffic using the `netsh.exe` utility.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the user to check if they are aware of the operation.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check whether it makes sense to enable RDP to this host, given its role in the environment.\n- Check if the host is directly exposed to the internet.\n- Check whether privileged accounts accessed the host shortly after the modification.\n- Review network events within a short timespan of this alert for incoming RDP connection attempts.\n\n### False positive analysis\n\n- The `netsh.exe` utility can be used legitimately. Check whether the user should be performing this kind of activity, whether the user is aware of it, whether RDP should be open, and whether the action exposes the environment to unnecessary risks.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If RDP is needed, make sure to secure it:\n  - Allowlist RDP traffic to specific trusted hosts.\n  - Restrict RDP logins to authorized non-administrator accounts, where possible.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"c85653ad-0d65-4782-a055-258610cfcdc6","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/004/","name":"Disable or Modify System Firewall","id":"T1562.004"}],"id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n (process.name : \"netsh.exe\" or process.pe.original_file_name == \"netsh.exe\") and\n process.args : (\"localport=3389\", \"RemoteDesktop\", \"group=\\\"remote desktop\\\"\") and\n process.args : (\"action=allow\", \"enable=Yes\", \"enable\")\n","throttle":"no_actions","actions":[]}
{"id":"483d6b30-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.163Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.725Z","created_by":"chaykovskiyv","name":"Exporting Exchange Mailbox via PowerShell [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Collection","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the use of the Exchange PowerShell cmdlet, New-MailBoxExportRequest, to export the contents of a primary mailbox or archive to a .pst file. Adversaries may target user email to collect sensitive information.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Exporting Exchange Mailbox via PowerShell\n\nThe `New-MailBoxExportRequest` cmdlet is used to begin the process of exporting contents of a primary mailbox or archive to a .pst file. Note that this is done on a per-mailbox basis and this cmdlet is available only in on-premises Exchange.\n\nAttackers can abuse this functionality in preparation for exfiltrating contents, which is likely to contain sensitive and strategic data.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the export operation:\n  - Identify the user account that performed the action and whether it should perform this kind of action.\n  - Contact the account owner and confirm whether they are aware of this activity.\n  - Check if this operation was approved and performed according to the organization's change management policy.\n  - Retrieve the operation status and use the `Get-MailboxExportRequest` cmdlet to review previous requests.\n  - By default, no group in Exchange has the privilege to import or export mailboxes. Investigate administrators that assigned the \"Mailbox Import Export\" privilege for abnormal activity.\n- Investigate if there is a significant quantity of export requests in the alert timeframe. This operation is done on a per-mailbox basis and can be part of a mass export.\n- If the operation was completed successfully:\n  - Check if the file is on the path specified in the command.\n  - Investigate if the file was compressed, archived, or retrieved by the attacker for exfiltration.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and it is done with proper approval.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the involved host is not the Exchange server, isolate the host to prevent further post-compromise behavior.\n- Use the `Remove-MailboxExportRequest` cmdlet to remove fully or partially completed export requests.\n- Prioritize cases that involve personally identifiable information (PII) or other classified data.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges of users with the \"Mailbox Import Export\" privilege to ensure that the least privilege principle is being followed.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Legitimate exchange system administration activity."],"from":"now-9m","rule_id":"2d70f9f0-8492-4adf-b853-a993ac41dcf3","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1005/","name":"Data from Local System","id":"T1005"},{"reference":"https://attack.mitre.org/techniques/T1114/","name":"Email Collection","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1114/002/","name":"Remote Email Collection","id":"T1114.002"}],"id":"T1114"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0009/","name":"Collection","id":"TA0009"}}],"to":"now","references":["https://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breach-organizations/","https://docs.microsoft.com/en-us/powershell/module/exchange/new-mailboxexportrequest?view=exchange-ps"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.name: (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and \n  process.command_line : (\"*MailboxExportRequest*\", \"*-Mailbox*-ContentFilter*\")\n","throttle":"no_actions","actions":[]}
{"id":"4d519ec0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.194Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.246Z","created_by":"chaykovskiyv","name":"Account Discovery Command via SYSTEM Account [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies when the SYSTEM account uses an account discovery utility. This could be a sign of discovery activity after an adversary has achieved privilege escalation.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Account Discovery Command via SYSTEM Account\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of account discovery utilities using the SYSTEM account, which is commonly observed after attackers successfully perform privilege escalation or exploit web applications.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - If the process tree includes a web-application server process such as w3wp, httpd.exe, nginx.exe and alike, investigate any suspicious file creation or modification in the last 48 hours to assess the presence of any potential webshell backdoor.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Determine how the SYSTEM account is being used. For example, users with administrator privileges can spawn a system shell using Windows services, scheduled tasks or other third party utilities.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n- Use the data collected through the analysis to investigate other machines affected in the environment.","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"a487a432-2658-4eb2-ba3c-8a61f04edab8","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1033/","name":"System Owner/User Discovery","id":"T1033"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  (?process.Ext.token.integrity_level_name : \"System\" or\n  ?winlog.event_data.IntegrityLevel : \"System\") and\n  (process.name : \"whoami.exe\" or\n  (process.name : \"net1.exe\" and not process.parent.name : \"net.exe\"))\n","throttle":"no_actions","actions":[]}
{"id":"52b1f680-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:33.319Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.270Z","created_by":"chaykovskiyv","name":"Unsigned DLL Side-Loading from a Suspicious Folder [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Identifies a Windows trusted program running from locations often abused by adversaries to masquerade as a trusted program and loading a recently dropped DLL. This behavior may indicate an attempt to evade defenses via side-loading a malicious DLL within the memory space of a signed processes.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"8a4c7a74-bfa0-405a-a2ed-18774fbbef54","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1574/","name":"Hijack Execution Flow","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1574/002/","name":"DLL Side-Loading","id":"T1574.002"}],"id":"T1574"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"library where \n\n process.code_signature.trusted == true and \n \n (dll.Ext.relative_file_creation_time <= 500 or dll.Ext.relative_file_name_modify_time <= 500) and \n \n  not dll.code_signature.status : (\"trusted\", \"errorExpired\", \"errorCode_endpoint*\", \"errorChaining\") and \n  \n      /* Suspicious Paths */\n      dll.path : (\"?:\\\\PerfLogs\\\\*.dll\",\n                  \"?:\\\\Users\\\\*\\\\Pictures\\\\*.dll\",\n                  \"?:\\\\Users\\\\*\\\\Music\\\\*.dll\",\n                  \"?:\\\\Users\\\\Public\\\\*.dll\",\n                  \"?:\\\\Users\\\\*\\\\Documents\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Tasks\\\\*.dll\",\n                  \"?:\\\\Windows\\\\System32\\\\Tasks\\\\*.dll\",\n                  \"?:\\\\Intel\\\\*.dll\",\n                  \"?:\\\\AMD\\\\Temp\\\\*.dll\",\n                  \"?:\\\\Windows\\\\AppReadiness\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ServiceState\\\\*.dll\",\n                  \"?:\\\\Windows\\\\security\\\\*.dll\",\n\t\t  \"?:\\\\Windows\\\\System\\\\*.dll\",\n                  \"?:\\\\Windows\\\\IdentityCRL\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Branding\\\\*.dll\",\n                  \"?:\\\\Windows\\\\csc\\\\*.dll\",\n                  \"?:\\\\Windows\\\\DigitalLocker\\\\*.dll\",\n                  \"?:\\\\Windows\\\\en-US\\\\*.dll\",\n                  \"?:\\\\Windows\\\\wlansvc\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Prefetch\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Fonts\\\\*.dll\",\n                  \"?:\\\\Windows\\\\diagnostics\\\\*.dll\",\n                  \"?:\\\\Windows\\\\TAPI\\\\*.dll\",\n                  \"?:\\\\Windows\\\\INF\\\\*.dll\",\n                  \"?:\\\\windows\\\\tracing\\\\*.dll\",\n                  \"?:\\\\windows\\\\IME\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Performance\\\\*.dll\",\n                  \"?:\\\\windows\\\\intel\\\\*.dll\",\n                  \"?:\\\\windows\\\\ms\\\\*.dll\",\n                  \"?:\\\\Windows\\\\dot3svc\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ServiceProfiles\\\\*.dll\",\n                  \"?:\\\\Windows\\\\panther\\\\*.dll\",\n                  \"?:\\\\Windows\\\\RemotePackages\\\\*.dll\",\n                  \"?:\\\\Windows\\\\OCR\\\\*.dll\",\n                  \"?:\\\\Windows\\\\appcompat\\\\*.dll\",\n                  \"?:\\\\Windows\\\\apppatch\\\\*.dll\",\n                  \"?:\\\\Windows\\\\addins\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Setup\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Help\\\\*.dll\",\n                  \"?:\\\\Windows\\\\SKB\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Vss\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Web\\\\*.dll\",\n                  \"?:\\\\Windows\\\\servicing\\\\*.dll\",\n                  \"?:\\\\Windows\\\\CbsTemp\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Logs\\\\*.dll\",\n                  \"?:\\\\Windows\\\\WaaS\\\\*.dll\",\n                  \"?:\\\\Windows\\\\twain_32\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ShellExperiences\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ShellComponents\\\\*.dll\",\n                  \"?:\\\\Windows\\\\PLA\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Migration\\\\*.dll\",\n                  \"?:\\\\Windows\\\\debug\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Cursors\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Containers\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Boot\\\\*.dll\",\n                  \"?:\\\\Windows\\\\bcastdvr\\\\*.dll\",\n                  \"?:\\\\Windows\\\\TextInput\\\\*.dll\",\n                  \"?:\\\\Windows\\\\schemas\\\\*.dll\",\n                  \"?:\\\\Windows\\\\SchCache\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Resources\\\\*.dll\",\n                  \"?:\\\\Windows\\\\rescache\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Provisioning\\\\*.dll\",\n                  \"?:\\\\Windows\\\\PrintDialog\\\\*.dll\",\n                  \"?:\\\\Windows\\\\PolicyDefinitions\\\\*.dll\",\n                  \"?:\\\\Windows\\\\media\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Globalization\\\\*.dll\",\n                  \"?:\\\\Windows\\\\L2Schemas\\\\*.dll\",\n                  \"?:\\\\Windows\\\\LiveKernelReports\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ModemLogs\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ImmersiveControlPanel\\\\*.dll\",\n                  \"?:\\\\$Recycle.Bin\\\\*.dll\") and \n\t \n\t /* DLL loaded from the process.executable current directory */\n\t endswith~(substring(dll.path, 0, length(dll.path) - (length(dll.name) + 1)), substring(process.executable, 0, length(process.executable) - (length(process.name) + 1)))\n","throttle":"no_actions","actions":[]}
{"id":"4f2aa480-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.126Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.358Z","created_by":"chaykovskiyv","name":"Disabling Windows Defender Security Settings via PowerShell [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies use of the Set-MpPreference PowerShell command to disable or weaken certain Windows Defender settings.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Disabling Windows Defender Security Settings via PowerShell\n\nMicrosoft Windows Defender is an antivirus product built into Microsoft Windows, which makes it popular across multiple environments. Disabling it is a common step in threat actor playbooks.\n\nThis rule monitors the execution of commands that can tamper the Windows Defender antivirus features.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the command line to determine which action was executed. Based on that, examine exceptions, antivirus state, sample submission, etc.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity, the configuration is justified (for example, it is being used to deploy other security solutions or troubleshooting), and no other suspicious activity has been observed.\n\n### Related rules\n\n- Windows Defender Disabled via Registry Modification - 2ffa1f1e-b6db-47fa-994b-1512743847eb\n- Microsoft Windows Defender Tampering - fe794edd-487f-4a90-b285-3ee54f2af2d3\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Based on the command line, take actions to restore the appropriate Windows Defender antivirus configurations.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Planned Windows Defender configuration changes."],"from":"now-9m","rule_id":"6701bcc1-cc6e-48d6-be62-d9947eb30ed6","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/001/","name":"Disable or Modify Tools","id":"T1562.001"}],"id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://docs.microsoft.com/en-us/powershell/module/defender/set-mppreference?view=windowsserver2019-ps"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n (process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")) and\n process.args : \"Set-MpPreference\" and process.args : (\"-Disable*\", \"Disabled\", \"NeverSend\", \"-Exclusion*\")\n","throttle":"no_actions","actions":[]}
{"id":"4f204440-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.176Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.318Z","created_by":"chaykovskiyv","name":"Persistence via BITS Job Notify Cmdline [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"An adversary can use the Background Intelligent Transfer Service (BITS) SetNotifyCmdLine method to execute a program that runs after a job finishes transferring data or after a job enters a specified state in order to persist on a system.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"3846e333-adcc-436c-bc72-a5acc6eac5b2","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1197/","name":"BITS Jobs","id":"T1197"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://pentestlab.blog/2019/10/30/persistence-bits-jobs/","https://docs.microsoft.com/en-us/windows/win32/api/bits1_5/nf-bits1_5-ibackgroundcopyjob2-setnotifycmdline","https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/bitsadmin-setnotifycmdline","https://www.elastic.co/blog/hunting-for-persistence-using-elastic-security-part-2"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  process.parent.name : \"svchost.exe\" and process.parent.args : \"BITS\" and\n  not process.executable :\n              (\"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\",\n               \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n               \"?:\\\\Windows\\\\System32\\\\wermgr.exe\",\n               \"?:\\\\WINDOWS\\\\system32\\\\directxdatabaseupdater.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"483d1d10-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.182Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.721Z","created_by":"chaykovskiyv","name":"Command Execution via SolarWinds Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Elastic Endgame"],"interval":"5m","enabled":true,"description":"A suspicious SolarWinds child process (Cmd.exe or Powershell.exe) was detected.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Trusted SolarWinds child processes. Verify process details such as network connections and file writes."],"from":"now-9m","rule_id":"0b1fceb0-0a81-4abc-bbd2-1db83988bbfc","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1195/","name":"Supply Chain Compromise","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1195/002/","name":"Compromise Software Supply Chain","id":"T1195.002"}],"id":"T1195"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":["https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html","https://github.com/mandiant/sunburst_countermeasures/blob/main/rules/SUNBURST/hxioc/SUNBURST%20SUSPICIOUS%20FILEWRITES%20(METHODOLOGY).ioc"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and process.name: (\"cmd.exe\", \"powershell.exe\") and\nprocess.parent.name: (\n     \"ConfigurationWizard*.exe\",\n     \"NetflowDatabaseMaintenance*.exe\",\n     \"NetFlowService*.exe\",\n     \"SolarWinds.Administration*.exe\",\n     \"SolarWinds.Collector.Service*.exe\",\n     \"SolarwindsDiagnostics*.exe\"\n     )\n","throttle":"no_actions","actions":[]}
{"id":"4b46da40-bc7a-11ed-b6f4-dfeac9073248","updated_at":"2023-08-22T08:15:36.573Z","updated_by":"chaykovskiyv","created_at":"2023-03-06T23:54:56.180Z","created_by":"burzhynskyyy","name":"Fortigate IPS Internal Detection","tags":["Custom Rules"],"interval":"5m","enabled":true,"description":"Fortigate IPS detection where source IP address from private networks (10.0.0.0/8,\n 172.16.0.0/12, 192.168.0.0/24)","risk_score":73,"severity":"high","license":"","output_index":"","timeline_id":"300afc76-072d-4261-864d-4149714bf3f1","timeline_title":"Comprehensive Network Timeline","meta":{"from":"1m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-360s","rule_id":"2bafbf96-6c88-40b0-ae58-51d35ae26206","max_signals":100,"risk_score_mapping":[],"severity_mapping":[{"field":"fortinet.firewall.crlevel","value":"low","operator":"equals","severity":"low"},{"field":"fortinet.firewall.crlevel","value":"medium","operator":"equals","severity":"medium"},{"field":"fortinet.firewall.crlevel","value":"high","operator":"equals","severity":"high"},{"field":"fortinet.firewall.crlevel","value":"critical","operator":"equals","severity":"critical"}],"threat":[],"to":"now","references":[],"version":8,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"fortinet.firewall.subtype:\"ips\" and source.ip:(10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16) and not (destination.ip:\"9.9.9.9\" or \"192.168.5.141\" and destination.port:\"53\" or \"1433\") and fortinet.firewall.crscore>= 30 and not source.ip: (\"192.168.5.194\" or \"172.20.5.4\" or \"192.168.5.125\" or \"192.168.5.165\") and not (fortinet.firewall.attack: \"MS.SQL.Server.Login.Large.Buffer.DoS\" and destination.ip: \"192.168.5.141\" and destination.port: \"1433\" and source.ip: (\"172.20.11.31\" or \"172.20.11.32\" or \"172.20.11.33\" or \"172.20.11.34\"))","filters":[],"throttle":"no_actions","actions":[]}
{"id":"50e37810-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.250Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.259Z","created_by":"chaykovskiyv","name":"Potential Local NTLM Relay via HTTP [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies attempt to coerce a local NTLM authentication via HTTP using the Windows Printer Spooler service as a target. An adversary may use this primitive in combination with other techniques to elevate privileges on a compromised system.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"64cd9bc7-b450-42f1-a539-201f9244332d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1212/","name":"Exploitation for Credential Access","id":"T1212"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://github.com/med0x2e/NTLMRelay2Self","https://github.com/topotam/PetitPotam","https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.name : \"rundll32.exe\" and\n\n  /* Rundll32 WbeDav Client  */\n  process.args : (\"?:\\\\Windows\\\\System32\\\\davclnt.dll,DavSetCookie\", \"?:\\\\Windows\\\\SysWOW64\\\\davclnt.dll,DavSetCookie\") and\n\n  /* Access to named pipe via http */\n  process.args : (\"http*/print/pipe/*\", \"http*/pipe/spoolss\", \"http*/pipe/srvsvc\")\n","throttle":"no_actions","actions":[]}
{"id":"50e10710-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.065Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.226Z","created_by":"chaykovskiyv","name":"Microsoft Exchange Server UM Spawning Suspicious Processes [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Initial Access"],"interval":"5m","enabled":true,"description":"Identifies suspicious processes being spawned by the Microsoft Exchange Server Unified Messaging (UM) service. This activity has been observed exploiting CVE-2021-26857.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic","Austin Songer"],"false_positives":["Legitimate processes may be spawned from the Microsoft Exchange Server Unified Messaging (UM) service. If known processes are causing false positives, they can be exempted from the rule."],"from":"now-9m","rule_id":"258309bd-e0ba-4d1a-84ea-d84808b8138d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1190/","name":"Exploit Public-Facing Application","id":"T1190"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":["https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers","https://www.volexity.com/blog/2021/03/02/active-exploitation-of-microsoft-exchange-zero-day-vulnerabilities"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  process.parent.name : (\"UMService.exe\", \"UMWorkerProcess.exe\") and\n    not process.executable :\n              (\"?:\\\\Windows\\\\System32\\\\werfault.exe\",\n               \"?:\\\\Windows\\\\System32\\\\wermgr.exe\",\n               \"?:\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\V??\\\\Bin\\\\UMWorkerProcess.exe\",\n               \"D:\\\\Exchange 2016\\\\Bin\\\\UMWorkerProcess.exe\",\n               \"E:\\\\ExchangeServer\\\\Bin\\\\UMWorkerProcess.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"4f224010-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.182Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.331Z","created_by":"chaykovskiyv","name":"Sensitive Privilege SeEnableDelegationPrivilege assigned to a User [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Active Directory","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies the assignment of the SeEnableDelegationPrivilege sensitive \"user right\" to a user. The SeEnableDelegationPrivilege \"user right\" enables computer and user accounts to be trusted for delegation. Attackers can abuse this right to compromise Active Directory accounts and elevate their privileges.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Sensitive Privilege SeEnableDelegationPrivilege assigned to a User\n\nKerberos delegation is an Active Directory feature that allows user and computer accounts to impersonate other accounts, act on their behalf, and use their privileges. Delegation (constrained and unconstrained) can be configured for user and computer objects.\n\nEnabling unconstrained delegation for a computer causes the computer to store the ticket-granting ticket (TGT) in memory at any time an account connects to the computer, so it can be used by the computer for impersonation when needed. Risk is heightened if an attacker compromises computers with unconstrained delegation enabled, as they could extract TGTs from memory and then replay them to move laterally on the domain. If the attacker coerces a privileged user to connect to the server, or if the user does so routinely, the account will be compromised and the attacker will be able to pass-the-ticket to privileged assets.\n\nSeEnableDelegationPrivilege is a user right that is controlled within the Local Security Policy of a domain controller and is managed through Group Policy. This setting is named **Enable computer and user accounts to be trusted for delegation**.\n\nIt is critical to control the assignment of this privilege. A user with this privilege and write access to a computer can control delegation settings, perform the attacks described above, and harvest TGTs from any user that connects to the system.\n\n#### Possible investigation steps\n\n- Investigate how the privilege was assigned to the user and who assigned it.\n- Investigate other potentially malicious activity that was performed by the user that assigned the privileges using the `user.id` and `winlog.activity_id` fields as a filter during the past 48 hours.\n- Investigate other alerts associated with the users/host during the past 48 hours.\n\n### False positive analysis\n\n- The SeEnableDelegationPrivilege privilege should not be assigned to users. If this rule is triggered in your environment legitimately, the security team should notify the administrators about the risks of using it.\n\n### Related rules\n\n- KRBTGT Delegation Backdoor - e052c845-48d0-4f46-8a13-7d0aba05df82\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Remove the privilege from the account.\n- Review the privileges of the administrator account that performed the action.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"a2498679-f687-4971-bd1b-b3972220cf9f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}},{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://blog.harmj0y.net/activedirectory/the-most-dangerous-user-right-you-probably-have-never-heard-of/","https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_alert_active_directory_user_control.yml","https://twitter.com/_nwodtuhs/status/1454049485080907776","https://www.thehacker.recipes/ad/movement/kerberos/delegations","https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0105_windows_audit_authorization_policy_change.md"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.action: \"Authorization Policy Change\" and event.code:4704 and winlog.event_data.PrivilegeList:\"SeEnableDelegationPrivilege\"\n","throttle":"no_actions","actions":[]}
{"id":"4f2414d0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.193Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.343Z","created_by":"chaykovskiyv","name":"Windows Registry File Creation in SMB Share [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement","Credential Access","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies the creation or modification of a medium-size registry hive file on a Server Message Block (SMB) share, which may indicate an exfiltration attempt of a previously dumped Security Account Manager (SAM) registry hive for credential extraction on an attacker-controlled system.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Windows Registry File Creation in SMB Share\n\nDumping registry hives is a common way to access credential information. Some hives store credential material, as is the case for the SAM hive, which stores locally cached credentials (SAM secrets), and the SECURITY hive, which stores domain cached credentials (LSA secrets). Dumping these hives in combination with the SYSTEM hive enables the attacker to decrypt these secrets.\n\nAttackers can try to evade detection on the host by transferring this data to a system that is not monitored to be parsed and decrypted. This rule identifies the creation or modification of a medium-size registry hive file on an SMB share, which may indicate this kind of exfiltration attempt.\n\n#### Possible investigation steps\n\n- Investigate other alerts associated with the user/source host during the past 48 hours.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Inspect the source host for suspicious or abnormal behaviors in the alert timeframe.\n- Capture the registry file(s) to determine the extent of the credential compromise in an eventual incident response.\n\n### False positive analysis\n\n- Administrators can export registry hives for backup purposes. Check whether the user should be performing this kind of activity and is aware of it.\n\n### Related rules\n\n- Credential Acquisition via Registry Hive Dumping - a7e7bfa3-088e-4f13-b29e-3986e0e756b8\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system and restore compromised files to clean versions.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"988d3622-1710-43f2-8a83-39dc654b64cc","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/002/","name":"Security Account Manager","id":"T1003.002"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1021/002/","name":"SMB/Windows Admin Shares","id":"T1021.002"}],"id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":["https://www.elastic.co/security-labs/detect-credential-access"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"file where event.type == \"creation\" and\n /* regf file header */\n file.Ext.header_bytes : \"72656766*\" and file.size >= 30000 and\n process.pid == 4 and user.id : (\"S-1-5-21*\", \"S-1-12-1-*\")\n","throttle":"no_actions","actions":[]}
{"id":"50e525c0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.264Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.277Z","created_by":"chaykovskiyv","name":"Remote Logon followed by Scheduled Task Creation [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies a remote logon followed by a scheduled task creation on the target host. This could be indicative of adversary lateral movement.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Remote Scheduled Task Creation\n\n[Scheduled tasks](https://docs.microsoft.com/en-us/windows/win32/taskschd/about-the-task-scheduler) are a great mechanism for persistence and program execution. These features can be used remotely for a variety of legitimate reasons, but at the same time used by malware and adversaries. When investigating scheduled tasks that were set up remotely, one of the first steps should be to determine the original intent behind the configuration and to verify if the activity is tied to benign behavior such as software installation or any kind of network administrator work. One objective for these alerts is to understand the configured action within the scheduled task. This is captured within the registry event data for this rule and can be base64 decoded to view the value.\n\n#### Possible investigation steps\n\n- Review the TaskContent value to investigate the task configured action.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Further examination should include review of host-based artifacts and network logs from around when the scheduled task was created, on both the source and target machines.\n\n### False positive analysis\n\n- There is a high possibility of benign activity tied to the creation of remote scheduled tasks as it is a general feature within Windows and used for legitimate purposes for a wide range of activity. Any kind of context should be found to further understand the source of the activity and determine the intent based on the scheduled task's contents.\n\n### Related rules\n\n- Service Command Lateral Movement - d61cbcf8-1bc1-4cff-85ba-e7b21c5beedc\n- Remotely Started Services via RPC - aa9a274d-6b53-424d-ac5e-cb8ca4251650\n- Remote Scheduled Task Creation - 954ee7c8-5437-49ae-b2d6-2960883898e9\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Remove scheduled task and any other related artifacts.\n- Review privileged account management and user account management settings. Consider implementing group policy object (GPO) policies to further restrict activity, or configuring settings that only allow administrators to create remote scheduled tasks.\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"a14173a2-4adc-4c31-a8f9-1d5507b7387d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1053/","name":"Scheduled Task/Job","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1053/005/","name":"Scheduled Task","id":"T1053.005"}],"id":"T1053"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":3,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"/* Network Logon followed by Scheduled Task creation  */\n\nsequence by winlog.computer_name with maxspan=1m\n  [authentication where event.action == \"logged-in\" and\n   winlog.logon.type == \"Network\" and event.outcome == \"success\" and\n   not user.name == \"ANONYMOUS LOGON\" and not winlog.event_data.SubjectUserName : \"*$\" and\n   not user.domain == \"NT AUTHORITY\" and source.ip != \"127.0.0.1\" and source.ip !=\"::1\"] by winlog.event_data.TargetLogonId\n\n  [iam where event.action == \"scheduled-task-created\"] by winlog.event_data.SubjectLogonId\n","throttle":"no_actions","actions":[]}
{"id":"4b711ef0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.642Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.134Z","created_by":"chaykovskiyv","name":"Volume Shadow Copy Deletion via WMIC [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Impact","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies use of wmic.exe for shadow copy deletion on endpoints. This commonly occurs in tandem with ransomware or other destructive attacks.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Volume Shadow Copy Deletion via WMIC\n\nThe Volume Shadow Copy Service (VSS) is a Windows feature that enables system administrators to take snapshots of volumes that can later be restored or mounted to recover specific files or folders.\n\nA typical step in the playbook of an attacker attempting to deploy ransomware is to delete Volume Shadow Copies to ensure that victims have no alternative to paying the ransom, making any action that deletes shadow copies worth monitoring.\n\nThis rule monitors the execution of `wmic.exe` to interact with VSS via the `shadowcopy` alias and delete parameter.\n\n#### Possible investigation steps\n\n- Investigate the program execution chain (parent process tree).\n- Check whether the account is authorized to perform this operation.\n- Contact the account owner and confirm whether they are aware of this activity.\n- In the case of a resize operation, check if the resize value is equal to suspicious values, like 401MB.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- If unsigned files are found on the process tree, retrieve them and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Use process name, command line, and file hash to search for occurrences in other hosts.\n- Check if any files on the host machine have been encrypted.\n\n\n### False positive analysis\n\n- This rule has chances of producing benign true positives (B-TPs). If this activity is expected and noisy in your environment, consider adding exceptions — preferably with a combination of user and command line conditions.\n\n### Related rules\n\n- Volume Shadow Copy Deleted or Resized via VssAdmin - b5ea4bfe-a1b2-421f-9d47-22a75a6f2921\n- Volume Shadow Copy Deletion via PowerShell - d99a037b-c8e2-47a5-97b9-170d076827c4\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Priority should be given due to the advanced stage of this activity on the attack.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- If data was encrypted, deleted, or modified, activate your data recovery plan.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Perform data recovery locally or restore the backups from replicated copies (cloud, other servers, etc.).\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"f9669470-51c3-43c1-82b5-73189b9ea401","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1490/","name":"Inhibit System Recovery","id":"T1490"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0040/","name":"Impact","id":"TA0040"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  (process.name : \"WMIC.exe\" or process.pe.original_file_name == \"wmic.exe\") and\n  process.args : \"delete\" and process.args : \"shadowcopy\"\n","throttle":"no_actions","actions":[]}
{"id":"3ae14890-bc7d-11ed-b6f4-dfeac9073248","updated_at":"2023-06-20T11:04:25.823Z","updated_by":"analyst","created_at":"2023-03-07T00:15:56.781Z","created_by":"burzhynskyyy","name":"One Host Scanning Detected","tags":["Custom Rules"],"interval":"5m","enabled":true,"description":"Network scanning detected of multiple ports toward one host","risk_score":47,"severity":"medium","license":"","output_index":"","timeline_id":"300afc76-072d-4261-864d-4149714bf3f1","timeline_title":"Comprehensive Network Timeline","meta":{"from":"6m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-660s","rule_id":"e694c966-f1cf-4d1a-a0f0-efde745a8d14","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":4,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"fortinet.firewall.type:\"traffic\" and source.ip:(10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16) and destination.port < 10000 and not destination.port:(53 or 80 or 443) and not source.ip: (\"192.168.5.194\" or \"192.168.5.155\")","filters":[],"threshold":{"field":["source.ip","destination.ip"],"value":20,"cardinality":[{"field":"destination.port","value":20}]},"throttle":"no_actions","actions":[]}
{"id":"16f09400-f372-11ed-8f07-79710758f25a","updated_at":"2023-06-08T21:31:14.593Z","updated_by":"burzhynskyyy","created_at":"2023-05-15T22:44:46.325Z","created_by":"burzhynskyyy","name":"o365 MFA multiple phone app no response by one user","tags":["Custom Rules"],"interval":"5m","enabled":true,"description":"o365 MFA multiple phone app no response by one user","risk_score":47,"severity":"medium","license":"","output_index":"","meta":{"from":"10m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-900s","rule_id":"f5c124d3-a345-4157-898e-aec8ca9ecf2d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"azure.eventhub.properties.authenticationRequirement:\"multiFactorAuthentication\" and azure.eventhub.properties.status.additionalDetails:\"MFA denied; user did not respond to mobile app notification\"","filters":[],"threshold":{"field":["azure.eventhub.properties.userPrincipalName","azure.eventhub.properties.resourceDisplayName"],"value":3,"cardinality":[]},"throttle":"no_actions","actions":[]}
{"id":"48427440-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.198Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.781Z","created_by":"chaykovskiyv","name":"Potential Invoke-Mimikatz PowerShell Script [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Investigation Guide","PowerShell"],"interval":"5m","enabled":true,"description":"Mimikatz is a credential dumper capable of obtaining plaintext Windows account logins and passwords, along with many other features that make it useful for testing the security of networks. This rule detects Invoke-Mimikatz PowerShell script and alike.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Mimikatz PowerShell Activity\n\n[Mimikatz](https://github.com/gentilkiwi/mimikatz) is an open-source tool used to collect, decrypt, and/or use cached credentials. This tool is commonly abused by adversaries during the post-compromise stage where adversaries have gained an initial foothold on an endpoint and are looking to elevate privileges and seek out additional authentication objects such as tokens/hashes/credentials that can then be used to move laterally and pivot across a network.\n\nThis rule looks for PowerShell scripts that load mimikatz in memory, like Invoke-Mimikataz, which are used to dump credentials from the Local Security Authority Subsystem Service (LSASS). Any activity triggered from this rule should be treated with high priority as it typically represents an active adversary.\n\nMore information about Mimikatz components and how to detect/prevent them can be found on [ADSecurity](https://adsecurity.org/?page_id=1821).\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Invoke-Mimitakz and alike scripts heavily use other capabilities covered by other detections described in the \"Related Rules\" section.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host.\n  - Examine network and security events in the environment to identify potential lateral movement using compromised credentials.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Suspicious .NET Reflection via PowerShell - e26f042e-c590-4e82-8e05-41e81bd822ad\n- PowerShell Suspicious Payload Encoded and Compressed - 81fe9dc6-a2d7-4192-a2d8-eed98afc766a\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- Mimikatz Memssp Log File Detected - ebb200e8-adf0-43f8-a0bb-4ee5b5d852c6\n- Modification of WDigest Security Provider - d703a5af-d5b0-43bd-8ddb-7a5d500b7da5\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Validate that cleartext passwords are disabled in memory for use with `WDigest`.\n- Look into preventing access to `LSASS` using capabilities such as LSA protection or antivirus/EDR tools that provide this capability.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"48e44c81-589a-49f7-a961-e56f2285857a","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/001/","name":"LSASS Memory","id":"T1003.001"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://attack.mitre.org/software/S0002/","https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1","https://www.elastic.co/security-labs/detect-credential-access"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and\npowershell.file.script_block_text:(\n  (DumpCreds and\n  DumpCerts) or\n  \"sekurlsa::logonpasswords\" or\n  (\"crypto::certificates\" and\n  \"CERT_SYSTEM_STORE_LOCAL_MACHINE\")\n)\n","throttle":"no_actions","actions":[]}
{"id":"483fb520-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.180Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.746Z","created_by":"chaykovskiyv","name":"Lateral Movement via Startup Folder [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies suspicious file creations in the startup folder of a remote system. An adversary could abuse this to move laterally by dropping a malicious script or executable that will be executed after a reboot or user logon.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"fc753339-435e-402b-8fd8-87524c4a3bf6","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1547/001/","name":"Registry Run Keys / Startup Folder","id":"T1547.001"}],"id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://www.mdsec.co.uk/2017/06/rdpinception/"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"file where event.type in (\"creation\", \"change\") and\n\n /* via RDP TSClient mounted share or SMB */\n  (process.name : \"mstsc.exe\" or process.pid == 4) and\n\n   file.path : (\"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\",\n                \"?:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\")\n","throttle":"no_actions","actions":[]}
{"id":"49b230e0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.191Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.174Z","created_by":"chaykovskiyv","name":"Potential DNS Tunneling via NsLookup [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Command and Control","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"This rule identifies a large number (15) of nslookup.exe executions with an explicit query type from the same host. This may indicate command and control activity utilizing the DNS protocol.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Potential DNS Tunneling via NsLookup\n\nAttackers can abuse existing network rules that allow DNS communication with external resources to use the protocol as their command and control and/or exfiltration channel.\n\nDNS queries can be used to infiltrate data such as commands to be run, malicious files, etc., and also for exfiltration, since queries can be used to send data to the attacker-controlled DNS server. This process is commonly known as DNS tunneling.\n\nMore information on how tunneling works and how it can be abused can be found on [Palo Alto Unit42 Research](https://unit42.paloaltonetworks.com/dns-tunneling-how-dns-can-be-abused-by-malicious-actors).\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the DNS query and identify the information sent.\n- Extract this communication's indicators of compromise (IoCs) and use traffic logs to search for other potentially compromised hosts.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. If the parent process is trusted and the data sent is not sensitive nor command and control related, this alert can be closed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Immediately block the identified indicators of compromise (IoCs).\n- Implement any temporary network rules, procedures, and segmentation required to contain the attack.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Update firewall rules to be more restrictive.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"c32140d1-3438-46eb-b0d5-5eb176b9a152","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1071/","name":"Application Layer Protocol","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1071/004/","name":"DNS","id":"T1071.004"}],"id":"T1071"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0011/","name":"Command and Control","id":"TA0011"}}],"to":"now","references":["https://unit42.paloaltonetworks.com/dns-tunneling-in-the-wild-overview-of-oilrigs-dns-tunneling/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"event.category:process and event.type:start and process.name:nslookup.exe and process.args:(-querytype=* or -qt=* or -q=* or -type=*)\n","threshold":{"field":["host.id"],"value":15},"throttle":"no_actions","actions":[]}
{"id":"49b05c20-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.158Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.146Z","created_by":"chaykovskiyv","name":"Mounting Hidden or WebDav Remote Shares [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Initial Access","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies the use of net.exe to mount a WebDav or hidden remote share. This may indicate lateral movement or preparation for data exfiltration.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"751f46f5-abb3-449c-9564-f00d2ae1cef1","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1021/002/","name":"SMB/Windows Admin Shares","id":"T1021.002"}],"id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1078/","name":"Valid Accounts","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1078/003/","name":"Local Accounts","id":"T1078.003"}],"id":"T1078"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"process where event.type == \"start\" and\n ((process.name : \"net.exe\" or process.pe.original_file_name == \"net.exe\") or ((process.name : \"net1.exe\" or process.pe.original_file_name == \"net1.exe\") and\n not process.parent.name : \"net.exe\")) and\n process.args : \"use\" and\n /* including hidden and webdav based online shares such as onedrive  */\n process.args : (\"\\\\\\\\*\\\\*$*\", \"\\\\\\\\*@SSL\\\\*\", \"http*\") and\n /* excluding shares deletion operation */\n not process.args : \"/d*\"\n","throttle":"no_actions","actions":[]}
{"id":"4b6dc390-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.613Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.092Z","created_by":"chaykovskiyv","name":"Remote File Download via Desktopimgdownldr Utility [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Command and Control","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the desktopimgdownldr utility being used to download a remote file. An adversary may use desktopimgdownldr to download arbitrary files as an alternative to certutil.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Remote File Download via Desktopimgdownldr Utility\n\nAttackers commonly transfer tooling or malware from external systems into a compromised environment using the command and control channel. However, they can also abuse signed utilities to drop these files.\n\nThe `Desktopimgdownldr.exe` utility is used to to configure lockscreen/desktop image, and can be abused with the `lockscreenurl` argument to download remote files and tools, this rule looks for this behavior.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Check the reputation of the domain or IP address used to host the downloaded file or if the user downloaded the file from an internal system.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unusual but can be done by administrators. Benign true positives (B-TPs) can be added as exceptions if necessary.\n- Analysts can dismiss the alert if the downloaded file is a legitimate image.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"73ad1543-5d92-4feb-b765-d843e05d57f8","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1105/","name":"Ingress Tool Transfer","id":"T1105"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0011/","name":"Command and Control","id":"TA0011"}}],"to":"now","references":["https://labs.sentinelone.com/living-off-windows-land-a-new-native-file-downldr/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  (process.name : \"desktopimgdownldr.exe\" or process.pe.original_file_name == \"desktopimgdownldr.exe\") and\n  process.args : \"/lockscreenurl:http*\"\n","throttle":"no_actions","actions":[]}
{"id":"4f29e130-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.206Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.351Z","created_by":"chaykovskiyv","name":"AdminSDHolder SDProp Exclusion Added [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Active Directory","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies a modification on the dsHeuristics attribute on the bit that holds the configuration of groups excluded from the SDProp process. The SDProp compares the permissions on protected objects with those defined on the AdminSDHolder object. If the permissions on any of the protected accounts and groups do not match, the permissions on the protected accounts and groups are reset to match those of the domain's AdminSDHolder object, meaning that groups excluded will remain unchanged. Attackers can abuse this misconfiguration to maintain long-term access to privileged accounts in these groups.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating AdminSDHolder SDProp Exclusion Added\n\nThe SDProp process compares the permissions on protected objects with those defined on the AdminSDHolder object. If the permissions on any of the protected accounts and groups do not match, it resets the permissions on the protected accounts and groups to match those defined in the domain AdminSDHolder object.\n\nThe dSHeuristics is a Unicode string attribute, in which each character in the string represents a heuristic that is used to determine the behavior of Active Directory.\n\nAdministrators can use the dSHeuristics attribute to exclude privilege groups from the SDProp process by setting the 16th bit (dwAdminSDExMask) of the string to a certain value, which represents the group(s):\n\n- For example, to exclude the Account Operators group, an administrator would modify the string, so the 16th character is set to 1 (i.e., 0000000001000001).\n\nThe usage of this exclusion can leave the accounts unprotected and facilitate the misconfiguration of privileges for the excluded groups, enabling attackers to add accounts to these groups to maintain long-term persistence with high privileges.\n\nThis rule matches changes of the dsHeuristics object where the 16th bit is set to a value other than zero.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check the value assigned to the 16th bit of the string on the `winlog.event_data.AttributeValue` field:\n    - Account Operators eq 1\n    - Server Operators eq 2\n    - Print Operators eq 4\n    - Backup Operators eq 8\n    The field value can range from 0 to f (15). If more than one group is specified, the values will be summed together; for example, Backup Operators and Print Operators will set the `c` value on the bit.\n\n### False positive analysis\n\n- While this modification can be done legitimately, it is not a best practice. Any potential benign true positive (B-TP) should be mapped and reviewed by the security team for alternatives as this weakens the security of the privileged group.\n\n### Response and remediation\n\n- The change can be reverted by setting the dwAdminSDExMask (16th bit) to 0 in dSHeuristics.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"573f15ae-1dbb-405e-8753-5541e5da6b58","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://www.cert.ssi.gouv.fr/uploads/guide-ad.html#dsheuristics_bad","https://petri.com/active-directory-security-understanding-adminsdholder-object"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"any where event.action == \"Directory Service Changes\" and\n  event.code == \"5136\" and\n  winlog.event_data.AttributeLDAPDisplayName : \"dSHeuristics\" and\n  length(winlog.event_data.AttributeValue) > 15 and\n  winlog.event_data.AttributeValue regex~ \"[0-9]{15}([1-9a-f]).*\"\n","throttle":"no_actions","actions":[]}
{"id":"4f1fa800-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.168Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.312Z","created_by":"chaykovskiyv","name":"Potential Privilege Escalation via InstallerFileTakeOver [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies a potential exploitation of InstallerTakeOver (CVE-2021-41379) default PoC execution. Successful exploitation allows an unprivileged user to escalate privileges to SYSTEM.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Potential Privilege Escalation via InstallerFileTakeOver\n\nInstallerFileTakeOver is a weaponized escalation of privilege proof of concept (EoP PoC) to the CVE-2021-41379 vulnerability. Upon successful exploitation, an unprivileged user will escalate privileges to SYSTEM/NT AUTHORITY.\n\nThis rule detects the default execution of the PoC, which overwrites the `elevation_service.exe` DACL and copies itself to the location to escalate privileges. An attacker is able to still take over any file that is not in use (locked), which is outside the scope of this rule.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Look for additional processes spawned by the process, command lines, and network communications.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- Verify whether a digital signature exists in the executable, and if it is valid.\n\n### Related rules\n\n- Suspicious DLL Loaded for Persistence or Privilege Escalation - bfeaf89b-a2a7-48a3-817f-e41829dc61ee\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"3f70ffd8-d776-4cec-b594-4a2db9ff8547","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1068/","name":"Exploitation for Privilege Escalation","id":"T1068"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://github.com/klinix5/InstallerFileTakeOver"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"/* This rule is compatible with both Sysmon and Elastic Endpoint */\n\nprocess where event.type == \"start\" and\n    (?process.Ext.token.integrity_level_name : \"System\" or\n    ?winlog.event_data.IntegrityLevel : \"System\") and\n    (\n      (process.name : \"elevation_service.exe\" and\n       not process.pe.original_file_name == \"elevation_service.exe\") or\n\n      (process.parent.name : \"elevation_service.exe\" and\n       process.name : (\"rundll32.exe\", \"cmd.exe\", \"powershell.exe\"))\n    )\n","throttle":"no_actions","actions":[]}
{"id":"4f2c2b20-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.155Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.386Z","created_by":"chaykovskiyv","name":"Potential Credential Access via DuplicateHandle in LSASS [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Sysmon Only"],"interval":"5m","enabled":true,"description":"Identifies suspicious access to an LSASS handle via DuplicateHandle from an unknown call trace module. This may indicate an attempt to bypass the NtOpenProcess API to evade detection and dump LSASS memory for credential access.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"21bff790-04b1-4dfe-9b02-166e2aac817f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/001/","name":"LSASS Memory","id":"T1003.001"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://github.com/CCob/MirrorDump"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-windows.*"],"query":"process where event.code == \"10\" and\n\n /* LSASS requesting DuplicateHandle access right to another process */\n process.name : \"lsass.exe\" and winlog.event_data.GrantedAccess == \"0x40\" and\n\n /* call is coming from an unknown executable region */\n winlog.event_data.CallTrace : \"*UNKNOWN*\"\n","throttle":"no_actions","actions":[]}
{"id":"f0c253e0-bc7b-11ed-b6f4-dfeac9073248","updated_at":"2023-06-08T21:29:33.492Z","updated_by":"burzhynskyyy","created_at":"2023-03-07T00:06:42.509Z","created_by":"burzhynskyyy","name":"Suspicious Remote VPN connection","tags":["Custom Rules"],"interval":"5m","enabled":true,"description":"Remote VPN connection from russia,belarus or other non Europe countries.","risk_score":47,"severity":"medium","license":"","output_index":"","timeline_id":"300afc76-072d-4261-864d-4149714bf3f1","timeline_title":"Comprehensive Network Timeline","meta":{"from":"1m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-360s","rule_id":"a803010b-7d7e-4708-84a3-fde4d58042e5","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":3,"exceptions_list":[{"id":"989b8980-ea65-11ed-b6f4-dfeac9073248","list_id":"b42117f4-4a87-4e70-bdca-e8c4ac7ac897","type":"rule_default","namespace_type":"single"}],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"fortinet.firewall.action:\"tunnel-up\" and not destination.ip:(10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16) and not (destination.geo.continent_name:\"Europe\" and not destination.geo.country_name:(\"Russia\" or \"Belarus\")) and not source.user.group.name:\"HomePC_Forti_VPN\"","filters":[],"throttle":"no_actions","actions":[]}
{"id":"4b6ed500-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.623Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.110Z","created_by":"chaykovskiyv","name":"Installation of Security Support Provider [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Identifies registry modifications related to the Windows Security Support Provider (SSP) configuration. Adversaries may abuse this to establish persistence in an environment.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"c30af7e3-3c93-4415-828d-d5bd92c8268e","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1547/005/","name":"Security Support Provider","id":"T1547.005"}],"id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"registry where\n   registry.path : (\"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\Security Packages*\",\n                    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\OSConfig\\\\Security Packages*\") and\n   not process.executable : (\"C:\\\\Windows\\\\System32\\\\msiexec.exe\", \"C:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"4d534c70-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.204Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.264Z","created_by":"chaykovskiyv","name":"Microsoft Build Engine Started an Unusual Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"An instance of MSBuild, the Microsoft Build Engine, started a PowerShell script or the Visual C# Command Line Compiler. This technique is sometimes used to deploy a malicious payload using the Build Engine.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["The Build Engine is commonly used by Windows developers but use by non-engineers is unusual. If a build system triggers this rule it can be exempted by process, user or host name."],"from":"now-9m","rule_id":"0d641c33-7cbb-4a14-92ac-d7544292d64d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1027/","name":"Obfuscated Files or Information","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1027/004/","name":"Compile After Delivery","id":"T1027.004"}],"id":"T1027"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://blog.talosintelligence.com/2020/02/building-bypass-with-msbuild.html"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.parent.name : \"MSBuild.exe\" and\n  process.name : (\"csc.exe\", \"iexplore.exe\", \"powershell.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"52ae25f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.282Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.221Z","created_by":"chaykovskiyv","name":"Local Account TokenFilter Policy Disabled [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Privilege Escalation","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies registry modification to the LocalAccountTokenFilterPolicy policy. If this value exists (which doesn't by default) and is set to 1, then remote connections from all local members of Administrators are granted full high-integrity tokens during negotiation.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"60c63c70-aafa-4cdf-aceb-8594b9c95447","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1112/","name":"Modify Registry","id":"T1112"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1078/","name":"Valid Accounts","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1078/003/","name":"Local Accounts","id":"T1078.003"}],"id":"T1078"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://www.stigviewer.com/stig/windows_server_2008_r2_member_server/2014-04-02/finding/V-36439","https://posts.specterops.io/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy-506c25a7c167","https://www.welivesecurity.com/wp-content/uploads/2018/01/ESET_Turla_Mosquito.pdf"],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"registry where registry.path : (\n  \"HKLM\\\\*\\\\LocalAccountTokenFilterPolicy\",\n  \"\\\\REGISTRY\\\\MACHINE\\\\*\\\\LocalAccountTokenFilterPolicy\") and\n  registry.data.strings : (\"1\", \"0x00000001\")\n","throttle":"no_actions","actions":[]}
{"id":"49b1e2c0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.560Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.170Z","created_by":"chaykovskiyv","name":"Incoming DCOM Lateral Movement with MMC [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies the use of Distributed Component Object Model (DCOM) to run commands from a remote host, which are launched via the MMC20 Application COM Object. This behavior may indicate an attacker abusing a DCOM application to move laterally.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"b0abeabf-8116-464e-8733-758e885ff70b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1021/003/","name":"Distributed Component Object Model","id":"T1021.003"}],"id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":["https://enigma0x3.net/2017/01/05/lateral-movement-using-the-mmc20-application-com-object/"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by host.id with maxspan=1m\n [network where event.type == \"start\" and process.name : \"mmc.exe\" and source.port >= 49152 and\n destination.port >= 49152 and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n  network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\"\n ] by process.entity_id\n [process where event.type == \"start\" and process.parent.name : \"mmc.exe\"\n ] by process.parent.entity_id\n","throttle":"no_actions","actions":[]}
{"id":"50e28db0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.241Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.243Z","created_by":"chaykovskiyv","name":"Disable Windows Event and Security Logs Using Built-in Tools [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies attempts to disable EventLog via the logman Windows utility, PowerShell, or auditpol. This is often done by attackers in an attempt to evade detection on a system.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Disable Windows Event and Security Logs Using Built-in Tools\n\nWindows event logs are a fundamental data source for security monitoring, forensics, and incident response. Adversaries can tamper, clear, and delete this data to break SIEM detections, cover their tracks, and slow down incident response.\n\nThis rule looks for the usage of different utilities to disable the EventLog service or specific event logs.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Verify if any other anti-forensics behaviors were observed.\n- Investigate the event logs prior to the action for suspicious behaviors that an attacker may be trying to cover up.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Re-enable affected logging components, services, and security monitoring.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic","Ivan Ninichuck","Austin Songer"],"false_positives":[],"from":"now-9m","rule_id":"788dee80-3866-4bce-80d4-114c09ef9ef8","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1070/","name":"Indicator Removal","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1070/001/","name":"Clear Windows Event Logs","id":"T1070.001"}],"id":"T1070"},{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/006/","name":"Indicator Blocking","id":"T1562.006"}],"id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/logman","https://medium.com/palantir/tampering-with-windows-event-tracing-background-offense-and-defense-4be7ac62ac63"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n(\n  ((process.name:\"logman.exe\" or process.pe.original_file_name == \"Logman.exe\") and\n      process.args : \"EventLog-*\" and process.args : (\"stop\", \"delete\")) or\n\n  ((process.name : (\"pwsh.exe\", \"powershell.exe\", \"powershell_ise.exe\") or process.pe.original_file_name in\n      (\"pwsh.exe\", \"powershell.exe\", \"powershell_ise.exe\")) and\n\tprocess.args : \"Set-Service\" and process.args: \"EventLog\" and process.args : \"Disabled\")  or\n\n  ((process.name:\"auditpol.exe\" or process.pe.original_file_name == \"AUDITPOL.EXE\") and process.args : \"/success:disable\")\n)\n","throttle":"no_actions","actions":[]}
{"id":"4b6efc10-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.621Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.108Z","created_by":"chaykovskiyv","name":"Potential DLL SideLoading via Trusted Microsoft Programs [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies an instance of a Windows trusted program that is known to be vulnerable to DLL Search Order Hijacking starting after being renamed or from a non-standard path. This is uncommon behavior and may indicate an attempt to evade defenses via side loading a malicious DLL within the memory space of one of those processes.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"e37ae3b4-71e6-49ef-836e-590a3ebd09d7","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1036/","name":"Masquerading","id":"T1036"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.pe.original_file_name in (\"WinWord.exe\", \"EXPLORER.EXE\", \"w3wp.exe\", \"DISM.EXE\") and\n  not (process.name : (\"winword.exe\", \"explorer.exe\", \"w3wp.exe\", \"Dism.exe\") or\n         process.executable : (\"?:\\\\Windows\\\\explorer.exe\",\n                               \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\Office*\\\\WINWORD.EXE\",\n                               \"?:\\\\Program Files?(x86)\\\\Microsoft Office\\\\root\\\\Office*\\\\WINWORD.EXE\",\n                               \"?:\\\\Windows\\\\System32\\\\Dism.exe\",\n                               \"?:\\\\Windows\\\\SysWOW64\\\\Dism.exe\",\n                               \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\")\n         )\n","throttle":"no_actions","actions":[]}
{"id":"50e5e910-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.269Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.286Z","created_by":"chaykovskiyv","name":"Remote Windows Service Installed [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement","Persistence"],"interval":"5m","enabled":true,"description":"Identifies a network logon followed by Windows service creation with same LogonId. This could be indicative of lateral movement, but will be noisy if commonly done by administrators.\"","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"946812ea-cdaa-4a77-9795-a0155f090be2","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1543/","name":"Create or Modify System Process","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1543/003/","name":"Windows Service","id":"T1543.003"}],"id":"T1543"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":3,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"sequence by winlog.logon.id, winlog.computer_name with maxspan=1m\n[authentication where event.action == \"logged-in\" and winlog.logon.type : \"Network\" and\nevent.outcome==\"success\" and source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\"]\n[iam where event.action == \"service-installed\" and\n not winlog.event_data.SubjectLogonId : \"0x3e7\" and\n not winlog.event_data.ServiceFileName :\n               (\"?:\\\\Windows\\\\ADCR_Agent\\\\adcrsvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\VSSVC.exe\",\n                \"?:\\\\Windows\\\\servicing\\\\TrustedInstaller.exe\",\n                \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n                \"?:\\\\Program Files (x86)\\\\*.exe\",\n                \"?:\\\\Program Files\\\\*.exe\",\n                \"?:\\\\Windows\\\\PSEXESVC.EXE\",\n                \"?:\\\\Windows\\\\System32\\\\sppsvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiApSrv.exe\",\n                \"?:\\\\WINDOWS\\\\RemoteAuditService.exe\",\n                \"?:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe\",\n                \"?:\\\\Windows\\\\VeeamLogShipper\\\\VeeamLogShipper.exe\",\n                \"?:\\\\Windows\\\\CAInvokerService.exe\",\n                \"?:\\\\Windows\\\\System32\\\\upfc.exe\",\n                \"?:\\\\Windows\\\\AdminArsenal\\\\PDQ*.exe\",\n                \"?:\\\\Windows\\\\System32\\\\vds.exe\",\n                \"?:\\\\Windows\\\\Veeam\\\\Backup\\\\VeeamDeploymentSvc.exe\",\n                \"?:\\\\Windows\\\\ProPatches\\\\Scheduler\\\\STSchedEx.exe\",\n                \"?:\\\\Windows\\\\System32\\\\certsrv.exe\",\n                \"?:\\\\Windows\\\\eset-remote-install-service.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\OSCToGPAutoService\\\\OSCToGPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Windows\\\\SysWOW64\\\\NwxExeSvc\\\\NwxExeSvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\taskhostex.exe\")]\n","throttle":"no_actions","actions":[]}
{"id":"4b6b5290-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.551Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.064Z","created_by":"chaykovskiyv","name":"Multiple Logon Failure Followed by Logon Success [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access"],"interval":"5m","enabled":true,"description":"Identifies multiple logon failures followed by a successful one from the same source address. Adversaries will often brute force login attempts across multiple users with a common or known password, in an attempt to gain access to accounts.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n#### Possible investigation steps\n\n- Investigate the logon failure reason code and the targeted user names.\n- Investigate the source IP address of the failed Network Logon attempts.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Identify the source and the target computer and their roles in the IT environment.\n\n### False positive analysis\n\n- Authentication misconfiguration or obsolete credentials.\n- Service account password expired.\n- Trust relationship between the primary domain and the trusted domain issue.\n- Infrastructure or availability issue.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the host is a domain controller (DC):\n  - Activate your incident response plan for total Active Directory compromise.\n  - Review the privileges assigned to users that can access the DCs, to ensure that the least privilege principle is being followed and to reduce the attack surface.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"553e8a7f-c07b-46a6-9e58-816e789182cd","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1110/","name":"Brute Force","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1110/001/","name":"Password Guessing","id":"T1110.001"},{"reference":"https://attack.mitre.org/techniques/T1110/003/","name":"Password Spraying","id":"T1110.003"}],"id":"T1110"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4625"],"version":3,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"sequence by winlog.computer_name, source.ip with maxspan=5s\n  [authentication where event.action == \"logon-failed\" and\n    /* event 4625 need to be logged */\n    winlog.logon.type : \"Network\" and\n    source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n    not user.name : (\"ANONYMOUS LOGON\", \"-\", \"*$\") and not user.domain == \"NT AUTHORITY\" and\n\n    /* noisy failure status codes often associated to authentication misconfiguration */\n    not winlog.event_data.Status : (\"0xC000015B\", \"0XC000005E\", \"0XC0000133\", \"0XC0000192\")] with runs=5\n  [authentication where event.action == \"logged-in\" and\n    /* event 4624 need to be logged */\n    winlog.logon.type : \"Network\" and\n    source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n    not user.name : (\"ANONYMOUS LOGON\", \"-\", \"*$\") and not user.domain == \"NT AUTHORITY\"]\n","throttle":"no_actions","actions":[]}
{"id":"4f206b50-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.174Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.320Z","created_by":"chaykovskiyv","name":"Potential Privileged Escalation via SamAccountName Spoofing [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Privilege Escalation","Active Directory"],"interval":"5m","enabled":true,"description":"Identifies a suspicious computer account name rename event, which may indicate an attempt to exploit CVE-2021-42278 to elevate privileges from a standard domain user to a user with domain admin privileges. CVE-2021-42278 is a security vulnerability that allows potential attackers to impersonate a domain controller via samAccountName attribute spoofing.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"119515ca-fbb2-4b61-ace0-4867bec12d88","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1078/","name":"Valid Accounts","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1078/002/","name":"Domain Accounts","id":"T1078.002"}],"id":"T1078"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1098/","name":"Account Manipulation","id":"T1098"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://support.microsoft.com/en-us/topic/kb5008102-active-directory-security-accounts-manager-hardening-changes-cve-2021-42278-5975b463-4c95-45e1-831a-d120004e258e","https://cloudbrothers.info/en/exploit-kerberos-samaccountname-spoofing/","https://github.com/cube0x0/noPac","https://twitter.com/exploitph/status/1469157138928914432","https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"iam where event.action == \"renamed-user-account\" and\n  /* machine account name renamed to user like account name */\n  winlog.event_data.OldTargetUserName : \"*$\" and not winlog.event_data.NewTargetUserName : \"*$\"\n","throttle":"no_actions","actions":[]}
{"id":"4f21a3d0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.183Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.327Z","created_by":"chaykovskiyv","name":"PowerShell Kerberos Ticket Request [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Investigation Guide","PowerShell"],"interval":"5m","enabled":true,"description":"Detects PowerShell scripts that have the capability of requesting kerberos tickets, which is a common step in Kerberoasting toolkits to crack service accounts.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating PowerShell Kerberos Ticket Request\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks, making it available for use in various environments, creating an attractive way for attackers to execute code.\n\nAccounts associated with a service principal name (SPN) are viable targets for Kerberoasting attacks, which use brute force to crack the user password, which is used to encrypt a Kerberos TGS ticket.\n\nAttackers can use PowerShell to request these Kerberos tickets, with the intent of extracting them from memory to perform Kerberoasting.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate if the script was executed, and if so, which account was targeted.\n- Validate if the account has an SPN associated with it.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Check if the script has any other functionality that can be potentially malicious.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Review event ID [4769](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4769) related to this account and service name for additional information.\n\n### False positive analysis\n\n- A possible false positive can be identified if the script content is not malicious/harmful or does not request Kerberos tickets for user accounts, as computer accounts are not vulnerable to Kerberoasting due to complex password requirements and policy.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services. Prioritize privileged accounts.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"646a31ca-1294-42ef-b28b-3f9ca147488b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","id":"T1003"},{"reference":"https://attack.mitre.org/techniques/T1558/","name":"Steal or Forge Kerberos Tickets","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1558/003/","name":"Kerberoasting","id":"T1558.003"}],"id":"T1558"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://cobalt.io/blog/kerberoast-attack-techniques","https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and\n  powershell.file.script_block_text : (\n    KerberosRequestorSecurityToken\n  ) and not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"4b705ba0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.633Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.123Z","created_by":"chaykovskiyv","name":"Network Connection via Registration Utility [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution"],"interval":"5m","enabled":true,"description":"Identifies the native Windows tools regsvr32.exe, regsvr64.exe, RegSvcs.exe, or RegAsm.exe making a network connection. This may be indicative of an attacker bypassing allowlists or running arbitrary scripts via a signed Microsoft binary.","risk_score":21,"severity":"low","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":["Security testing may produce events like this. Activity of this kind performed by non-engineers and ordinary users is unusual."],"from":"now-9m","rule_id":"8fc9c11a-b9ad-4a4c-97fe-670d4b228e25","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1218/","name":"System Binary Proxy Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1218/010/","name":"Regsvr32","id":"T1218.010"}],"id":"T1218"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by process.entity_id\n  [process where event.type == \"start\" and\n   process.name : (\"regsvr32.exe\", \"RegAsm.exe\", \"RegSvcs.exe\") and\n   not (\n         (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\") and\n         (process.parent.name : \"msiexec.exe\" or process.parent.executable : (\"C:\\\\Program Files (x86)\\\\*.exe\", \"C:\\\\Program Files\\\\*.exe\"))\n       )\n   ]\n  [network where process.name : (\"regsvr32.exe\", \"RegAsm.exe\", \"RegSvcs.exe\")  and\n   not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\") and network.protocol != \"dns\"]\n","throttle":"no_actions","actions":[]}
{"id":"fb3ab640-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.280Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.667Z","created_by":"burzhynskyyy","name":"Microsoft 365 Exchange Anti-Phish Rule Modification [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Configuration Audit"],"interval":"5m","enabled":true,"description":"Identifies the modification of an anti-phishing rule in Microsoft 365. By default, Microsoft 365 includes built-in features that help protect users from phishing attacks. Anti-phishing rules increase this protection by refining settings to better detect and prevent attacks.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["An anti-phishing rule may be deleted by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."],"from":"now-30m","rule_id":"baf9d8d0-a41e-482b-96d7-40e901e1d46c","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1566/","name":"Phishing","id":"T1566"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":["https://docs.microsoft.com/en-us/powershell/module/exchange/remove-antiphishrule?view=exchange-ps","https://docs.microsoft.com/en-us/powershell/module/exchange/disable-antiphishrule?view=exchange-ps"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:(\"Remove-AntiPhishRule\" or \"Disable-AntiPhishRule\") and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"52b06fe0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.303Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.246Z","created_by":"chaykovskiyv","name":"Unsigned DLL Loaded by Svchost [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Identifies an unsigned library created in the last 5 minutes and subsequently loaded by a shared windows service (svchost). Adversaries may use this technique to maintain persistence or run with System privileges.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"befa218a-04de-4dd9-b6bf-2a5013ce03c5","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1543/","name":"Create or Modify System Process","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1543/003/","name":"Windows Service","id":"T1543.003"}],"id":"T1543"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"library where\n\n process.executable : \n     (\"?:\\\\Windows\\\\System32\\\\svchost.exe\", \"?:\\\\Windows\\\\Syswow64\\\\svchost.exe\") and \n     \n dll.code_signature.trusted != true and \n \n not dll.code_signature.status : (\"trusted\", \"errorExpired\", \"errorCode_endpoint*\") and \n \n dll.hash.sha256 != null and \n \n (\n       /* DLL created within 5 minutes of the library load event - compatible with Elastic Endpoint 8.4+ */\n       dll.Ext.relative_file_creation_time <= 300 or \n   \n       /* unusual paths */\n       dll.path :(\"?:\\\\ProgramData\\\\*\",\n                  \"?:\\\\Users\\\\*\",\n                  \"?:\\\\PerfLogs\\\\*\",\n                  \"?:\\\\Windows\\\\Tasks\\\\*\",\n                  \"?:\\\\Intel\\\\*\",\n                  \"?:\\\\AMD\\\\Temp\\\\*\",\n                  \"?:\\\\Windows\\\\AppReadiness\\\\*\",\n                  \"?:\\\\Windows\\\\ServiceState\\\\*\",\n                  \"?:\\\\Windows\\\\security\\\\*\",\n                  \"?:\\\\Windows\\\\IdentityCRL\\\\*\",\n                  \"?:\\\\Windows\\\\Branding\\\\*\",\n                  \"?:\\\\Windows\\\\csc\\\\*\",\n                  \"?:\\\\Windows\\\\DigitalLocker\\\\*\",\n                  \"?:\\\\Windows\\\\en-US\\\\*\",\n                  \"?:\\\\Windows\\\\wlansvc\\\\*\",\n                  \"?:\\\\Windows\\\\Prefetch\\\\*\",\n                  \"?:\\\\Windows\\\\Fonts\\\\*\",\n                  \"?:\\\\Windows\\\\diagnostics\\\\*\",\n                  \"?:\\\\Windows\\\\TAPI\\\\*\",\n                  \"?:\\\\Windows\\\\INF\\\\*\",\n                  \"?:\\\\Windows\\\\System32\\\\Speech\\\\*\",\n                  \"?:\\\\windows\\\\tracing\\\\*\",\n                  \"?:\\\\windows\\\\IME\\\\*\",\n                  \"?:\\\\Windows\\\\Performance\\\\*\",\n                  \"?:\\\\windows\\\\intel\\\\*\",\n                  \"?:\\\\windows\\\\ms\\\\*\",\n                  \"?:\\\\Windows\\\\dot3svc\\\\*\",\n                  \"?:\\\\Windows\\\\panther\\\\*\",\n                  \"?:\\\\Windows\\\\RemotePackages\\\\*\",\n                  \"?:\\\\Windows\\\\OCR\\\\*\",\n                  \"?:\\\\Windows\\\\appcompat\\\\*\",\n                  \"?:\\\\Windows\\\\apppatch\\\\*\",\n                  \"?:\\\\Windows\\\\addins\\\\*\",\n                  \"?:\\\\Windows\\\\Setup\\\\*\",\n                  \"?:\\\\Windows\\\\Help\\\\*\",\n                  \"?:\\\\Windows\\\\SKB\\\\*\",\n                  \"?:\\\\Windows\\\\Vss\\\\*\",\n                  \"?:\\\\Windows\\\\servicing\\\\*\",\n                  \"?:\\\\Windows\\\\CbsTemp\\\\*\",\n                  \"?:\\\\Windows\\\\Logs\\\\*\",\n                  \"?:\\\\Windows\\\\WaaS\\\\*\",\n                  \"?:\\\\Windows\\\\twain_32\\\\*\",\n                  \"?:\\\\Windows\\\\ShellExperiences\\\\*\",\n                  \"?:\\\\Windows\\\\ShellComponents\\\\*\",\n                  \"?:\\\\Windows\\\\PLA\\\\*\",\n                  \"?:\\\\Windows\\\\Migration\\\\*\",\n                  \"?:\\\\Windows\\\\debug\\\\*\",\n                  \"?:\\\\Windows\\\\Cursors\\\\*\",\n                  \"?:\\\\Windows\\\\Containers\\\\*\",\n                  \"?:\\\\Windows\\\\Boot\\\\*\",\n                  \"?:\\\\Windows\\\\bcastdvr\\\\*\",\n                  \"?:\\\\Windows\\\\TextInput\\\\*\",\n                  \"?:\\\\Windows\\\\security\\\\*\",\n                  \"?:\\\\Windows\\\\schemas\\\\*\",\n                  \"?:\\\\Windows\\\\SchCache\\\\*\",\n                  \"?:\\\\Windows\\\\Resources\\\\*\",\n                  \"?:\\\\Windows\\\\rescache\\\\*\",\n                  \"?:\\\\Windows\\\\Provisioning\\\\*\",\n                  \"?:\\\\Windows\\\\PrintDialog\\\\*\",\n                  \"?:\\\\Windows\\\\PolicyDefinitions\\\\*\",\n                  \"?:\\\\Windows\\\\media\\\\*\",\n                  \"?:\\\\Windows\\\\Globalization\\\\*\",\n                  \"?:\\\\Windows\\\\L2Schemas\\\\*\",\n                  \"?:\\\\Windows\\\\LiveKernelReports\\\\*\",\n                  \"?:\\\\Windows\\\\ModemLogs\\\\*\",\n                  \"?:\\\\Windows\\\\ImmersiveControlPanel\\\\*\",\n                  \"?:\\\\$Recycle.Bin\\\\*\")\n  ) and \n  \n  not dll.hash.sha256 : \n            (\"3ed33e71641645367442e65dca6dab0d326b22b48ef9a4c2a2488e67383aa9a6\", \n             \"b4db053f6032964df1b254ac44cb995ffaeb4f3ade09597670aba4f172cf65e4\", \n             \"214c75f678bc596bbe667a3b520aaaf09a0e50c364a28ac738a02f867a085eba\", \n             \"23aa95b637a1bf6188b386c21c4e87967ede80242327c55447a5bb70d9439244\", \n             \"5050b025909e81ae5481db37beb807a80c52fc6dd30c8aa47c9f7841e2a31be7\")\n","throttle":"no_actions","actions":[]}
{"id":"483e0770-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.164Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.732Z","created_by":"chaykovskiyv","name":"ImageLoad via Windows Update Auto Update Client [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies abuse of the Windows Update Auto Update Client (wuauclt.exe) to load an arbitrary DLL. This behavior is used as a defense evasion technique to blend-in malicious activity with legitimate Windows software.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timeline_id":"e70679c2-6cde-4510-9764-4823df18f7db","timeline_title":"Comprehensive Process Timeline","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"2644361c-91fe-4128-a3fe-2a1705c491d9","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1218/","name":"System Binary Proxy Execution","id":"T1218"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://dtm.uk/wuauclt/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  (process.pe.original_file_name == \"wuauclt.exe\" or process.name : \"wuauclt.exe\") and\n   /* necessary windows update client args to load a dll */\n   process.args : \"/RunHandlerComServer\" and process.args : \"/UpdateDeploymentProvider\" and\n   /* common paths writeable by a standard user where the target DLL can be placed */\n   process.args : (\"C:\\\\Users\\\\*.dll\", \"C:\\\\ProgramData\\\\*.dll\", \"C:\\\\Windows\\\\Temp\\\\*.dll\", \"C:\\\\Windows\\\\Tasks\\\\*.dll\")\n","throttle":"no_actions","actions":[]}
{"id":"4b6a1a10-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.522Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.049Z","created_by":"chaykovskiyv","name":"Suspicious .NET Code Compilation [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies suspicious .NET code execution. connections.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"60e45850-9e65-4ab7-b1f8-e3f09e6d0e0e","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1027/","name":"Obfuscated Files or Information","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1027/004/","name":"Compile After Delivery","id":"T1027.004"}],"id":"T1027"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.name : (\"csc.exe\", \"vbc.exe\") and\n  process.parent.name : (\"wscript.exe\", \"mshta.exe\", \"cscript.exe\", \"wmic.exe\", \"svchost.exe\", \"rundll32.exe\", \"cmstp.exe\", \"regsvr32.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"4f23c6b0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.189Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.341Z","created_by":"chaykovskiyv","name":"LSASS Memory Dump Handle Access [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies handle requests for the Local Security Authority Subsystem Service (LSASS) object access with specific access masks that many tools with a capability to dump memory to disk use (0x1fffff, 0x1010, 0x120089). This rule is tool agnostic as it has been validated against a host of various LSASS dump tools such as SharpDump, Procdump, Mimikatz, Comsvcs etc. It detects this behavior at a low level and does not depend on a specific tool or dump file name.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating LSASS Memory Dump Handle Access\n\nLocal Security Authority Server Service (LSASS) is a process in Microsoft Windows operating systems that is responsible for enforcing security policy on the system. It verifies users logging on to a Windows computer or server, handles password changes, and creates access tokens.\n\nAdversaries may attempt to access credential material stored in LSASS process memory. After a user logs on, the system generates and stores a variety of credential materials in LSASS process memory. This is meant to facilitate single sign-on (SSO) ensuring a user isn’t prompted each time resource access is requested. These credential materials can be harvested by an adversary using administrative user or SYSTEM privileges to conduct lateral movement using [alternate authentication material](https://attack.mitre.org/techniques/T1550/).\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- There should be very few or no false positives for this rule. If this activity is expected or noisy in your environment, consider adding exceptions — preferably with a combination of user and command line conditions.\n- If the process is related to antivirus or endpoint detection and response solutions, validate that it is installed on the correct path and signed with the company's valid digital signature.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Scope compromised credentials and disable the accounts.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\nEnsure advanced audit policies for Windows are enabled, specifically:\nObject Access policies [Event ID 4656](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4656) (Handle to an Object was Requested)\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nSystem Audit Policies >\nObject Access >\nAudit File System (Success,Failure)\nAudit Handle Manipulation (Success,Failure)\n```\n\nAlso, this event generates only if the object’s [SACL](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-control-lists) has the required access control entry (ACE) to handle the use of specific access rights.\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2, events will not define `event.ingested` and default fallback for EQL rules was not added until 8.2, so you will need to add a custom pipeline to populate `event.ingested` to @timestamp for this rule to work.","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"cc037af3-4b0f-4ca9-bb51-bc2bc3e633fc","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/001/","name":"LSASS Memory","id":"T1003.001"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4656","https://twitter.com/jsecurity101/status/1227987828534956033?s=20","https://attack.mitre.org/techniques/T1003/001/","https://threathunterplaybook.com/notebooks/windows/06_credential_access/WIN-170105221010.html","http://findingbad.blogspot.com/2017/","https://www.elastic.co/security-labs/detect-credential-access"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"any where event.action == \"File System\" and event.code == \"4656\" and\n\n    winlog.event_data.ObjectName : (\n        \"?:\\\\Windows\\\\System32\\\\lsass.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\lsass.exe\",\n        \"\\\\Device\\\\HarddiskVolume??\\\\Windows\\\\System32\\\\lsass.exe\") and\n\n    /* The right to perform an operation controlled by an extended access right. */\n\n    (winlog.event_data.AccessMask : (\"0x1fffff\" , \"0x1010\", \"0x120089\", \"0x1F3FFF\") or\n     winlog.event_data.AccessMaskDescription : (\"READ_CONTROL\", \"Read from process memory\"))\n\n     /* Common Noisy False Positives */\n\n    and not winlog.event_data.ProcessName : (\n        \"?:\\\\Program Files\\\\*.exe\",\n        \"?:\\\\Program Files (x86)\\\\*.exe\",\n        \"?:\\\\Windows\\\\system32\\\\wbem\\\\WmiPrvSE.exe\",\n        \"?:\\\\Windows\\\\System32\\\\dllhost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\*.exe\",\n        \"?:\\\\Windows\\\\explorer.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"945195a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.770Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.308Z","created_by":"chaykovskiyv","name":"Remote Computer Account DnsHostName Update [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Active Directory"],"interval":"5m","enabled":true,"description":"Identifies the remote update to a computer account's DnsHostName attribute. If the new value set is a valid domain controller DNS hostname and the subject computer name is not a domain controller, then it's highly likely a preparation step to exploit CVE-2022-26923 in an attempt to elevate privileges from a standard domain user to domain admin privileges.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"0cc16f54-ee20-4713-98cb-12e49edb4c3a","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1068/","name":"Exploitation for Privilege Escalation","id":"T1068"},{"reference":"https://attack.mitre.org/techniques/T1078/","name":"Valid Accounts","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1078/002/","name":"Domain Accounts","id":"T1078.002"}],"id":"T1078"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://research.ifcr.dk/certifried-active-directory-domain-privilege-escalation-cve-2022-26923-9e098fe298f4","https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2022-26923"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"sequence by winlog.computer_name with maxspan=5m\n\n  [authentication where event.action == \"logged-in\" and\n   winlog.logon.type == \"Network\" and event.outcome == \"success\" and\n   not user.name == \"ANONYMOUS LOGON\" and not winlog.event_data.SubjectUserName : \"*$\" and\n   not user.domain == \"NT AUTHORITY\" and source.ip != \"127.0.0.1\" and source.ip !=\"::1\"] by winlog.event_data.TargetLogonId\n\n  [iam where event.action == \"changed-computer-account\" and\n\n    /* if DnsHostName value equal a DC DNS hostname then it's highly suspicious */\n    winlog.event_data.DnsHostName : \"??*\" and\n\n    /* exclude FPs where DnsHostName starts with the ComputerName that was changed */\n    not startswith~(winlog.event_data.DnsHostName, substring(winlog.event_data.TargetUserName, 0, length(winlog.event_data.TargetUserName) - 1))\n    ] by winlog.event_data.SubjectLogonId\n","throttle":"no_actions","actions":[]}
{"id":"4f235180-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.188Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.336Z","created_by":"chaykovskiyv","name":"Windows Service Installed via an Unusual Client [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Identifies the creation of a Windows service by an unusual client process. Services may be created with administrator privileges but are executed under SYSTEM privileges, so an adversary may also use a service to escalate privileges from administrator to SYSTEM.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"ebf384be-8aae-4008-ba0c-0dc53934aeab","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1543/","name":"Create or Modify System Process","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1543/003/","name":"Windows Service","id":"T1543.003"}],"id":"T1543"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://www.x86matthew.com/view_post?id=create_svc_rpc","https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4697","https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0100_windows_audit_security_system_extension.md"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.action:\"service-installed\"  and (winlog.event_data.ClientProcessId:\"0\" or winlog.event_data.ParentProcessId:\"0\")\n","throttle":"no_actions","actions":[]}
{"id":"4b6d7570-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.611Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.088Z","created_by":"chaykovskiyv","name":"Service Command Lateral Movement [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies use of sc.exe to create, modify, or start services on remote hosts. This could be indicative of adversary lateral movement but will be noisy if commonly done by admins.","risk_score":21,"severity":"low","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"bc0c7342-87ad-4cd6-8eb1-fa2df6de62b1","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1543/","name":"Create or Modify System Process","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1543/003/","name":"Windows Service","id":"T1543.003"}],"id":"T1543"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1569/","name":"System Services","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1569/002/","name":"Service Execution","id":"T1569.002"}],"id":"T1569"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"sequence by process.entity_id with maxspan = 1m\n  [process where event.type == \"start\" and\n     (process.name : \"sc.exe\" or process.pe.original_file_name : \"sc.exe\") and\n      process.args : \"\\\\\\\\*\" and process.args : (\"binPath=*\", \"binpath=*\") and\n      process.args : (\"create\", \"config\", \"failure\", \"start\")]\n  [network where process.name : \"sc.exe\" and destination.ip != \"127.0.0.1\"]\n","throttle":"no_actions","actions":[]}
{"id":"49b47ad1-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.526Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.201Z","created_by":"chaykovskiyv","name":"Uncommon Registry Persistence Change [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Detects changes to registry persistence keys that are not commonly used or modified by legitimate programs. This could be an indication of an adversary's attempt to persist in a stealthy manner.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timeline_id":"3e47ef71-ebfc-4520-975c-cb27fc090799","timeline_title":"Comprehensive Registry Timeline","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"dac17ef5-fc40-4019-8793-f0093eb6461a","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1547/001/","name":"Registry Run Keys / Startup Folder","id":"T1547.001"}],"id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1112/","name":"Modify Registry","id":"T1112"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://www.microsoftpressstore.com/articles/article.aspx?p=2762082&seqNum=2"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"registry where\n  /* uncomment once stable length(registry.data.strings) > 0 and */\n registry.path : (\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Terminal Server\\\\Install\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Terminal Server\\\\Install\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Runonce\\\\*\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Load\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Run\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\IconServiceLib\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\AppSetup\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Taskman\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Userinit\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\VmApplet\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Active Setup\\\\Installed Components\\\\*\\\\ShellComponent\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows CE Services\\\\AutoStartOnConnect\\\\MicrosoftActiveSync\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows CE Services\\\\AutoStartOnDisconnect\\\\MicrosoftActiveSync\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\VerifierDlls\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\GpExtensions\\\\*\\\\DllName\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\SafeBoot\\\\AlternateShell\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Terminal Server\\\\Wds\\\\rdpwd\\\\StartupPrograms\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Terminal Server\\\\WinStations\\\\RDP-Tcp\\\\InitialProgram\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\BootExecute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\SetupExecute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\Execute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\S0InitialCommand\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\ServiceControlManagerExtension\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\BootVerificationProgram\\\\ImagePath\",\n      \"HKLM\\\\SYSTEM\\\\Setup\\\\CmdLine\",\n      \"HKEY_USERS\\\\*\\\\Environment\\\\UserInitMprLogonScript\") and\n\n not registry.data.strings : (\"C:\\\\Windows\\\\system32\\\\userinit.exe\", \"cmd.exe\", \"C:\\\\Program Files (x86)\\\\*.exe\",\n                              \"C:\\\\Program Files\\\\*.exe\") and\n not (process.name : \"rundll32.exe\" and registry.path : \"*\\\\Software\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\") and\n not process.executable : (\"C:\\\\Windows\\\\System32\\\\msiexec.exe\",\n                           \"C:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n                           \"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n                           \"C:\\\\Program Files\\\\*.exe\",\n                           \"C:\\\\Program Files (x86)\\\\*.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"4f2a7d70-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.136Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.356Z","created_by":"chaykovskiyv","name":"Unusual Print Spooler Child Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Detects unusual Print Spooler service (spoolsv.exe) child processes. This may indicate an attempt to exploit privilege escalation vulnerabilities related to the Printing Service on Windows.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Install or update of a legitimate printing driver. Verify the printer driver file metadata such as manufacturer and signature information."],"from":"now-9m","rule_id":"07036064-cd6e-449e-a92c-5a5f9dcd9038","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1068/","name":"Exploitation for Privilege Escalation","id":"T1068"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n process.parent.name : \"spoolsv.exe\" and\n (?process.Ext.token.integrity_level_name : \"System\" or\n ?winlog.event_data.IntegrityLevel : \"System\") and\n\n /* exclusions for FP control below */\n not process.name : (\"splwow64.exe\", \"PDFCreator.exe\", \"acrodist.exe\", \"spoolsv.exe\", \"msiexec.exe\", \"route.exe\", \"WerFault.exe\") and\n not process.command_line : \"*\\\\WINDOWS\\\\system32\\\\spool\\\\DRIVERS*\" and\n not (process.name : \"net.exe\" and process.command_line : (\"*stop*\", \"*start*\")) and\n not (process.name : (\"cmd.exe\", \"powershell.exe\") and process.command_line : (\"*.spl*\", \"*\\\\program files*\", \"*route add*\")) and\n not (process.name : \"netsh.exe\" and process.command_line : (\"*add portopening*\", \"*rule name*\")) and\n not (process.name : \"regsvr32.exe\" and process.command_line : \"*PrintConfig.dll*\")\n","throttle":"no_actions","actions":[]}
{"id":"8cc8b530-2a78-11ee-8f07-79710758f25a","updated_at":"2023-07-24T23:19:36.359Z","updated_by":"burzhynskyyy","created_at":"2023-07-24T23:19:34.732Z","created_by":"burzhynskyyy","name":"Nginx server mass of error events detected during 1 hour","tags":["Custom Rules","Test"],"interval":"5m","enabled":true,"description":"Виявлення великої кількості подій помилок (більше 100) відносно хоста з nginx на протязі 1 години.","risk_score":73,"severity":"high","license":"","output_index":"","meta":{"from":"1h","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-3900s","rule_id":"83d6937c-3ba1-48b7-af27-e9df85c9685d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"tags:\"nginx-error\" and log.level:\"error\"","filters":[],"threshold":{"field":["host.name"],"value":100,"cardinality":[]},"throttle":"no_actions","actions":[]}
{"id":"49b62880-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.540Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.215Z","created_by":"chaykovskiyv","name":"Remote Scheduled Task Creation [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies remote scheduled task creations on a target host. This could be indicative of adversary lateral movement.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Remote Scheduled Task Creation\n\n[Scheduled tasks](https://docs.microsoft.com/en-us/windows/win32/taskschd/about-the-task-scheduler) are a great mechanism for persistence and program execution. These features can be used remotely for a variety of legitimate reasons, but at the same time used by malware and adversaries. When investigating scheduled tasks that were set up remotely, one of the first steps should be to determine the original intent behind the configuration and to verify if the activity is tied to benign behavior such as software installation or any kind of network administrator work. One objective for these alerts is to understand the configured action within the scheduled task. This is captured within the registry event data for this rule and can be base64 decoded to view the value.\n\n#### Possible investigation steps\n\n- Review the base64 encoded tasks actions registry value to investigate the task configured action.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Further examination should include review of host-based artifacts and network logs from around when the scheduled task was created, on both the source and target machines.\n\n### False positive analysis\n\n- There is a high possibility of benign activity tied to the creation of remote scheduled tasks as it is a general feature within Windows and used for legitimate purposes for a wide range of activity. Any kind of context should be found to further understand the source of the activity and determine the intent based on the scheduled task's contents.\n\n### Related rules\n\n- Service Command Lateral Movement - d61cbcf8-1bc1-4cff-85ba-e7b21c5beedc\n- Remotely Started Services via RPC - aa9a274d-6b53-424d-ac5e-cb8ca4251650\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Remove scheduled task and any other related artifacts.\n- Review privileged account management and user account management settings. Consider implementing group policy object (GPO) policies to further restrict activity, or configuring settings that only allow administrators to create remote scheduled tasks.\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"20b4b7b1-83d3-4200-b5b4-1907e90cd709","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1053/","name":"Scheduled Task/Job","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1053/005/","name":"Scheduled Task","id":"T1053.005"}],"id":"T1053"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"/* Task Scheduler service incoming connection followed by TaskCache registry modification  */\n\nsequence by host.id, process.entity_id with maxspan = 1m\n   [network where process.name : \"svchost.exe\" and\n   network.direction : (\"incoming\", \"ingress\") and source.port >= 49152 and destination.port >= 49152 and\n   source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n   ]\n   [registry where registry.path : \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tasks\\\\*\\\\Actions\"]\n","throttle":"no_actions","actions":[]}
{"id":"4f2acb90-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.144Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.361Z","created_by":"chaykovskiyv","name":"Enable Host Network Discovery via Netsh [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies use of the netsh.exe program to enable host discovery via the network. Attackers can use this command-line tool to weaken the host firewall settings.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Enable Host Network Discovery via Netsh\n\nThe Windows Defender Firewall is a native component that provides host-based, two-way network traffic filtering for a device and blocks unauthorized network traffic flowing into or out of the local device.\n\nAttackers can enable Network Discovery on the Windows firewall to find other systems present in the same network. Systems with this setting enabled will communicate with other systems using broadcast messages, which can be used to identify targets for lateral movement. This rule looks for the setup of this setting using the netsh utility.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the Administrator is aware of the activity and there are justifications for this configuration.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Disable Network Discovery:\n    - Using netsh: `netsh advfirewall firewall set rule group=\"Network Discovery\" new enable=No`\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Host Windows Firewall planned system administration changes."],"from":"now-9m","rule_id":"6296dd7a-70db-4364-a975-e64c08ee5996","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/004/","name":"Disable or Modify System Firewall","id":"T1562.004"}],"id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\nprocess.name : \"netsh.exe\" and\nprocess.args : (\"firewall\", \"advfirewall\") and process.args : \"group=Network Discovery\" and process.args : \"enable=Yes\"\n","throttle":"no_actions","actions":[]}
{"id":"49b42cb0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.524Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.195Z","created_by":"chaykovskiyv","name":"Registry Persistence via AppCert DLL [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Detects attempts to maintain persistence by creating registry keys using AppCert DLLs. AppCert DLLs are loaded by every process using the common API functions to create processes.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"4ee0a6aa-1a6a-47f3-8850-ca5c78ac4715","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1546/","name":"Event Triggered Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1546/009/","name":"AppCert DLLs","id":"T1546.009"}],"id":"T1546"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"registry where\n/* uncomment once stable length(bytes_written_string) > 0 and */\n  registry.path : \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Session Manager\\\\AppCertDLLs\\\\*\"\n","throttle":"no_actions","actions":[]}
{"id":"4d503f30-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.181Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.235Z","created_by":"chaykovskiyv","name":"System Shells via Services [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Investigation Guide"],"interval":"5m","enabled":true,"description":"Windows services typically run as SYSTEM and can be used as a privilege escalation opportunity. Malware or penetration testers may run a shell as a service to gain SYSTEM permissions.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating System Shells via Services\n\nAttackers may configure existing services or create new ones to execute system shells to elevate their privileges from administrator to SYSTEM. They can also configure services to execute these shells with persistence payloads.\n\nThis rule looks for system shells being spawned by `services.exe`, which is compatible with the above behavior.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify how the service was created or modified. Look for registry changes events or Windows events related to service activities (for example, 4697 and/or 7045).\n  - Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Check for commands executed under the spawned shell.\n\n### False positive analysis\n\n- This activity should not happen legitimately. The security team should address any potential benign true positive (B-TP), as this configuration can put the user and the domain at risk.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service or restore it to the original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"c8ec5383-b872-46df-bb28-fe3f06689739","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1543/","name":"Create or Modify System Process","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1543/003/","name":"Windows Service","id":"T1543.003"}],"id":"T1543"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  process.parent.name : \"services.exe\" and\n  process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n\n  /* Third party FP's */\n  not process.args : \"NVDisplay.ContainerLocalSystem\"\n","throttle":"no_actions","actions":[]}
{"id":"4d560b90-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.016Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.293Z","created_by":"chaykovskiyv","name":"Command Prompt Network Connection [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution"],"interval":"5m","enabled":true,"description":"Identifies cmd.exe making a network connection. Adversaries could abuse cmd.exe to download or execute malware from a remote URL.","risk_score":21,"severity":"low","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":["Administrators may use the command prompt for regular administrative tasks. It's important to baseline your environment for network connections being made from the command prompt to determine any abnormal use of this tool."],"from":"now-9m","rule_id":"1de186cb-f974-4fdf-9dab-f4bc74d1c6b8","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1105/","name":"Ingress Tool Transfer","id":"T1105"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0011/","name":"Command and Control","id":"TA0011"}}],"to":"now","references":["https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by process.entity_id\n  [process where process.name : \"cmd.exe\" and event.type == \"start\"]\n  [network where process.name : \"cmd.exe\" and\n     not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n                                  \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\",\n                                  \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\",\n                                  \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\n                                  \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n                                  \"FE80::/10\", \"FF00::/8\")]\n","throttle":"no_actions","actions":[]}
{"id":"4d5150a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.189Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.242Z","created_by":"chaykovskiyv","name":"Modification of Boot Configuration [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Impact","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies use of bcdedit.exe to delete boot configuration data. This tactic is sometimes used as by malware or an attacker as a destructive technique.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Modification of Boot Configuration\n\nBoot entry parameters, or boot parameters, are optional, system-specific settings that represent configuration options. These are stored in a boot configuration data (BCD) store, and administrators can use utilities like `bcdedit.exe` to configure these.\n\nThis rule identifies the usage of `bcdedit.exe` to:\n\n- Disable Windows Error Recovery (recoveryenabled).\n- Ignore errors if there is a failed boot, failed shutdown, or failed checkpoint (bootstatuspolicy ignoreallfailures).\n\nThese are common steps in destructive attacks by adversaries leveraging ransomware.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Check if any files on the host machine have been encrypted.\n\n### False positive analysis\n\n- The usage of these options is not inherently malicious. Administrators can modify these configurations to force a machine to boot for troubleshooting or data recovery purposes.\n\n### Related rules\n\n- Deleting Backup Catalogs with Wbadmin - 581add16-df76-42bb-af8e-c979bfb39a59\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If any other destructive action was identified on the host, it is recommended to prioritize the investigation and look for ransomware preparation and execution activities.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"ea363415-3951-4d4d-93fa-c91c7a40b57c","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1490/","name":"Inhibit System Recovery","id":"T1490"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0040/","name":"Impact","id":"TA0040"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  (process.name : \"bcdedit.exe\" or process.pe.original_file_name == \"bcdedit.exe\") and\n    (\n      (process.args : \"/set\" and process.args : \"bootstatuspolicy\" and process.args : \"ignoreallfailures\") or\n      (process.args : \"no\" and process.args : \"recoveryenabled\")\n    )\n","throttle":"no_actions","actions":[]}
{"id":"49b0f860-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.182Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.152Z","created_by":"chaykovskiyv","name":"UAC Bypass Attempt via Elevated COM Internet Explorer Add-On Installer [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Identifies User Account Control (UAC) bypass attempts by abusing an elevated COM Interface to launch a malicious program. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"c251e293-9736-4c8f-a6a8-bc18401857d0","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1548/","name":"Abuse Elevation Control Mechanism","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1548/002/","name":"Bypass User Account Control","id":"T1548.002"}],"id":"T1548"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://swapcontext.blogspot.com/2020/11/uac-bypasses-from-comautoapprovallist.html"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n process.executable : \"C:\\\\*\\\\AppData\\\\*\\\\Temp\\\\IDC*.tmp\\\\*.exe\" and\n process.parent.name : \"ieinstal.exe\" and process.parent.args : \"-Embedding\"\n\n /* uncomment once in winlogbeat */\n /* and not (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true) */\n","throttle":"no_actions","actions":[]}
{"id":"4f20b970-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.181Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.322Z","created_by":"chaykovskiyv","name":"Symbolic Link to Shadow Copy Created [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the creation of symbolic links to a shadow copy. Symbolic links can be used to access files in the shadow copy, including sensitive files such as ntds.dit, System Boot Key and browser offline credentials.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Symbolic Link to Shadow Copy Created\n\nShadow copies are backups or snapshots of an endpoint's files or volumes while they are in use. Adversaries may attempt to discover and create symbolic links to these shadow copies in order to copy sensitive information offline. If Active Directory (AD) is in use, often the ntds.dit file is a target as it contains password hashes, but an offline copy is needed to extract these hashes and potentially conduct lateral movement.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Determine if a volume shadow copy was recently created on this endpoint.\n- Review privileges of the end user as this requires administrative access.\n- Verify if the ntds.dit file was successfully copied and determine its copy destination.\n- Investigate for registry SYSTEM file copies made recently or saved via Reg.exe.\n- Investigate recent deletions of volume shadow copies.\n- Identify other files potentially copied from volume shadow copy paths directly.\n\n### False positive analysis\n\n- This rule should cause very few false positives. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- NTDS or SAM Database File Copied - 3bc6deaa-fbd4-433a-ae21-3e892f95624f\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the entire domain or the `krbtgt` user was compromised:\n  - Activate your incident response plan for total Active Directory compromise which should include, but not be limited to, a password reset (twice) of the `krbtgt` user.\n- Locate and remove static files copied from volume shadow copies.\n- Command-Line tool mklink should require administrative access by default unless in developer mode.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\nEnsure advanced audit policies for Windows are enabled, specifically:\nObject Access policies [Event ID 4656](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4656) (Handle to an Object was Requested)\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nSystem Audit Policies >\nObject Access >\nAudit File System (Success,Failure)\nAudit Handle Manipulation (Success,Failure)\n```\n\nThis event will only trigger if symbolic links are created from a new process spawning cmd.exe or powershell.exe with the correct arguments.\nDirect access to a shell and calling symbolic link creation tools will not generate an event matching this rule.\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2, events will not define `event.ingested` and default fallback for EQL rules was not added until 8.2, so you will need to add a custom pipeline to populate `event.ingested` to @timestamp for this rule to work.","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic","Austin Songer"],"false_positives":["Legitimate administrative activity related to shadow copies."],"from":"now-9m","rule_id":"4aea9a0a-3d15-4b4b-a371-795a0b6608eb","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/mklink","https://2017.zeronights.org/wp-content/uploads/materials/ZN17_Kheirkhabarov_Hunting_for_Credentials_Dumping_in_Windows_Environment.pdf","https://blog.netwrix.com/2021/11/30/extracting-password-hashes-from-the-ntds-dit-file/","https://www.hackingarticles.in/credential-dumping-ntds-dit/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type in (\"start\",\"process_created\") and\n process.pe.original_file_name in (\"Cmd.Exe\",\"PowerShell.EXE\") and\n\n /* Create Symbolic Link to Shadow Copies */\n process.args : (\"*mklink*\", \"*SymbolicLink*\") and process.command_line : (\"*HarddiskVolumeShadowCopy*\")\n","throttle":"no_actions","actions":[]}
{"id":"4d4fca00-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.175Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.232Z","created_by":"chaykovskiyv","name":"Adobe Hijack Persistence [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Investigation Guide"],"interval":"5m","enabled":true,"description":"Detects writing executable files that will be automatically launched by Adobe on launch.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Adobe Hijack Persistence\n\nAttackers can replace the `RdrCEF.exe` executable with their own to maintain their access, which will be launched whenever Adobe Acrobat Reader is executed.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"0d346c09-fba7-4726-ab3f-fd4235c4d376","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1574/","name":"Hijack Execution Flow","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1574/010/","name":"Services File Permissions Weakness","id":"T1574.010"}],"id":"T1574"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://twitter.com/pabraeken/status/997997818362155008"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"file where event.type == \"creation\" and\n  file.path : (\"?:\\\\Program Files (x86)\\\\Adobe\\\\Acrobat Reader DC\\\\Reader\\\\AcroCEF\\\\RdrCEF.exe\",\n               \"?:\\\\Program Files\\\\Adobe\\\\Acrobat Reader DC\\\\Reader\\\\AcroCEF\\\\RdrCEF.exe\") and\n  not process.name : \"msiexec.exe\"\n","throttle":"no_actions","actions":[]}
{"id":"4d54fa20-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.007Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.282Z","created_by":"chaykovskiyv","name":"MsBuild Making Network Connections [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Identifies MsBuild.exe making outbound network connections. This may indicate adversarial activity as MsBuild is often leveraged by adversaries to execute code and evade detection.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"f3550ed5-61da-4616-a728-b234d85e61d9","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1127/","name":"Trusted Developer Utilities Proxy Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1127/001/","name":"MSBuild","id":"T1127.001"}],"id":"T1127"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by process.entity_id\n  [process where process.name : \"MSBuild.exe\" and event.type == \"start\"]\n  [network where process.name : \"MSBuild.exe\" and\n     not cidrmatch(destination.ip, \"127.0.0.1\", \"::1\")]\n","throttle":"no_actions","actions":[]}
{"id":"49af4ab0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.650Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.135Z","created_by":"chaykovskiyv","name":"UAC Bypass Attempt with IEditionUpgradeManager Elevated COM Interface [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Identifies attempts to bypass User Account Control (UAC) by abusing an elevated COM Interface to launch a rogue Windows ClipUp program. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"430ecfcd-d8df-4d4c-982d-963480f70fdf","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1548/","name":"Abuse Elevation Control Mechanism","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1548/002/","name":"Bypass User Account Control","id":"T1548.002"}],"id":"T1548"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://github.com/hfiref0x/UACME"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and process.name : \"Clipup.exe\" and\n  not process.executable : \"C:\\\\Windows\\\\System32\\\\ClipUp.exe\" and process.parent.name : \"dllhost.exe\" and\n  /* CLSID of the Elevated COM Interface IEditionUpgradeManager */\n  process.parent.args : \"/Processid:{BD54C901-076B-434E-B6C7-17C531F4AB41}\"\n","throttle":"no_actions","actions":[]}
{"id":"4d4ff110-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.176Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.230Z","created_by":"chaykovskiyv","name":"Local Scheduled Task Creation [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Indicates the creation of a scheduled task. Adversaries can use these to establish persistence, move laterally, and/or escalate privileges.","risk_score":21,"severity":"low","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":["Legitimate scheduled tasks may be created during installation of new software."],"from":"now-9m","rule_id":"a2cd9c65-8c90-4383-a155-bd180969ac13","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1053/","name":"Scheduled Task/Job","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1053/005/","name":"Scheduled Task","id":"T1053.005"}],"id":"T1053"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://www.elastic.co/security-labs/hunting-for-persistence-using-elastic-security-part-1","https://www.elastic.co/security-labs/hunting-for-persistence-using-elastic-security-part-2"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence with maxspan=1m\n  [process where event.type != \"end\" and\n    ((process.name : (\"cmd.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\", \"wmic.exe\", \"mshta.exe\",\n                      \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"WmiPrvSe.exe\", \"wsmprovhost.exe\", \"winrshost.exe\") or\n    process.pe.original_file_name : (\"cmd.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\", \"wmic.exe\", \"mshta.exe\",\n                                     \"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\", \"WmiPrvSe.exe\", \"wsmprovhost.exe\",\n                                     \"winrshost.exe\")) or\n    process.code_signature.trusted == false)] by process.entity_id\n  [process where event.type == \"start\" and\n    (process.name : \"schtasks.exe\" or process.pe.original_file_name == \"schtasks.exe\") and\n    process.args : (\"/create\", \"-create\") and process.args : (\"/RU\", \"/SC\", \"/TN\", \"/TR\", \"/F\", \"/XML\") and\n    /* exclude SYSTEM Integrity Level - look for task creations by non-SYSTEM user */\n    not (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\")\n  ] by process.parent.entity_id\n","throttle":"no_actions","actions":[]}
{"id":"4b6b79a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T11:21:08.156Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.066Z","created_by":"chaykovskiyv","name":"Multiple Logon Failure from the same Source Address [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access"],"interval":"5m","enabled":true,"description":"Identifies multiple consecutive logon failures from the same source address and within a short time interval. Adversaries will often brute force login attempts across multiple users with a common or known password, in an attempt to gain access to accounts.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n#### Possible investigation steps\n\n- Investigate the logon failure reason code and the targeted user names.\n- Investigate the source IP address of the failed Network Logon attempts.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Identify the source and the target computer and their roles in the IT environment.\n\n### False positive analysis\n\n- Authentication misconfiguration or obsolete credentials.\n- Service account password expired.\n- Trust relationship between the primary domain and the trusted domain issue.\n- Infrastructure or availability issue.\n\n### Related rules\n\n- Multiple Logon Failure Followed by Logon Success - 4e85dc8a-3e41-40d8-bc28-91af7ac6cf60\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the host is a domain controller (DC):\n  - Activate your incident response plan for total Active Directory compromise.\n  - Review the privileges assigned to users that can access the DCs, to ensure that the least privilege principle is being followed and to reduce the attack surface.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"11cb41df-1d9c-46e6-98ce-6a468625e232","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"},"technique":[{"reference":"https://attack.mitre.org/techniques/T1110/","name":"Brute Force","id":"T1110","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1110/001/","name":"Password Guessing","id":"T1110.001"},{"reference":"https://attack.mitre.org/techniques/T1110/003/","name":"Password Spraying","id":"T1110.003"}]}]}],"to":"now","references":["https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4625"],"version":3,"exceptions_list":[{"id":"edd7d620-eb36-11ed-b6f4-dfeac9073248","list_id":"71d0fb45-25fa-4072-8d53-6cd0d89ac827","type":"rule_default","namespace_type":"single"}],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"sequence by winlog.computer_name, source.ip with maxspan=10s\n  [authentication where event.action == \"logon-failed\" and\n    /* event 4625 need to be logged */\n    winlog.logon.type : \"Network\" and\n    source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n    not user.name : (\"ANONYMOUS LOGON\", \"-\", \"*$\") and not user.domain == \"NT AUTHORITY\" and\n\n    /*\n    noisy failure status codes often associated to authentication misconfiguration :\n     0xC000015B - The user has not been granted the requested logon type (also called the logon right) at this machine.\n     0XC000005E\t- There are currently no logon servers available to service the logon request.\n     0XC0000133\t- Clocks between DC and other computer too far out of sync.\n     0XC0000192\tAn attempt was made to logon, but the Netlogon service was not started.\n    */\n    not winlog.event_data.Status : (\"0xC000015B\", \"0XC000005E\", \"0XC0000133\", \"0XC0000192\")] with runs=10\n","throttle":"no_actions","actions":[]}
{"id":"50e17c40-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.072Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.234Z","created_by":"chaykovskiyv","name":"Persistence via Scheduled Job Creation [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"A job can be used to schedule programs or scripts to be executed at a specified date and time. Adversaries may abuse task scheduling functionality to facilitate initial or recurring execution of malicious code.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Legitimate scheduled jobs may be created during installation of new software."],"from":"now-9m","rule_id":"be9529c8-2238-4e1f-b162-b26d86fba032","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1053/","name":"Scheduled Task/Job","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1053/005/","name":"Scheduled Task","id":"T1053.005"}],"id":"T1053"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"file where event.type != \"deletion\" and\n file.path : \"?:\\\\Windows\\\\Tasks\\\\*\" and file.extension : \"job\"\n","throttle":"no_actions","actions":[]}
{"id":"4d50b460-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.179Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.237Z","created_by":"chaykovskiyv","name":"User Account Creation [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies attempts to create new users. This is sometimes done by attackers to increase access or establish persistence on a system or domain.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating User Account Creation\n\nAttackers may create new accounts (both local and domain) to maintain access to victim systems.\n\nThis rule identifies the usage of `net.exe` to create new accounts.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Identify if the account was added to privileged groups or assigned special privileges after creation.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- Account creation is a common administrative task, so there is a high chance of the activity being legitimate. Before investigating further, verify that this activity is not benign.\n\n### Related rules\n\n- Creation of a Hidden Local User Account - 2edc8076-291e-41e9-81e4-e3fcbc97ae5e\n- Windows User Account Creation - 38e17753-f581-4644-84da-0d60a8318694\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Delete the created account.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"8f8248bb-62c9-4801-aca2-03f85b922a7f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1136/","name":"Create Account","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1136/001/","name":"Local Account","id":"T1136.001"}],"id":"T1136"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  process.name : (\"net.exe\", \"net1.exe\") and\n  not process.parent.name : \"net.exe\" and\n  (process.args : \"user\" and process.args : (\"/ad\", \"/add\"))\n","throttle":"no_actions","actions":[]}
{"id":"4f1ff620-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.173Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.316Z","created_by":"chaykovskiyv","name":"Potential LSASS Clone Creation via PssCaptureSnapShot [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Sysmon Only"],"interval":"5m","enabled":true,"description":"Identifies the creation of an LSASS process clone via PssCaptureSnapShot where the parent process is the initial LSASS process instance. This may indicate an attempt to evade detection and dump LSASS memory for credential access.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"12b8a33e-417b-43e9-ab78-83bf5524c358","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/001/","name":"LSASS Memory","id":"T1003.001"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://www.matteomalvica.com/blog/2019/12/02/win-defender-atp-cred-bypass/","https://medium.com/@Achilles8284/the-birth-of-a-process-part-2-97c6fb9c42a2"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-windows.*"],"query":"process where event.code:\"4688\" and\n  process.executable : \"?:\\\\Windows\\\\System32\\\\lsass.exe\" and\n  process.parent.executable : \"?:\\\\Windows\\\\System32\\\\lsass.exe\"\n","throttle":"no_actions","actions":[]}
{"id":"4b6d0040-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.605Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.083Z","created_by":"chaykovskiyv","name":"Suspicious WMIC XSL Script Execution [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Identifies WMIC allowlist bypass techniques by alerting on suspicious execution of scripts. When WMIC loads scripting libraries it may be indicative of an allowlist bypass.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"25aff90f-ee97-450b-9fc5-83b4325a14fd","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1220/","name":"XSL Script Processing","id":"T1220"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by process.entity_id with maxspan = 2m\n[process where event.type == \"start\" and\n   (process.name : \"WMIC.exe\" or process.pe.original_file_name : \"wmic.exe\") and\n   process.args : (\"format*:*\", \"/format*:*\", \"*-format*:*\") and\n   not process.command_line : \"* /format:table *\"]\n[any where (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n (dll.name : (\"jscript.dll\", \"vbscript.dll\") or file.name : (\"jscript.dll\", \"vbscript.dll\"))]\n","throttle":"no_actions","actions":[]}
{"id":"4d5213f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.197Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.255Z","created_by":"chaykovskiyv","name":"Windows CryptoAPI Spoofing Vulnerability (CVE-2020-0601 - CurveBall) [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"A spoofing vulnerability exists in the way Windows CryptoAPI (Crypt32.dll) validates Elliptic Curve Cryptography (ECC) certificates. An attacker could exploit the vulnerability by using a spoofed code-signing certificate to sign a malicious executable, making it appear the file was from a trusted, legitimate source.","risk_score":21,"severity":"low","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-6m","rule_id":"f9718912-2d55-4d4f-aeaa-d7d3daa90948","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1553/","name":"Subvert Trust Controls","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1553/002/","name":"Code Signing","id":"T1553.002"}],"id":"T1553"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.provider:\"Microsoft-Windows-Audit-CVE\" and message:\"[CVE-2020-0601]\"\n","throttle":"no_actions","actions":[]}
{"id":"4f2cc760-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.159Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.392Z","created_by":"chaykovskiyv","name":"Potential Credential Access via LSASS Memory Dump [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Sysmon Only"],"interval":"5m","enabled":true,"description":"Identifies suspicious access to LSASS handle from a call trace pointing to DBGHelp.dll or DBGCore.dll, which both export the MiniDumpWriteDump method that can be used to dump LSASS memory content in preparation for credential access.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"07e73765-ae75-4b27-8429-7c6e7b226042","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/001/","name":"LSASS Memory","id":"T1003.001"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dump-credentials-from-lsass-process-without-mimikatz","https://www.elastic.co/security-labs/detect-credential-access"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-windows.*"],"query":"process where event.code == \"10\" and\n  winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\" and\n\n   /* DLLs exporting MiniDumpWriteDump API to create an lsass mdmp*/\n  winlog.event_data.CallTrace : (\"*dbghelp*\", \"*dbgcore*\") and\n\n   /* case of lsass crashing */\n  not process.executable : (\"?:\\\\Windows\\\\System32\\\\WerFault.exe\", \"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"fb6f0cb0-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.276Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.736Z","created_by":"burzhynskyyy","name":"SharePoint Malware File Upload [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies the occurence of files uploaded to SharePoint being detected as Malware by the file scanning engine. Attackers can use File Sharing and Organization Repositories to spread laterally within the company and amplify their access. Users can inadvertently share these files without knowing their maliciousness, giving adversaries opportunities to gain initial access to other endpoints in the environment.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Benign files can trigger signatures in the built-in virus protection"],"from":"now-30m","rule_id":"cd31903c-fe8b-4410-a315-be8c7a9897d5","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1080/","name":"Taint Shared Content","id":"T1080"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":["https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/virus-detection-in-spo?view=o365-worldwide"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:SharePoint and event.code:SharePointFileOperation and event.action:FileMalwareDetected\n","throttle":"no_actions","actions":[]}
{"id":"49b47ad0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.523Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.197Z","created_by":"chaykovskiyv","name":"Registry Persistence via AppInit DLL [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Attackers may maintain persistence by creating registry keys using AppInit DLLs. AppInit DLLs are loaded by every process using the common library, user32.dll.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"89d10993-d495-422e-a62a-b3471a51f13f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1546/","name":"Event Triggered Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1546/010/","name":"AppInit DLLs","id":"T1546.010"}],"id":"T1546"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"registry where\n   registry.path : (\"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\AppInit_Dlls\",\n                    \"HKLM\\\\SOFTWARE\\\\Wow6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\AppInit_Dlls\") and\n   not process.executable : (\"C:\\\\Windows\\\\System32\\\\msiexec.exe\",\n                             \"C:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n                             \"C:\\\\Program Files\\\\Commvault\\\\ContentStore*\\\\Base\\\\cvd.exe\",\n                             \"C:\\\\Program Files (x86)\\\\Commvault\\\\ContentStore*\\\\Base\\\\cvd.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"4d5436d0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.209Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.272Z","created_by":"chaykovskiyv","name":"Adding Hidden File Attribute via Attrib [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Adversaries can add the 'hidden' attribute to files to hide them from the user in an attempt to evade detection.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timeline_id":"e70679c2-6cde-4510-9764-4823df18f7db","timeline_title":"Comprehensive Process Timeline","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"97190c1c-362d-4dd8-801b-c94bfa63f35e","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1564/","name":"Hide Artifacts","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1564/001/","name":"Hidden Files and Directories","id":"T1564.001"}],"id":"T1564"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}},{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.name : \"attrib.exe\" and process.args : \"+h\"\n","throttle":"no_actions","actions":[]}
{"id":"50df8070-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.054Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.210Z","created_by":"chaykovskiyv","name":"Potential Persistence via Time Provider Modification [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Identifies modification of the Time Provider. Adversaries may establish persistence by registering and enabling a malicious DLL as a time provider. Windows uses the time provider architecture to obtain accurate time stamps from other network devices or clients in the network. Time providers are implemented in the form of a DLL file which resides in the System32 folder. The service W32Time initiates during the startup of Windows and loads w32time.dll.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"61cc8ee4-923a-444c-a740-9a1159cb3f69","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1547/003/","name":"Time Providers","id":"T1547.003"}],"id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://pentestlab.blog/2019/10/22/persistence-time-providers/"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"registry where event.type:\"change\" and\n  registry.path:\"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\W32Time\\\\TimeProviders\\\\*\" and\n  registry.data.strings:\"*.dll\"\n","throttle":"no_actions","actions":[]}
{"id":"4d537380-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.206Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.266Z","created_by":"chaykovskiyv","name":"Process Injection by the Microsoft Build Engine [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Sysmon Only"],"interval":"5m","enabled":true,"description":"An instance of MSBuild, the Microsoft Build Engine, created a thread in another process. This technique is sometimes used to evade detection or elevate privileges.","risk_score":21,"severity":"low","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."],"from":"now-6m","rule_id":"f56b8f76-d852-42cf-951a-53222b4f8489","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1055/","name":"Process Injection","id":"T1055"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1055/","name":"Process Injection","id":"T1055"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"process.name:MSBuild.exe and event.action:\"CreateRemoteThread detected (rule: CreateRemoteThread)\"\n","throttle":"no_actions","actions":[]}
{"id":"50e39f20-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.251Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.261Z","created_by":"chaykovskiyv","name":"Remote Computer Account DnsHostName Update [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Active Directory"],"interval":"5m","enabled":true,"description":"Identifies the remote update to a computer account's DnsHostName attribute. If the new value set is a valid domain controller DNS hostname and the subject computer name is not a domain controller, then it's highly likely a preparation step to exploit CVE-2022-26923 in an attempt to elevate privileges from a standard domain user to domain admin privileges.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"cb08a9a8-385f-4fa1-9869-c16a2aa648fa","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1068/","name":"Exploitation for Privilege Escalation","id":"T1068"},{"reference":"https://attack.mitre.org/techniques/T1078/","name":"Valid Accounts","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1078/002/","name":"Domain Accounts","id":"T1078.002"}],"id":"T1078"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://research.ifcr.dk/certifried-active-directory-domain-privilege-escalation-cve-2022-26923-9e098fe298f4","https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2022-26923"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"sequence by winlog.computer_name with maxspan=5m\n\n  [authentication where event.action == \"logged-in\" and\n   winlog.logon.type == \"Network\" and event.outcome == \"success\" and\n   not user.name == \"ANONYMOUS LOGON\" and not winlog.event_data.SubjectUserName : \"*$\" and\n   not user.domain == \"NT AUTHORITY\" and source.ip != \"127.0.0.1\" and source.ip !=\"::1\"] by winlog.event_data.TargetLogonId\n\n  [iam where event.action == \"changed-computer-account\" and\n\n    /* if DnsHostName value equal a DC DNS hostname then it's highly suspicious */\n    winlog.event_data.DnsHostName : \"??*\" and\n\n    /* exclude FPs where DnsHostName starts with the ComputerName that was changed */\n    not startswith~(winlog.event_data.DnsHostName, substring(winlog.event_data.TargetUserName, 0, length(winlog.event_data.TargetUserName) - 1))\n    ] by winlog.event_data.SubjectLogonId\n","throttle":"no_actions","actions":[]}
{"id":"4d571d00-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.033Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.306Z","created_by":"chaykovskiyv","name":"Microsoft Windows Defender Tampering [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies when one or more features on Microsoft Defender are disabled. Adversaries may disable or tamper with Microsoft Defender features to evade detection and conceal malicious behavior.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Microsoft Windows Defender Tampering\n\nMicrosoft Windows Defender is an antivirus product built into Microsoft Windows, which makes it popular across multiple environments. Disabling it is a common step in threat actor playbooks.\n\nThis rule monitors the registry for modifications that disable Windows Defender features.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine which features have been disabled, and check if this operation is done under change management and approved according to the organization's policy.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity, the configuration is justified (for example, it is being used to deploy other security solutions or troubleshooting), and no other suspicious activity has been observed.\n\n### Related rules\n\n- Windows Defender Disabled via Registry Modification - 2ffa1f1e-b6db-47fa-994b-1512743847eb\n- Disabling Windows Defender Security Settings via PowerShell - c8cccb06-faf2-4cd5-886e-2c9636cfcb87\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Take actions to restore the appropriate Windows Defender antivirus configurations.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Austin Songer"],"false_positives":["Legitimate Windows Defender configuration changes"],"from":"now-9m","rule_id":"1df812f3-c012-4539-b172-4df3f4e316b2","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://thedfirreport.com/2021/10/18/icedid-to-xinglocker-ransomware-in-24-hours/","https://www.tenforums.com/tutorials/32236-enable-disable-microsoft-defender-pua-protection-windows-10-a.html","https://www.tenforums.com/tutorials/104025-turn-off-core-isolation-memory-integrity-windows-10-a.html","https://www.tenforums.com/tutorials/105533-enable-disable-windows-defender-exploit-protection-settings.html","https://www.tenforums.com/tutorials/123792-turn-off-tamper-protection-microsoft-defender-antivirus.html","https://www.tenforums.com/tutorials/51514-turn-off-microsoft-defender-periodic-scanning-windows-10-a.html","https://www.tenforums.com/tutorials/3569-turn-off-real-time-protection-microsoft-defender-antivirus.html","https://www.tenforums.com/tutorials/99576-how-schedule-scan-microsoft-defender-antivirus-windows-10-a.html"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"registry where event.type in (\"creation\", \"change\") and\n  (registry.path : \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\PUAProtection\" and\n  registry.data.strings : (\"0\", \"0x00000000\")) or\n  (registry.path : \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender Security Center\\\\App and Browser protection\\\\DisallowExploitProtectionOverride\" and\n  registry.data.strings : (\"0\", \"0x00000000\")) or\n  (registry.path : \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\DisableAntiSpyware\" and\n  registry.data.strings : (\"1\", \"0x00000001\")) or\n  (registry.path : \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Features\\\\TamperProtection\" and\n  registry.data.strings : (\"0\", \"0x00000000\")) or\n  (registry.path : \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableRealtimeMonitoring\" and\n  registry.data.strings : (\"1\", \"0x00000001\")) or\n  (registry.path : \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableIntrusionPreventionSystem\" and\n  registry.data.strings : (\"1\", \"0x00000001\")) or\n  (registry.path : \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableScriptScanning\" and\n  registry.data.strings : (\"1\", \"0x00000001\")) or\n  (registry.path : \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Windows Defender Exploit Guard\\\\Controlled Folder Access\\\\EnableControlledFolderAccess\" and\n  registry.data.strings : (\"0\", \"0x00000000\")) or\n  (registry.path : \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableIOAVProtection\" and\n  registry.data.strings : (\"1\", \"0x00000001\")) or\n  (registry.path : \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Reporting\\\\DisableEnhancedNotifications\" and\n  registry.data.strings : (\"1\", \"0x00000001\")) or\n  (registry.path : \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\SpyNet\\\\DisableBlockAtFirstSeen\" and\n  registry.data.strings : (\"1\", \"0x00000001\")) or\n  (registry.path : \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\SpyNet\\\\SpynetReporting\" and\n  registry.data.strings : (\"0\", \"0x00000000\")) or\n  (registry.path : \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\SpyNet\\\\SubmitSamplesConsent\" and\n  registry.data.strings : (\"0\", \"0x00000000\")) or\n  (registry.path : \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableBehaviorMonitoring\" and\n  registry.data.strings : (\"1\", \"0x00000001\"))\n","throttle":"no_actions","actions":[]}
{"id":"49b0d150-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.179Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.154Z","created_by":"chaykovskiyv","name":"Remote Execution via File Shares [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies the execution of a file that was created by the virtual system process. This may indicate lateral movement via network file shares.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Remote Execution via File Shares\n\nAdversaries can use network shares to host tooling to support the compromise of other hosts in the environment. These tools can include discovery utilities, credential dumpers, malware, etc.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Review adjacent login events (e.g., 4624) in the alert timeframe to identify the account used to perform this action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity can happen legitimately. Consider adding exceptions if it is expected and noisy in your environment.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Review the privileges needed to write to the network share and restrict write access as needed.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"71e97cee-ec32-4c82-9bed-7690ac9279bd","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1021/002/","name":"SMB/Windows Admin Shares","id":"T1021.002"}],"id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":["https://blog.menasec.net/2020/08/new-trick-to-detect-lateral-movement.html"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"sequence with maxspan=1m\n  [file where event.type in (\"creation\", \"change\") and process.pid == 4 and file.extension : \"exe\"] by host.id, file.path\n  [process where event.type == \"start\"] by host.id, process.executable\n","throttle":"no_actions","actions":[]}
{"id":"4d510280-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.182Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.239Z","created_by":"chaykovskiyv","name":"Potential Application Shimming via Sdbinst [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"The Application Shim was created to allow for backward compatibility of software as the operating system codebase changes over time. This Windows functionality has been abused by attackers to stealthily gain persistence and arbitrary code execution in legitimate Windows processes.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"1ff2222f-0032-4ba4-bd10-29e373aba67f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1546/","name":"Event Triggered Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1546/011/","name":"Application Shimming","id":"T1546.011"}],"id":"T1546"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1546/","name":"Event Triggered Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1546/011/","name":"Application Shimming","id":"T1546.011"}],"id":"T1546"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and process.name : \"sdbinst.exe\" and\n  not (process.args : \"-m\" and process.args : \"-bg\") and\n  not process.args : \"-mm\"\n","throttle":"no_actions","actions":[]}
{"id":"483072e0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.167Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.632Z","created_by":"chaykovskiyv","name":"Encoded Executable Stored in the Registry [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies registry write modifications to hide an encoded portable executable. This could be indicative of adversary defense evasion by avoiding the storing of malicious content directly on disk.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"1bfaf265-e5f3-4361-ba05-14d5ae60da76","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1112/","name":"Modify Registry","id":"T1112"},{"reference":"https://attack.mitre.org/techniques/T1140/","name":"Deobfuscate/Decode Files or Information","id":"T1140"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","endgame-*"],"query":"registry where\n/* update here with encoding combinations */\n registry.data.strings : \"TVqQAAMAAAAEAAAA*\"\n","throttle":"no_actions","actions":[]}
{"id":"4f2db1c0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.168Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.403Z","created_by":"chaykovskiyv","name":"PowerShell Keylogging Script [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Collection","Investigation Guide","PowerShell"],"interval":"5m","enabled":true,"description":"Detects the use of Win32 API Functions that can be used to capture user keystrokes in PowerShell scripts. Attackers use this technique to capture user input, looking for credentials and/or other valuable data.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating PowerShell Keylogging Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can abuse PowerShell capabilities to capture user keystrokes with the goal of stealing credentials and other valuable information as credit card data and confidential conversations.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Investigate if the script stores the captured data locally.\n- Investigate if the script contains exfiltration capabilities and the destination of this exfiltration.\n- Assess network data to determine if the host communicated with the exfiltration server.\n\n### False positive analysis\n\n- Regular users do not have a business justification for using scripting utilities to capture keystrokes, making false positives unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- The response must be prioritized if this alert involves key executives or potentially valuable targets for espionage.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"2208c696-f57a-4ead-a3c4-8c6a5da5189b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1056/","name":"Input Capture","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1056/001/","name":"Keylogging","id":"T1056.001"}],"id":"T1056"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0009/","name":"Collection","id":"TA0009"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://github.com/EmpireProject/Empire/blob/master/data/module_source/collection/Get-Keystrokes.ps1","https://github.com/MojtabaTajik/FunnyKeylogger/blob/master/FunnyLogger.ps1"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and\n  (\n   powershell.file.script_block_text : (GetAsyncKeyState or NtUserGetAsyncKeyState or GetKeyboardState or \"Get-Keystrokes\") or\n   powershell.file.script_block_text : (\n        (SetWindowsHookA or SetWindowsHookW or SetWindowsHookEx or SetWindowsHookExA or NtUserSetWindowsHookEx) and\n        (GetForegroundWindow or GetWindowTextA or GetWindowTextW or \"WM_KEYBOARD_LL\")\n   )\n   ) and not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"50e4feb0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.260Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.275Z","created_by":"chaykovskiyv","name":"Full User-Mode Dumps Enabled System-Wide [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access"],"interval":"5m","enabled":true,"description":"Identifies the enable of the full user-mode dumps feature system-wide. This feature allows Windows Error Reporting (WER) to collect data after an application crashes. This setting is a requirement for the LSASS Shtinkering attack, which fakes the communication of a crash on LSASS, generating a dump of the process memory, which gives the attacker access to the credentials present on the system without having to bring malware to the system. This setting is not enabled by default, and applications must create their registry subkeys to hold settings that enable them to collect dumps.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"47c73ef4-73a5-4899-b3b9-29e4c04c0467","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/001/","name":"LSASS Memory","id":"T1003.001"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1112/","name":"Modify Registry","id":"T1112"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://docs.microsoft.com/en-us/windows/win32/wer/collecting-user-mode-dumps","https://github.com/deepinstinct/Lsass-Shtinkering","https://media.defcon.org/DEF%20CON%2030/DEF%20CON%2030%20presentations/Asaf%20Gilboa%20-%20LSASS%20Shtinkering%20Abusing%20Windows%20Error%20Reporting%20to%20Dump%20LSASS.pdf"],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"registry where registry.path : \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\Windows Error Reporting\\\\LocalDumps\\\\DumpType\" and\n    registry.data.strings : (\"2\", \"0x00000002\") and\n    not (process.executable : \"?:\\\\Windows\\\\system32\\\\svchost.exe\" and user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\"))\n","throttle":"no_actions","actions":[]}
{"id":"4f2c0410-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.153Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.385Z","created_by":"chaykovskiyv","name":"Control Panel Process with Unusual Arguments [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies unusual instances of Control Panel with suspicious keywords or paths in the process command line value. Adversaries may abuse control.exe to proxy execution of malicious code.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"abaad7ff-114b-4cdb-9ab5-f27f212b3c18","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1218/","name":"System Binary Proxy Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1218/002/","name":"Control Panel","id":"T1218.002"}],"id":"T1218"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://www.joesandbox.com/analysis/476188/1/html"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n process.executable : (\"?:\\\\Windows\\\\SysWOW64\\\\control.exe\", \"?:\\\\Windows\\\\System32\\\\control.exe\") and\n process.command_line :\n          (\"*.jpg*\",\n           \"*.png*\",\n           \"*.gif*\",\n           \"*.bmp*\",\n           \"*.jpeg*\",\n           \"*.TIFF*\",\n           \"*.inf*\",\n           \"*.cpl:*/*\",\n           \"*../../..*\",\n           \"*/AppData/Local/*\",\n           \"*:\\\\Users\\\\Public\\\\*\",\n           \"*\\\\AppData\\\\Local\\\\*\")\n","throttle":"no_actions","actions":[]}
{"id":"4b6a4120-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.532Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.053Z","created_by":"chaykovskiyv","name":"Suspicious Managed Code Hosting Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Identifies a suspicious managed code hosting process which could indicate code injection or other form of suspicious code execution.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"c5fe96cb-812d-46fa-aa4b-764661cc3ffd","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1055/","name":"Process Injection","id":"T1055"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://blog.menasec.net/2019/07/interesting-difr-traces-of-net-clr.html"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by process.entity_id with maxspan=5m\n [process where event.type == \"start\" and\n  process.name : (\"wscript.exe\", \"cscript.exe\", \"mshta.exe\", \"wmic.exe\", \"regsvr32.exe\", \"svchost.exe\", \"dllhost.exe\", \"cmstp.exe\")]\n [file where event.type != \"deletion\" and\n  file.name : (\"wscript.exe.log\",\n               \"cscript.exe\",\n               \"mshta.exe.log\",\n               \"wmic.exe.log\",\n               \"svchost.exe.log\",\n               \"dllhost.exe.log\",\n               \"cmstp.exe.log\",\n               \"regsvr32.exe.log\")]\n","throttle":"no_actions","actions":[]}
{"id":"4d576b20-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.035Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.314Z","created_by":"chaykovskiyv","name":"PowerShell Suspicious Script with Audio Capture Capabilities [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Collection","Investigation Guide","PowerShell"],"interval":"5m","enabled":true,"description":"Detects PowerShell scripts that can record audio, a common feature in popular post-exploitation tooling.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating PowerShell Suspicious Script with Audio Capture Capabilities\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can use PowerShell to interact with the Windows API with the intent of capturing audio from input devices connected to the victim's computer.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Investigate if the script stores the recorded data locally and determine if anything was recorded.\n- Investigate if the script contains exfiltration capabilities and the destination of this exfiltration.\n- Assess network data to determine if the host communicated with the exfiltration server.\n\n### False positive analysis\n\n- Regular users should not need scripts to capture audio, which makes false positives unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- The response must be prioritized if this alert involves key executives or potentially valuable targets for espionage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"c3c20d7c-1500-4093-b287-0bafcccb8782","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1123/","name":"Audio Capture","id":"T1123"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0009/","name":"Collection","id":"TA0009"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-MicrophoneAudio.ps1"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and\n  powershell.file.script_block_text : (\n    \"Get-MicrophoneAudio\" or (waveInGetNumDevs and mciSendStringA)\n  ) and not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"48413bc0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.553Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.770Z","created_by":"chaykovskiyv","name":"Encrypting Files with WinRar or 7z [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Collection","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies use of WinRar or 7z to create an encrypted files. Adversaries will often compress and encrypt data in preparation for exfiltration.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Encrypting Files with WinRar or 7z\n\nAttackers may compress and/or encrypt data collected before exfiltration. Compressing the data can help obfuscate the collected data and minimize the amount of data sent over the network. Encryption can be used to hide information that is being exfiltrated from detection or make exfiltration less apparent upon inspection by a defender.\n\nThese steps are usually done in preparation for exfiltration, meaning the attack may be in its final stages.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Retrieve the encrypted file.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check if the password used in the encryption was included in the command line.\n- Decrypt the `.rar`/`.zip` and check if the information is sensitive.\n- If the password is not available, and the format is `.zip` or the option used in WinRAR is not the `-hp`, list the file names included in the encrypted file.\n- Investigate if the file was transferred to an attacker-controlled server.\n\n### False positive analysis\n\n- Backup software can use these utilities. Check the `process.parent.executable` and `process.parent.command_line` fields to determine what triggered the encryption.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Prioritize cases that involve personally identifiable information (PII) or other classified data.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"eee16795-fb10-407f-aaf8-c833a15c6825","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1560/","name":"Archive Collected Data","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1560/001/","name":"Archive via Utility","id":"T1560.001"}],"id":"T1560"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0009/","name":"Collection","id":"TA0009"}}],"to":"now","references":["https://www.welivesecurity.com/2020/12/02/turla-crutch-keeping-back-door-open/"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n(\n  ((process.name:\"rar.exe\" or process.code_signature.subject_name == \"win.rar GmbH\" or\n      process.pe.original_file_name == \"Command line RAR\") and\n    process.args == \"a\" and process.args : (\"-hp*\", \"-p*\", \"-dw\", \"-tb\", \"-ta\", \"/hp*\", \"/p*\", \"/dw\", \"/tb\", \"/ta\"))\n\n  or\n  (process.pe.original_file_name in (\"7z.exe\", \"7za.exe\") and\n     process.args == \"a\" and process.args : (\"-p*\", \"-sdel\"))\n\n  /* uncomment if noisy for backup software related FPs */\n  /* not process.parent.executable : (\"C:\\\\Program Files\\\\*.exe\", \"C:\\\\Program Files (x86)\\\\*.exe\") */\n)\n","throttle":"no_actions","actions":[]}
{"id":"49b209d0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.187Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.172Z","created_by":"chaykovskiyv","name":"Incoming DCOM Lateral Movement with ShellBrowserWindow or ShellWindows [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies use of Distributed Component Object Model (DCOM) to run commands from a remote host, which are launched via the ShellBrowserWindow or ShellWindows Application COM Object. This behavior may indicate an attacker abusing a DCOM application to stealthily move laterally.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"27bca0cb-d6c6-4ef0-b22a-99e0a3c0d2e4","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1021/003/","name":"Distributed Component Object Model","id":"T1021.003"}],"id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":["https://enigma0x3.net/2017/01/23/lateral-movement-via-dcom-round-2/"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by host.id with maxspan=5s\n [network where event.type == \"start\" and process.name : \"explorer.exe\" and\n  network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n  source.port > 49151 and destination.port > 49151 and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n ] by process.entity_id\n [process where event.type == \"start\" and\n  process.parent.name : \"explorer.exe\"\n ] by process.parent.entity_id\n","throttle":"no_actions","actions":[]}
{"id":"4f2d3c90-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.160Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.395Z","created_by":"chaykovskiyv","name":"Privilege Escalation via Rogue Named Pipe Impersonation [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Sysmon Only"],"interval":"5m","enabled":true,"description":"Identifies a privilege escalation attempt via rogue named pipe impersonation. An adversary may abuse this technique by masquerading as a known named pipe and manipulating a privileged process to connect to it.","risk_score":73,"severity":"high","note":"Named Pipe Creation Events need to be enabled within the Sysmon configuration by including the following settings:\n`condition equal \"contains\" and keyword equal \"pipe\"`\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2, events will not define `event.ingested` and default fallback for EQL rules was not added until 8.2, so you will need to add a custom pipeline to populate `event.ingested` to @timestamp for this rule to work.","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"55623383-ee6f-429a-8111-508510f241f1","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1134/","name":"Access Token Manipulation","id":"T1134"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/","https://github.com/zcgonvh/EfsPotato","https://twitter.com/SBousseaden/status/1429530155291193354"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-windows.*"],"query":"file where event.action : \"Pipe Created*\" and\n /* normal sysmon named pipe creation events truncate the pipe keyword */\n  file.name : \"\\\\*\\\\Pipe\\\\*\"\n","throttle":"no_actions","actions":[]}
{"id":"4b6f2320-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.624Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.112Z","created_by":"chaykovskiyv","name":"Command Shell Activity Started via RunDLL32 [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Credential Access","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies command shell activity started via RunDLL32, which is commonly abused by attackers to host malicious code.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Microsoft Windows installers leveraging RunDLL32 for installation."],"from":"now-9m","rule_id":"5cd6c239-b997-4a17-86c6-db47311683bf","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"},{"reference":"https://attack.mitre.org/techniques/T1059/003/","name":"Windows Command Shell","id":"T1059.003"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1552/","name":"Unsecured Credentials","id":"T1552"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n process.name : (\"cmd.exe\", \"powershell.exe\") and\n  process.parent.name : \"rundll32.exe\" and process.parent.command_line != null and\n  /* common FPs can be added here */\n  not process.parent.args : (\"C:\\\\Windows\\\\System32\\\\SHELL32.dll,RunAsNewUser_RunDLL\",\n                             \"C:\\\\WINDOWS\\\\*.tmp,zzzzInvokeManagedCustomActionOutOfProc\")\n","throttle":"no_actions","actions":[]}
{"id":"4b68e190-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.221Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.041Z","created_by":"chaykovskiyv","name":"Potential Secure File Deletion via SDelete Utility [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Detects file name patterns generated by the use of Sysinternals SDelete utility to securely delete a file via multiple file overwrite and rename operations.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\nVerify process details such as command line and hash to confirm this activity legitimacy.","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"a60789cf-ac6a-47e9-a131-8f98283dc14f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1070/","name":"Indicator Removal","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1070/004/","name":"File Deletion","id":"T1070.004"}],"id":"T1070"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"file where event.type == \"change\" and file.name : \"*AAA.AAA\"\n","throttle":"no_actions","actions":[]}
{"id":"49b5b350-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.536Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.212Z","created_by":"chaykovskiyv","name":"Execution of Persistent Suspicious Program [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Identifies execution of suspicious persistent programs (scripts, rundll32, etc.) by looking at process lineage and command line usage.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"4ef2b869-eb1d-4fac-a7d7-b13dba32a623","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1547/001/","name":"Registry Run Keys / Startup Folder","id":"T1547.001"}],"id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"/* userinit followed by explorer followed by early child process of explorer (unlikely to be launched interactively) within 1m */\nsequence by host.id, user.name with maxspan=1m\n  [process where event.type == \"start\" and process.name : \"userinit.exe\" and process.parent.name : \"winlogon.exe\"]\n  [process where event.type == \"start\" and process.name : \"explorer.exe\"]\n  [process where event.type == \"start\" and process.parent.name : \"explorer.exe\" and\n   /* add suspicious programs here */\n   process.pe.original_file_name in (\"cscript.exe\",\n                                     \"wscript.exe\",\n                                     \"PowerShell.EXE\",\n                                     \"MSHTA.EXE\",\n                                     \"RUNDLL32.EXE\",\n                                     \"REGSVR32.EXE\",\n                                     \"RegAsm.exe\",\n                                     \"MSBuild.exe\",\n                                     \"InstallUtil.exe\") and\n    /* add potential suspicious paths here */\n    process.args : (\"C:\\\\Users\\\\*\", \"C:\\\\ProgramData\\\\*\", \"C:\\\\Windows\\\\Temp\\\\*\", \"C:\\\\Windows\\\\Tasks\\\\*\", \"C:\\\\PerfLogs\\\\*\", \"C:\\\\Intel\\\\*\")\n   ]\n","throttle":"no_actions","actions":[]}
{"id":"4b6a8f40-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.537Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.058Z","created_by":"chaykovskiyv","name":"Suspicious Endpoint Security Parent Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"A suspicious Endpoint Security parent process was detected. This may indicate a process hollowing or other form of code injection.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"332b29ba-fafd-49cf-9ade-a22c5c319965","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1036/","name":"Masquerading","id":"T1036"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n process.name : (\"esensor.exe\", \"elastic-endpoint.exe\") and\n process.parent.executable != null and\n  /* add FPs here */\n not process.parent.executable : (\"C:\\\\Program Files\\\\Elastic\\\\*\",\n                                  \"C:\\\\Windows\\\\System32\\\\services.exe\",\n                                  \"C:\\\\Windows\\\\System32\\\\WerFault*.exe\",\n                                  \"C:\\\\Windows\\\\System32\\\\wermgr.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"4f2a2f50-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.135Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.352Z","created_by":"chaykovskiyv","name":"Signed Proxy Execution via MS Work Folders [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the use of Windows Work Folders to execute a potentially masqueraded control.exe file in the current working directory. Misuse of Windows Work Folders could indicate malicious activity.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Signed Proxy Execution via MS Work Folders\n\nWork Folders is a role service for file servers running Windows Server that provides a consistent way for users to access their work files from their PCs and devices. This allows users to store work files and access them from anywhere. When called, Work Folders will automatically execute any Portable Executable (PE) named control.exe as an argument before accessing the synced share.\n\nUsing Work Folders to execute a masqueraded control.exe could allow an adversary to bypass application controls and increase privileges.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n    - Examine the location of the WorkFolders.exe binary to determine if it was copied to the location of the control.exe binary. It resides in the System32 directory by default.\n- Trace the activity related to the control.exe binary to identify any continuing intrusion activity on the host.\n- Review the control.exe binary executed with Work Folders to determine maliciousness such as additional host activity or network traffic.\n- Determine if control.exe was synced to sync share, indicating potential lateral movement.\n- Review how control.exe was originally delivered on the host, such as emailed, downloaded from the web, or written to\ndisk from a separate binary.\n\n### False positive analysis\n\n- Windows Work Folders are used legitimately by end users and administrators for file sharing and syncing but not in the instance where a suspicious control.exe is passed as an argument.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Review the Work Folders synced share to determine if the control.exe was shared and if so remove it.\n- If no lateral movement was identified during investigation, take the affected host offline if possible and remove the control.exe binary as well as any additional artifacts identified during investigation.\n- Review integrating Windows Information Protection (WIP) to enforce data protection by encrypting the data on PCs using Work Folders.\n- Confirm with the user whether this was expected or not, and reset their password.","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic","Austin Songer"],"false_positives":[],"from":"now-9m","rule_id":"29935cb1-d39d-43b4-afef-de82dd9343a6","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1218/","name":"System Binary Proxy Execution","id":"T1218"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://docs.microsoft.com/en-us/windows-server/storage/work-folders/work-folders-overview","https://twitter.com/ElliotKillick/status/1449812843772227588","https://lolbas-project.github.io/lolbas/Binaries/WorkFolders/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\"\n    and process.name : \"control.exe\" and process.parent.name : \"WorkFolders.exe\"\n    and not process.executable : (\"?:\\\\Windows\\\\System32\\\\control.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\control.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"4f2155b0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.177Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.325Z","created_by":"chaykovskiyv","name":"Kerberos Pre-authentication Disabled for User [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Investigation Guide","Active Directory"],"interval":"5m","enabled":true,"description":"Identifies the modification of an account's Kerberos pre-authentication options. An adversary with GenericWrite/GenericAll rights over the account can maliciously modify these settings to perform offline password cracking attacks such as AS-REP roasting.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Kerberos Pre-authentication Disabled for User\n\nKerberos pre-authentication is an account protection against offline password cracking. When enabled, a user requesting access to a resource initiates communication with the Domain Controller (DC) by sending an Authentication Server Request (AS-REQ) message with a timestamp that is encrypted with the hash of their password. If and only if the DC is able to successfully decrypt the timestamp with the hash of the user’s password, it will then send an Authentication Server Response (AS-REP) message that contains the Ticket Granting Ticket (TGT) to the user. Part of the AS-REP message is signed with the user’s password. Microsoft's security monitoring [recommendations](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4738) state that `'Don't Require Preauth' – Enabled` should not be enabled for user accounts because it weakens security for the account’s Kerberos authentication.\n\nAS-REP roasting is an attack against Kerberos for user accounts that do not require pre-authentication, which means that if the target user has pre-authentication disabled, an attacker can request authentication data for it and get a TGT that can be brute-forced offline, similarly to Kerberoasting.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Determine if the target account is sensitive or privileged.\n- Inspect the account activities for suspicious or abnormal behaviors in the alert timeframe.\n\n### False positive analysis\n\n- Disabling pre-authentication is a bad security practice and should not be allowed in the domain. The security team should map and monitor any potential benign true positives (B-TPs), especially if the target account is privileged.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Reset the target account's password if there is any risk of TGTs having been retrieved.\n- Re-enable the preauthentication option or disable the target account.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"38c30a4f-5759-4d36-ad66-4020f36cc6b2","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1558/","name":"Steal or Forge Kerberos Tickets","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1558/004/","name":"AS-REP Roasting","id":"T1558.004"}],"id":"T1558"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://harmj0y.medium.com/roasting-as-reps-e6179a65216b","https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4738","https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0026_windows_audit_user_account_management.md"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.code:4738 and message:\"'Don't Require Preauth' - Enabled\"\n","throttle":"no_actions","actions":[]}
{"id":"4d57b940-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.037Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.316Z","created_by":"chaykovskiyv","name":"PowerShell Suspicious Script with Screenshot Capabilities [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Collection","Investigation Guide","PowerShell"],"interval":"5m","enabled":true,"description":"Detects PowerShell scripts that can take screenshots, which is a common feature in post-exploitation kits and remote access tools (RATs).","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating PowerShell Suspicious Script with Screenshot Capabilities\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks, which makes it available for use in various environments and creates an attractive way for attackers to execute code.\n\nAttackers can abuse PowerShell capabilities and take screen captures of desktops to gather information over the course of an operation.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Investigate if the script stores the captured data locally.\n- Investigate if the script contains exfiltration capabilities and the destination of this exfiltration.\n- Assess network data to determine if the host communicated with the exfiltration server.\n\n### False positive analysis\n\n- Regular users do not have a business justification for using scripting utilities to take screenshots, which makes false positives unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Related rules\n\n- PowerShell Keylogging Script - bd2c86a0-8b61-4457-ab38-96943984e889\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"a6839527-00ca-4514-a37b-6209ae32bd86","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1113/","name":"Screen Capture","id":"T1113"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0009/","name":"Collection","id":"TA0009"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://docs.microsoft.com/en-us/dotnet/api/system.drawing.graphics.copyfromscreen"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and\n  powershell.file.script_block_text : (\n    CopyFromScreen and\n    (\"System.Drawing.Bitmap\" or \"Drawing.Bitmap\")\n  ) and not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"4f228e30-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.184Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.332Z","created_by":"chaykovskiyv","name":"KRBTGT Delegation Backdoor [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Active Directory"],"interval":"5m","enabled":true,"description":"Identifies the modification of the msDS-AllowedToDelegateTo attribute to KRBTGT. Attackers can use this technique to maintain persistence to the domain by having the ability to request tickets for the KRBTGT service.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"cdad1bda-9bb6-4918-b2f1-e248117c207f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1098/","name":"Account Manipulation","id":"T1098"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1558/","name":"Steal or Forge Kerberos Tickets","id":"T1558"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://skyblue.team/posts/delegate-krbtgt","https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0026_windows_audit_user_account_management.md"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.action:modified-user-account and event.code:4738 and winlog.event_data.AllowedToDelegateTo:*krbtgt*\n","throttle":"no_actions","actions":[]}
{"id":"4f296c00-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.191Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.347Z","created_by":"chaykovskiyv","name":"User account exposed to Kerberoasting [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Active Directory","Investigation Guide"],"interval":"5m","enabled":true,"description":"Detects when a user account has the servicePrincipalName attribute modified. Attackers can abuse write privileges over a user to configure Service Principle Names (SPNs) so that they can perform Kerberoasting. Administrators can also configure this for legitimate purposes, exposing the account to Kerberoasting.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating User account exposed to Kerberoasting\n\nService Principal Names (SPNs) are names by which Kerberos clients uniquely identify service instances for Kerberos target computers.\n\nBy default, only computer accounts have SPNs, which creates no significant risk, since machine accounts have a default domain policy that rotates their passwords every 30 days, and the password is composed of 120 random characters, making them invulnerable to Kerberoasting.\n\nA user account with an SPN assigned is considered a service account, and is accessible to the entire domain. If any user in the directory requests a ticket-granting service (TGS), the domain controller will encrypt it with the secret key of the account executing the service. An attacker can potentially perform a Kerberoasting attack with this information, as the human-defined password is likely to be less complex.\n\nFor scenarios where SPNs cannot be avoided on user accounts, Microsoft provides the Group Managed Service Accounts (gMSA) feature, which ensures that account passwords are robust and changed regularly and automatically. More information can be found [here](https://docs.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview).\n\nAttackers can also perform \"Targeted Kerberoasting\", which consists of adding fake SPNs to user accounts that they have write privileges to, making them potentially vulnerable to Kerberoasting.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate if the target account is a member of privileged groups (Domain Admins, Enterprise Admins, etc.).\n- Investigate if tickets have been requested for the target account.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- The use of user accounts as service accounts is a bad security practice and should not be allowed in the domain. The security team should map and monitor any potential benign true positive (B-TP), especially if the account is privileged. Domain Administrators that define this kind of setting can put the domain at risk as user accounts don't have the same security standards as computer accounts (which have long, complex, random passwords that change frequently), exposing them to credential cracking attacks (Kerberoasting, brute force, etc.).\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services. Prioritize privileged accounts.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"b3e52b25-8105-42af-a831-46ae77e9d6a4","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1558/","name":"Steal or Forge Kerberos Tickets","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1558/003/","name":"Kerberoasting","id":"T1558.003"}],"id":"T1558"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://www.thehacker.recipes/ad/movement/access-controls/targeted-kerberoasting","https://www.qomplx.com/qomplx-knowledge-kerberoasting-attacks-explained/","https://www.thehacker.recipes/ad/movement/kerberos/kerberoast","https://attack.stealthbits.com/cracking-kerberos-tgs-tickets-using-kerberoasting","https://adsecurity.org/?p=280","https://github.com/OTRF/Set-AuditRule"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.action:\"Directory Service Changes\" and event.code:5136 and winlog.event_data.ObjectClass:\"user\"\nand winlog.event_data.AttributeLDAPDisplayName:\"servicePrincipalName\"\n","throttle":"no_actions","actions":[]}
{"id":"4f2d8ab0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.166Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.401Z","created_by":"chaykovskiyv","name":"Potential Process Injection via PowerShell [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","PowerShell"],"interval":"5m","enabled":true,"description":"Detects the use of Windows API functions that are commonly abused by malware and security tools to load malicious code or inject it into remote processes.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Potential Process Injection via PowerShell\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nPowerShell also has solid capabilities to make the interaction with the Win32 API in an uncomplicated and reliable way, like the execution of inline C# code, PSReflect, Get-ProcAddress, etc.\n\nRed Team tooling and malware developers take advantage of these capabilities to develop stagers and loaders that inject payloads directly into the memory without touching the disk to circumvent file-based security protections.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Check if the imported function was executed and which process it targeted.\n- Check if the injected code can be retrieved (hardcoded in the script or on command line logs).\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Legitimate PowerShell scripts that make use of these functions."],"from":"now-9m","rule_id":"ee066ea8-d3c6-469e-a72d-72fbc15642dc","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1055/","name":"Process Injection","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1055/001/","name":"Dynamic-link Library Injection","id":"T1055.001"},{"reference":"https://attack.mitre.org/techniques/T1055/002/","name":"Portable Executable Injection","id":"T1055.002"}],"id":"T1055"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://github.com/EmpireProject/Empire/blob/master/data/module_source/management/Invoke-PSInject.ps1","https://github.com/EmpireProject/Empire/blob/master/data/module_source/management/Invoke-ReflectivePEInjection.ps1","https://github.com/BC-SECURITY/Empire/blob/master/empire/server/data/module_source/credentials/Invoke-Mimikatz.ps1","https://www.elastic.co/security-labs/detect-credential-access"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and\n  powershell.file.script_block_text : (\n   (VirtualAlloc or VirtualAllocEx or VirtualProtect or LdrLoadDll or LoadLibrary or LoadLibraryA or\n      LoadLibraryEx or GetProcAddress or OpenProcess or OpenProcessToken or AdjustTokenPrivileges) and\n   (WriteProcessMemory or CreateRemoteThread or NtCreateThreadEx or CreateThread or QueueUserAPC or\n      SuspendThread or ResumeThread or GetDelegateForFunctionPointer)\n  ) and not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"4f230360-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.041Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.338Z","created_by":"chaykovskiyv","name":"AdminSDHolder Backdoor [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Active Directory"],"interval":"5m","enabled":true,"description":"Detects modifications in the AdminSDHolder object. Attackers can abuse the SDProp process to implement a persistent backdoor in Active Directory. SDProp compares the permissions on protected objects with those defined on the AdminSDHolder object. If the permissions on any of the protected accounts and groups do not match, the permissions on the protected accounts and groups are reset to match those of the domain's AdminSDHolder object, regaining their Administrative Privileges.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"e460f1e8-e546-41b7-918e-b4a2ec69aaa4","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://adsecurity.org/?p=1906","https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory#adminsdholder"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.action:\"Directory Service Changes\" and event.code:5136 and winlog.event_data.ObjectDN:CN=AdminSDHolder,CN=System*\n","throttle":"no_actions","actions":[]}
{"id":"50e4b090-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.259Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.272Z","created_by":"chaykovskiyv","name":"PowerShell Share Enumeration Script [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Investigation Guide","PowerShell"],"interval":"5m","enabled":true,"description":"Detects scripts that contain PowerShell functions, structures, or Windows API functions related to windows share enumeration activities. Attackers, mainly ransomware groups, commonly identify and inspect network shares, looking for critical information for encryption and/or exfiltration.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating PowerShell Share Enumeration Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can use PowerShell to enumerate shares to search for sensitive data like documents, scripts, and other kinds of valuable data for encryption, exfiltration, and lateral movement.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Check for additional PowerShell and command line logs that indicate that imported functions were run.\n  - Evaluate which information was potentially mapped and accessed by the attacker.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"7c72c403-7b04-4e2a-b6d8-1e51e2efd707","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1135/","name":"Network Share Discovery","id":"T1135"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"},{"reference":"https://attack.mitre.org/techniques/T1106/","name":"Native API","id":"T1106"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://www.advintel.io/post/hunting-for-corporate-insurance-policies-indicators-of-ransom-exfiltrations","https://thedfirreport.com/2022/04/04/stolen-images-campaign-ends-in-conti-ransomware/","https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"],"version":4,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and\n  powershell.file.script_block_text:(\n    \"Invoke-ShareFinder\" or\n    \"Invoke-ShareFinderThreaded\" or\n    (\n      \"shi1_netname\" and\n      \"shi1_remark\"\n    ) or\n    (\n      \"NetShareEnum\" and\n      \"NetApiBufferFree\"\n    )\n  ) and not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"49b2cd21-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.199Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.181Z","created_by":"chaykovskiyv","name":"WMI Incoming Lateral Movement [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies processes executed via Windows Management Instrumentation (WMI) on a remote host. This could be indicative of adversary lateral movement, but could be noisy if administrators use WMI to remotely manage hosts.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"7895213a-dbe3-42ad-a707-6b8e40120803","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1047/","name":"Windows Management Instrumentation","id":"T1047"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"sequence by host.id with maxspan = 2s\n\n /* Accepted Incoming RPC connection by Winmgmt service */\n\n  [network where process.name : \"svchost.exe\" and network.direction : (\"incoming\", \"ingress\") and\n   source.ip != \"127.0.0.1\" and source.ip != \"::1\" and source.port >= 49152 and destination.port >= 49152\n  ]\n\n  /* Excluding Common FPs Nessus and SCCM */\n\n  [process where event.type == \"start\" and process.parent.name : \"WmiPrvSE.exe\" and\n   not process.args : (\"C:\\\\windows\\\\temp\\\\nessus_*.txt\",\n                       \"C:\\\\windows\\\\TEMP\\\\nessus_*.TMP\",\n                       \"C:\\\\Windows\\\\CCM\\\\SystemTemp\\\\*\",\n                       \"C:\\\\Windows\\\\CCMCache\\\\*\",\n                       \"C:\\\\CCM\\\\Cache\\\\*\")\n   ]\n","throttle":"no_actions","actions":[]}
{"id":"4f2af2a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.147Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.374Z","created_by":"chaykovskiyv","name":"Potential DLL Side-Loading via Microsoft Antimalware Service Executable [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies a Windows trusted program that is known to be vulnerable to DLL Search Order Hijacking starting after being renamed or from a non-standard path. This is uncommon behavior and may indicate an attempt to evade defenses via side-loading a malicious DLL within the memory space of one of those processes.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic","Dennis Perto"],"false_positives":["Microsoft Antimalware Service Executable installed on non default installation path."],"from":"now-9m","rule_id":"41b17065-0ec5-4c5f-b6c1-56bc25c54f31","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1574/","name":"Hijack Execution Flow","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1574/002/","name":"DLL Side-Loading","id":"T1574.002"}],"id":"T1574"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://news.sophos.com/en-us/2021/07/04/independence-day-revil-uses-supply-chain-exploit-to-attack-hundreds-of-businesses/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n(\n  (process.pe.original_file_name == \"MsMpEng.exe\" and not process.name : \"MsMpEng.exe\") or\n  (process.name : \"MsMpEng.exe\" and not\n        process.executable : (\"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\*.exe\",\n                              \"?:\\\\Program Files\\\\Windows Defender\\\\*.exe\",\n                              \"?:\\\\Program Files (x86)\\\\Windows Defender\\\\*.exe\",\n                              \"?:\\\\Program Files\\\\Microsoft Security Client\\\\*.exe\",\n                              \"?:\\\\Program Files (x86)\\\\Microsoft Security Client\\\\*.exe\"))\n)\n","throttle":"no_actions","actions":[]}
{"id":"4d526210-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.198Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.257Z","created_by":"chaykovskiyv","name":"Microsoft Build Engine Started by an Office Application [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"An instance of MSBuild, the Microsoft Build Engine, was started by Excel or Word. This is unusual behavior for the Build Engine and could have been caused by an Excel or Word document executing a malicious script payload.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Microsoft Build Engine Started by an Office Application\n\nMicrosoft Office (MS Office) is a suite of applications designed to help with productivity and completing common tasks on a computer. You can create and edit documents containing text and images, work with data in spreadsheets and databases, and create presentations and posters. As it is some of the most-used software across companies, MS Office is frequently targeted for initial access. It also has a wide variety of capabilities that attackers can take advantage of.\n\nThe Microsoft Build Engine is a platform for building applications. This engine, also known as MSBuild, provides an XML schema for a project file that controls how the build platform processes and builds software, and can be abused to proxy execution of code.\n\nThis rule looks for the `Msbuild.exe` utility spawned by MS Office programs. This is generally the result of the execution of malicious documents.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate abnormal behaviors observed by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve MS Office documents received and opened by the user that could cause this behavior. Common locations include, but are not limited to, the Downloads and Document folders and the folder configured at the email client.\n- Determine if the collected files are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["The Build Engine is commonly used by Windows developers but use by non-engineers is unusual. It is quite unusual for this program to be started by an Office application like Word or Excel."],"from":"now-9m","rule_id":"5c165def-b69d-4da0-9522-648640f6181e","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1127/","name":"Trusted Developer Utilities Proxy Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1127/001/","name":"MSBuild","id":"T1127.001"}],"id":"T1127"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}},{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://blog.talosintelligence.com/2020/02/building-bypass-with-msbuild.html"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.name : \"MSBuild.exe\" and\n  process.parent.name : (\"eqnedt32.exe\",\n                         \"excel.exe\",\n                         \"fltldr.exe\",\n                         \"msaccess.exe\",\n                         \"mspub.exe\",\n                         \"outlook.exe\",\n                         \"powerpnt.exe\",\n                         \"winword.exe\" )\n","throttle":"no_actions","actions":[]}
{"id":"52afac90-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.294Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.236Z","created_by":"chaykovskiyv","name":"Suspicious Inter-Process Communication via Outlook [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Collection"],"interval":"5m","enabled":true,"description":"Detects Inter-Process Communication with Outlook via Component Object Model from an unusual process. Adversaries may target user email to collect sensitive information or send email on their behalf via API.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"8f8840eb-6a53-4d22-95dd-f26dd1c5e278","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1114/","name":"Email Collection","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1114/001/","name":"Local Email Collection","id":"T1114.001"}],"id":"T1114"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0009/","name":"Collection","id":"TA0009"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1559/","name":"Inter-Process Communication","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1559/001/","name":"Component Object Model","id":"T1559.001"}],"id":"T1559"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://github.com/center-for-threat-informed-defense/adversary_emulation_library/blob/master/apt29/Archive/CALDERA_DIY/evals/payloads/stepSeventeen_email.ps1"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"process where event.action == \"start\" and process.name : \"OUTLOOK.EXE\"  and\n process.Ext.effective_parent.name != null and\n not process.Ext.effective_parent.executable : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\")\n","throttle":"no_actions","actions":[]}
{"id":"49b257f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.190Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.176Z","created_by":"chaykovskiyv","name":"Potential SharpRDP Behavior [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies potential behavior of SharpRDP, which is a tool that can be used to perform authenticated command execution against a remote target via Remote Desktop Protocol (RDP) for the purposes of lateral movement.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"2c9291a7-d560-4148-aab8-9439da22a9e9","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1021/001/","name":"Remote Desktop Protocol","id":"T1021.001"}],"id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":["https://posts.specterops.io/revisiting-remote-desktop-lateral-movement-8fb905cb46c3","https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/blob/master/Lateral%20Movement/LM_sysmon_3_12_13_1_SharpRDP.evtx"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"/* Incoming RDP followed by a new RunMRU string value set to cmd, powershell, taskmgr or tsclient, followed by process execution within 1m */\n\nsequence by host.id with maxspan=1m\n  [network where event.type == \"start\" and process.name : \"svchost.exe\" and destination.port == 3389 and\n   network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n   source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n  ]\n\n  [registry where process.name : \"explorer.exe\" and\n   registry.path : (\"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\RunMRU\\\\*\") and\n   registry.data.strings : (\"cmd.exe*\", \"powershell.exe*\", \"taskmgr*\", \"\\\\\\\\tsclient\\\\*.exe\\\\*\")\n  ]\n\n  [process where event.type == \"start\" and\n   (process.parent.name : (\"cmd.exe\", \"powershell.exe\", \"taskmgr.exe\") or process.args : (\"\\\\\\\\tsclient\\\\*.exe\")) and\n   not process.name : \"conhost.exe\"\n   ]\n","throttle":"no_actions","actions":[]}
{"id":"4d56a7d0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.027Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.302Z","created_by":"chaykovskiyv","name":"Suspicious Portable Executable Encoded in Powershell Script [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Investigation Guide","PowerShell"],"interval":"5m","enabled":true,"description":"Detects the presence of a portable executable (PE) in a PowerShell script by looking for its encoded header. Attackers embed PEs into PowerShell scripts to inject them into memory, avoiding defences by not writing to disk.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Suspicious Portable Executable Encoded in Powershell Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can abuse PowerShell in-memory capabilities to inject executables into memory without touching the disk, bypassing file-based security protections. These executables are generally base64 encoded.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- Suspicious .NET Reflection via PowerShell - e26f042e-c590-4e82-8e05-41e81bd822ad\n- PowerShell Suspicious Payload Encoded and Compressed - 81fe9dc6-a2d7-4192-a2d8-eed98afc766a\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"5d87cd57-ee17-4791-8b33-e7dc13b1a68c","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and\n  powershell.file.script_block_text : (\n    TVqQAAMAAAAEAAAA\n  ) and not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"fb765fb0-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.252Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.780Z","created_by":"burzhynskyyy","name":"O365 Email Reported by User as Malware or Phish [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Initial Access"],"interval":"5m","enabled":true,"description":"Detects the occurrence of emails reported as Phishing or Malware by Users. Security Awareness training is essential to stay ahead of scammers and threat actors, as security products can be bypassed, and the user can still receive a malicious message. Educating users to report suspicious messages can help identify gaps in security controls and prevent malware infections and Business Email Compromise attacks.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Legitimate files reported by the users"],"from":"now-30m","rule_id":"7c73017e-0f46-46b7-b53d-56dd7fc004cc","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1566/","name":"Phishing","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1566/001/","name":"Spearphishing Attachment","id":"T1566.001"},{"reference":"https://attack.mitre.org/techniques/T1566/002/","name":"Spearphishing Link","id":"T1566.002"}],"id":"T1566"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":["https://support.microsoft.com/en-us/office/use-the-report-message-add-in-b5caa9f1-cdf3-4443-af8c-ff724ea719d2?ui=en-us&rs=en-us&ad=us"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.action:AlertTriggered and rule.name:\"Email reported by user as malware or phish\"\n","throttle":"no_actions","actions":[]}
{"id":"52af8580-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.295Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.237Z","created_by":"chaykovskiyv","name":"PowerShell Script with Encryption/Decryption Capabilities [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","PowerShell"],"interval":"5m","enabled":true,"description":"Identifies the use of Cmdlets and methods related to encryption/decryption of files in PowerShell scripts, which malware and offensive security tools can abuse to encrypt data or decrypt payloads to bypass security solutions.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Legitimate PowerShell Scripts which makes use of encryption."],"from":"now-9m","rule_id":"5ac65b3b-c139-4c1e-a1f6-f5cb9f1eca92","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1140/","name":"Deobfuscate/Decode Files or Information","id":"T1140"},{"reference":"https://attack.mitre.org/techniques/T1027/","name":"Obfuscated Files or Information","id":"T1027"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and\n  powershell.file.script_block_text : (\n    (\n      \"Cryptography.AESManaged\" or\n      \"Cryptography.RijndaelManaged\" or\n      \"Cryptography.SHA1Managed\" or\n      \"Cryptography.SHA256Managed\" or\n      \"Cryptography.SHA384Managed\" or\n      \"Cryptography.SHA512Managed\" or\n      \"Cryptography.SymmetricAlgorithm\" or\n      \"PasswordDeriveBytes\" or\n      \"Rfc2898DeriveBytes\"\n    ) and\n    (\n      CipherMode and PaddingMode\n    ) and\n    (\n      \".CreateEncryptor\" or\n      \".CreateDecryptor\"\n    )\n  ) and not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"52ad62a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.278Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.214Z","created_by":"chaykovskiyv","name":"SeDebugPrivilege Enabled by a Suspicious Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Identifies the creation of a process running as SYSTEM and impersonating a Windows core binary privileges. Adversaries may create a new process with a different token to escalate privileges and bypass access controls.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"9adbdf24-bf63-4616-8b92-d7a8d3cc63c7","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1134/","name":"Access Token Manipulation","id":"T1134"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4703","https://blog.palantir.com/windows-privilege-abuse-auditing-detection-and-defense-3078a403d74e"],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-windows.*"],"query":"any where event.provider: \"Microsoft-Windows-Security-Auditing\" and\n event.action : \"Token Right Adjusted Events\" and\n\n winlog.event_data.EnabledPrivilegeList : \"SeDebugPrivilege\" and\n\n /* exclude processes with System Integrity  */\n not winlog.event_data.SubjectUserSid : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n\n not winlog.event_data.ProcessName :\n         (\"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n          \"?:\\\\Windows\\\\System32\\\\lsass.exe\",\n          \"?:\\\\Windows\\\\WinSxS\\\\*\",\n          \"?:\\\\Program Files\\\\*\",\n          \"?:\\\\Program Files (x86)\\\\*\",\n          \"?:\\\\Windows\\\\System32\\\\MRT.exe\",\n          \"?:\\\\Windows\\\\System32\\\\cleanmgr.exe\",\n          \"?:\\\\Windows\\\\System32\\\\taskhostw.exe\",\n          \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\*-*\\\\DismHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\auditpol.exe\",\n          \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiPrvSe.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\wbem\\\\WmiPrvSe.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"fb6f33c0-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.274Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.737Z","created_by":"burzhynskyyy","name":"O365 Mailbox Audit Logging Bypass [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Initial Access"],"interval":"5m","enabled":true,"description":"Detects the occurrence of mailbox audit bypass associations. The mailbox audit is responsible for logging specified mailbox events (like accessing a folder or a message or permanently deleting a message). However, actions taken by some authorized accounts, such as accounts used by third-party tools or accounts used for lawful monitoring, can create a large number of mailbox audit log entries and may not be of interest to your organization. Because of this, administrators can create bypass associations, allowing certain accounts to perform their tasks without being logged. Attackers can abuse this allowlist mechanism to conceal actions taken, as the mailbox audit will log no activity done by the account.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Legitimate allowlisting of noisy accounts"],"from":"now-30m","rule_id":"58539277-3f78-4aff-938e-af2f5a9bfbdb","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/001/","name":"Disable or Modify Tools","id":"T1562.001"}],"id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://twitter.com/misconfig/status/1476144066807140355"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:Exchange and event.action:Set-MailboxAuditBypassAssociation and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"50df0b40-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.053Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.208Z","created_by":"chaykovskiyv","name":"Searching for Saved Credentials via VaultCmd [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Windows Credential Manager allows you to create, view, or delete saved credentials for signing into websites, connected applications, and networks. An adversary may abuse this to list or dump credentials stored in the Credential Manager for saved usernames and passwords. This may also be performed in preparation of lateral movement.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"4c7d7d04-df45-49b4-beca-1a3486cadada","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","id":"T1003"},{"reference":"https://attack.mitre.org/techniques/T1555/","name":"Credentials from Password Stores","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1555/004/","name":"Windows Credential Manager","id":"T1555.004"}],"id":"T1555"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://medium.com/threatpunter/detecting-adversary-tradecraft-with-image-load-event-logging-and-eql-8de93338c16","https://web.archive.org/web/20201004080456/https://rastamouse.me/blog/rdp-jump-boxes/","https://www.elastic.co/security-labs/detect-credential-access"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  (process.pe.original_file_name:\"vaultcmd.exe\" or process.name:\"vaultcmd.exe\") and\n  process.args:\"/list*\"\n","throttle":"no_actions","actions":[]}
{"id":"4f21f1f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.185Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.329Z","created_by":"chaykovskiyv","name":"Potential Shadow Credentials added to AD Object [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Active Directory"],"interval":"5m","enabled":true,"description":"Identify the modification of the msDS-KeyCredentialLink attribute in an Active Directory Computer or User Object. Attackers can abuse control over the object and create a key pair, append to raw public key in the attribute, and obtain persistent and stealthy access to the target user or computer object.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Modifications in the msDS-KeyCredentialLink attribute can be done legitimately by the Azure AD Connect synchronization account or the ADFS service account. These accounts can be added as Exceptions."],"from":"now-9m","rule_id":"8de7a2d9-4760-4c35-b9d2-e511f27d80cd","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1556/","name":"Modify Authentication Process","id":"T1556"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab","https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials","https://github.com/OTRF/Set-AuditRule","https://cyberstoph.org/posts/2022/03/detecting-shadow-credentials/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.action:\"Directory Service Changes\" and event.code:\"5136\" and\n winlog.event_data.AttributeLDAPDisplayName:\"msDS-KeyCredentialLink\" and winlog.event_data.AttributeValue :B\\:828* and not winlog.event_data.SubjectUserName: MSOL_*\n","throttle":"no_actions","actions":[]}
{"id":"49b405a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.521Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.194Z","created_by":"chaykovskiyv","name":"Program Files Directory Masquerading [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies execution from a directory masquerading as the Windows Program Files directories. These paths are trusted and usually host trusted third party programs. An adversary may leverage masquerading, along with low privileges to bypass detections allowlisting those folders.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"98f814f1-a542-41f0-84ae-c92261b36df4","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1036/","name":"Masquerading","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1036/005/","name":"Match Legitimate Name or Location","id":"T1036.005"}],"id":"T1036"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n process.executable : \"C:\\\\*Program*Files*\\\\*.exe\" and\n not process.executable : (\"C:\\\\Program Files\\\\*.exe\", \"C:\\\\Program Files (x86)\\\\*.exe\", \"C:\\\\Users\\\\*.exe\", \"C:\\\\ProgramData\\\\*.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"4d54ac00-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.004Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.279Z","created_by":"chaykovskiyv","name":"Disable Windows Firewall Rules via Netsh [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies use of the netsh.exe to disable or weaken the local firewall. Attackers will use this command line tool to disable the firewall during troubleshooting or to enable network mobility.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Disable Windows Firewall Rules via Netsh\n\nThe Windows Defender Firewall is a native component which provides host-based, two-way network traffic filtering for a device, and blocks unauthorized network traffic flowing into or out of the local device.\n\nAttackers can disable the Windows firewall or its rules to enable lateral movement and command and control activity.\n\nThis rule identifies patterns related to disabling the Windows firewall or its rules using the `netsh.exe` utility.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the user to check if they are aware of the operation.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Check whether the user is an administrator and is legitimately performing troubleshooting.\n- In case of an allowed benign true positive (B-TP), assess adding rules to allow needed traffic and re-enable the firewall.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"56679dcc-3ed4-404a-a2fc-3ea407b6b323","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/004/","name":"Disable or Modify System Firewall","id":"T1562.004"}],"id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.name : \"netsh.exe\" and\n  (\n    (process.args : \"disable\" and process.args : \"firewall\" and process.args : \"set\") or\n    (process.args : \"advfirewall\" and process.args : \"off\" and process.args : \"state\")\n  )\n","throttle":"no_actions","actions":[]}
{"id":"4d56cee0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.030Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.300Z","created_by":"chaykovskiyv","name":"PowerShell PSReflect Script [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Investigation Guide","PowerShell"],"interval":"5m","enabled":true,"description":"Detects the use of PSReflect in PowerShell scripts. Attackers leverage PSReflect as a library that enables PowerShell to access win32 API functions.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating PowerShell PSReflect Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nPSReflect is a library that enables PowerShell to access win32 API functions in an uncomplicated way. It also helps to create enums and structs easily—all without touching the disk.\n\nAlthough this is an interesting project for every developer and admin out there, it is mainly used in the red team and malware tooling for its capabilities.\n\nDetecting the core implementation of PSReflect means detecting most of the tooling that uses Windows API through PowerShell, enabling defenders to discover tools being dropped in the environment.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics. The script content that may be split into multiple script blocks (you can use the field `powershell.file.script_block_id` for filtering).\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Check for additional PowerShell and command-line logs that indicate that imported functions were run.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- PowerShell Suspicious Discovery Related Windows API Functions - 61ac3638-40a3-44b2-855a-985636ca985e\n- PowerShell Keylogging Script - bd2c86a0-8b61-4457-ab38-96943984e889\n- PowerShell Suspicious Script with Audio Capture Capabilities - 2f2f4939-0b34-40c2-a0a3-844eb7889f43\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- Suspicious .NET Reflection via PowerShell - e26f042e-c590-4e82-8e05-41e81bd822ad\n- PowerShell Suspicious Payload Encoded and Compressed - 81fe9dc6-a2d7-4192-a2d8-eed98afc766a\n- PowerShell Suspicious Script with Screenshot Capabilities - 959a7353-1129-4aa7-9084-30746b256a70\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Legitimate PowerShell scripts that make use of PSReflect to access the win32 API"],"from":"now-9m","rule_id":"9a88e214-78f0-4fd5-986c-582b8ee2b55f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"},{"reference":"https://attack.mitre.org/techniques/T1106/","name":"Native API","id":"T1106"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://github.com/mattifestation/PSReflect/blob/master/PSReflect.psm1","https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and\n  powershell.file.script_block_text:(\n    \"New-InMemoryModule\" or\n    \"Add-Win32Type\" or\n    psenum or\n    DefineDynamicAssembly or\n    DefineDynamicModule or\n    \"Reflection.TypeAttributes\" or\n    \"Reflection.Emit.OpCodes\" or\n    \"Reflection.Emit.CustomAttributeBuilder\" or\n    \"Runtime.InteropServices.DllImportAttribute\"\n  ) and not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"49331720-b674-11ed-b6f4-dfeac9073248","updated_at":"2023-08-18T07:58:30.657Z","updated_by":"chaykovskiyv","created_at":"2023-02-27T07:56:48.409Z","created_by":"burzhynskyyy","name":"Microsoft Defender 365 Incident","tags":["Custom Rules"],"interval":"5m","enabled":true,"description":"Microsoft Defender 365 Incident","risk_score":21,"severity":"low","license":"","output_index":"","meta":{"from":"1m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"rule_name_override":"m365_defender.incidentName","timestamp_override":"m365_defender.alerts.creationTime","timestamp_override_fallback_disabled":false,"author":["Octava"],"false_positives":[],"from":"now-360s","rule_id":"24226c28-c679-4fd4-b88f-a208dc076683","max_signals":100,"risk_score_mapping":[],"severity_mapping":[{"field":"m365_defender.alerts.severity","value":"Low","operator":"equals","severity":"low"},{"field":"m365_defender.alerts.severity","value":"Medium","operator":"equals","severity":"medium"},{"field":"m365_defender.alerts.severity","value":"High","operator":"equals","severity":"high"},{"field":"m365_defender.alerts.severity","value":"Critical","operator":"equals","severity":"critical"}],"threat":[],"to":"now","references":[],"version":10,"exceptions_list":[{"id":"f2b36820-ed94-11ed-8f07-79710758f25a","list_id":"0b056f53-34ff-4759-bea1-923dead178af","type":"rule_default","namespace_type":"single"}],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"observer.product:\"365 Defender\" and m365_defender.alerts.status:\"New\" and not message:(\"Connection to a custom network indicator\" or \"Unsanctioned cloud app access was blocked\") and not event.provider: \"MicrosoftEndPointDlp\" and not (file.path: \"C:\\Program Files (x86)\\Bulletin_129_key\" and file.name: \"Nvkreg.exe\")","filters":[],"throttle":"no_actions","actions":[]}
{"id":"fb75c370-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.285Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.774Z","created_by":"burzhynskyyy","name":"O365 Excessive Single Sign-On Logon Errors [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Identity and Access"],"interval":"5m","enabled":true,"description":"Identifies accounts with a high number of single sign-on (SSO) logon errors. Excessive logon errors may indicate an attempt to brute force a password or SSO token.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","author":["Elastic","Austin Songer"],"false_positives":["Automated processes that attempt to authenticate using expired credentials and unbounded retries may lead to false positives."],"from":"now-20m","rule_id":"8d4daa12-9949-417e-a94b-8ab79d9b348d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1110/","name":"Brute Force","id":"T1110"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:AzureActiveDirectory and event.category:authentication and o365.audit.LogonError:\"SsoArtifactInvalidOrExpired\"\n","threshold":{"field":["user.id"],"value":5},"throttle":"no_actions","actions":[]}
{"id":"52ae9b20-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.285Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.227Z","created_by":"chaykovskiyv","name":"Modification of the msPKIAccountCredentials [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Active Directory","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Identify the modification of the msPKIAccountCredentials attribute in an Active Directory User Object. Attackers can abuse the credentials roaming feature to overwrite an arbitrary file for privilege escalation. ms-PKI-AccountCredentials contains binary large objects (BLOBs) of encrypted credential objects from the credential manager store, private keys, certificates, and certificate requests.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"3402423e-bf22-45da-a75f-53ee42b9bdf9","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1068/","name":"Exploitation for Privilege Escalation","id":"T1068"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://www.mandiant.com/resources/blog/apt29-windows-credential-roaming","https://social.technet.microsoft.com/wiki/contents/articles/11483.windows-credential-roaming.aspx","https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-5136"],"version":3,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.action:\"Directory Service Changes\" and event.code:\"5136\" and\n winlog.event_data.AttributeLDAPDisplayName:\"msPKIAccountCredentials\" and winlog.event_data.OperationType:\"%%14674\" and\n not winlog.event_data.SubjectUserSid : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"fb3a4110-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.273Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.379Z","created_by":"burzhynskyyy","name":"Potential Password Spraying of Microsoft 365 User Accounts [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Identity and Access"],"interval":"5m","enabled":true,"description":"Identifies a high number (25) of failed Microsoft 365 user authentication attempts from a single IP address within 30 minutes, which could be indicative of a password spraying attack. An adversary may attempt a password spraying attack to obtain unauthorized access to user accounts.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":["Automated processes that attempt to authenticate using expired credentials and unbounded retries may lead to false positives."],"from":"now-30m","rule_id":"1c33e846-77f8-4bd2-a66d-c18c2ed60ce1","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1110/","name":"Brute Force","id":"T1110"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:(Exchange or AzureActiveDirectory) and event.category:authentication and\nevent.action:(\"UserLoginFailed\" or \"PasswordLogonInitialAuthUsingPassword\")\n","threshold":{"field":["source.ip"],"value":25},"throttle":"no_actions","actions":[]}
{"id":"50e23f90-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.236Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.240Z","created_by":"chaykovskiyv","name":"Potential Remote Desktop Shadowing Activity [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies the modification of the Remote Desktop Protocol (RDP) Shadow registry or the execution of processes indicative of an active RDP shadowing session. An adversary may abuse the RDP Shadowing feature to spy on or control other users active RDP sessions.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"4a9b1bf5-15eb-40c9-a1dc-3fbc6c6d4506","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":["https://bitsadm.in/blog/spying-on-users-using-rdp-shadowing","https://swarm.ptsecurity.com/remote-desktop-services-shadowing/"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"/* Identifies the modification of RDP Shadow registry or\n  the execution of processes indicative of active shadow RDP session */\n\nany where\n  (event.category == \"registry\" and\n     registry.path : \"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\Windows NT\\\\Terminal Services\\\\Shadow\"\n  ) or\n  (event.category == \"process\" and event.type == \"start\" and\n     (process.name : (\"RdpSaUacHelper.exe\", \"RdpSaProxy.exe\") and process.parent.name : \"svchost.exe\") or\n     (process.pe.original_file_name : \"mstsc.exe\" and process.args : \"/shadow:*\")\n  )\n","throttle":"no_actions","actions":[]}
{"id":"4f299310-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.199Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.349Z","created_by":"chaykovskiyv","name":"Account Configured with Never-Expiring Password [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Active Directory","Investigation Guide"],"interval":"5m","enabled":true,"description":"Detects the creation and modification of an account with the \"Don't Expire Password\" option Enabled. Attackers can abuse this misconfiguration to persist in the domain and maintain long-term access using compromised accounts with this property.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Account Configured with Never-Expiring Password\n\nActive Directory provides a setting that prevents users' passwords from expiring. Enabling this setting is bad practice and can expose environments to vulnerabilities that weaken security posture, especially when these accounts are privileged.\n\nThe setting is usually configured so a user account can act as a service account. Attackers can abuse these accounts to persist in the domain and maintain long-term access using compromised accounts with a never-expiring password set.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/source host during the past 48 hours.\n- Inspect the account for suspicious or abnormal behaviors in the alert timeframe.\n\n### False positive analysis\n\n- This activity should not happen legitimately. The security team should address any potential benign true positive (B-TP), as this configuration can put the user and the domain at risk.\n- Using user accounts as service accounts is a bad security practice and should not be allowed in the domain. The security team should map and monitor potential benign true positives (B-TPs), especially if the account is privileged. For cases in which user accounts cannot be avoided, Microsoft provides the Group Managed Service Accounts (gMSA) feature, which ensures that the account password is robust and changed regularly and automatically.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Reset the password of the account and update its password settings.\n- Search for other occurrences on the domain.\n    - Using the [Active Directory PowerShell module](https://docs.microsoft.com/en-us/powershell/module/activedirectory/get-aduser):\n        - `get-aduser -filter { passwordNeverExpires -eq $true  -and enabled -eq $true } | ft`\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["User accounts can be used as service accounts and have their password set never to expire. This is a bad security practice that exposes the account to Credential Access attacks. For cases in which user accounts cannot be avoided, Microsoft provides the Group Managed Service Accounts (gMSA) feature, which ensures that the account password is robust and changed regularly and automatically."],"from":"now-9m","rule_id":"f6dc2e58-a76a-47a6-948b-9fd4d2d771b2","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1098/","name":"Account Manipulation","id":"T1098"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://www.cert.ssi.gouv.fr/uploads/guide-ad.html#dont_expire","https://blog.menasec.net/2019/02/threat-hunting-26-persistent-password.html"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.action:\"modified-user-account\" and event.code:\"4738\" and message:\"'Don't Expire Password' - Enabled\" and not user.id:\"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"483ea3b0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.183Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.736Z","created_by":"chaykovskiyv","name":"Potential Remote Desktop Tunneling Detected [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Command and Control","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies potential use of an SSH utility to establish RDP over a reverse SSH Tunnel. This can be used by attackers to enable routing of network packets that would otherwise not reach their intended destination.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Potential Remote Desktop Tunneling Detected\n\nProtocol Tunneling is a mechanism that involves explicitly encapsulating a protocol within another for various use cases, ranging from providing an outer layer of encryption (similar to a VPN) to enabling traffic that network appliances would filter to reach their destination.\n\nAttackers may tunnel Remote Desktop Protocol (RDP) traffic through other protocols like Secure Shell (SSH) to bypass network restrictions that block incoming RDP connections but may be more permissive to other protocols.\n\nThis rule looks for command lines involving the `3389` port, which RDP uses by default and options commonly associated with tools that perform tunneling.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine network data to determine if the host communicated with external servers using the tunnel.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n- Investigate the command line for the execution of programs that are unrelated to tunneling, like Remote Desktop clients.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Take the necessary actions to disable the tunneling, which can be a process kill, service deletion, registry key modification, etc. Inspect the host to learn which method was used and to determine a response for the case.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"b381bee1-b76a-424f-acba-2721bd2b295b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1572/","name":"Protocol Tunneling","id":"T1572"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0011/","name":"Command and Control","id":"TA0011"}}],"to":"now","references":["https://blog.netspi.com/how-to-access-rdp-over-a-reverse-ssh-tunnel/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  /* RDP port and usual SSH tunneling related switches in command line */\n  process.args : \"*:3389\" and\n  process.args : (\"-L\", \"-P\", \"-R\", \"-pw\", \"-ssh\")\n","throttle":"no_actions","actions":[]}
{"id":"4f2c7940-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.157Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.390Z","created_by":"chaykovskiyv","name":"PowerShell MiniDump Script [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Investigation Guide","PowerShell"],"interval":"5m","enabled":true,"description":"This rule detects PowerShell scripts capable of dumping process memory using WindowsErrorReporting or Dbghelp.dll MiniDumpWriteDump. Attackers can use this tooling to dump LSASS and get access to credentials.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating PowerShell MiniDump Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can abuse Process Memory Dump capabilities to extract credentials from LSASS or to obtain other privileged information stored in the process memory.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Check if the imported function was executed and which process it targeted.\n\n### False positive analysis\n\n- Regular users do not have a business justification for using scripting utilities to dump process memory, making false positives unlikely.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["PowerShell scripts that use this capability for troubleshooting."],"from":"now-9m","rule_id":"bbbad86f-2a4c-4410-b9f6-92446fe0e23f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/001/","name":"LSASS Memory","id":"T1003.001"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Out-Minidump.ps1","https://github.com/FuzzySecurity/PowerShell-Suite/blob/master/Get-ProcessMiniDump.ps1","https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and powershell.file.script_block_text:(MiniDumpWriteDump or MiniDumpWithFullMemory or pmuDetirWpmuDiniM) and not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"4d53c1a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.207Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.268Z","created_by":"chaykovskiyv","name":"IIS HTTP Logging Disabled [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies when Internet Information Services (IIS) HTTP Logging is disabled on a server. An attacker with IIS server access via a webshell or other mechanism can disable HTTP Logging as an effective anti-forensics measure.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"e5328d66-d84d-4029-9715-b4ba48712934","max_signals":33,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/002/","name":"Disable Windows Event Logging","id":"T1562.002"}],"id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  (process.name : \"appcmd.exe\" or process.pe.original_file_name == \"appcmd.exe\") and\n  process.args : \"/dontLog*:*True\" and\n  not process.parent.name : \"iissetup.exe\"\n","throttle":"no_actions","actions":[]}
{"id":"50de6f00-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.046Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.196Z","created_by":"chaykovskiyv","name":"Creation of a Hidden Local User Account [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies the creation of a hidden local user account by appending the dollar sign to the account name. This is sometimes done by attackers to increase access to a system and avoid appearing in the results of accounts listing using the net users command.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Creation of a Hidden Local User Account\n\nAttackers can create accounts ending with a `$` symbol to make the account hidden to user enumeration utilities and bypass detections that identify computer accounts by this pattern to apply filters.\n\nThis rule uses registry events to identify the creation of local hidden accounts.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positive (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Delete the hidden account.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"18f68206-edf4-4fe2-874f-6ec2b4855222","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1136/","name":"Create Account","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1136/001/","name":"Local Account","id":"T1136.001"}],"id":"T1136"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://blog.menasec.net/2019/02/threat-hunting-6-hiding-in-plain-sights_8.html","https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/tree/master/2020/2020.12.15.Lazarus_Campaign"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"registry where registry.path : \"HKLM\\\\SAM\\\\SAM\\\\Domains\\\\Account\\\\Users\\\\Names\\\\*$\\\\\"\n","throttle":"no_actions","actions":[]}
{"id":"49b3b780-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.501Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.190Z","created_by":"chaykovskiyv","name":"Image File Execution Options Injection [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"The Debugger and SilentProcessExit registry keys can allow an adversary to intercept the execution of files, causing a different process to be executed. This functionality can be abused by an adversary to establish persistence.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"a85c0a99-903f-461e-836d-28c4b0b5f0e6","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1546/","name":"Event Triggered Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1546/012/","name":"Image File Execution Options Injection","id":"T1546.012"}],"id":"T1546"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://oddvar.moe/2018/04/10/persistence-using-globalflags-in-image-file-execution-options-hidden-from-autoruns-exe/"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"registry where length(registry.data.strings) > 0 and\n registry.path : (\"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*.exe\\\\Debugger\",\n                  \"HKLM\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\Debugger\",\n                  \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n                  \"HKLM\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\") and\n   /* add FPs here */\n not registry.data.strings regex~ (\"\"\"C:\\\\Program Files( \\(x86\\))?\\\\ThinKiosk\\\\thinkiosk\\.exe\"\"\", \"\"\".*\\\\PSAppDeployToolkit\\\\.*\"\"\")\n","throttle":"no_actions","actions":[]}
{"id":"4f2a5660-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.133Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.359Z","created_by":"chaykovskiyv","name":"Suspicious Print Spooler File Deletion [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Detects deletion of print driver files by an unusual process. This may indicate a clean up attempt post successful privilege escalation via Print Spooler service related vulnerabilities.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Uninstall or manual deletion of a legitimate printing driver files. Verify the printer file metadata such as manufacturer and signature information."],"from":"now-9m","rule_id":"5439f8ae-eb9d-454c-b726-6e14db2ed77c","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1068/","name":"Exploitation for Privilege Escalation","id":"T1068"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"file where event.type : \"deletion\" and\n not process.name : (\"spoolsv.exe\", \"dllhost.exe\", \"explorer.exe\") and\n file.path : \"?:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\3\\\\*.dll\"\n","throttle":"no_actions","actions":[]}
{"id":"483aac10-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.176Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.681Z","created_by":"chaykovskiyv","name":"RDP Enabled via Registry [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies registry write modifications to enable Remote Desktop Protocol (RDP) access. This could be indicative of adversary lateral movement preparation.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating RDP Enabled via Registry\n\nMicrosoft Remote Desktop Protocol (RDP) is a proprietary Microsoft protocol that enables remote connections to other computers, typically over TCP port 3389.\n\nAttackers can use RDP to conduct their actions interactively. Ransomware operators frequently use RDP to access victim servers, often using privileged accounts.\n\nThis rule detects modification of the fDenyTSConnections registry key to the value `0`, which specifies that remote desktop connections are enabled. Attackers can abuse remote registry, use psexec, etc., to enable RDP and move laterally.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the user to check if they are aware of the operation.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check whether it makes sense to enable RDP to this host, given its role in the environment.\n- Check if the host is directly exposed to the internet.\n- Check whether privileged accounts accessed the host shortly after the modification.\n- Review network events within a short timespan of this alert for incoming RDP connection attempts.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Check whether the user should be performing this kind of activity, whether they are aware of it, whether RDP should be open, and whether the action exposes the environment to unnecessary risks.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If RDP is needed, make sure to secure it using firewall rules:\n  - Allowlist RDP traffic to specific trusted hosts.\n  - Restrict RDP logins to authorized non-administrator accounts, where possible.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"2e5f922e-6a88-4985-a16f-ea8cc0f677e4","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1021/001/","name":"Remote Desktop Protocol","id":"T1021.001"}],"id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"registry where event.type in (\"creation\", \"change\") and\n  registry.path : \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Terminal Server\\\\fDenyTSConnections\" and\n  registry.data.strings : (\"0\", \"0x00000000\") and not (process.name : \"svchost.exe\" and user.domain == \"NT AUTHORITY\") and\n  not process.executable : \"C:\\\\Windows\\\\System32\\\\SystemPropertiesRemote.exe\"\n","throttle":"no_actions","actions":[]}
{"id":"49cb8540-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.545Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.278Z","created_by":"chaykovskiyv","name":"Execution via MSSQL xp_cmdshell Stored Procedure [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies execution via MSSQL xp_cmdshell stored procedure. Malicious users may attempt to elevate their privileges by using xp_cmdshell, which is disabled by default, thus, it's important to review the context of it's use.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Execution via MSSQL xp_cmdshell Stored Procedure\n\nMicrosoft SQL Server (MSSQL) has procedures meant to extend its functionality, the Extended Stored Procedures. These procedures are external functions written in C/C++; some provide interfaces for external programs. This is the case for xp_cmdshell, which spawns a Windows command shell and passes in a string for execution. Attackers can use this to execute commands on the system running the SQL server, commonly to escalate their privileges and establish persistence.\n\nThe xp_cmdshell procedure is disabled by default, but when used, it has the same security context as the MSSQL Server service account, which is often privileged.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the command line to determine if the command executed is potentially harmful or malicious.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n\n### False positive analysis\n\n- This mechanism can be used legitimately, but it brings inherent risk. The security team must monitor any activity of it. If recurrent tasks are being executed using this mechanism, consider adding exceptions — preferably with a full command line.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Ensure that SQL servers are not directly exposed to the internet. If there is a business justification for such, use an allowlist to allow only connections from known legitimate sources.\n- Disable the xp_cmdshell stored procedure.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"8ae4ec83-25d7-4710-9962-a14cb4b67318","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://thedfirreport.com/2022/07/11/select-xmrig-from-sqlserver/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.name : \"cmd.exe\" and process.parent.name : \"sqlservr.exe\" and\n  not process.args : (\"\\\\\\\\*\", \"diskfree\", \"rmdir\", \"mkdir\", \"dir\", \"del\", \"rename\", \"bcp\", \"*XMLNAMESPACES*\",\n                      \"?:\\\\MSSQL\\\\Backup\\\\Jobs\\\\sql_agent_backup_job.ps1\", \"K:\\\\MSSQL\\\\Backup\\\\msdb\", \"K:\\\\MSSQL\\\\Backup\\\\Logins\")\n","throttle":"no_actions","actions":[]}
{"id":"50e1f170-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.073Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.236Z","created_by":"chaykovskiyv","name":"Network Logon Provider Registry Modification [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Credential Access","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the modification of the network logon provider registry. Adversaries may register a rogue network logon provider module for persistence and/or credential access via intercepting the authentication credentials in clear text during user logon.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Authorized third party network logon providers."],"from":"now-9m","rule_id":"41f2ecd2-d517-4a4f-9d7e-2f851df407f9","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1556/","name":"Modify Authentication Process","id":"T1556"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1543/","name":"Create or Modify System Process","id":"T1543"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://github.com/gtworek/PSBits/tree/master/PasswordStealing/NPPSpy","https://docs.microsoft.com/en-us/windows/win32/api/npapi/nf-npapi-nplogonnotify"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","endgame-*"],"query":"registry where registry.data.strings != null and\n registry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\NetworkProvider\\\\ProviderPath\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\NetworkProvider\\\\ProviderPath\"\n ) and\n /* Excluding default NetworkProviders RDPNP, LanmanWorkstation and webclient. */\n not ( user.id : \"S-1-5-18\" and\n       registry.data.strings in\n                (\"%SystemRoot%\\\\System32\\\\ntlanman.dll\",\n                 \"%SystemRoot%\\\\System32\\\\drprov.dll\",\n                 \"%SystemRoot%\\\\System32\\\\davclnt.dll\")\n      )\n","throttle":"no_actions","actions":[]}
{"id":"4d57e050-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.039Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.318Z","created_by":"chaykovskiyv","name":"PowerShell Suspicious Payload Encoded and Compressed [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","PowerShell"],"interval":"5m","enabled":true,"description":"Identifies the use of .NET functionality for decompression and base64 decoding combined in PowerShell scripts, which malware and security tools heavily use to deobfuscate payloads and load them directly in memory to bypass defenses.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating PowerShell Suspicious Payload Encoded and Compressed\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can embed compressed and encoded payloads in scripts to load directly into the memory without touching the disk. This strategy can circumvent string and file-based security protections.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately outside engineering or IT business units. As long as the analyst did not identify malware or suspicious activity related to the user or host, this alert can be dismissed.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- Suspicious .NET Reflection via PowerShell - e26f042e-c590-4e82-8e05-41e81bd822ad\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Legitimate PowerShell Scripts which makes use of compression and encoding."],"from":"now-9m","rule_id":"22a0fdde-1900-4c47-baac-bf06f2a0d59c","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1027/","name":"Obfuscated Files or Information","id":"T1027"},{"reference":"https://attack.mitre.org/techniques/T1140/","name":"Deobfuscate/Decode Files or Information","id":"T1140"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and\n  powershell.file.script_block_text : (\n    (\n      \"System.IO.Compression.DeflateStream\" or\n      \"System.IO.Compression.GzipStream\" or\n      \"IO.Compression.DeflateStream\" or\n      \"IO.Compression.GzipStream\"\n    ) and\n    FromBase64String\n  ) and not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"52add7d0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.276Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.216Z","created_by":"chaykovskiyv","name":"Process Created with an Elevated Token [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Identifies the creation of a process running as SYSTEM and impersonating a Windows core binary privileges. Adversaries may create a new process with a different token to escalate privileges and bypass access controls.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"cc9ccd2f-e03c-4113-9f8c-fc1be43a49c4","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1134/","name":"Access Token Manipulation","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1134/002/","name":"Create Process with Token","id":"T1134.002"}],"id":"T1134"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://lengjibo.github.io/token/","https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createprocesswithtokenw"],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"/* This rule is only compatible with Elastic Endpoint 8.4+ */\n\nprocess where event.action == \"start\" and\n\n /* CreateProcessWithToken and effective parent is a privileged MS native binary used as a target for token theft */\n user.id : \"S-1-5-18\"  and\n\n /* Token Theft target process usually running as service are located in one of the following paths */\n process.Ext.effective_parent.executable :\n                (\"?:\\\\Windows\\\\*.exe\",\n                 \"?:\\\\Program Files\\\\*.exe\",\n                 \"?:\\\\Program Files (x86)\\\\*.exe\",\n                 \"?:\\\\ProgramData\\\\*\") and\n\n not (process.Ext.effective_parent.executable : \"?:\\\\Windows\\\\System32\\\\Utilman.exe\" and\n      process.parent.executable : \"?:\\\\Windows\\\\System32\\\\Utilman.exe\" and process.parent.args : \"/debug\") and\n\n not process.executable : (\"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n                           \"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\WerFaultSecure.exe\",\n                           \"?:\\\\windows\\\\system32\\\\WerMgr.exe\",\n                           \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\Install\\\\securityhealthsetup.exe\")  and\n\n not process.parent.executable : (\"?:\\\\Windows\\\\System32\\\\AtBroker.exe\", \"?:\\\\Windows\\\\system32\\\\svchost.exe\", \"?:\\\\Program Files (x86)\\\\*.exe\", \"?:\\\\Program Files\\\\*.exe\", \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n \"C:\\\\Windows\\\\System32\\\\DriverStore\\\\*\") and\n\n\n not (process.code_signature.trusted == true and\n      process.code_signature.subject_name in (\"philandro Software GmbH\", \"Freedom Scientific Inc.\", \"TeamViewer Germany GmbH\", \"Projector.is, Inc.\", \"TeamViewer GmbH\", \"Cisco WebEx LLC\", \"Dell Inc\"))\n","throttle":"no_actions","actions":[]}
{"id":"50dff5a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.057Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.213Z","created_by":"chaykovskiyv","name":"Execution of COM object via Xwizard [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Windows Component Object Model (COM) is an inter-process communication (IPC) component of the native Windows application programming interface (API) that enables interaction between software objects or executable code. Xwizard can be used to run a COM object created in registry to evade defensive counter measures.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"5cdc1648-6f4d-489c-ac5d-9a453301ab40","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1559/","name":"Inter-Process Communication","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1559/001/","name":"Component Object Model","id":"T1559.001"}],"id":"T1559"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://lolbas-project.github.io/lolbas/Binaries/Xwizard/","http://www.hexacorn.com/blog/2017/07/31/the-wizard-of-x-oppa-plugx-style/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n process.pe.original_file_name : \"xwizard.exe\" and\n (\n   (process.args : \"RunWizard\" and process.args : \"{*}\") or\n   (process.executable != null and\n     not process.executable : (\"C:\\\\Windows\\\\SysWOW64\\\\xwizard.exe\", \"C:\\\\Windows\\\\System32\\\\xwizard.exe\")\n   )\n )\n","throttle":"no_actions","actions":[]}
{"id":"944dec20-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.763Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.287Z","created_by":"chaykovskiyv","name":"User account exposed to Kerberoasting [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Active Directory","Investigation Guide"],"interval":"5m","enabled":true,"description":"Detects when a user account has the servicePrincipalName attribute modified. Attackers can abuse write privileges over a user to configure Service Principle Names (SPNs) so that they can perform Kerberoasting. Administrators can also configure this for legitimate purposes, exposing the account to Kerberoasting.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating User account exposed to Kerberoasting\n\nService Principal Names (SPNs) are names by which Kerberos clients uniquely identify service instances for Kerberos target computers.\n\nBy default, only computer accounts have SPNs, which creates no significant risk, since machine accounts have a default domain policy that rotates their passwords every 30 days, and the password is composed of 120 random characters, making them invulnerable to Kerberoasting.\n\nA user account with an SPN assigned is considered a service account, and is accessible to the entire domain. If any user in the directory requests a ticket-granting service (TGS), the domain controller will encrypt it with the secret key of the account executing the service. An attacker can potentially perform a Kerberoasting attack with this information, as the human-defined password is likely to be less complex.\n\nFor scenarios where SPNs cannot be avoided on user accounts, Microsoft provides the Group Managed Service Accounts (gMSA) feature, which ensures that account passwords are robust and changed regularly and automatically. More information can be found [here](https://docs.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview).\n\nAttackers can also perform \"Targeted Kerberoasting\", which consists of adding fake SPNs to user accounts that they have write privileges to, making them potentially vulnerable to Kerberoasting.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate if the target account is a member of privileged groups (Domain Admins, Enterprise Admins, etc.).\n- Investigate if tickets have been requested for the target account.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- The use of user accounts as service accounts is a bad security practice and should not be allowed in the domain. The security team should map and monitor any potential benign true positive (B-TP), especially if the account is privileged. Domain Administrators that define this kind of setting can put the domain at risk as user accounts don't have the same security standards as computer accounts (which have long, complex, random passwords that change frequently), exposing them to credential cracking attacks (Kerberoasting, brute force, etc.).\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services. Prioritize privileged accounts.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"3d263d56-2b6a-4d17-9aad-2268880bedab","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1558/","name":"Steal or Forge Kerberos Tickets","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1558/003/","name":"Kerberoasting","id":"T1558.003"}],"id":"T1558"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://www.thehacker.recipes/ad/movement/access-controls/targeted-kerberoasting","https://www.qomplx.com/qomplx-knowledge-kerberoasting-attacks-explained/","https://www.thehacker.recipes/ad/movement/kerberos/kerberoast","https://attack.stealthbits.com/cracking-kerberos-tgs-tickets-using-kerberoasting","https://adsecurity.org/?p=280","https://github.com/OTRF/Set-AuditRule"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.action:\"Directory Service Changes\" and event.code:5136 and winlog.event_data.ObjectClass:\"user\"\nand winlog.event_data.AttributeLDAPDisplayName:\"servicePrincipalName\"\n","throttle":"no_actions","actions":[]}
{"id":"50e46270-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.256Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.268Z","created_by":"chaykovskiyv","name":"Suspicious LSASS Access via MalSecLogon [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Sysmon Only"],"interval":"5m","enabled":true,"description":"Identifies suspicious access to LSASS handle from a call trace pointing to seclogon.dll and with a suspicious access rights value. This may indicate an attempt to leak an LSASS handle via abusing the Secondary Logon service in preparation for credential access.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"7ca6490e-d3ab-48d6-ae5b-171a350dd68e","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/001/","name":"LSASS Memory","id":"T1003.001"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://splintercod3.blogspot.com/p/the-hidden-side-of-seclogon-part-3.html"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-windows.*"],"query":"process where event.code == \"10\" and\n  winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\" and\n\n   /* seclogon service accessing lsass */\n  winlog.event_data.CallTrace : \"*seclogon.dll*\" and process.name : \"svchost.exe\" and\n\n   /* PROCESS_CREATE_PROCESS & PROCESS_DUP_HANDLE & PROCESS_QUERY_INFORMATION */\n  winlog.event_data.GrantedAccess == \"0x14c0\"\n","throttle":"no_actions","actions":[]}
{"id":"52b13331-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.307Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.263Z","created_by":"chaykovskiyv","name":"Windows Subsystem for Linux Distribution Installed [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Detects changes to the registry that indicates the install of a new Windows Subsystem for Linux distribution by name. Adversaries may enable and use WSL for Linux to avoid detection.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timeline_id":"3e47ef71-ebfc-4520-975c-cb27fc090799","timeline_title":"Comprehensive Registry Timeline","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"0c8fc41b-1d17-4149-9064-42bebd65c275","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1112/","name":"Modify Registry","id":"T1112"},{"reference":"https://attack.mitre.org/techniques/T1202/","name":"Indirect Command Execution","id":"T1202"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://learn.microsoft.com/en-us/windows/wsl/wsl-config"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"registry where\n registry.path : \n       (\"HK*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Lxss\\\\*\\\\PackageFamilyName\",\n        \"\\\\REGISTRY\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Lxss\\\\*\\\\PackageFamilyName\")\n","throttle":"no_actions","actions":[]}
{"id":"4f2bdd00-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.152Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.383Z","created_by":"chaykovskiyv","name":"Web Shell Detection: Script Process Child of Common Web Processes [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies suspicious commands executed via a web server, which may suggest a vulnerability and remote shell access.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Web Shell Detection: Script Process Child of Common Web Processes\n\nAdversaries may backdoor web servers with web shells to establish persistent access to systems. A web shell is a web script that is placed on an openly accessible web server to allow an adversary to use the web server as a gateway into a network. A web shell may provide a set of functions to execute or a command-line interface on the system that hosts the web server.\n\nThis rule detects a web server process spawning script and command-line interface programs, potentially indicating attackers executing commands using the web shell.\n\n#### Possible investigation steps\n\n- Investigate abnormal behaviors observed by the subject process such as network connections, registry or file modifications, and any other spawned child processes.\n- Examine the command line to determine which commands or scripts were executed.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Security audits, maintenance, and network administrative scripts may trigger this alert when run under web processes."],"from":"now-9m","rule_id":"29e2c233-948b-4427-982f-50420f2873cb","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1505/","name":"Server Software Component","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1505/003/","name":"Web Shell","id":"T1505.003"}],"id":"T1505"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1190/","name":"Exploit Public-Facing Application","id":"T1190"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":["https://www.microsoft.com/security/blog/2020/02/04/ghost-in-the-shell-investigating-web-shell-attacks/","https://www.elastic.co/security-labs/elastic-response-to-the-the-spring4shell-vulnerability-cve-2022-22965","https://www.elastic.co/security-labs/hunting-for-persistence-using-elastic-security-part-1"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  process.parent.name : (\"w3wp.exe\", \"httpd.exe\", \"nginx.exe\", \"php.exe\", \"php-cgi.exe\", \"tomcat.exe\") and\n  process.name : (\"cmd.exe\", \"cscript.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"wmic.exe\", \"wscript.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"50df5960-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.055Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.211Z","created_by":"chaykovskiyv","name":"Enumeration Command Spawned via WMIPrvSE [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies native Windows host and network enumeration commands spawned by the Windows Management Instrumentation Provider Service (WMIPrvSE).","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"06b7b3b7-1c65-4c10-9c89-2cc688be10b2","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1047/","name":"Windows Management Instrumentation","id":"T1047"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1018/","name":"Remote System Discovery","id":"T1018"},{"reference":"https://attack.mitre.org/techniques/T1087/","name":"Account Discovery","id":"T1087"},{"reference":"https://attack.mitre.org/techniques/T1518/","name":"Software Discovery","id":"T1518"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.name:\n  (\n    \"arp.exe\",\n    \"dsquery.exe\",\n    \"dsget.exe\",\n    \"gpresult.exe\",\n    \"hostname.exe\",\n    \"ipconfig.exe\",\n    \"nbtstat.exe\",\n    \"net.exe\",\n    \"net1.exe\",\n    \"netsh.exe\",\n    \"netstat.exe\",\n    \"nltest.exe\",\n    \"ping.exe\",\n    \"qprocess.exe\",\n    \"quser.exe\",\n    \"qwinsta.exe\",\n    \"reg.exe\",\n    \"sc.exe\",\n    \"systeminfo.exe\",\n    \"tasklist.exe\",\n    \"tracert.exe\",\n    \"whoami.exe\"\n  ) and\n  process.parent.name:\"wmiprvse.exe\"\n","throttle":"no_actions","actions":[]}
{"id":"fb6e2250-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.271Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.727Z","created_by":"burzhynskyyy","name":"Microsoft 365 Exchange Safe Link Policy Disabled [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Identity and Access"],"interval":"5m","enabled":true,"description":"Identifies when a Safe Link policy is disabled in Microsoft 365. Safe Link policies for Office applications extend phishing protection to documents that contain hyperlinks, even after they have been delivered to a user.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Disabling safe links may be done by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."],"from":"now-30m","rule_id":"1c6d4e7d-8be9-4959-9b11-af93da8ea8c4","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1566/","name":"Phishing","id":"T1566"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":["https://docs.microsoft.com/en-us/powershell/module/exchange/disable-safelinksrule?view=exchange-ps","https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/atp-safe-links?view=o365-worldwide"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"Disable-SafeLinksRule\" and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"483bbd80-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.158Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.705Z","created_by":"chaykovskiyv","name":"Startup Folder Persistence via Unsigned Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies files written or modified in the startup folder by unsigned processes. Adversaries may abuse this technique to maintain persistence in an environment.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Startup Folder Persistence via Unsigned Process\n\nThe Windows Startup folder is a special folder in Windows. Programs added to this folder are executed during account logon, without user interaction, providing an excellent way for attackers to maintain persistence.\n\nThis rule looks for unsigned processes writing to the Startup folder locations.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- There is a high possibility of benign legitimate programs being added to Startup folders. This activity could be based on new software installations, patches, or any kind of network administrator related activity. Before undertaking further investigation, verify that this activity is not benign.\n\n### Related rules\n\n- Suspicious Startup Shell Folder Modification - c8b150f0-0164-475b-a75e-74b47800a9ff\n- Persistent Scripts in the Startup Directory - f7c4dc5a-a58d-491d-9f14-9b66507121c0\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"ee1d7204-dd9c-4770-a9e3-9e7f12ac5413","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1547/001/","name":"Registry Run Keys / Startup Folder","id":"T1547.001"}],"id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"sequence by host.id, process.entity_id with maxspan=5s\n  [process where event.type == \"start\" and process.code_signature.trusted == false and\n  /* suspicious paths can be added here  */\n   process.executable : (\"C:\\\\Users\\\\*.exe\",\n                         \"C:\\\\ProgramData\\\\*.exe\",\n                         \"C:\\\\Windows\\\\Temp\\\\*.exe\",\n                         \"C:\\\\Windows\\\\Tasks\\\\*.exe\",\n                         \"C:\\\\Intel\\\\*.exe\",\n                         \"C:\\\\PerfLogs\\\\*.exe\")\n   ]\n   [file where event.type != \"deletion\" and user.domain != \"NT AUTHORITY\" and\n    file.path : (\"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\",\n                 \"C:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\StartUp\\\\*\")\n   ]\n","throttle":"no_actions","actions":[]}
{"id":"4f22dc50-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.187Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.334Z","created_by":"chaykovskiyv","name":"PowerShell Script Block Logging Disabled [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies attempts to disable PowerShell Script Block Logging via registry modification. Attackers may disable this logging to conceal their activities in the host and evade detection.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating PowerShell Script Block Logging Disabled\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks, making it available in various environments and creating an attractive way for attackers to execute code.\n\nPowerShell Script Block Logging is a feature of PowerShell that records the content of all script blocks that it processes, giving defenders visibility of PowerShell scripts and sequences of executed commands.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check whether it makes sense for the user to use PowerShell to complete tasks.\n- Investigate if PowerShell scripts were run after logging was disabled.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- PowerShell Suspicious Discovery Related Windows API Functions - 61ac3638-40a3-44b2-855a-985636ca985e\n- PowerShell Keylogging Script - bd2c86a0-8b61-4457-ab38-96943984e889\n- PowerShell Suspicious Script with Audio Capture Capabilities - 2f2f4939-0b34-40c2-a0a3-844eb7889f43\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- Suspicious .NET Reflection via PowerShell - e26f042e-c590-4e82-8e05-41e81bd822ad\n- PowerShell Suspicious Payload Encoded and Compressed - 81fe9dc6-a2d7-4192-a2d8-eed98afc766a\n- PowerShell Suspicious Script with Screenshot Capabilities - 959a7353-1129-4aa7-9084-30746b256a70\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"f67e33fe-8bb8-413e-8cb4-cacbcb505e29","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/002/","name":"Disable Windows Event Logging","id":"T1562.002"}],"id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://admx.help/?Category=Windows_10_2016&Policy=Microsoft.Policies.PowerShell::EnableScriptBlockLogging"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"registry where event.type == \"change\" and\n    registry.path : (\n        \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\PowerShell\\\\ScriptBlockLogging\\\\EnableScriptBlockLogging\",\n        \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\PowerShell\\\\ScriptBlockLogging\\\\EnableScriptBlockLogging\"\n    ) and registry.data.strings : (\"0\", \"0x00000000\")\n","throttle":"no_actions","actions":[]}
{"id":"4836db80-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.185Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.678Z","created_by":"chaykovskiyv","name":"NTDS or SAM Database File Copied [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies a copy operation of the Active Directory Domain Database (ntds.dit) or Security Account Manager (SAM) files. Those files contain sensitive information including hashed domain and/or local credentials.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic","Austin Songer"],"false_positives":[],"from":"now-9m","rule_id":"7a26ede7-e996-42f8-b57e-85750b15819d","max_signals":33,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/002/","name":"Security Account Manager","id":"T1003.002"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://thedfirreport.com/2020/11/23/pysa-mespinoza-ransomware/","https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1003.002/T1003.002.md#atomic-test-3---esentutlexe-sam-copy","https://www.elastic.co/security-labs/detect-credential-access"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  (\n    (process.pe.original_file_name in (\"Cmd.Exe\", \"PowerShell.EXE\", \"XCOPY.EXE\") and\n       process.args : (\"copy\", \"xcopy\", \"Copy-Item\", \"move\", \"cp\", \"mv\")\n    ) or\n    (process.pe.original_file_name : \"esentutl.exe\" and process.args : (\"*/y*\", \"*/vss*\", \"*/d*\"))\n  ) and\n  process.args : (\"*\\\\ntds.dit\", \"*\\\\config\\\\SAM\", \"\\\\*\\\\GLOBALROOT\\\\Device\\\\HarddiskVolumeShadowCopy*\\\\*\", \"*/system32/config/SAM*\")\n","throttle":"no_actions","actions":[]}
{"id":"fb3a8f30-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.283Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.662Z","created_by":"burzhynskyyy","name":"Microsoft 365 Exchange Malware Filter Policy Deletion [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Configuration Audit"],"interval":"5m","enabled":true,"description":"Identifies when a malware filter policy has been deleted in Microsoft 365. A malware filter policy is used to alert administrators that an internal user sent a message that contained malware. This may indicate an account or machine compromise that would need to be investigated. Deletion of a malware filter policy may be done to evade detection.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["A malware filter policy may be deleted by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."],"from":"now-30m","rule_id":"a02ad4ed-f77d-4684-a944-2917af1c5e51","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://docs.microsoft.com/en-us/powershell/module/exchange/remove-malwarefilterpolicy?view=exchange-ps"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"Remove-MalwareFilterPolicy\" and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"4b6c6400-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.598Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.075Z","created_by":"chaykovskiyv","name":"Mshta Making Network Connections [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Identifies Mshta.exe making outbound network connections. This may indicate adversarial activity, as Mshta is often leveraged by adversaries to execute malicious scripts and evade detection.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-20m","rule_id":"738065f9-2178-4ef6-bb83-ddc6a1fdc38a","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1218/","name":"System Binary Proxy Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1218/005/","name":"Mshta","id":"T1218.005"}],"id":"T1218"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"sequence by process.entity_id with maxspan=10m\n  [process where event.type == \"start\" and process.name : \"mshta.exe\" and\n     not process.parent.name : \"Microsoft.ConfigurationManagement.exe\" and\n     not (process.parent.executable : \"C:\\\\Amazon\\\\Amazon Assistant\\\\amazonAssistantService.exe\" or\n          process.parent.executable : \"C:\\\\TeamViewer\\\\TeamViewer.exe\") and\n     not process.args : \"ADSelfService_Enroll.hta\"]\n  [network where process.name : \"mshta.exe\"]\n","throttle":"no_actions","actions":[]}
{"id":"484189e0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.187Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.774Z","created_by":"chaykovskiyv","name":"Enumeration of Administrator Accounts [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies instances of lower privilege accounts enumerating Administrator accounts or groups using built-in Windows tools.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Enumeration of Administrator Accounts\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `net` and `wmic` utilities to enumerate administrator-related users or groups in the domain and local machine scope. Attackers can use this information to plan their next steps of the attack, such as mapping targets for credential compromise and other post-exploitation activities.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Related rules\n\n- AdFind Command Activity - eda499b8-a073-4e35-9733-22ec71f57f3a\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"48b267b8-ad33-452b-9404-56280949c4e0","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1069/","name":"Permission Groups Discovery","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1069/001/","name":"Local Groups","id":"T1069.001"},{"reference":"https://attack.mitre.org/techniques/T1069/002/","name":"Domain Groups","id":"T1069.002"}],"id":"T1069"},{"reference":"https://attack.mitre.org/techniques/T1087/","name":"Account Discovery","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1087/001/","name":"Local Account","id":"T1087.001"},{"reference":"https://attack.mitre.org/techniques/T1087/002/","name":"Domain Account","id":"T1087.002"}],"id":"T1087"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}}],"to":"now","references":[],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n(\n  (((process.name : \"net.exe\" or process.pe.original_file_name == \"net.exe\") or\n    ((process.name : \"net1.exe\" or process.pe.original_file_name == \"net1.exe\") and\n        not process.parent.name : \"net.exe\")) and\n   process.args : (\"group\", \"user\", \"localgroup\") and\n   process.args : (\"*admin*\", \"Domain Admins\", \"Remote Desktop Users\", \"Enterprise Admins\", \"Organization Management\") and\n   not process.args : \"/add\")\n\n   or\n\n  ((process.name : \"wmic.exe\" or process.pe.original_file_name == \"wmic.exe\") and\n     process.args : (\"group\", \"useraccount\"))\n)\n","throttle":"no_actions","actions":[]}
{"id":"944d28d0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.767Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.293Z","created_by":"chaykovskiyv","name":"Kerberos Pre-authentication Disabled for User [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Investigation Guide","Active Directory"],"interval":"5m","enabled":true,"description":"Identifies the modification of an account's Kerberos pre-authentication options. An adversary with GenericWrite/GenericAll rights over the account can maliciously modify these settings to perform offline password cracking attacks such as AS-REP roasting.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Kerberos Pre-authentication Disabled for User\n\nKerberos pre-authentication is an account protection against offline password cracking. When enabled, a user requesting access to a resource initiates communication with the Domain Controller (DC) by sending an Authentication Server Request (AS-REQ) message with a timestamp that is encrypted with the hash of their password. If and only if the DC is able to successfully decrypt the timestamp with the hash of the user’s password, it will then send an Authentication Server Response (AS-REP) message that contains the Ticket Granting Ticket (TGT) to the user. Part of the AS-REP message is signed with the user’s password. Microsoft's security monitoring [recommendations](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4738) state that `'Don't Require Preauth' – Enabled` should not be enabled for user accounts because it weakens security for the account’s Kerberos authentication.\n\nAS-REP roasting is an attack against Kerberos for user accounts that do not require pre-authentication, which means that if the target user has pre-authentication disabled, an attacker can request authentication data for it and get a TGT that can be brute-forced offline, similarly to Kerberoasting.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Determine if the target account is sensitive or privileged.\n- Inspect the account activities for suspicious or abnormal behaviors in the alert timeframe.\n\n### False positive analysis\n\n- Disabling pre-authentication is a bad security practice and should not be allowed in the domain. The security team should map and monitor any potential benign true positives (B-TPs), especially if the target account is privileged.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Reset the target account's password if there is any risk of TGTs having been retrieved.\n- Re-enable the preauthentication option or disable the target account.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"1b5ed3a1-2e61-4a4d-8b26-8e781f4a08f8","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1558/","name":"Steal or Forge Kerberos Tickets","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1558/004/","name":"AS-REP Roasting","id":"T1558.004"}],"id":"T1558"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://harmj0y.medium.com/roasting-as-reps-e6179a65216b","https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4738","https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0026_windows_audit_user_account_management.md"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.code:4738 and message:\"'Don't Require Preauth' - Enabled\"\n","throttle":"no_actions","actions":[]}
{"id":"50e21880-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.103Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.238Z","created_by":"chaykovskiyv","name":"NullSessionPipe Registry Modification [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies NullSessionPipe registry modifications that specify which pipes can be accessed anonymously. This could be indicative of adversary lateral movement preparation by making the added pipe available to everyone.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"e74a37ae-547b-40c6-a1f5-44bf1a1eb094","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1021/002/","name":"SMB/Windows Admin Shares","id":"T1021.002"}],"id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":["https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/","https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-access-restrict-anonymous-access-to-named-pipes-and-shares"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"registry where event.type in (\"creation\", \"change\") and\nregistry.path : \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\services\\\\LanmanServer\\\\Parameters\\\\NullSessionPipes\" and\nlength(registry.data.strings) > 0\n","throttle":"no_actions","actions":[]}
{"id":"49b676a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.542Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.219Z","created_by":"chaykovskiyv","name":"Creation or Modification of a new GPO Scheduled Task or Service [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Detects the creation or modification of a new Group Policy based scheduled task or service. These methods are used for legitimate system administration, but can also be abused by an attacker with domain admin permissions to execute a malicious payload remotely on all or a subset of the domain joined machines.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"7f53a1a6-d82c-4608-af1e-bb39e89f6065","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1053/","name":"Scheduled Task/Job","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1053/005/","name":"Scheduled Task","id":"T1053.005"}],"id":"T1053"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"file where event.type != \"deletion\" and\n  file.path : (\"?:\\\\Windows\\\\SYSVOL\\\\domain\\\\Policies\\\\*\\\\MACHINE\\\\Preferences\\\\ScheduledTasks\\\\ScheduledTasks.xml\",\n               \"?:\\\\Windows\\\\SYSVOL\\\\domain\\\\Policies\\\\*\\\\MACHINE\\\\Preferences\\\\Services\\\\Services.xml\") and\n  not process.name : \"dfsrs.exe\"\n","throttle":"no_actions","actions":[]}
{"id":"944e6150-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.777Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.319Z","created_by":"chaykovskiyv","name":"User Added to Privileged Group [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Investigation Guide","Active Directory"],"interval":"5m","enabled":true,"description":"Identifies a user being added to a privileged group in Active Directory. Privileged accounts and groups in Active Directory are those to which powerful rights, privileges, and permissions are granted that allow them to perform nearly any action in Active Directory and on domain-joined systems.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating User Added to Privileged Group in Active Directory\n\nPrivileged accounts and groups in Active Directory are those to which powerful rights, privileges, and permissions are granted that allow them to perform nearly any action in Active Directory and on domain-joined systems.\n\nAttackers can add users to privileged groups to maintain a level of access if their other privileged accounts are uncovered by the security team. This allows them to keep operating after the security team discovers abused accounts.\n\nThis rule monitors events related to a user being added to a privileged group.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should manage members of this group.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- This attack abuses a legitimate Active Directory mechanism, so it is important to determine whether the activity is legitimate, if the administrator is authorized to perform this operation, and if there is a need to grant the account this level of privilege.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the admin is not aware of the operation, activate your Active Directory incident response plan.\n- If the user does not need the administrator privileges, remove the account from the privileged group.\n- Review the privileges of the administrator account that performed the action.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic","Skoetting"],"false_positives":[],"from":"now-9m","rule_id":"b0223179-34e7-407d-a32a-ddc256822cc6","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1098/","name":"Account Manipulation","id":"T1098"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-b--privileged-accounts-and-groups-in-active-directory"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"iam where event.action == \"added-member-to-group\" and\n  group.name : (\"Admin*\",\n                \"Local Administrators\",\n                \"Domain Admins\",\n                \"Enterprise Admins\",\n                \"Backup Admins\",\n                \"Schema Admins\",\n                \"DnsAdmins\",\n                \"Exchange Organization Administrators\")\n","throttle":"no_actions","actions":[]}
{"id":"47bc0630-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.157Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:05.850Z","created_by":"chaykovskiyv","name":"Scheduled Tasks AT Command Enabled [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies attempts to enable the Windows scheduled tasks AT command via the registry. Attackers may use this method to move laterally or persist locally. The AT command has been deprecated since Windows 8 and Windows Server 2012, but still exists for backwards compatibility.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"2770f5ad-97ac-4fa0-be6c-e374581c42c6","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/001/","name":"Disable or Modify Tools","id":"T1562.001"}],"id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-scheduledjob"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"registry where\n  registry.path : (\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\Configuration\\\\EnableAt\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\Configuration\\\\EnableAt\"\n  ) and registry.data.strings : (\"1\", \"0x00000001\")\n","throttle":"no_actions","actions":[]}
{"id":"4f20e080-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.180Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.323Z","created_by":"chaykovskiyv","name":"MS Office Macro Security Registry Modifications [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Microsoft Office Products offer options for users and developers to control the security settings for running and using Macros. Adversaries may abuse these security settings to modify the default behavior of the Office Application to trust future macros and/or disable security warnings, which could increase their chances of establishing persistence.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating MS Office Macro Security Registry Modifications\n\nMacros are small programs that are used to automate repetitive tasks in Microsoft Office applications. Historically, macros have been used for a variety of reasons -- from automating part of a job, to building entire processes and data flows. Macros are written in Visual Basic for Applications (VBA) and are saved as part of Microsoft Office files.\n\nMacros are often created for legitimate reasons, but they can also be written by attackers to gain access, harm a system, or bypass other security controls such as application allow listing. In fact, exploitation from malicious macros is one of the top ways that organizations are compromised today. These attacks are often conducted through phishing or spear phishing campaigns.\n\nAttackers can convince victims to modify Microsoft Office security settings, so their macros are trusted by default and no warnings are displayed when they are executed. These settings include:\n\n- *Trust access to the VBA project object model* - When enabled, Microsoft Office will trust all macros and run any code without showing a security warning or requiring user permission.\n- *VbaWarnings* - When set to 1, Microsoft Office will trust all macros and run any code without showing a security warning or requiring user permission.\n\nThis rule looks for registry changes affecting the conditions above.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the user and check if the change was done manually.\n- Verify whether malicious macros were executed after the registry change.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve recently executed Office documents and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity should not happen legitimately. The security team should address any potential benign true positive (B-TP), as this configuration can put the user and the domain at risk.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Reset the registry key value.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Explore using GPOs to manage security settings for Microsoft Office macros.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"0c1d6fa1-a128-4a34-ad25-03f18b211d88","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1112/","name":"Modify Registry","id":"T1112"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1204/","name":"User Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1204/002/","name":"Malicious File","id":"T1204.002"}],"id":"T1204"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-windows.*","endgame-*"],"query":"registry where event.type == \"change\" and\n    registry.path : (\n        \"HKU\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"HKU\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\",\n        \"HKU\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"HKU\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\",\n        \"\\\\REGISTRY\\\\USER\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"\\\\REGISTRY\\\\USER\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\",\n        \"\\\\REGISTRY\\\\USER\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"\\\\REGISTRY\\\\USER\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\"\n        ) and\n    registry.data.strings : (\"0x00000001\", \"1\") and\n    process.name : (\"cscript.exe\", \"wscript.exe\", \"mshta.exe\", \"mshta.exe\", \"winword.exe\", \"excel.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"4d52b030-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.201Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.261Z","created_by":"chaykovskiyv","name":"Microsoft Build Engine Started by a System Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"An instance of MSBuild, the Microsoft Build Engine, was started by Explorer or the WMI (Windows Management Instrumentation) subsystem. This behavior is unusual and is sometimes used by malicious payloads.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."],"from":"now-9m","rule_id":"af5ae0ff-4a0c-443a-9f4d-ff0825fa2f22","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1127/","name":"Trusted Developer Utilities Proxy Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1127/001/","name":"MSBuild","id":"T1127.001"}],"id":"T1127"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}},{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.name : \"MSBuild.exe\" and\n  process.parent.name : (\"explorer.exe\", \"wmiprvse.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"4f2b8ee0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.149Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.379Z","created_by":"chaykovskiyv","name":"Windows Defender Exclusions Added via PowerShell [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies modifications to the Windows Defender configuration settings using PowerShell to add exclusions at the folder directory or process level.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Windows Defender Exclusions Added via PowerShell\n\nMicrosoft Windows Defender is an antivirus product built into Microsoft Windows. Since this software product is used to prevent and stop malware, it's important to monitor what specific exclusions are made to the product's configuration settings. These can often be signs of an adversary or malware trying to bypass Windows Defender's capabilities. One of the more notable [examples](https://www.cyberbit.com/blog/endpoint-security/latest-trickbot-variant-has-new-tricks-up-its-sleeve/) was observed in 2018 where Trickbot incorporated mechanisms to disable Windows Defender to avoid detection.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Examine the exclusion in order to determine the intent behind it.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- If the exclusion specifies a suspicious file or path, retrieve the file(s) and determine if malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This rule has a high chance to produce false positives due to how often network administrators legitimately configure exclusions. In order to validate the activity further, review the specific exclusion and its intent. There are many legitimate reasons for exclusions, so it's important to gain context.\n\n### Related rules\n\n- Windows Defender Disabled via Registry Modification - 2ffa1f1e-b6db-47fa-994b-1512743847eb\n- Disabling Windows Defender Security Settings via PowerShell - c8cccb06-faf2-4cd5-886e-2c9636cfcb87\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Exclusion lists for antimalware capabilities should always be routinely monitored for review.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"d1da8a8f-9b7a-46b2-b4f8-4a943fecc0d7","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/001/","name":"Disable or Modify Tools","id":"T1562.001"},{"reference":"https://attack.mitre.org/techniques/T1562/006/","name":"Indicator Blocking","id":"T1562.006"}],"id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://www.bitdefender.com/files/News/CaseStudies/study/400/Bitdefender-PR-Whitepaper-MosaicLoader-creat5540-en-EN.pdf"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n (process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")) and\n  process.args : (\"*Add-MpPreference*\", \"*Set-MpPreference*\") and\n  process.args : (\"*-Exclusion*\")\n","throttle":"no_actions","actions":[]}
{"id":"50e12e20-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.069Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.229Z","created_by":"chaykovskiyv","name":"Microsoft Exchange Worker Spawning Suspicious Processes [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Initial Access"],"interval":"5m","enabled":true,"description":"Identifies suspicious processes being spawned by the Microsoft Exchange Server worker process (w3wp). This activity may indicate exploitation activity or access to an existing web shell backdoor.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"f3a5f6f3-0578-47b3-b046-3c2a349a2ae3","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1190/","name":"Exploit Public-Facing Application","id":"T1190"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":["https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers","https://www.volexity.com/blog/2021/03/02/active-exploitation-of-microsoft-exchange-zero-day-vulnerabilities","https://discuss.elastic.co/t/detection-and-response-for-hafnium-activity/266289"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  process.parent.name : \"w3wp.exe\" and process.parent.args : \"MSExchange*AppPool\" and\n  (process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n  process.pe.original_file_name in (\"cmd.exe\", \"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\"))\n","throttle":"no_actions","actions":[]}
{"id":"49af71c0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.164Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.137Z","created_by":"chaykovskiyv","name":"Suspicious Explorer Child Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Initial Access"],"interval":"5m","enabled":true,"description":"Identifies a suspicious Windows explorer child process. Explorer.exe can be abused to launch malicious scripts or executables from a trusted parent process.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"5d5f769e-43af-42ae-aa13-72e30edc0b81","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1566/","name":"Phishing","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1566/001/","name":"Spearphishing Attachment","id":"T1566.001"},{"reference":"https://attack.mitre.org/techniques/T1566/002/","name":"Spearphishing Link","id":"T1566.002"}],"id":"T1566"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  (\n   process.name : (\"cscript.exe\", \"wscript.exe\", \"powershell.exe\", \"rundll32.exe\", \"cmd.exe\", \"mshta.exe\", \"regsvr32.exe\") or\n   process.pe.original_file_name in (\"cscript.exe\", \"wscript.exe\", \"PowerShell.EXE\", \"RUNDLL32.EXE\", \"Cmd.Exe\", \"MSHTA.EXE\", \"REGSVR32.EXE\")\n  ) and\n  /* Explorer started via DCOM */\n  process.parent.name : \"explorer.exe\" and process.parent.args : \"-Embedding\" and\n  not process.parent.args:\n          (\n            /* Noisy CLSID_SeparateSingleProcessExplorerHost Explorer COM Class IDs   */\n            \"/factory,{5BD95610-9434-43C2-886C-57852CC8A120}\",\n            \"/factory,{ceff45ee-c862-41de-aee2-a022c81eda92}\"\n          )\n","throttle":"no_actions","actions":[]}
{"id":"fb79bb10-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.329Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.792Z","created_by":"burzhynskyyy","name":"Microsoft 365 User Restricted from Sending Email [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Configuration Audit"],"interval":"5m","enabled":true,"description":"Identifies when a user has been restricted from sending email due to exceeding sending limits of the service policies per the Security Compliance Center.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Austin Songer"],"false_positives":["A user sending emails using personal distribution folders may trigger the event."],"from":"now-30m","rule_id":"1c8486b8-9bbb-4e4c-bcda-120f7c55c5f2","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1078/","name":"Valid Accounts","id":"T1078"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":["https://docs.microsoft.com/en-us/cloud-app-security/anomaly-detection-policy","https://docs.microsoft.com/en-us/cloud-app-security/policy-template-reference"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.category:web and event.action:\"User restricted from sending email\" and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"50dee430-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.273Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.203Z","created_by":"chaykovskiyv","name":"Modification of WDigest Security Provider [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies attempts to modify the WDigest security provider in the registry to force the user's password to be stored in clear text in memory. This behavior can be indicative of an adversary attempting to weaken the security configuration of an endpoint. Once the UseLogonCredential value is modified, the adversary may attempt to dump clear text passwords from memory.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Modification of WDigest Security Provider\n\nIn Windows XP, Microsoft added support for a protocol known as WDigest. The WDigest protocol allows clients to send cleartext credentials to Hypertext Transfer Protocol (HTTP) and Simple Authentication Security Layer (SASL) applications based on RFC 2617 and 2831. Windows versions up to 8 and 2012 store logon credentials in memory in plaintext by default, which is no longer the case with newer Windows versions.\n\nStill, attackers can force WDigest to store the passwords insecurely on the memory by modifying the `HKLM\\SYSTEM\\*ControlSet*\\Control\\SecurityProviders\\WDigest\\UseLogonCredential` registry key. This activity is commonly related to the execution of credential dumping tools.\n\n#### Possible investigation steps\n\n- It is unlikely that the monitored registry key was modified legitimately in newer versions of Windows. Analysts should treat any activity triggered from this rule with high priority as it typically represents an active adversary.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Determine if credential dumping tools were run on the host, and retrieve and analyze suspicious executables:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Use process name, command line, and file hash to search for occurrences on other hosts.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This modification should not happen legitimately. Any potential benign true positive (B-TP) should be mapped and monitored by the security team, as these modifications expose the entire domain to credential compromises and consequently unauthorized access.\n\n### Related rules\n\n- Mimikatz Powershell Module Activity - ac96ceb8-4399-4191-af1d-4feeac1f1f46\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system and restore compromised files to clean versions.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"066bcbb1-6971-4921-a255-56edc9574983","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/001/","name":"LSASS Memory","id":"T1003.001"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://www.csoonline.com/article/3438824/how-to-detect-and-halt-credential-theft-via-windows-wdigest.html","https://www.praetorian.com/blog/mitigating-mimikatz-wdigest-cleartext-credential-theft?edition=2019","https://frsecure.com/compromised-credentials-response-playbook","https://www.elastic.co/security-labs/detect-credential-access"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"registry where event.type : (\"creation\", \"change\") and\n    registry.path : (\n        \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\SecurityProviders\\\\WDigest\\\\UseLogonCredential\",\n        \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\SecurityProviders\\\\WDigest\\\\UseLogonCredential\"\n    ) and registry.data.strings : (\"1\", \"0x00000001\") and\n    not (process.executable : \"?:\\\\Windows\\\\System32\\\\svchost.exe\" and user.id : \"S-1-5-18\")\n","throttle":"no_actions","actions":[]}
{"id":"52b0be00-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.305Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.253Z","created_by":"chaykovskiyv","name":"PowerShell Suspicious Script with Clipboard Retrieval Capabilities [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Collection","PowerShell"],"interval":"5m","enabled":true,"description":"Detects PowerShell scripts that can get the contents of the clipboard, which attackers can abuse to retrieve sensitive information like credentials, messages, etc.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"a7a1b122-5a16-432c-962d-e28f5fa7c42c","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1115/","name":"Clipboard Data","id":"T1115"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0009/","name":"Collection","id":"TA0009"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-clipboard","https://github.com/EmpireProject/Empire/blob/master/data/module_source/collection/Get-ClipboardContents.ps1"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and\n  (powershell.file.script_block_text : (\n    \"Windows.Clipboard\" or\n    \"Windows.Forms.Clipboard\" or\n    \"Windows.Forms.TextBox\"\n   ) and\n   powershell.file.script_block_text : (\n    \"]::GetText\" or\n    \".Paste()\"\n  )) or powershell.file.script_block_text : \"Get-Clipboard\"\n  and not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"49b39070-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.520Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.188Z","created_by":"chaykovskiyv","name":"Suspicious PowerShell Engine ImageLoad [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the PowerShell engine being invoked by unexpected processes. Rather than executing PowerShell functionality with powershell.exe, some attackers do this to operate more stealthily.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Suspicious PowerShell Engine ImageLoad\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can use PowerShell without having to execute `PowerShell.exe` directly. This technique, often called \"PowerShell without PowerShell,\" works by using the underlying System.Management.Automation namespace and can bypass application allowlisting and PowerShell security features.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate abnormal behaviors observed by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Retrieve the implementation (DLL, executable, etc.) and determine if it is malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell `Get-FileHash` cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity can happen legitimately. Some vendors have their own PowerShell implementations that are shipped with some products. These benign true positives (B-TPs) can be added as exceptions if necessary after analysis.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2, events will not define `event.ingested` and default fallback for EQL rules was not added until 8.2, so you will need to add a custom pipeline to populate `event.ingested` to @timestamp for this rule to work.","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"0383408a-85c8-4a8d-8103-aa3506128c2c","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*","endgame-*"],"query":"any where (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n (dll.name : (\"System.Management.Automation.ni.dll\", \"System.Management.Automation.dll\") or\n  file.name : (\"System.Management.Automation.ni.dll\", \"System.Management.Automation.dll\")) and\n\n/* add false positives relevant to your environment here */\nnot process.executable : (\"C:\\\\Windows\\\\System32\\\\RemoteFXvGPUDisablement.exe\", \"C:\\\\Windows\\\\System32\\\\sdiagnhost.exe\") and\nnot process.executable regex~ \"\"\"C:\\\\Program Files( \\(x86\\))?\\\\*\\.exe\"\"\" and\n  not process.name :\n  (\n    \"Altaro.SubAgent.exe\",\n    \"AppV_Manage.exe\",\n    \"azureadconnect.exe\",\n    \"CcmExec.exe\",\n    \"configsyncrun.exe\",\n    \"choco.exe\",\n    \"ctxappvservice.exe\",\n    \"DVLS.Console.exe\",\n    \"edgetransport.exe\",\n    \"exsetup.exe\",\n    \"forefrontactivedirectoryconnector.exe\",\n    \"InstallUtil.exe\",\n    \"JenkinsOnDesktop.exe\",\n    \"Microsoft.EnterpriseManagement.ServiceManager.UI.Console.exe\",\n    \"mmc.exe\",\n    \"mscorsvw.exe\",\n    \"msexchangedelivery.exe\",\n    \"msexchangefrontendtransport.exe\",\n    \"msexchangehmworker.exe\",\n    \"msexchangesubmission.exe\",\n    \"msiexec.exe\",\n    \"MsiExec.exe\",\n    \"noderunner.exe\",\n    \"NServiceBus.Host.exe\",\n    \"NServiceBus.Host32.exe\",\n    \"NServiceBus.Hosting.Azure.HostProcess.exe\",\n    \"OuiGui.WPF.exe\",\n    \"powershell.exe\",\n    \"powershell_ise.exe\",\n    \"pwsh.exe\",\n    \"SCCMCliCtrWPF.exe\",\n    \"ScriptEditor.exe\",\n    \"ScriptRunner.exe\",\n    \"sdiagnhost.exe\",\n    \"servermanager.exe\",\n    \"setup100.exe\",\n    \"ServiceHub.VSDetouredHost.exe\",\n    \"SPCAF.Client.exe\",\n    \"SPCAF.SettingsEditor.exe\",\n    \"SQLPS.exe\",\n    \"telemetryservice.exe\",\n    \"UMWorkerProcess.exe\",\n    \"w3wp.exe\",\n    \"wsmprovhost.exe\"\n  )\n","throttle":"no_actions","actions":[]}
{"id":"4d5484f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.006Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.277Z","created_by":"chaykovskiyv","name":"Delete Volume USN Journal with Fsutil [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies use of the fsutil.exe to delete the volume USNJRNL. This technique is used by attackers to eliminate evidence of files created during post-exploitation activities.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"d2367bc5-3c04-4e9d-a0b4-a11b6bda8516","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1070/","name":"Indicator Removal","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1070/004/","name":"File Deletion","id":"T1070.004"}],"id":"T1070"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  (process.name : \"fsutil.exe\" or process.pe.original_file_name == \"fsutil.exe\") and\n  process.args : \"deletejournal\" and process.args : \"usn\"\n","throttle":"no_actions","actions":[]}
{"id":"4841d800-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.207Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.777Z","created_by":"chaykovskiyv","name":"Remote System Discovery Commands [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Discovery of remote system information using built-in commands, which may be used to move laterally.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Remote System Discovery Commands\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `arp` or `nbstat` utilities to enumerate remote systems in the environment, which is useful for attackers to identify lateral movement targets.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"68272caf-b7b7-42fe-a199-57dcf57ad8a4","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1016/","name":"System Network Configuration Discovery","id":"T1016"},{"reference":"https://attack.mitre.org/techniques/T1018/","name":"Remote System Discovery","id":"T1018"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}}],"to":"now","references":[],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n(\n  ((process.name : \"nbtstat.exe\" and process.args : (\"-n\", \"-s\")) or\n  (process.name : \"arp.exe\" and process.args : \"-a\"))\n)\n","throttle":"no_actions","actions":[]}
{"id":"4f2dd8d0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.044Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.405Z","created_by":"chaykovskiyv","name":"Suspicious .NET Reflection via PowerShell [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","PowerShell"],"interval":"5m","enabled":true,"description":"Detects the use of Reflection.Assembly to load PEs and DLLs in memory in PowerShell scripts. Attackers use this method to load executables and DLLs without writing to the disk, bypassing security solutions.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Suspicious .NET Reflection via PowerShell\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can use .NET reflection to load PEs and DLLs in memory. These payloads are commonly embedded in the script, which can circumvent file-based security protections.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately outside engineering or IT business units. As long as the analyst did not identify malware or suspicious activity related to the user or host, this alert can be dismissed.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- PowerShell Suspicious Payload Encoded and Compressed - 81fe9dc6-a2d7-4192-a2d8-eed98afc766a\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"ffc82f29-d669-4886-8d73-b25687f3442b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1055/","name":"Process Injection","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1055/001/","name":"Dynamic-link Library Injection","id":"T1055.001"},{"reference":"https://attack.mitre.org/techniques/T1055/002/","name":"Portable Executable Injection","id":"T1055.002"}],"id":"T1055"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://docs.microsoft.com/en-us/dotnet/api/system.reflection.assembly.load"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and\n  powershell.file.script_block_text : (\n    \"[System.Reflection.Assembly]::Load\" or\n    \"[Reflection.Assembly]::Load\"\n  ) and not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"4f2462f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.192Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.345Z","created_by":"chaykovskiyv","name":"Suspicious Remote Registry Access via SeBackupPrivilege [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement","Credential Access","Investigation Guide","Active Directory"],"interval":"5m","enabled":true,"description":"Identifies remote access to the registry using an account with Backup Operators group membership. This may indicate an attempt to exfiltrate credentials by dumping the Security Account Manager (SAM) registry hive in preparation for credential access and privileges elevation.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Suspicious Remote Registry Access via SeBackupPrivilege\n\nSeBackupPrivilege is a privilege that allows file content retrieval, designed to enable users to create backup copies of the system. Since it is impossible to make a backup of something you cannot read, this privilege comes at the cost of providing the user with full read access to the file system. This privilege must bypass any access control list (ACL) placed in the system.\n\nThis rule identifies remote access to the registry using an account with Backup Operators group membership. This may indicate an attempt to exfiltrate credentials by dumping the Security Account Manager (SAM) registry hive in preparation for credential access and privileges elevation.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the activities done by the subject user the login session. The field `winlog.event_data.SubjectLogonId` can be used to get this data.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate abnormal behaviors observed by the subject user such as network connections, registry or file modifications, and processes created.\n- Investigate if the registry file was retrieved or exfiltrated.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Limit or disable the involved user account to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"9de9cc8d-eac3-40db-88ef-2331252bf805","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/002/","name":"Security Account Manager","id":"T1003.002"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":["https://github.com/mpgn/BackupOperatorToDA","https://raw.githubusercontent.com/Wh04m1001/Random/main/BackupOperators.cpp","https://www.elastic.co/security-labs/detect-credential-access"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"sequence by winlog.computer_name, winlog.event_data.SubjectLogonId with maxspan=1m\n [iam where event.action == \"logged-in-special\"  and\n  winlog.event_data.PrivilegeList : \"SeBackupPrivilege\" and\n\n  /* excluding accounts with existing privileged access */\n  not winlog.event_data.PrivilegeList : \"SeDebugPrivilege\"]\n [any where event.action == \"Detailed File Share\" and winlog.event_data.RelativeTargetName : \"winreg\"]\n","throttle":"no_actions","actions":[]}
{"id":"52b096f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.302Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.248Z","created_by":"chaykovskiyv","name":"Potential Exfiltration via Certreq [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Command and Control","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies Certreq making an HTTP Post request. Adversaries could abuse Certreq to exfiltrate data to a remote URL.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"7fc6d786-f003-45f6-bd77-8d69548a11cf","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1105/","name":"Ingress Tool Transfer","id":"T1105"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0011/","name":"Command and Control","id":"TA0011"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1218/","name":"System Binary Proxy Execution","id":"T1218"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://lolbas-project.github.io/lolbas/Binaries/Certreq/"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and \n (process.name : \"CertReq.exe\" or process.pe.original_file_name == \"CertReq.exe\") and process.args : \"-Post\"\n","throttle":"no_actions","actions":[]}
{"id":"fb6ebe90-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.279Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.734Z","created_by":"burzhynskyyy","name":"OneDrive Malware File Upload [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Lateral Movement"],"interval":"5m","enabled":true,"description":"Identifies the occurence of files uploaded to OneDrive being detected as Malware by the file scanning engine. Attackers can use File Sharing and Organization Repositories to spread laterally within the company and amplify their access. Users can inadvertently share these files without knowing their maliciousness, giving adversaries opportunity to gain initial access to other endpoints in the environment.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Benign files can trigger signatures in the built-in virus protection"],"from":"now-30m","rule_id":"b3247333-a763-4a14-b869-d099979d2dd7","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1080/","name":"Taint Shared Content","id":"T1080"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":["https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/virus-detection-in-spo?view=o365-worldwide"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:OneDrive and event.code:SharePointFileOperation and event.action:FileMalwareDetected\n","throttle":"no_actions","actions":[]}
{"id":"52b3cb40-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:33.356Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.293Z","created_by":"chaykovskiyv","name":"Windows Subsystem for Linux Enabled via Dism Utility [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Detects attempts to enable the Windows Subsystem for Linux using Microsoft Dism utility. Adversaries may enable and use WSL for Linux to avoid detection.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"508c35cd-d7ab-4561-8de1-24387cbc7d67","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1202/","name":"Indirect Command Execution","id":"T1202"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://blog.f-secure.com/hunting-for-windows-subsystem-for-linux/"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type : \"start\" and \n (process.name : \"Dism.exe\" or process.pe.original_file_name == \"DISM.EXE\") and \n process.command_line : \"*Microsoft-Windows-Subsystem-Linux*\"\n","throttle":"no_actions","actions":[]}
{"id":"49cdcf30-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.549Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.288Z","created_by":"chaykovskiyv","name":"Conhost Spawned By Suspicious Parent Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Detects when the Console Window Host (conhost.exe) process is spawned by a suspicious parent process, which could be indicative of code injection.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Conhost Spawned By Suspicious Parent Process\n\nThe Windows Console Host, or `conhost.exe`, is both the server application for all of the Windows Console APIs as well as the classic Windows user interface for working with command-line applications.\n\nAttackers often rely on custom shell implementations to avoid using built-in command interpreters like `cmd.exe` and `PowerShell.exe` and bypass application allowlisting and security features. Attackers commonly inject these implementations into legitimate system processes.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate abnormal behaviors observed by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Retrieve the parent process executable and determine if it is malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell `Get-FileHash` cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- Suspicious Process from Conhost - 28896382-7d4f-4d50-9b72-67091901fd26\n- Suspicious PowerShell Engine ImageLoad - 852c1f19-68e8-43a6-9dce-340771fe1be3\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"84572298-6fa6-4127-83b3-1a3924e7986b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://www.fireeye.com/blog/threat-research/2017/08/monitoring-windows-console-activity-part-one.html"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.name : \"conhost.exe\" and\n  process.parent.name : (\"lsass.exe\", \"services.exe\", \"smss.exe\", \"winlogon.exe\", \"explorer.exe\", \"dllhost.exe\", \"rundll32.exe\",\n                         \"regsvr32.exe\", \"userinit.exe\", \"wininit.exe\", \"spoolsv.exe\", \"ctfmon.exe\") and\n  not (process.parent.name : \"rundll32.exe\" and\n       process.parent.args : (\"?:\\\\Windows\\\\Installer\\\\MSI*.tmp,zzzzInvokeManagedCustomActionOutOfProc\",\n                              \"?:\\\\WINDOWS\\\\system32\\\\PcaSvc.dll,PcaPatchSdbTask\",\n                              \"?:\\\\WINDOWS\\\\system32\\\\davclnt.dll,DavSetCookie\"))\n","throttle":"no_actions","actions":[]}
{"id":"50e41450-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.254Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.265Z","created_by":"chaykovskiyv","name":"Suspicious Microsoft Diagnostics Wizard Execution [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies potential abuse of the Microsoft Diagnostics Troubleshooting Wizard (MSDT) to proxy malicious command or binary execution via malicious process arguments.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"4086ac62-6103-4c38-9b94-3bbba5f333a7","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1218/","name":"System Binary Proxy Execution","id":"T1218"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://twitter.com/nao_sec/status/1530196847679401984","https://lolbas-project.github.io/lolbas/Binaries/Msdt/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n   (process.pe.original_file_name == \"msdt.exe\" or process.name : \"msdt.exe\") and\n   (\n    process.args : (\"IT_RebrowseForFile=*\", \"ms-msdt:/id\", \"ms-msdt:-id\", \"*FromBase64*\") or\n\n    (process.args : \"-af\" and process.args : \"/skip\" and\n     process.parent.name : (\"explorer.exe\", \"cmd.exe\", \"powershell.exe\", \"cscript.exe\", \"wscript.exe\", \"mshta.exe\", \"rundll32.exe\", \"regsvr32.exe\") and\n     process.args : (\"?:\\\\WINDOWS\\\\diagnostics\\\\index\\\\PCWDiagnostic.xml\", \"PCWDiagnostic.xml\", \"?:\\\\Users\\\\Public\\\\*\", \"?:\\\\Windows\\\\Temp\\\\*\")) or\n\n    (process.pe.original_file_name == \"msdt.exe\" and not process.name : \"msdt.exe\" and process.name != null) or\n\n    (process.pe.original_file_name == \"msdt.exe\" and not process.executable : (\"?:\\\\Windows\\\\system32\\\\msdt.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\msdt.exe\"))\n    )\n","throttle":"no_actions","actions":[]}
{"id":"50e4d7a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.261Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.274Z","created_by":"chaykovskiyv","name":"PowerShell Script with Token Impersonation Capabilities [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","PowerShell"],"interval":"5m","enabled":true,"description":"Detects scripts that contain PowerShell functions, structures, or Windows API functions related to token impersonation/theft. Attackers may duplicate then impersonate another user's token to escalate privileges and bypass access controls.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"df74d91b-8bc0-4493-9df0-e8c55cfcc7a1","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1134/","name":"Access Token Manipulation","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1134/001/","name":"Token Impersonation/Theft","id":"T1134.001"}],"id":"T1134"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"},{"reference":"https://attack.mitre.org/techniques/T1106/","name":"Native API","id":"T1106"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://github.com/decoder-it/psgetsystem","https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/Get-System.ps1","https://github.com/EmpireProject/Empire/blob/master/data/module_source/privesc/Invoke-MS16032.ps1","https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"],"version":3,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and\n  powershell.file.script_block_text:(\n    \"Invoke-TokenManipulation\" or\n    \"ImpersonateNamedPipeClient\" or\n    \"NtImpersonateThread\" or\n    (\n      \"STARTUPINFOEX\" and\n      \"UpdateProcThreadAttribute\"\n    ) or\n    (\n      \"AdjustTokenPrivileges\" and\n      \"SeDebugPrivilege\"\n    ) or\n    (\n      (\"DuplicateToken\" or\n      \"DuplicateTokenEx\") and\n      (\"SetThreadToken\" or\n      \"ImpersonateLoggedOnUser\" or\n      \"CreateProcessWithTokenW\" or\n      \"CreatePRocessAsUserW\" or\n      \"CreateProcessAsUserA\")\n    ) \n  ) and not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"47bcc980-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.150Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:05.843Z","created_by":"chaykovskiyv","name":"Persistence via Microsoft Outlook VBA [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Detects attempts to establish persistence on an endpoint by installing a rogue Microsoft Outlook VBA Template.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["A legitimate VBA for Outlook is usually configured interactively via OUTLOOK.EXE."],"from":"now-9m","rule_id":"f532e713-b284-4fe3-a958-1995a1acc8f5","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1137/","name":"Office Application Startup","id":"T1137"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://www.mdsec.co.uk/2020/11/a-fresh-outlook-on-mail-based-persistence/","https://www.linkedin.com/pulse/outlook-backdoor-using-vba-samir-b-/"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"file where event.type != \"deletion\" and\n file.path : \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Outlook\\\\VbaProject.OTM\"\n","throttle":"no_actions","actions":[]}
{"id":"52b1cf70-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:33.313Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.268Z","created_by":"chaykovskiyv","name":"PowerShell Invoke-NinjaCopy script [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","PowerShell"],"interval":"5m","enabled":true,"description":"Detects PowerShell scripts that contain the default exported functions used on Invoke-NinjaCopy. Attackers can use Invoke-NinjaCopy to read SYSTEM files that are normally locked, such as the NTDS.dit file or registry hives.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"6fc0a5ae-6f40-43d9-a73b-b3c3aaca849b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/002/","name":"Security Account Manager","id":"T1003.002"},{"reference":"https://attack.mitre.org/techniques/T1003/003/","name":"NTDS","id":"T1003.003"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://github.com/BC-SECURITY/Empire/blob/main/empire/server/data/module_source/collection/Invoke-NinjaCopy.ps1"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*"],"query":"event.category:process and\n  powershell.file.script_block_text : (\n    \"StealthReadFile\" or\n    \"StealthReadFileAddr\" or\n    \"StealthCloseFileDelegate\" or\n    \"StealthOpenFile\" or\n    \"StealthCloseFile\" or\n    \"StealthReadFile\" or\n    \"Invoke-NinjaCopy\"\n   )\n  and not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"4d552130-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.011Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.284Z","created_by":"chaykovskiyv","name":"Suspicious CertUtil Commands [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies suspicious commands being used with certutil.exe. CertUtil is a native Windows component which is part of Certificate Services. CertUtil is often abused by attackers to live off the land for stealthier command and control or data exfiltration.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timeline_id":"e70679c2-6cde-4510-9764-4823df18f7db","timeline_title":"Comprehensive Process Timeline","timestamp_override":"event.ingested","author":["Elastic","Austin Songer"],"false_positives":[],"from":"now-9m","rule_id":"8ce10993-8209-4724-80ca-406f31d69b20","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1140/","name":"Deobfuscate/Decode Files or Information","id":"T1140"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://twitter.com/Moriarty_Meng/status/984380793383370752","https://twitter.com/egre55/status/1087685529016193025","https://www.sysadmins.lv/blog-en/certutil-tips-and-tricks-working-with-x509-file-format.aspx","https://docs.microsoft.com/en-us/archive/blogs/pki/basic-crl-checking-with-certutil"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  (process.name : \"certutil.exe\" or process.pe.original_file_name == \"CertUtil.exe\") and\n  process.args : (\"?decode\", \"?encode\", \"?urlcache\", \"?verifyctl\", \"?encodehex\", \"?decodehex\", \"?exportPFX\")\n","throttle":"no_actions","actions":[]}
{"id":"50e43b60-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.255Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.266Z","created_by":"chaykovskiyv","name":"Enumerating Domain Trusts via NLTEST.EXE [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the use of nltest.exe for domain trust discovery purposes. Adversaries may use this command-line utility to enumerate domain trusts and gain insight into trust relationships, as well as the state of Domain Controller (DC) replication in a Microsoft Windows NT Domain.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Domain administrators may use this command-line utility for legitimate information gathering purposes, but it is not common for environments with Windows Server 2012 and newer."],"from":"now-9m","rule_id":"d0ec194a-f97a-43b3-82ac-f115904d38b6","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1482/","name":"Domain Trust Discovery","id":"T1482"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}}],"to":"now","references":["https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731935(v=ws.11)","https://redcanary.com/blog/how-one-hospital-thwarted-a-ryuk-ransomware-outbreak/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n    process.name : \"nltest.exe\" and process.args : (\n        \"/DCLIST:*\", \"/DCNAME:*\", \"/DSGET*\",\n        \"/LSAQUERYFTI:*\", \"/PARENTDOMAIN\",\n        \"/DOMAIN_TRUSTS\", \"/BDC_QUERY:*\")\n","throttle":"no_actions","actions":[]}
{"id":"4d6ec3b0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.040Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.376Z","created_by":"chaykovskiyv","name":"Startup/Logon Script added to Group Policy Object [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Active Directory","Investigation Guide"],"interval":"5m","enabled":true,"description":"Detects the modification of Group Policy Objects (GPO) to add a startup/logon script to users or computer objects.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Scheduled Task Execution at Scale via GPO\n\nGroup Policy Objects (GPOs) can be used by attackers to instruct arbitrarily large groups of clients to execute specified commands at startup, logon, shutdown, and logoff. This is done by creating or modifying the `scripts.ini` or `psscripts.ini` files. The scripts are stored in the following paths:\n  - `<GPOPath>\\Machine\\Scripts\\`\n  - `<GPOPath>\\User\\Scripts\\`\n\n#### Possible investigation steps\n\n- This attack abuses a legitimate mechanism of Active Directory, so it is important to determine whether the activity is legitimate and the administrator is authorized to perform this operation.\n- Retrieve the contents of the `ScheduledTasks.xml` file, and check the `<Command>` and `<Arguments>` XML tags for any potentially malicious commands or binaries.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Scope which objects may be compromised by retrieving information about which objects are controlled by the GPO.\n\n### False positive analysis\n\n- Verify if the execution is legitimately authorized and executed under a change management process.\n\n### Related rules\n\n- Group Policy Abuse for Privilege Addition - b9554892-5e0e-424b-83a0-5aef95aa43bf\n- Scheduled Task Execution at Scale via GPO - 15a8ba77-1c13-4274-88fe-6bd14133861e\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- The investigation and containment must be performed in every computer controlled by the GPO, where necessary.\n- Remove the script from the GPO.\n- Check if other GPOs have suspicious scripts attached.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Legitimate Administrative Activity"],"from":"now-6m","rule_id":"5cf91313-edd8-4c2e-a7db-1d36d85c832f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1484/","name":"Domain Policy Modification","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1484/001/","name":"Group Policy Modification","id":"T1484.001"}],"id":"T1484"},{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0025_windows_audit_directory_service_changes.md","https://github.com/atc-project/atc-data/blob/f2bbb51ecf68e2c9f488e3c70dcdd3df51d2a46b/docs/Logging_Policies/LP_0029_windows_audit_detailed_file_share.md","https://labs.f-secure.com/tools/sharpgpoabuse"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"(\n event.code:5136 and winlog.event_data.AttributeLDAPDisplayName:(gPCMachineExtensionNames or gPCUserExtensionNames) and\n   winlog.event_data.AttributeValue:(*42B5FAAE-6536-11D2-AE5A-0000F87571E3* and\n                                      (*40B66650-4972-11D1-A7CA-0000F87571E3* or *40B6664F-4972-11D1-A7CA-0000F87571E3*))\n)\nor\n(\n event.code:5145 and winlog.event_data.ShareName:\\\\\\\\*\\\\SYSVOL and\n   winlog.event_data.RelativeTargetName:(*\\\\scripts.ini or *\\\\psscripts.ini) and\n   (message:WriteData or winlog.event_data.AccessList:*%%4417*)\n)\n","throttle":"no_actions","actions":[]}
{"id":"4d523b00-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.192Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.253Z","created_by":"chaykovskiyv","name":"Potential Credential Access via Trusted Developer Utility [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Investigation Guide"],"interval":"5m","enabled":true,"description":"An instance of MSBuild, the Microsoft Build Engine, loaded DLLs (dynamically linked libraries) responsible for Windows credential management. This technique is sometimes used for credential dumping.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Potential Credential Access via Trusted Developer Utility\n\nThe Microsoft Build Engine is a platform for building applications. This engine, also known as MSBuild, provides an XML schema for a project file that controls how the build platform processes and builds software.\n\nAdversaries can abuse MSBuild to proxy the execution of malicious code. The inline task capability of MSBuild that was introduced in .NET version 4 allows for C# or Visual Basic code to be inserted into an XML project file. MSBuild will compile and execute the inline task. `MSBuild.exe` is a signed Microsoft binary, and the execution of code using it can bypass application control defenses that are configured to allow `MSBuild.exe` execution.\n\nThis rule looks for the MSBuild process loading `vaultcli.dll` or `SAMLib.DLL`, which indicates the execution of credential access activities.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate abnormal behaviors observed by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the command line to identify the `.csproj` file location.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":["The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."],"from":"now-9m","rule_id":"bded0de5-fc03-469f-ab13-20f38da8ce4e","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by process.entity_id\n [process where event.type == \"start\" and (process.name : \"MSBuild.exe\" or process.pe.original_file_name == \"MSBuild.exe\")]\n [any where (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  (dll.name : (\"vaultcli.dll\", \"SAMLib.DLL\") or file.name : (\"vaultcli.dll\", \"SAMLib.DLL\"))]\n","throttle":"no_actions","actions":[]}
{"id":"945231e0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.830Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.331Z","created_by":"chaykovskiyv","name":"Potential Shadow Credentials added to AD Object [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Active Directory"],"interval":"5m","enabled":true,"description":"Identify the modification of the msDS-KeyCredentialLink attribute in an Active Directory Computer or User Object. Attackers can abuse control over the object and create a key pair, append to raw public key in the attribute, and obtain persistent and stealthy access to the target user or computer object.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Modifications in the msDS-KeyCredentialLink attribute can be done legitimately by the Azure AD Connect synchronization account or the ADFS service account. These accounts can be added as Exceptions."],"from":"now-9m","rule_id":"b7f23879-00f3-4214-94b2-c0ff8c122e25","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1556/","name":"Modify Authentication Process","id":"T1556"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab","https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials","https://github.com/OTRF/Set-AuditRule","https://cyberstoph.org/posts/2022/03/detecting-shadow-credentials/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.action:\"Directory Service Changes\" and event.code:\"5136\" and\n winlog.event_data.AttributeLDAPDisplayName:\"msDS-KeyCredentialLink\" and winlog.event_data.AttributeValue :B\\:828* and not winlog.event_data.SubjectUserName: MSOL_*\n","throttle":"no_actions","actions":[]}
{"id":"4f2c5230-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.156Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.388Z","created_by":"chaykovskiyv","name":"Third-party Backup Files Deleted via Unexpected Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Impact","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the deletion of backup files, saved using third-party software, by a process outside of the backup suite. Adversaries may delete Backup files to ensure that recovery from a ransomware attack is less likely.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Third-party Backup Files Deleted via Unexpected Process\n\nBackups are a significant obstacle for any ransomware operation. They allow the victim to resume business by performing data recovery, making them a valuable target.\n\nAttackers can delete backups from the host and gain access to backup servers to remove centralized backups for the environment, ensuring that victims have no alternatives to paying the ransom.\n\nThis rule identifies file deletions performed by a process that does not belong to the backup suite and aims to delete Veritas or Veeam backups.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check if any files on the host machine have been encrypted.\n\n### False positive analysis\n\n- This rule can be triggered by the manual removal of backup files and by removal using other third-party tools that are not from the backup suite. Exceptions can be added for specific accounts and executables, preferably tied together.\n\n### Related rules\n\n- Deleting Backup Catalogs with Wbadmin - 581add16-df76-42bb-af8e-c979bfb39a59\n- Volume Shadow Copy Deleted or Resized via VssAdmin - b5ea4bfe-a1b2-421f-9d47-22a75a6f2921\n- Volume Shadow Copy Deletion via PowerShell - d99a037b-c8e2-47a5-97b9-170d076827c4\n- Volume Shadow Copy Deletion via WMIC - dc9c1f74-dac3-48e3-b47f-eb79db358f57\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- Perform data recovery locally or restore the backups from replicated copies (Cloud, other servers, etc.).\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Certain utilities that delete files for disk cleanup or Administrators manually removing backup files."],"from":"now-9m","rule_id":"e3d36d54-ca01-4320-af1d-5675bad14ad2","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1490/","name":"Inhibit System Recovery","id":"T1490"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0040/","name":"Impact","id":"TA0040"}}],"to":"now","references":["https://www.advintel.io/post/backup-removal-solutions-from-conti-ransomware-with-love"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"file where event.type == \"deletion\" and\n  (\n  /* Veeam Related Backup Files */\n  (file.extension : (\"VBK\", \"VIB\", \"VBM\") and\n  not process.executable : (\"?:\\\\Windows\\\\Veeam\\\\Backup\\\\*\",\n                            \"?:\\\\Program Files\\\\Veeam\\\\Backup and Replication\\\\*\",\n                            \"?:\\\\Program Files (x86)\\\\Veeam\\\\Backup and Replication\\\\*\")) or\n\n  /* Veritas Backup Exec Related Backup File */\n  (file.extension : \"BKF\" and\n  not process.executable : (\"?:\\\\Program Files\\\\Veritas\\\\Backup Exec\\\\*\",\n                            \"?:\\\\Program Files (x86)\\\\Veritas\\\\Backup Exec\\\\*\"))\n  )\n","throttle":"no_actions","actions":[]}
{"id":"483e7ca0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.201Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.734Z","created_by":"chaykovskiyv","name":"UAC Bypass via Windows Firewall Snap-In Hijack [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies attempts to bypass User Account Control (UAC) by hijacking the Microsoft Management Console (MMC) Windows Firewall snap-in. Attackers bypass UAC to stealthily execute code with elevated permissions.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating UAC Bypass via Windows Firewall Snap-In Hijack\n\nWindows User Account Control (UAC) allows a program to elevate its privileges (tracked as low to high integrity levels) to perform a task under administrator-level permissions, possibly by prompting the user for confirmation. UAC can deny an operation under high-integrity enforcement, or allow the user to perform the action if they are in the local administrators group and enter an administrator password when prompted.\n\nFor more information about the UAC and how it works, check the [official Microsoft docs page](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works).\n\nThis rule identifies attempts to bypass User Account Control (UAC) by hijacking the Microsoft Management Console (MMC) Windows Firewall snap-in. Attackers bypass UAC to stealthily execute code with elevated permissions.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze any suspicious spawned processes using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"ade1e83a-8919-4733-b934-048f3f38d8ad","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1548/","name":"Abuse Elevation Control Mechanism","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1548/002/","name":"Bypass User Account Control","id":"T1548.002"}],"id":"T1548"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://github.com/AzAgarampur/byeintegrity-uac"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n process.parent.name == \"mmc.exe\" and\n /* process.Ext.token.integrity_level_name == \"high\" can be added in future for tuning */\n /* args of the Windows Firewall SnapIn */\n  process.parent.args == \"WF.msc\" and process.name != \"WerFault.exe\"\n","throttle":"no_actions","actions":[]}
{"id":"52b2b9d0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:33.322Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.279Z","created_by":"chaykovskiyv","name":"First Time Seen Driver Loaded [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Identifies the load of a driver with an original file name and signature values that were observed for the first time during the last 30 days. This rule type can help baseline drivers installation within your environment.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"a776bd34-ed54-4f29-b601-b0da211bb3b8","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1543/","name":"Create or Modify System Process","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1543/003/","name":"Windows Service","id":"T1543.003"}],"id":"T1543"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://www.elastic.co/kr/security-labs/stopping-vulnerable-driver-attacks"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"new_terms","query":"event.category : \"driver\" and event.action : \"load\"\n","new_terms_fields":["dll.pe.original_file_name","dll.code_signature.subject_name"],"history_window_start":"now-30d","index":["logs-endpoint.events.*"],"language":"kuery","throttle":"no_actions","actions":[]}
{"id":"50e2dbd0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.243Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.247Z","created_by":"chaykovskiyv","name":"Unusual Network Connection via DllHost [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Identifies unusual instances of dllhost.exe making outbound network connections. This may indicate adversarial Command and Control activity.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"f9eda27b-2d62-4f3e-8d07-938688fc6532","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1218/","name":"System Binary Proxy Execution","id":"T1218"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://www.microsoft.com/security/blog/2021/05/27/new-sophisticated-email-based-attack-from-nobelium/","https://www.volexity.com/blog/2021/05/27/suspected-apt29-operation-launches-election-fraud-themed-phishing-campaigns/","https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by host.id, process.entity_id with maxspan=1m\n  [process where event.type == \"start\" and process.name : \"dllhost.exe\" and process.args_count == 1]\n  [network where process.name : \"dllhost.exe\" and\n   not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n    \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n    \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n    \"192.175.48.0/24\", \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n    \"FF00::/8\")]\n","throttle":"no_actions","actions":[]}
{"id":"50e06ad0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.064Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.220Z","created_by":"chaykovskiyv","name":"Potential LSA Authentication Package Abuse [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Adversaries can use the autostart mechanism provided by the Local Security Authority (LSA) authentication packages for privilege escalation or persistence by placing a reference to a binary in the Windows registry. The binary will then be executed by SYSTEM when the authentication packages are loaded.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"3d515080-c700-45bb-ae88-347adfdf0d28","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1547/002/","name":"Authentication Package","id":"T1547.002"}],"id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1547/","name":"Boot or Logon Autostart Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1547/002/","name":"Authentication Package","id":"T1547.002"}],"id":"T1547"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"registry where event.type == \"change\" and\n  registry.path : \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\Authentication Packages\" and\n  /* exclude SYSTEM SID - look for changes by non-SYSTEM user */\n  not user.id : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"49b5da60-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:21.537Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.214Z","created_by":"chaykovskiyv","name":"Suspicious Execution via Scheduled Task [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"Identifies execution of a suspicious program via scheduled tasks by looking at process lineage and command line usage.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Legitimate scheduled tasks running third party software."],"from":"now-9m","rule_id":"e085f899-f01a-44ae-8759-05dd88fda977","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1053/","name":"Scheduled Task/Job","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1053/005/","name":"Scheduled Task","id":"T1053.005"}],"id":"T1053"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n    /* Schedule service cmdline on Win10+ */\n    process.parent.name : \"svchost.exe\" and process.parent.args : \"Schedule\" and\n    /* add suspicious programs here */\n    process.pe.original_file_name in\n                                (\n                                  \"cscript.exe\",\n                                  \"wscript.exe\",\n                                  \"PowerShell.EXE\",\n                                  \"Cmd.Exe\",\n                                  \"MSHTA.EXE\",\n                                  \"RUNDLL32.EXE\",\n                                  \"REGSVR32.EXE\",\n                                  \"MSBuild.exe\",\n                                  \"InstallUtil.exe\",\n                                  \"RegAsm.exe\",\n                                  \"RegSvcs.exe\",\n                                  \"msxsl.exe\",\n                                  \"CONTROL.EXE\",\n                                  \"EXPLORER.EXE\",\n                                  \"Microsoft.Workflow.Compiler.exe\",\n                                  \"msiexec.exe\"\n                                  ) and\n    /* add suspicious paths here */\n    process.args : (\n       \"C:\\\\Users\\\\*\",\n       \"C:\\\\ProgramData\\\\*\",\n       \"C:\\\\Windows\\\\Temp\\\\*\",\n       \"C:\\\\Windows\\\\Tasks\\\\*\",\n       \"C:\\\\PerfLogs\\\\*\",\n       \"C:\\\\Intel\\\\*\",\n       \"C:\\\\Windows\\\\Debug\\\\*\",\n       \"C:\\\\HP\\\\*\") and\n\n     not (process.name : \"cmd.exe\" and process.args : \"?:\\\\*.bat\" and process.working_directory : \"?:\\\\Windows\\\\System32\\\\\") and\n     not (process.name : \"cscript.exe\" and process.args : \"?:\\\\Windows\\\\system32\\\\calluxxprovider.vbs\") and\n     not (process.name : \"powershell.exe\" and process.args : (\"-File\", \"-PSConsoleFile\") and user.id : \"S-1-5-18\") and\n     not (process.name : \"msiexec.exe\" and user.id : \"S-1-5-18\")\n","throttle":"no_actions","actions":[]}
{"id":"4d51c5d0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.195Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.247Z","created_by":"chaykovskiyv","name":"Network Connection via Certutil [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Command and Control","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies certutil.exe making a network connection. Adversaries could abuse certutil.exe to download a certificate, or malware, from a remote URL.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Network Connection via Certutil\n\nAttackers can abuse `certutil.exe` to download malware, offensive security tools, and certificates from external sources in order to take the next steps in a compromised environment.\n\nThis rule looks for network events where `certutil.exe` contacts IP ranges other than the ones specified in [IANA IPv4 Special-Purpose Address Registry](https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml)\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate if the downloaded file was executed.\n- Determine the context in which `certutil.exe` and the file were run.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the downloaded file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. If trusted software uses this command and the triage has not identified anything suspicious, this alert can be closed as a false positive.\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"d1a4d5cc-5e0d-4dc1-994b-32d1990d4706","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1105/","name":"Ingress Tool Transfer","id":"T1105"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0011/","name":"Command and Control","id":"TA0011"}}],"to":"now","references":["https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml","https://frsecure.com/malware-incident-response-playbook/"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by process.entity_id\n  [process where process.name : \"certutil.exe\" and event.type == \"start\"]\n  [network where process.name : \"certutil.exe\" and\n    not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n                                  \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\",\n                                  \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\",\n                                  \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\n                                  \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n                                  \"FE80::/10\", \"FF00::/8\")]\n","throttle":"no_actions","actions":[]}
{"id":"9450f960-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.776Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.315Z","created_by":"chaykovskiyv","name":"KRBTGT Delegation Backdoor [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Active Directory"],"interval":"5m","enabled":true,"description":"Identifies the modification of the msDS-AllowedToDelegateTo attribute to KRBTGT. Attackers can use this technique to maintain persistence to the domain by having the ability to request tickets for the KRBTGT service.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"be37f13a-e438-4635-a11a-48bd0bbb855f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1098/","name":"Account Manipulation","id":"T1098"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1558/","name":"Steal or Forge Kerberos Tickets","id":"T1558"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://skyblue.team/posts/delegate-krbtgt","https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0026_windows_audit_user_account_management.md"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.action:modified-user-account and event.code:4738 and winlog.event_data.AllowedToDelegateTo:*krbtgt*\n","throttle":"no_actions","actions":[]}
{"id":"fb6e4960-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.265Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.730Z","created_by":"burzhynskyyy","name":"Microsoft 365 Teams External Access Enabled [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Configuration Audit"],"interval":"5m","enabled":true,"description":"Identifies when external access is enabled in Microsoft Teams. External access lets Teams and Skype for Business users communicate with other users that are outside their organization. An adversary may enable external access or add an allowed domain to exfiltrate data or maintain persistence in an environment.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Teams external access may be enabled by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."],"from":"now-30m","rule_id":"833a20c3-0566-4998-8e37-3407375e4181","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1098/","name":"Account Manipulation","id":"T1098"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://docs.microsoft.com/en-us/microsoftteams/manage-external-access"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:(SkypeForBusiness or MicrosoftTeams) and\nevent.category:web and event.action:\"Set-CsTenantFederationConfiguration\" and\no365.audit.Parameters.AllowFederatedUsers:True and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"4d532560-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.203Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.263Z","created_by":"chaykovskiyv","name":"Microsoft Build Engine Using an Alternate Name [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"An instance of MSBuild, the Microsoft Build Engine, was started after being renamed. This is uncommon behavior and may indicate an attempt to run unnoticed or undetected.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."],"from":"now-9m","rule_id":"7939a1fb-b91d-4d68-a758-6a6a4caa222f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1036/","name":"Masquerading","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1036/003/","name":"Rename System Utilities","id":"T1036.003"}],"id":"T1036"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.pe.original_file_name == \"MSBuild.exe\" and\n  not process.name : \"MSBuild.exe\"\n","throttle":"no_actions","actions":[]}
{"id":"483fdc30-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.199Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.748Z","created_by":"chaykovskiyv","name":"UAC Bypass via ICMLuaUtil Elevated COM Interface [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Identifies User Account Control (UAC) bypass attempts via the ICMLuaUtil Elevated COM interface. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions.","risk_score":73,"severity":"high","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"e9501e44-0e0a-4b83-9a34-71ba4b5aed5f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1548/","name":"Abuse Elevation Control Mechanism","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1548/002/","name":"Bypass User Account Control","id":"T1548.002"}],"id":"T1548"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n process.parent.name == \"dllhost.exe\" and\n process.parent.args in (\"/Processid:{3E5FC7F9-9A51-4367-9063-A120244FBEC7}\", \"/Processid:{D2E7041B-2927-42FB-8E9F-7CE93B6DC937}\") and\n process.pe.original_file_name != \"WerFault.exe\"\n","throttle":"no_actions","actions":[]}
{"id":"944e1331-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.761Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.283Z","created_by":"chaykovskiyv","name":"AdminSDHolder Backdoor [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Active Directory"],"interval":"5m","enabled":true,"description":"Detects modifications in the AdminSDHolder object. Attackers can abuse the SDProp process to implement a persistent backdoor in Active Directory. SDProp compares the permissions on protected objects with those defined on the AdminSDHolder object. If the permissions on any of the protected accounts and groups do not match, the permissions on the protected accounts and groups are reset to match those of the domain's AdminSDHolder object, regaining their Administrative Privileges.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"432705b3-f011-475f-9bba-e350f7da3dd8","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://adsecurity.org/?p=1906","https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory#adminsdholder"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.action:\"Directory Service Changes\" and event.code:5136 and winlog.event_data.ObjectDN:CN=AdminSDHolder,CN=System*\n","throttle":"no_actions","actions":[]}
{"id":"fb3add50-b619-11ed-b6f4-dfeac9073248","updated_at":"2023-02-26T21:10:36.286Z","updated_by":"burzhynskyyy","created_at":"2023-02-26T21:10:22.672Z","created_by":"burzhynskyyy","name":"Microsoft 365 Exchange Transport Rule Creation [Duplicate]","tags":["Elastic","Cloud","Microsoft 365","Continuous Monitoring","SecOps","Configuration Audit"],"interval":"5m","enabled":true,"description":"Identifies a transport rule creation in Microsoft 365. As a best practice, Exchange Online mail transport rules should not be set to forward email to domains outside of your organization. An adversary may create transport rules to exfiltrate data.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["A new transport rule may be created by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."],"from":"now-30m","rule_id":"85613a79-ae82-4d1a-b674-a832ba2d0df5","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1537/","name":"Transfer Data to Cloud Account","id":"T1537"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0010/","name":"Exfiltration","id":"TA0010"}}],"to":"now","references":["https://docs.microsoft.com/en-us/powershell/module/exchange/new-transportrule?view=exchange-ps","https://docs.microsoft.com/en-us/exchange/security-and-compliance/mail-flow-rules/mail-flow-rules"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["filebeat-*","logs-o365*"],"query":"event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"New-TransportRule\" and event.outcome:success\n","throttle":"no_actions","actions":[]}
{"id":"4d5177b0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.191Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.244Z","created_by":"chaykovskiyv","name":"Bypass UAC via Event Viewer [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies User Account Control (UAC) bypass via eventvwr.exe. Attackers bypass UAC to stealthily execute code with elevated permissions.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Bypass UAC via Event Viewer\n\nWindows User Account Control (UAC) allows a program to elevate its privileges (tracked as low to high integrity levels) to perform a task under administrator-level permissions, possibly by prompting the user for confirmation. UAC can deny an operation under high-integrity enforcement, or allow the user to perform the action if they are in the local administrators group and enter an administrator password when prompted.\n\nFor more information about the UAC and how it works, check the [official Microsoft docs page](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works).\n\nDuring startup, `eventvwr.exe` checks the registry value of the `HKCU\\Software\\Classes\\mscfile\\shell\\open\\command` registry key for the location of `mmc.exe`, which is used to open the `eventvwr.msc` saved console file. If the location of another binary or script is added to this registry value, it will be executed as a high-integrity process without a UAC prompt being displayed to the user. This rule detects this UAC bypass by monitoring processes spawned by `eventvwr.exe` other than `mmc.exe` and `werfault.exe`.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"2392c602-771c-419d-9ceb-c4a837b5e342","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1548/","name":"Abuse Elevation Control Mechanism","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1548/002/","name":"Bypass User Account Control","id":"T1548.002"}],"id":"T1548"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  process.parent.name : \"eventvwr.exe\" and\n  not process.executable :\n            (\"?:\\\\Windows\\\\SysWOW64\\\\mmc.exe\",\n             \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n             \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n             \"?:\\\\Windows\\\\System32\\\\WerFault.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"52ae4d00-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.284Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.225Z","created_by":"chaykovskiyv","name":"System Information Discovery via Windows Command Shell [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Execution"],"interval":"5m","enabled":true,"description":"Identifies the execution of discovery commands to enumerate system info or files and folders using the Windows Command Shell.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"9fa71165-41a9-4d72-91b0-523b65bb79c4","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1082/","name":"System Information Discovery","id":"T1082"},{"reference":"https://attack.mitre.org/techniques/T1083/","name":"File and Directory Discovery","id":"T1083"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/003/","name":"Windows Command Shell","id":"T1059.003"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-windows.*","logs-endpoint.events.*"],"query":"process where event.type == \"start\" and\n process.name : \"cmd.exe\" and process.args : \"/c\" and process.args : (\"set\", \"dir\")\n","throttle":"no_actions","actions":[]}
{"id":"94528001-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.842Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.338Z","created_by":"chaykovskiyv","name":"Modification of the msPKIAccountCredentials [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Active Directory","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Identify the modification of the msPKIAccountCredentials attribute in an Active Directory User Object. Attackers can abuse the credentials roaming feature to overwrite an arbitrary file for privilege escalation. ms-PKI-AccountCredentials contains binary large objects (BLOBs) of encrypted credential objects from the credential manager store, private keys, certificates, and certificate requests.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"435dd3cf-117f-4deb-9b01-1428aca741a3","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1068/","name":"Exploitation for Privilege Escalation","id":"T1068"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://www.mandiant.com/resources/blog/apt29-windows-credential-roaming","https://social.technet.microsoft.com/wiki/contents/articles/11483.windows-credential-roaming.aspx","https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-5136"],"version":3,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.action:\"Directory Service Changes\" and event.code:\"5136\" and\n winlog.event_data.AttributeLDAPDisplayName:\"msPKIAccountCredentials\" and winlog.event_data.OperationType:\"%%14674\" and\n not winlog.event_data.SubjectUserSid : \"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"4b6e86e0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.617Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.103Z","created_by":"chaykovskiyv","name":"Potential Lateral Tool Transfer via SMB Share [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies the creation or change of a Windows executable file over network shares. Adversaries may transfer tools or other files between systems in a compromised environment.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Potential Lateral Tool Transfer via SMB Share\n\nAdversaries can use network shares to host tooling to support the compromise of other hosts in the environment. These tools can include discovery utilities, credential dumpers, malware, etc. Attackers can also leverage file shares that employees frequently access to host malicious files to gain a foothold in other machines.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve the created file and determine if it is malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell `Get-FileHash` cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity can happen legitimately. Consider adding exceptions if it is expected and noisy in your environment.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Review the privileges needed to write to the network share and restrict write access as needed.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"d0918cd3-98d5-4a6e-a282-16afe1112feb","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1021/002/","name":"SMB/Windows Admin Shares","id":"T1021.002"}],"id":"T1021"},{"reference":"https://attack.mitre.org/techniques/T1570/","name":"Lateral Tool Transfer","id":"T1570"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"sequence by host.id with maxspan=30s\n  [network where event.type == \"start\" and process.pid == 4 and destination.port == 445 and\n   network.direction : (\"incoming\", \"ingress\") and\n   network.transport == \"tcp\" and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n  ] by process.entity_id\n  /* add more executable extensions here if they are not noisy in your environment */\n  [file where event.type in (\"creation\", \"change\") and process.pid == 4 and file.extension : (\"exe\", \"dll\", \"bat\", \"cmd\")] by process.entity_id\n","throttle":"no_actions","actions":[]}
{"id":"484114b1-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.191Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.768Z","created_by":"chaykovskiyv","name":"Remote File Download via PowerShell [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Command and Control","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies powershell.exe being used to download an executable file from an untrusted remote destination.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Remote File Download via PowerShell\n\nAttackers commonly transfer tooling or malware from external systems into a compromised environment using the command and control channel. However, they can also abuse signed utilities to drop these files.\n\nPowerShell is one of system administrators' main tools for automation, report routines, and other tasks. This makes it available for use in various environments and creates an attractive way for attackers to execute code and perform actions. This rule correlates network and file events to detect downloads of executable and script files performed using PowerShell.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check the reputation of the domain or IP address used to host the downloaded file.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- Administrators can use PowerShell legitimately to download executable and script files. Analysts can dismiss the alert if the Administrator is aware of the activity and the triage has not identified suspicious or malicious files.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"86708a21-4531-4fe8-be2a-e3decd5ffe8c","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1105/","name":"Ingress Tool Transfer","id":"T1105"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0011/","name":"Command and Control","id":"TA0011"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by host.id, process.entity_id with maxspan=30s\n  [network where process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and network.protocol == \"dns\" and\n   not dns.question.name : (\"localhost\", \"*.microsoft.com\", \"*.azureedge.net\", \"*.powershellgallery.com\", \"*.windowsupdate.com\", \"metadata.google.internal\") and\n   not user.domain : \"NT AUTHORITY\"]\n    [file where process.name : \"powershell.exe\" and event.type == \"creation\" and file.extension : (\"exe\", \"dll\", \"ps1\", \"bat\") and\n   not file.name : \"__PSScriptPolicy*.ps1\"]\n","throttle":"no_actions","actions":[]}
{"id":"4d559660-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.012Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.290Z","created_by":"chaykovskiyv","name":"Potential Evasion via Filter Manager [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"The Filter Manager Control Program (fltMC.exe) binary may be abused by adversaries to unload a filter driver and evade defenses.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"ee1b9ba5-fb27-47ba-ba1f-e5bac043c389","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/001/","name":"Disable or Modify Tools","id":"T1562.001"}],"id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n process.name : \"fltMC.exe\" and process.args : \"unload\"\n","throttle":"no_actions","actions":[]}
{"id":"483f6700-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.212Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.745Z","created_by":"chaykovskiyv","name":"Suspicious Cmd Execution via WMI [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies suspicious command execution (cmd) via Windows Management Instrumentation (WMI) on a remote host. This could be indicative of adversary lateral movement.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"fd3f58e7-00b4-410a-8ab8-eecdfabbdad5","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1047/","name":"Windows Management Instrumentation","id":"T1047"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n process.parent.name : \"WmiPrvSE.exe\" and process.name : \"cmd.exe\" and\n process.args : \"\\\\\\\\127.0.0.1\\\\*\" and process.args : (\"2>&1\", \"1>\")\n","throttle":"no_actions","actions":[]}
{"id":"9451e3c0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.829Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.329Z","created_by":"chaykovskiyv","name":"Account Configured with Never-Expiring Password [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Active Directory","Investigation Guide"],"interval":"5m","enabled":true,"description":"Detects the creation and modification of an account with the \"Don't Expire Password\" option Enabled. Attackers can abuse this misconfiguration to persist in the domain and maintain long-term access using compromised accounts with this property.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Account Configured with Never-Expiring Password\n\nActive Directory provides a setting that prevents users' passwords from expiring. Enabling this setting is bad practice and can expose environments to vulnerabilities that weaken security posture, especially when these accounts are privileged.\n\nThe setting is usually configured so a user account can act as a service account. Attackers can abuse these accounts to persist in the domain and maintain long-term access using compromised accounts with a never-expiring password set.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/source host during the past 48 hours.\n- Inspect the account for suspicious or abnormal behaviors in the alert timeframe.\n\n### False positive analysis\n\n- This activity should not happen legitimately. The security team should address any potential benign true positive (B-TP), as this configuration can put the user and the domain at risk.\n- Using user accounts as service accounts is a bad security practice and should not be allowed in the domain. The security team should map and monitor potential benign true positives (B-TPs), especially if the account is privileged. For cases in which user accounts cannot be avoided, Microsoft provides the Group Managed Service Accounts (gMSA) feature, which ensures that the account password is robust and changed regularly and automatically.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Reset the password of the account and update its password settings.\n- Search for other occurrences on the domain.\n    - Using the [Active Directory PowerShell module](https://docs.microsoft.com/en-us/powershell/module/activedirectory/get-aduser):\n        - `get-aduser -filter { passwordNeverExpires -eq $true  -and enabled -eq $true } | ft`\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["User accounts can be used as service accounts and have their password set never to expire. This is a bad security practice that exposes the account to Credential Access attacks. For cases in which user accounts cannot be avoided, Microsoft provides the Group Managed Service Accounts (gMSA) feature, which ensures that the account password is robust and changed regularly and automatically."],"from":"now-9m","rule_id":"46c60d3e-2eb1-4267-8dac-c4120767d0ca","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1098/","name":"Account Manipulation","id":"T1098"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://www.cert.ssi.gouv.fr/uploads/guide-ad.html#dont_expire","https://blog.menasec.net/2019/02/threat-hunting-26-persistent-password.html"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"event.action:\"modified-user-account\" and event.code:\"4738\" and message:\"'Don't Expire Password' - Enabled\" and not user.id:\"S-1-5-18\"\n","throttle":"no_actions","actions":[]}
{"id":"4d528920-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:25.200Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.259Z","created_by":"chaykovskiyv","name":"Microsoft Build Engine Started by a Script Process [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"An instance of MSBuild, the Microsoft Build Engine, was started by a script or the Windows command interpreter. This behavior is unusual and is sometimes used by malicious payloads.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."],"from":"now-9m","rule_id":"c52e20cc-ea86-40d9-b9b4-076813f503b4","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1127/","name":"Trusted Developer Utilities Proxy Execution","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1127/001/","name":"MSBuild","id":"T1127.001"}],"id":"T1127"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}},{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  (process.name : \"MSBuild.exe\" or process.pe.original_file_name == \"MSBuild.exe\") and\n  process.parent.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"cscript.exe\", \"wscript.exe\", \"mshta.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"944d4fe0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.765Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.291Z","created_by":"chaykovskiyv","name":"Suspicious Remote Registry Access via SeBackupPrivilege [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Lateral Movement","Credential Access","Investigation Guide","Active Directory"],"interval":"5m","enabled":true,"description":"Identifies remote access to the registry using an account with Backup Operators group membership. This may indicate an attempt to exfiltrate credentials by dumping the Security Account Manager (SAM) registry hive in preparation for credential access and privileges elevation.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Suspicious Remote Registry Access via SeBackupPrivilege\n\nSeBackupPrivilege is a privilege that allows file content retrieval, designed to enable users to create backup copies of the system. Since it is impossible to make a backup of something you cannot read, this privilege comes at the cost of providing the user with full read access to the file system. This privilege must bypass any access control list (ACL) placed in the system.\n\nThis rule identifies remote access to the registry using an account with Backup Operators group membership. This may indicate an attempt to exfiltrate credentials by dumping the Security Account Manager (SAM) registry hive in preparation for credential access and privileges elevation.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the activities done by the subject user the login session. The field `winlog.event_data.SubjectLogonId` can be used to get this data.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate abnormal behaviors observed by the subject user such as network connections, registry or file modifications, and processes created.\n- Investigate if the registry file was retrieved or exfiltrated.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Limit or disable the involved user account to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"601ac8fb-541b-44f4-bd1c-4818b0cec36c","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1003/002/","name":"Security Account Manager","id":"T1003.002"}],"id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1021/","name":"Remote Services","id":"T1021"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0008/","name":"Lateral Movement","id":"TA0008"}}],"to":"now","references":["https://github.com/mpgn/BackupOperatorToDA","https://raw.githubusercontent.com/Wh04m1001/Random/main/BackupOperators.cpp","https://www.elastic.co/security-labs/detect-credential-access"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"sequence by winlog.computer_name, winlog.event_data.SubjectLogonId with maxspan=1m\n [iam where event.action == \"logged-in-special\"  and\n  winlog.event_data.PrivilegeList : \"SeBackupPrivilege\" and\n\n  /* excluding accounts with existing privileged access */\n  not winlog.event_data.PrivilegeList : \"SeDebugPrivilege\"]\n [any where event.action == \"Detailed File Share\" and winlog.event_data.RelativeTargetName : \"winreg\"]\n","throttle":"no_actions","actions":[]}
{"id":"50e48980-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.257Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.270Z","created_by":"chaykovskiyv","name":"Suspicious HTML File Creation [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Initial Access"],"interval":"5m","enabled":true,"description":"Identifies the execution of a browser process to open an HTML file with high entropy and size. Adversaries may smuggle data and files past content filters by hiding malicious payloads inside of seemingly benign HTML files.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"0e131e55-8f8a-4c32-8056-de4371fd058b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1566/","name":"Phishing","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1566/001/","name":"Spearphishing Attachment","id":"T1566.001"},{"reference":"https://attack.mitre.org/techniques/T1566/002/","name":"Spearphishing Link","id":"T1566.002"}],"id":"T1566"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1027/","name":"Obfuscated Files or Information","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1027/006/","name":"HTML Smuggling","id":"T1027.006"}],"id":"T1027"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"sequence by user.id with maxspan=5m\n [file where event.action in (\"creation\", \"rename\") and\n  file.extension : (\"htm\", \"html\") and\n   file.path : (\"?:\\\\Users\\\\*\\\\Downloads\\\\*\",\n                \"?:\\\\Users\\\\*\\\\Content.Outlook\\\\*\",\n                \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Temp?_*\",\n                \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\7z*\",\n                \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Rar$*\") and\n   ((file.Ext.entropy >= 5 and file.size >= 150000) or file.size >= 1000000)]\n [process where event.action == \"start\" and\n  (\n   (process.name in (\"chrome.exe\", \"msedge.exe\", \"brave.exe\", \"whale.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\", \"opera.exe\")\n    and process.args == \"--single-argument\") or\n   (process.name == \"iexplore.exe\" and process.args_count == 2) or\n   (process.name in (\"firefox.exe\", \"waterfox.exe\") and process.args == \"-url\")\n  )\n  and process.args : (\"?:\\\\Users\\\\*\\\\Downloads\\\\*.htm*\",\n                      \"?:\\\\Users\\\\*\\\\Content.Outlook\\\\*.htm*\",\n                      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Temp?_*.htm*\",\n                      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\7z*.htm*\",\n                      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Rar$*.htm*\")]\n","throttle":"no_actions","actions":[]}
{"id":"52adb0c0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.280Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.218Z","created_by":"chaykovskiyv","name":"Privileges Elevation via Parent Process PID Spoofing [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation"],"interval":"5m","enabled":true,"description":"Identifies parent process spoofing used to create an elevated child process. Adversaries may spoof the parent process identifier (PPID) of a new process to evade process-monitoring defenses or to elevate privileges.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"bf115670-d0f3-49fc-9d6a-bbc491fe731c","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1134/","name":"Access Token Manipulation","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1134/002/","name":"Create Process with Token","id":"T1134.002"},{"reference":"https://attack.mitre.org/techniques/T1134/004/","name":"Parent PID Spoofing","id":"T1134.004"}],"id":"T1134"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}}],"to":"now","references":["https://gist.github.com/xpn/a057a26ec81e736518ee50848b9c2cd6","https://blog.didierstevens.com/2017/03/20/","https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute","https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1134.002/T1134.002.md"],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"/* This rule is compatible with Elastic Endpoint only */\n\nprocess where event.action == \"start\" and\n\n /* process creation via seclogon */\n process.parent.Ext.real.pid > 0 and\n\n /* PrivEsc to SYSTEM */\n user.id : \"S-1-5-18\"  and\n\n /* Common FPs - evasion via hollowing is possible, should be covered by code injection */\n not process.executable : (\"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n                           \"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\WerFaultSecure.exe\",\n                           \"?:\\\\Windows\\\\System32\\\\Wermgr.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\Wermgr.exe\",\n                           \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\Install\\\\securityhealthsetup.exe\") and\n\n not process.parent.executable : \"?:\\\\Windows\\\\System32\\\\AtBroker.exe\" and\n\n not (process.code_signature.subject_name in\n           (\"philandro Software GmbH\", \"Freedom Scientific Inc.\", \"TeamViewer Germany GmbH\", \"Projector.is, Inc.\",\n            \"TeamViewer GmbH\", \"Cisco WebEx LLC\", \"Dell Inc\") and process.code_signature.trusted == true)\n","throttle":"no_actions","actions":[]}
{"id":"52b021c0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.297Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.243Z","created_by":"chaykovskiyv","name":"Suspicious Execution via Windows Subsystem for Linux [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Detects Linux Bash commands from the the Windows Subsystem for Linux. Adversaries may enable and use WSL for Linux to avoid detection.","risk_score":47,"severity":"medium","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"0d68b127-22a4-4d6d-bf58-dcb70b660ab9","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1202/","name":"Indirect Command Execution","id":"T1202"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/004/","name":"Unix Shell","id":"T1059.004"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://blog.f-secure.com/hunting-for-windows-subsystem-for-linux/","https://lolbas-project.github.io/lolbas/OtherMSBinaries/Wsl/","https://blog.qualys.com/vulnerabilities-threat-research/2022/03/22/implications-of-windows-subsystem-for-linux-for-adversaries-defenders-part-1"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type : \"start\" and \n (\n  ((process.executable : \"?:\\\\Windows\\\\System32\\\\bash.exe\" or process.pe.original_file_name == \"Bash.exe\") and \n  not process.command_line : (\"bash\", \"bash.exe\")) or \n  process.executable : \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Packages\\\\*\\\\rootfs\\\\usr\\\\bin\\\\bash\" or \n  (process.parent.name : \"wsl.exe\" and process.parent.command_line : \"bash*\" and not process.name : \"wslhost.exe\") or \n  (process.name : \"wsl.exe\" and process.args : (\"curl\", \"/etc/shadow\", \"/etc/passwd\", \"cat\",\"--system\", \"root\", \"-e\", \"--exec\", \"bash\", \"/mnt/c/*\"))\n  ) and \n  not process.parent.executable : (\"?:\\\\Program Files\\\\Docker\\\\*.exe\", \"?:\\\\Program Files (x86)\\\\Docker\\\\*.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"484162d0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.228Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.772Z","created_by":"chaykovskiyv","name":"Unusual Process Execution Path - Alternate Data Stream [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies processes running from an Alternate Data Stream. This is uncommon for legitimate processes and sometimes done by adversaries to hide malware.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"fbb72a85-557b-4562-b859-6fa94fa113cb","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1564/","name":"Hide Artifacts","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1564/004/","name":"NTFS File Attributes","id":"T1564.004"}],"id":"T1564"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.args : \"?:\\\\*:*\" and process.args_count == 1\n","throttle":"no_actions","actions":[]}
{"id":"49b16d90-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:20.186Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:09.165Z","created_by":"chaykovskiyv","name":"Connection to Commonly Abused Free SSL Certificate Providers [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Command and Control"],"interval":"5m","enabled":true,"description":"Identifies unusual processes connecting to domains using known free SSL certificates. Adversaries may employ a known encryption algorithm to conceal command and control traffic.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"d42f3f29-d142-4eb9-bdd9-dd8e73872f26","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1573/","name":"Encrypted Channel","id":"T1573"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0011/","name":"Command and Control","id":"TA0011"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"network where network.protocol == \"dns\" and\n  /* Add new free SSL certificate provider domains here */\n  dns.question.name : (\"*letsencrypt.org\", \"*.sslforfree.com\", \"*.zerossl.com\", \"*.freessl.org\") and\n\n  /* Native Windows process paths that are unlikely to have network connections to domains secured using free SSL certificates */\n  process.executable : (\"C:\\\\Windows\\\\System32\\\\*.exe\",\n                        \"C:\\\\Windows\\\\System\\\\*.exe\",\n\t                  \"C:\\\\Windows\\\\SysWOW64\\\\*.exe\",\n\t\t          \"C:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\*.exe\",\n\t\t          \"C:\\\\Windows\\\\explorer.exe\",\n\t\t          \"C:\\\\Windows\\\\notepad.exe\") and\n\n  /* Insert noisy false positives here */\n  not process.name : (\"svchost.exe\", \"MicrosoftEdge*.exe\", \"msedge.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"4b6a6830-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.527Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.055Z","created_by":"chaykovskiyv","name":"Unusual Parent Process for cmd.exe [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies a suspicious parent child process relationship with cmd.exe descending from an unusual process.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"8dd510f2-6b6b-4498-bd3f-d10a6515afa4","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n  process.name : \"cmd.exe\" and\n  process.parent.name : (\"lsass.exe\",\n                         \"csrss.exe\",\n                         \"epad.exe\",\n                         \"regsvr32.exe\",\n                         \"dllhost.exe\",\n                         \"LogonUI.exe\",\n                         \"wermgr.exe\",\n                         \"spoolsv.exe\",\n                         \"jucheck.exe\",\n                         \"jusched.exe\",\n                         \"ctfmon.exe\",\n                         \"taskhostw.exe\",\n                         \"GoogleUpdate.exe\",\n                         \"sppsvc.exe\",\n                         \"sihost.exe\",\n                         \"slui.exe\",\n                         \"SIHClient.exe\",\n                         \"SearchIndexer.exe\",\n                         \"SearchProtocolHost.exe\",\n                         \"FlashPlayerUpdateService.exe\",\n                         \"WerFault.exe\",\n                         \"WUDFHost.exe\",\n                         \"unsecapp.exe\",\n                         \"wlanext.exe\" )\n","throttle":"no_actions","actions":[]}
{"id":"483cf600-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.160Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.719Z","created_by":"chaykovskiyv","name":"SolarWinds Process Disabling Services via Registry [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies a SolarWinds binary modifying the start type of a service to be disabled. An adversary may abuse this technique to manipulate relevant security services.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"c0a2a270-ed64-495e-a658-b6d6012c69a8","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/001/","name":"Disable or Modify Tools","id":"T1562.001"}],"id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1195/","name":"Supply Chain Compromise","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1195/002/","name":"Compromise Software Supply Chain","id":"T1195.002"}],"id":"T1195"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":["https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"registry where registry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\Start\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\Start\"\n  ) and\n  registry.data.strings : (\"4\", \"0x00000004\") and\n  process.name : (\n      \"SolarWinds.BusinessLayerHost*.exe\",\n      \"ConfigurationWizard*.exe\",\n      \"NetflowDatabaseMaintenance*.exe\",\n      \"NetFlowService*.exe\",\n      \"SolarWinds.Administration*.exe\",\n      \"SolarWinds.Collector.Service*.exe\",\n      \"SolarwindsDiagnostics*.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"52b21d90-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:33.315Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.272Z","created_by":"chaykovskiyv","name":"Potential PowerShell HackTool Script by Function Names [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","PowerShell"],"interval":"5m","enabled":true,"description":"Detects known PowerShell offensive tooling functions names in PowerShell scripts. Attackers commonly use out-of-the-box offensive tools without modifying the code. This rule aim is to take advantage of that.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"e2cbe477-0caf-47a7-b0cc-50d0362d489e","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1059/","name":"Command and Scripting Interpreter","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1059/001/","name":"PowerShell","id":"T1059.001"}],"id":"T1059"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}}],"to":"now","references":["https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md","https://github.com/BC-SECURITY/Empire"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["winlogbeat-*","logs-windows.*","logs-system.*"],"query":"event.category:process and\n  powershell.file.script_block_text : (\n    \"Add-DomainGroupMember\" or \"Add-DomainObjectAcl\" or\n    \"Add-RemoteConnection\" or \"Add-ServiceDacl\" or\n    \"Add-Win32Type\" or \"Convert-ADName\" or\n    \"Convert-LDAPProperty\" or \"ConvertFrom-LDAPLogonHours\" or\n    \"ConvertFrom-SID\" or \"ConvertFrom-UACValue\" or\n    \"ConvertTo-SID\" or \"Copy-ArrayOfMemAddresses\" or\n    \"Create-NamedPipe\" or \"Create-ProcessWithToken\" or\n    \"Create-RemoteThread\" or \"Create-SuspendedWinLogon\" or\n    \"Create-WinLogonProcess\" or \"Emit-CallThreadStub\" or\n    \"Enable-SeAssignPrimaryTokenPrivilege\" or \"Enable-SeDebugPrivilege\" or\n    \"Enum-AllTokens\" or \"Export-PowerViewCSV\" or\n    \"Find-AVSignature\" or \"Find-AppLockerLog\" or\n    \"Find-DomainLocalGroupMember\" or \"Find-DomainObjectPropertyOutlier\" or\n    \"Find-DomainProcess\" or \"Find-DomainShare\" or\n    \"Find-DomainUserEvent\" or \"Find-DomainUserLocation\" or\n    \"Find-InterestingDomainAcl\" or \"Find-InterestingDomainShareFile\" or\n    \"Find-InterestingFile\" or \"Find-LocalAdminAccess\" or\n    \"Find-PSScriptsInPSAppLog\" or \"Find-PathDLLHijack\" or\n    \"Find-ProcessDLLHijack\" or \"Find-RDPClientConnection\" or\n    \"Get-AllAttributesForClass\" or \"Get-CachedGPPPassword\" or\n    \"Get-DecryptedCpassword\" or \"Get-DecryptedSitelistPassword\" or\n    \"Get-DelegateType\" or \"Get-DomainController\" or\n    \"Get-DomainDFSShare\" or \"Get-DomainDFSShareV1\" or\n    \"Get-DomainDFSShareV2\" or \"Get-DomainDNSRecord\" or\n    \"Get-DomainDNSZone\" or \"Get-DomainFileServer\" or\n    \"Get-DomainForeignGroupMember\" or \"Get-DomainForeignUser\" or\n    \"Get-DomainGPO\" or \"Get-DomainGPOComputerLocalGroupMapping\" or\n    \"Get-DomainGPOLocalGroup\" or \"Get-DomainGPOUserLocalGroupMapping\" or\n    \"Get-DomainGUIDMap\" or \"Get-DomainGroup\" or\n    \"Get-DomainGroupMember\" or \"Get-DomainGroupMemberDeleted\" or\n    \"Get-DomainManagedSecurityGroup\" or \"Get-DomainOU\" or\n    \"Get-DomainObject\" or \"Get-DomainObjectAcl\" or\n    \"Get-DomainObjectAttributeHistory\" or \"Get-DomainObjectLinkedAttributeHistory\" or\n    \"Get-DomainPolicyData\" or \"Get-DomainSID\" or\n    \"Get-DomainSPNTicket\" or \"Get-DomainSearcher\" or\n    \"Get-DomainSite\" or \"Get-DomainSubnet\" or\n    \"Get-DomainTrust\" or \"Get-DomainTrustMapping\" or\n    \"Get-DomainUser\" or \"Get-DomainUserEvent\" or\n    \"Get-Forest\" or \"Get-ForestDomain\" or\n    \"Get-ForestGlobalCatalog\" or \"Get-ForestSchemaClass\" or\n    \"Get-ForestTrust\" or \"Get-GPODelegation\" or\n    \"Get-GPPAutologon\" or \"Get-GPPInnerField\" or\n    \"Get-GPPInnerFields\" or \"Get-GPPPassword\" or\n    \"Get-GptTmpl\" or \"Get-GroupsXML\" or\n    \"Get-HttpStatus\" or \"Get-ImageNtHeaders\" or\n    \"Get-IniContent\" or \"Get-Keystrokes\" or\n    \"Get-MemoryProcAddress\" or \"Get-MicrophoneAudio\" or\n    \"Get-ModifiablePath\" or \"Get-ModifiableRegistryAutoRun\" or\n    \"Get-ModifiableScheduledTaskFile\" or \"Get-ModifiableService\" or\n    \"Get-ModifiableServiceFile\" or \"Get-Name\" or\n    \"Get-NetComputerSiteName\" or \"Get-NetLocalGroup\" or\n    \"Get-NetLocalGroupMember\" or \"Get-NetLoggedon\" or\n    \"Get-NetRDPSession\" or \"Get-NetSession\" or\n    \"Get-NetShare\" or \"Get-PEArchitecture\" or\n    \"Get-PEBasicInfo\" or \"Get-PEDetailedInfo\" or\n    \"Get-PathAcl\" or \"Get-PrimaryToken\" or\n    \"Get-PrincipalContext\" or \"Get-ProcAddress\" or\n    \"Get-ProcessTokenGroup\" or \"Get-ProcessTokenPrivilege\" or\n    \"Get-ProcessTokenType\" or \"Get-Property\" or\n    \"Get-RegLoggedOn\" or \"Get-RegistryAlwaysInstallElevated\" or\n    \"Get-RegistryAutoLogon\" or \"Get-RemoteProcAddress\" or\n    \"Get-Screenshot\" or \"Get-ServiceDetail\" or\n    \"Get-SiteListPassword\" or \"Get-SitelistField\" or\n    \"Get-System\" or \"Get-SystemNamedPipe\" or\n    \"Get-SystemToken\" or \"Get-ThreadToken\" or\n    \"Get-TimedScreenshot\" or \"Get-TokenInformation\" or\n    \"Get-TopPort\" or \"Get-UnattendedInstallFile\" or\n    \"Get-UniqueTokens\" or \"Get-UnquotedService\" or\n    \"Get-VaultCredential\" or \"Get-VaultElementValue\" or\n    \"Get-VirtualProtectValue\" or \"Get-VolumeShadowCopy\" or\n    \"Get-WMIProcess\" or \"Get-WMIRegCachedRDPConnection\" or\n    \"Get-WMIRegLastLoggedOn\" or \"Get-WMIRegMountedDrive\" or\n    \"Get-WMIRegProxy\" or \"Get-WebConfig\" or\n    \"Get-Win32Constants\" or \"Get-Win32Functions\" or\n    \"Get-Win32Types\" or \"Import-DllImports\" or\n    \"Import-DllInRemoteProcess\" or \"Inject-LocalShellcode\" or\n    \"Inject-RemoteShellcode\" or \"Install-ServiceBinary\" or\n    \"Invoke-CompareAttributesForClass\" or \"Invoke-CreateRemoteThread\" or\n    \"Invoke-CredentialInjection\" or \"Invoke-DllInjection\" or\n    \"Invoke-EventVwrBypass\" or \"Invoke-ImpersonateUser\" or\n    \"Invoke-Kerberoast\" or \"Invoke-MemoryFreeLibrary\" or\n    \"Invoke-MemoryLoadLibrary\" or \"Invoke-Method\" or\n    \"Invoke-Mimikatz\" or \"Invoke-NinjaCopy\" or\n    \"Invoke-PatchDll\" or \"Invoke-Portscan\" or\n    \"Invoke-PrivescAudit\" or \"Invoke-ReflectivePEInjection\" or\n    \"Invoke-ReverseDnsLookup\" or \"Invoke-RevertToSelf\" or\n    \"Invoke-ServiceAbuse\" or \"Invoke-Shellcode\" or\n    \"Invoke-TokenManipulation\" or \"Invoke-UserImpersonation\" or\n    \"Invoke-WmiCommand\" or \"Mount-VolumeShadowCopy\" or\n    \"New-ADObjectAccessControlEntry\" or \"New-DomainGroup\" or\n    \"New-DomainUser\" or \"New-DynamicParameter\" or\n    \"New-InMemoryModule\" or \"New-ScriptBlockCallback\" or\n    \"New-ThreadedFunction\" or \"New-VolumeShadowCopy\" or\n    \"Out-CompressedDll\" or \"Out-EncodedCommand\" or\n    \"Out-EncryptedScript\" or \"Out-Minidump\" or\n    \"PortScan-Alive\" or \"Portscan-Port\" or\n    \"Remove-DomainGroupMember\" or \"Remove-DomainObjectAcl\" or\n    \"Remove-RemoteConnection\" or \"Remove-VolumeShadowCopy\" or\n    \"Restore-ServiceBinary\" or \"Set-DesktopACLToAllowEveryone\" or\n    \"Set-DesktopACLs\" or \"Set-DomainObject\" or\n    \"Set-DomainObjectOwner\" or \"Set-DomainUserPassword\" or\n    \"Set-ServiceBinaryPath\" or \"Sub-SignedIntAsUnsigned\" or\n    \"Test-AdminAccess\" or \"Test-MemoryRangeValid\" or\n    \"Test-ServiceDaclPermission\" or\"Update-ExeFunctions\" or\n    \"Update-MemoryAddresses\" or \"Update-MemoryProtectionFlags\" or\n    \"Write-BytesToMemory\" or \"Write-HijackDll\" or\n    \"Write-PortscanOut\" or \"Write-ServiceBinary\" or\n    \"Write-UserAddMSI\" or \"Invoke-Privesc\" or\n    \"func_get_proc_address\" or \"Invoke-BloodHound\" or\n    \"Invoke-HostEnum\" or \"Get-BrowserInformation\" or\n    \"Get-DomainAccountPolicy\" or \"Get-DomainAdmins\" or\n    \"Get-AVProcesses\" or \"Get-AVInfo\" or\n    \"Get-RecycleBin\"\n  )\n","throttle":"no_actions","actions":[]}
{"id":"50e329f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.247Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.256Z","created_by":"chaykovskiyv","name":"Modification of AmsiEnable Registry Key [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies modifications of the AmsiEnable registry key to 0, which disables the Antimalware Scan Interface (AMSI). An adversary can modify this key to disable AMSI protections.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Modification of AmsiEnable Registry Key\n\nThe Windows Antimalware Scan Interface (AMSI) is a versatile interface standard that allows your applications and services to integrate with any antimalware product that's present on a machine. AMSI provides integration with multiple Windows components, ranging from User Account Control (UAC) to VBA Macros.\n\nSince AMSI is widely used across security products for increased visibility, attackers can disable it to evade detections that rely on it.\n\nThis rule monitors the modifications to the Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable registry key.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the execution of scripts and macros after the registry modification.\n- Retrieve scripts or Microsoft Office files and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Use process name, command line, and file hash to search for occurrences on other hosts.\n\n### False positive analysis\n\n- This modification should not happen legitimately. Any potential benign true positive (B-TP) should be mapped and monitored by the security team, as these modifications expose the host to malware infections.\n\n### Related rules\n\n- Microsoft Windows Defender Tampering - fe794edd-487f-4a90-b285-3ee54f2af2d3\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Delete or set the key to its default value.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"94c99866-a0ce-4ff5-9430-37ccf86e89ce","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1562/","name":"Impair Defenses","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1562/001/","name":"Disable or Modify Tools","id":"T1562.001"}],"id":"T1562"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://hackinparis.com/data/slides/2019/talks/HIP2019-Dominic_Chell-Cracking_The_Perimeter_With_Sharpshooter.pdf","https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-portal"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"registry where event.type in (\"creation\", \"change\") and\n  registry.path : (\n    \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows Script\\\\Settings\\\\AmsiEnable\",\n    \"HKU\\\\*\\\\Software\\\\Microsoft\\\\Windows Script\\\\Settings\\\\AmsiEnable\",\n    \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows Script\\\\Settings\\\\AmsiEnable\"\n  ) and\n  registry.data.strings: (\"0\", \"0x00000000\")\n","throttle":"no_actions","actions":[]}
{"id":"50dff5a1-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.060Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.217Z","created_by":"chaykovskiyv","name":"Disabling User Account Control via Registry Modification [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Privilege Escalation","Investigation Guide"],"interval":"5m","enabled":true,"description":"User Account Control (UAC) can help mitigate the impact of malware on Windows hosts. With UAC, apps and tasks always run in the security context of a non-administrator account, unless an administrator specifically authorizes administrator-level access to the system. This rule identifies registry value changes to bypass User Access Control (UAC) protection.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\n### Investigating Disabling User Account Control via Registry Modification\n\nWindows User Account Control (UAC) allows a program to elevate its privileges (tracked as low to high integrity levels) to perform a task under administrator-level permissions, possibly by prompting the user for confirmation. UAC can deny an operation under high-integrity enforcement, or allow the user to perform the action if they are in the local administrators group and enter an administrator password when prompted.\n\nFor more information about the UAC and how it works, check the [official Microsoft docs page](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works).\n\nAttackers may disable UAC to execute code directly in high integrity. This rule identifies registry value changes to bypass the UAC protection.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behaviors in the alert timeframe.\n- Investigate abnormal behaviors observed by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Analyze non-system processes executed with high integrity after UAC was disabled for unknown or suspicious processes.\n- Retrieve the suspicious processes' executables and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled tasks creation.\n  - Use the PowerShell `Get-FileHash` cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Restore UAC settings to the desired state.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"fdd7d544-eb0b-4bbd-9fce-e1f40248e1ff","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1548/","name":"Abuse Elevation Control Mechanism","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1548/002/","name":"Bypass User Account Control","id":"T1548.002"}],"id":"T1548"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0004/","name":"Privilege Escalation","id":"TA0004"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1548/","name":"Abuse Elevation Control Mechanism","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1548/002/","name":"Bypass User Account Control","id":"T1548.002"}],"id":"T1548"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://www.greyhathacker.net/?p=796","https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings","https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-overview"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"registry where event.type == \"change\" and\n  registry.path :\n    (\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\EnableLUA\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\ConsentPromptBehaviorAdmin\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\PromptOnSecureDesktop\"\n    ) and\n  registry.data.strings : (\"0\", \"0x00000000\")\n","throttle":"no_actions","actions":[]}
{"id":"4b6956c0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.519Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.042Z","created_by":"chaykovskiyv","name":"Persistence via Update Orchestrator Service Hijack [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","CVE-2020-1313","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies potential hijacking of the Microsoft Update Orchestrator Service to establish persistence with an integrity level of SYSTEM.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Persistence via Update Orchestrator Service Hijack\n\nWindows Update Orchestrator Service is a DCOM service used by other components to install Windows updates that are already downloaded. Windows Update Orchestrator Service was vulnerable to elevation of privileges (any user to local system) due to an improper authorization of the callers. The vulnerability affected the Windows 10 and Windows Server Core products. Fixed by Microsoft on Patch Tuesday June 2020.\n\nThis rule will detect uncommon processes spawned by `svchost.exe` with `UsoSvc` as the command line parameters. Attackers can leverage this technique to elevate privileges or maintain persistence.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"d7e6ed51-ed11-4e6f-90d8-09769059f3b9","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1543/","name":"Create or Modify System Process","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1543/003/","name":"Windows Service","id":"T1543.003"}],"id":"T1543"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://github.com/irsl/CVE-2020-1313"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  process.parent.executable : \"C:\\\\Windows\\\\System32\\\\svchost.exe\" and\n  process.parent.args : \"UsoSvc\" and\n  not process.executable :\n          (\"?:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\UUS\\\\Packages\\\\*\\\\amd64\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\UsoClient.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MusNotification.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MusNotificationUx.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MusNotifyIcon.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WerMgr.exe\",\n          \"?:\\\\Windows\\\\UUS\\\\amd64\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\UUS\\\\amd64\\\\UsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\UsoCoreWorker.exe\",\n          \"?:\\\\Program Files\\\\Common Files\\\\microsoft shared\\\\ClickToRun\\\\OfficeC2RClient.exe\") and\n  not process.name : (\"MoUsoCoreWorker.exe\", \"OfficeC2RClient.exe\")\n","throttle":"no_actions","actions":[]}
{"id":"daf63270-2a67-11ee-8f07-79710758f25a","updated_at":"2023-07-24T21:20:35.412Z","updated_by":"burzhynskyyy","created_at":"2023-07-24T21:20:05.395Z","created_by":"burzhynskyyy","name":"Apache server mass error events detected during 1 hour","tags":["Custom Rules","Test"],"interval":"5m","enabled":true,"description":"Виявлення великої кількості подій (більше 100) в журналі apache-error відносно одного хоста впродовж 1 години.","risk_score":47,"severity":"medium","license":"","output_index":"","meta":{"from":"1h","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-3900s","rule_id":"7ccab362-2498-4f10-acc4-02d4846aaed2","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"tags:\"apache-error\" and not message:AH01071*","filters":[],"threshold":{"field":["host.name"],"value":100,"cardinality":[]},"throttle":"no_actions","actions":[]}
{"id":"484d49b0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.210Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.805Z","created_by":"chaykovskiyv","name":"Potential Process Herpaderping Attempt [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion"],"interval":"5m","enabled":true,"description":"Identifies process execution followed by a file overwrite of an executable by the same parent process. This may indicate an evasion attempt to execute malicious code in a stealthy way.","risk_score":73,"severity":"high","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"b5a80941-b70d-45a7-87c0-9b44d60e4d8b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1036/","name":"Masquerading","id":"T1036"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":["https://github.com/jxy-s/herpaderping"],"version":102,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*"],"query":"sequence with maxspan=5s\n   [process where event.type == \"start\" and not process.parent.executable :\n      (\n         \"?:\\\\Windows\\\\SoftwareDistribution\\\\*.exe\",\n         \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\*.exe\",\n         \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\*.exe\"\n      )\n   ] by host.id, process.executable, process.parent.entity_id\n   [file where event.type == \"change\" and event.action == \"overwrite\" and file.extension == \"exe\"] by host.id, file.path, process.entity_id\n","throttle":"no_actions","actions":[]}
{"id":"4b6d4e60-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.608Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.086Z","created_by":"chaykovskiyv","name":"Execution of File Written or Modified by PDF Reader [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Investigation Guide","Elastic Endgame"],"interval":"60m","enabled":true,"description":"Identifies a suspicious file that was written by a PDF reader application and subsequently executed. These processes are often launched via exploitation of PDF applications.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Execution of File Written or Modified by PDF Reader\n\nPDF is a common file type used in corporate environments and most machines have software to handle these files. This creates a vector where attackers can exploit the engines and technology behind this class of software for initial access or privilege escalation.\n\nThis rule searches for executable files written by PDF reader software and executed in sequence. This is most likely the result of exploitation for privilege escalation or initial access. This rule can also detect suspicious processes masquerading as PDF readers.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve the PDF documents received and opened by the user that could cause this behavior. Common locations include, but are not limited to, the Downloads and Document folders and the folder configured at the email client.\n- Determine if the collected files are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell `Get-FileHash` cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-120m","rule_id":"dfad357a-3b39-4220-a113-0499c80ea62f","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1566/","name":"Phishing","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1566/001/","name":"Spearphishing Attachment","id":"T1566.001"},{"reference":"https://attack.mitre.org/techniques/T1566/002/","name":"Spearphishing Link","id":"T1566.002"}],"id":"T1566"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*","endgame-*"],"query":"sequence with maxspan=2h\n  [file where event.type != \"deletion\" and file.extension : \"exe\" and\n     (process.name : \"AcroRd32.exe\" or\n      process.name : \"rdrcef.exe\" or\n      process.name : \"FoxitPhantomPDF.exe\" or\n      process.name : \"FoxitReader.exe\") and\n     not (file.name : \"FoxitPhantomPDF.exe\" or\n          file.name : \"FoxitPhantomPDFUpdater.exe\" or\n          file.name : \"FoxitReader.exe\" or\n          file.name : \"FoxitReaderUpdater.exe\" or\n          file.name : \"AcroRd32.exe\" or\n          file.name : \"rdrcef.exe\")\n  ] by host.id, file.path\n  [process where event.type == \"start\"] by host.id, process.executable\n","throttle":"no_actions","actions":[]}
{"id":"4f1f80f0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:22.179Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.314Z","created_by":"chaykovskiyv","name":"Threat Intel Filebeat Module (v8.x) Indicator Match [Duplicate]","tags":["Elastic","Windows","Elastic Endgame","Network","Continuous Monitoring","SecOps","Monitoring","Investigation Guide"],"interval":"1h","enabled":true,"description":"This rule is triggered when indicators from the Threat Intel Filebeat module (v8.x) has a match against local file or network observations.","risk_score":99,"severity":"critical","note":"## Triage and Analysis\n\n### Investigating Threat Intel Indicator Matches\n\nThreat Intel indicator match rules allow matching from a local observation such as an endpoint event that records a file hash with an entry of a file hash stored within the Threat Intel integrations. Matches can also occur on an IP address, registry path, URL, or imphash.\n\nThe matches will be based on the incoming last 30 days feed data so it's important to validate the data and review the results by investigating the associated activity to determine if it requires further investigation.\n\nIf an indicator matches a local observation, the following enriched fields will be generated to identify the indicator, field, and type matched.\n\n- `threat.indicator.matched.atomic` - this identifies the atomic indicator that matched the local observation\n- `threat.indicator.matched.field` - this identifies the indicator field that matched the local observation\n- `threat.indicator.matched.type` - this identifies the indicator type that matched the local observation\n\n#### Possible investigation steps:\n- Investigation should be validated and reviewed based on the data (file hash, registry path, URL, imphash) that was matched and by viewing the source of that activity.\n- Consider the history of the indicator that was matched. Has it happened before? Is it happening on multiple machines? These kinds of questions can help understand if the activity is related to legitimate behavior.\n- Consider the user and their role within the company: is this something related to their job or work function?\n\n### False Positive Analysis\n- For any matches found, it's important to consider the initial release date of that indicator. Threat intelligence can be a great tool for augmenting existing security processes, while at the same time it should be understood that threat intelligence can represent a specific set of activity observed at a point in time. For example, an IP address may have hosted malware observed in a Dridex campaign months ago, but it's possible that IP has been remediated and no longer represents any threat.\n- Adversaries often use legitimate tools as network administrators such as `PsExec` or `AdFind`; these tools often find their way into indicator lists creating the potential for false positives.\n- It's possible after large and publicly written campaigns, curious employees might end up going directly to attacker infrastructure and triggering these rules.\n\n### Response and Remediation\n- If suspicious or malicious behavior is observed, take immediate action to isolate activity to prevent further post-compromise behavior.\n- One example of a response if a machine matched a command and control IP address would be to add an entry to a network device such as a firewall or proxy appliance to prevent any outbound activity from leaving that machine.\n- Another example of a response with a malicious file hash match would involve validating if the file was properly quarantined, reviewing current running processes for any abnormal activity, and investigating for any other follow-up actions such as persistence or lateral movement.\n","license":"Elastic License v2","output_index":"","timeline_id":"495ad7a7-316e-4544-8a0f-9c098daee76e","timeline_title":"Generic Threat Match Timeline","author":["Elastic"],"false_positives":[],"from":"now-65m","rule_id":"2aad324f-eb85-4567-93cd-bc6665e3d34b","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":["https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-threatintel.html"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threat_match","language":"kuery","index":["auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","winlogbeat-*"],"query":"file.hash.*:* or file.pe.imphash:* or source.ip:* or destination.ip:* or url.full:* or registry.path:*\n","threat_filters":[{"$state":{"store":"appState"},"meta":{"negate":false,"disabled":false,"params":{"query":"threatintel"},"type":"phrase","key":"event.module"},"query":{"match_phrase":{"event.module":"threatintel"}}},{"$state":{"store":"appState"},"meta":{"negate":false,"disabled":false,"params":{"query":"threat"},"type":"phrase","key":"event.category"},"query":{"match_phrase":{"event.category":"threat"}}},{"$state":{"store":"appState"},"meta":{"negate":false,"disabled":false,"params":{"query":"enrichment"},"type":"phrase","key":"event.kind"},"query":{"match_phrase":{"event.kind":"enrichment"}}},{"$state":{"store":"appState"},"meta":{"negate":false,"disabled":false,"params":{"query":"indicator"},"type":"phrase","key":"event.type"},"query":{"match_phrase":{"event.type":"indicator"}}}],"threat_query":"@timestamp >= \"now-30d/d\" and event.module:threatintel and (threat.indicator.file.hash.*:* or threat.indicator.file.pe.imphash:* or threat.indicator.ip:* or threat.indicator.registry.path:* or threat.indicator.url.full:*)","threat_mapping":[{"entries":[{"field":"file.hash.md5","type":"mapping","value":"threat.indicator.file.hash.md5"}]},{"entries":[{"field":"file.hash.sha1","type":"mapping","value":"threat.indicator.file.hash.sha1"}]},{"entries":[{"field":"file.hash.sha256","type":"mapping","value":"threat.indicator.file.hash.sha256"}]},{"entries":[{"field":"file.pe.imphash","type":"mapping","value":"threat.indicator.file.pe.imphash"}]},{"entries":[{"field":"source.ip","type":"mapping","value":"threat.indicator.ip"}]},{"entries":[{"field":"destination.ip","type":"mapping","value":"threat.indicator.ip"}]},{"entries":[{"field":"url.full","type":"mapping","value":"threat.indicator.url.full"}]},{"entries":[{"field":"registry.path","type":"mapping","value":"threat.indicator.registry.path"}]}],"threat_language":"kuery","threat_index":["filebeat-8*"],"threat_indicator_path":"threat.indicator","throttle":"no_actions","actions":[]}
{"id":"4b6d2750-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.607Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.084Z","created_by":"chaykovskiyv","name":"Execution of File Written or Modified by Microsoft Office [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Execution","Investigation Guide","Elastic Endgame"],"interval":"60m","enabled":true,"description":"Identifies an executable created by a Microsoft Office application and subsequently executed. These processes are often launched via scripts inside documents or during exploitation of Microsoft Office applications.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Execution of File Written or Modified by Microsoft Office\n\nMicrosoft Office is a suite of applications designed to help with productivity and completing common tasks on a computer. You can create and edit documents containing text and images, work with data in spreadsheets and databases, and create presentations and posters. As it is some of the most-used software across companies, MS Office is frequently targeted for initial access. It also has a wide variety of capabilities that attackers can take advantage of.\n\nThis rule searches for executable files written by MS Office applications executed in sequence. This is most likely the result of the execution of malicious documents or exploitation for initial access or privilege escalation. This rule can also detect suspicious processes masquerading as the MS Office applications.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve MS Office documents received and opened by the user that could cause this behavior. Common locations include, but are not limited to, the Downloads and Document folders and the folder configured at the email client.\n- Determine if the collected files are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell `Get-FileHash` cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-120m","rule_id":"6cf57496-a127-46a6-8eba-4e0ed0f98291","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0002/","name":"Execution","id":"TA0002"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1566/","name":"Phishing","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1566/001/","name":"Spearphishing Attachment","id":"T1566.001"},{"reference":"https://attack.mitre.org/techniques/T1566/002/","name":"Spearphishing Link","id":"T1566.002"}],"id":"T1566"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*","winlogbeat-*","logs-windows.*","endgame-*"],"query":"sequence with maxspan=2h\n  [file where event.type != \"deletion\" and file.extension : \"exe\" and\n     (process.name : \"WINWORD.EXE\" or\n      process.name : \"EXCEL.EXE\" or\n      process.name : \"OUTLOOK.EXE\" or\n      process.name : \"POWERPNT.EXE\" or\n      process.name : \"eqnedt32.exe\" or\n      process.name : \"fltldr.exe\" or\n      process.name : \"MSPUB.EXE\" or\n      process.name : \"MSACCESS.EXE\")\n  ] by host.id, file.path\n  [process where event.type == \"start\"] by host.id, process.executable\n","throttle":"no_actions","actions":[]}
{"id":"50e266a0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.242Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.241Z","created_by":"chaykovskiyv","name":"Threat Intel Indicator Match [Duplicate]","tags":["Elastic","Windows","Elastic Endgame","Network","Continuous Monitoring","SecOps","Monitoring","Investigation Guide"],"interval":"1h","enabled":true,"description":"This rule is triggered when indicators from the Threat Intel integrations have a match against local file or network observations.","risk_score":99,"severity":"critical","note":"## Triage and Analysis\n\n### Investigating Threat Intel Indicator Matches\n\nThreat Intel indicator match rules allow matching from a local observation such as an endpoint event that records a file hash with an entry of a file hash stored within the Threat Intel integrations. Matches can also occur on an IP address, registry path, URL, or imphash.\n\nThe matches will be based on the incoming last 30 days feed data so it's important to validate the data and review the results by investigating the associated activity to determine if it requires further investigation.\n\nIf an indicator matches a local observation, the following enriched fields will be generated to identify the indicator, field, and type matched.\n\n- `threat.indicator.matched.atomic` - this identifies the atomic indicator that matched the local observation\n- `threat.indicator.matched.field` - this identifies the indicator field that matched the local observation\n- `threat.indicator.matched.type` - this identifies the indicator type that matched the local observation\n\n#### Possible investigation steps:\n- Investigation should be validated and reviewed based on the data (file hash, registry path, URL, imphash) that was matched and by viewing the source of that activity.\n- Consider the history of the indicator that was matched. Has it happened before? Is it happening on multiple machines? These kinds of questions can help understand if the activity is related to legitimate behavior.\n- Consider the user and their role within the company: is this something related to their job or work function?\n\n### False Positive Analysis\n- For any matches found, it's important to consider the initial release date of that indicator. Threat intelligence can be a great tool for augmenting existing security processes, while at the same time it should be understood that threat intelligence can represent a specific set of activity observed at a point in time. For example, an IP address may have hosted malware observed in a Dridex campaign months ago, but it's possible that IP has been remediated and no longer represents any threat.\n- Adversaries often use legitimate tools as network administrators such as `PsExec` or `AdFind`; these tools often find their way into indicator lists creating the potential for false positives.\n- It's possible after large and publicly written campaigns, curious employees might end up going directly to attacker infrastructure and triggering these rules.\n\n### Response and Remediation\n- If suspicious or malicious behavior is observed, take immediate action to isolate activity to prevent further post-compromise behavior.\n- One example of a response if a machine matched a command and control IP address would be to add an entry to a network device such as a firewall or proxy appliance to prevent any outbound activity from leaving that machine.\n- Another example of a response with a malicious file hash match would involve validating if the file was properly quarantined, reviewing current running processes for any abnormal activity, and investigating for any other follow-up actions such as persistence or lateral movement.\n","license":"Elastic License v2","output_index":"","timeline_id":"495ad7a7-316e-4544-8a0f-9c098daee76e","timeline_title":"Generic Threat Match Timeline","author":["Elastic"],"false_positives":[],"from":"now-65m","rule_id":"f30bc390-d2cf-4bc6-81b4-b91bedcaa2a1","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":["https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-threatintel.html"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threat_match","language":"kuery","index":["auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","winlogbeat-*"],"query":"file.hash.*:* or file.pe.imphash:* or source.ip:* or destination.ip:* or url.full:* or registry.path:*\n","threat_filters":[{"$state":{"store":"appState"},"meta":{"negate":false,"disabled":false,"params":{"query":"ti_*"},"type":"phrase","key":"event.dataset"},"query":{"match_phrase":{"event.dataset":"ti_*"}}},{"$state":{"store":"appState"},"meta":{"negate":false,"disabled":false,"params":{"query":"threat"},"type":"phrase","key":"event.category"},"query":{"match_phrase":{"event.category":"threat"}}},{"$state":{"store":"appState"},"meta":{"negate":false,"disabled":false,"params":{"query":"enrichment"},"type":"phrase","key":"event.kind"},"query":{"match_phrase":{"event.kind":"enrichment"}}},{"$state":{"store":"appState"},"meta":{"negate":false,"disabled":false,"params":{"query":"indicator"},"type":"phrase","key":"event.type"},"query":{"match_phrase":{"event.type":"indicator"}}}],"threat_query":"@timestamp >= \"now-30d/d\" and event.dataset:ti_* and (threat.indicator.file.hash.*:* or threat.indicator.file.pe.imphash:* or threat.indicator.ip:* or threat.indicator.registry.path:* or threat.indicator.url.full:*)","threat_mapping":[{"entries":[{"field":"file.hash.md5","type":"mapping","value":"threat.indicator.file.hash.md5"}]},{"entries":[{"field":"file.hash.sha1","type":"mapping","value":"threat.indicator.file.hash.sha1"}]},{"entries":[{"field":"file.hash.sha256","type":"mapping","value":"threat.indicator.file.hash.sha256"}]},{"entries":[{"field":"file.pe.imphash","type":"mapping","value":"threat.indicator.file.pe.imphash"}]},{"entries":[{"field":"source.ip","type":"mapping","value":"threat.indicator.ip"}]},{"entries":[{"field":"destination.ip","type":"mapping","value":"threat.indicator.ip"}]},{"entries":[{"field":"url.full","type":"mapping","value":"threat.indicator.url.full"}]},{"entries":[{"field":"registry.path","type":"mapping","value":"threat.indicator.registry.path"}]}],"threat_language":"kuery","threat_index":["logs-ti_*"],"threat_indicator_path":"threat.indicator","throttle":"no_actions","actions":[]}
{"id":"24c68ca0-24b0-11ee-8f07-79710758f25a","updated_at":"2023-07-20T19:24:23.767Z","updated_by":"lozovoydmitr","created_at":"2023-07-17T14:42:24.495Z","created_by":"lozovoydmitr","name":"Suspicious number of web requests Apache","tags":["test"," Test"," Octava"," Apache"],"interval":"30m","enabled":true,"description":"This rule detects malicious activity associated with a suspiciously large number of requests to non-existent or erroneous web server directories from external IPs. These actions often indicate external intelligence or web vulnerability scanning.","risk_score":47,"severity":"medium","license":"","output_index":"","meta":{"from":"30m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-3600s","rule_id":"b714dcd0-1deb-4d1b-ba52-844462c83a5e","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":4,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"(event.module : \"apache\" or tags: apache-access) and http.request.method: \"GET\" and not source.ip:(10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16) and not url.path: \"/\" and http.response.status_code > 400","filters":[],"threshold":{"field":["source.ip"],"value":100,"cardinality":[{"field":"url.path","value":10}]},"throttle":"no_actions","actions":[]}
{"id":"96a3cf70-2732-11ee-8f07-79710758f25a","updated_at":"2023-07-20T19:26:03.221Z","updated_by":"lozovoydmitr","created_at":"2023-07-20T19:21:12.427Z","created_by":"lozovoydmitr","name":"Suspicious number of web requests Nginx","tags":["test"," Test","Octava"," Nginx"],"interval":"30m","enabled":true,"description":"This rule detects malicious activity associated with a suspiciously large number of requests to non-existent or erroneous web server directories from external IPs. These actions often indicate external intelligence or web vulnerability scanning. ","risk_score":47,"severity":"medium","license":"","output_index":"","meta":{"from":"30m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-3600s","rule_id":"0d77e0cd-2c84-43df-bbfa-45b8293c29c9","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"(event.module : \"nginx\" or tags: \"nginx-access\" ) and http.request.method: \"GET\" and not source.ip:(10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16) and not url.path: \"/\" and http.response.status_code > 400","filters":[],"threshold":{"field":["source.ip"],"value":100,"cardinality":[{"field":"url.path","value":10}]},"throttle":"no_actions","actions":[]}
{"id":"054cfe80-e226-11ed-b6f4-dfeac9073248","updated_at":"2023-06-08T21:29:33.490Z","updated_by":"burzhynskyyy","created_at":"2023-04-23T22:27:24.749Z","created_by":"burzhynskyyy","name":"Potential spam flood by one user 10 mails in 1 minute","tags":["Custom Rules"],"interval":"1m","enabled":true,"description":"Potential spam flood by one user 10 mails in 1 minute","risk_score":73,"severity":"high","license":"","output_index":"","meta":{"from":"1m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-120s","rule_id":"365f7349-5d27-479a-a79d-5dd0dac7fcab","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":2,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"threshold","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"event.module:\"o365\" and event.provider:\"Exchange\" and event.action:\"Send\"","filters":[],"threshold":{"field":["user.name"],"value":10,"cardinality":[{"field":"event.id","value":10}]},"throttle":"no_actions","actions":[]}
{"id":"50de9610-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.048Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:21.198Z","created_by":"chaykovskiyv","name":"Potential Cookies Theft via Browser Debugging [Duplicate]","tags":["Elastic","Host","Linux","Windows","macOS","Threat Detection","Credential Access"],"interval":"5m","enabled":true,"description":"Identifies the execution of a Chromium based browser with the debugging process argument, which may indicate an attempt to steal authentication cookies. An adversary may steal web application or service session cookies and use them to gain access web applications or Internet services as an authenticated user without needing credentials.","risk_score":47,"severity":"medium","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Developers performing browsers plugin or extension debugging."],"from":"now-9m","rule_id":"dcfbbb9f-7fed-4329-8629-ef77b24d8326","max_signals":33,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1539/","name":"Steal Web Session Cookie","id":"T1539"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://github.com/defaultnamehere/cookie_crimes","https://embracethered.com/blog/posts/2020/cookie-crimes-on-mirosoft-edge/","https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/post/multi/gather/chrome_cookies.md","https://posts.specterops.io/hands-in-the-cookie-jar-dumping-cookies-with-chromiums-remote-debugger-port-34c4f468844e"],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["auditbeat-*","winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type in (\"start\", \"process_started\", \"info\") and\n  process.name in (\n             \"Microsoft Edge\",\n             \"chrome.exe\",\n             \"Google Chrome\",\n             \"google-chrome-stable\",\n             \"google-chrome-beta\",\n             \"google-chrome\",\n             \"msedge.exe\") and\n   process.args : (\"--remote-debugging-port=*\",\n                   \"--remote-debugging-targets=*\",\n                   \"--remote-debugging-pipe=*\") and\n   process.args : \"--user-data-dir=*\" and not process.args:\"--remote-debugging-port=0\"\n","throttle":"no_actions","actions":[]}
{"id":"4d556f50-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.013Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:15.288Z","created_by":"chaykovskiyv","name":"Unusual Process Network Connection [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Defense Evasion","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies network activity from unexpected system applications. This may indicate adversarial activity as these applications are often leveraged by adversaries to execute code and evade detection.","risk_score":21,"severity":"low","note":"## Triage and analysis\n\n### Investigating Unusual Process Network Connection\n\nThis rule identifies network activity from unexpected system utilities and applications. These applications are commonly abused by attackers to execute code, evade detections, and bypass security protections.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the target host that the process is communicating with.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"6273c1e8-e045-46a1-9342-7e71d91c83e0","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1127/","name":"Trusted Developer Utilities Proxy Execution","id":"T1127"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0005/","name":"Defense Evasion","id":"TA0005"}}],"to":"now","references":[],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by process.entity_id\n  [process where (process.name : \"Microsoft.Workflow.Compiler.exe\" or\n                  process.name : \"bginfo.exe\" or\n                  process.name : \"cdb.exe\" or\n                  process.name : \"cmstp.exe\" or\n                  process.name : \"csi.exe\" or\n                  process.name : \"dnx.exe\" or\n                  process.name : \"fsi.exe\" or\n                  process.name : \"ieexec.exe\" or\n                  process.name : \"iexpress.exe\" or\n                  process.name : \"odbcconf.exe\" or\n                  process.name : \"rcsi.exe\" or\n                  process.name : \"xwizard.exe\") and\n     event.type == \"start\"]\n  [network where (process.name : \"Microsoft.Workflow.Compiler.exe\" or\n                  process.name : \"bginfo.exe\" or\n                  process.name : \"cdb.exe\" or\n                  process.name : \"cmstp.exe\" or\n                  process.name : \"csi.exe\" or\n                  process.name : \"dnx.exe\" or\n                  process.name : \"fsi.exe\" or\n                  process.name : \"ieexec.exe\" or\n                  process.name : \"iexpress.exe\" or\n                  process.name : \"odbcconf.exe\" or\n                  process.name : \"rcsi.exe\" or\n                  process.name : \"xwizard.exe\")]\n","throttle":"no_actions","actions":[]}
{"id":"52aec230-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.287Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.228Z","created_by":"chaykovskiyv","name":"System Time Discovery [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Detects the usage of commonly used system time discovery techniques, which attackers may use during the reconnaissance phase after compromising a system.","risk_score":21,"severity":"low","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"5381f2a9-b6ae-4cbf-82c2-fd4f113274e3","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1124/","name":"System Time Discovery","id":"T1124"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}}],"to":"now","references":[],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n(\n ((process.name: \"net.exe\" or (process.name : \"net1.exe\" and not process.parent.name : \"net.exe\")) and process.args : \"time\") or \n (process.name: \"w32tm.exe\" and process.args: \"/tz\") or \n (process.name: \"tzutil.exe\" and process.args: \"/g\")\n)\n","throttle":"no_actions","actions":[]}
{"id":"483b9670-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.208Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.703Z","created_by":"chaykovskiyv","name":"Scheduled Task Created by a Windows Script [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence"],"interval":"5m","enabled":true,"description":"A scheduled task was created by a Windows script via cscript.exe, wscript.exe or powershell.exe. This can be abused by an adversary to establish persistence.","risk_score":47,"severity":"medium","note":"## Triage and analysis\n\nDecode the base64 encoded Tasks Actions registry value to investigate the task's configured action.","license":"Elastic License v2","output_index":"","author":["Elastic"],"false_positives":["Legitimate scheduled tasks may be created during installation of new software."],"from":"now-9m","rule_id":"d55f96d6-5fc2-43d7-9901-0ea0d43c71eb","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1053/","name":"Scheduled Task/Job","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1053/005/","name":"Scheduled Task","id":"T1053.005"}],"id":"T1053"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":[],"version":101,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"sequence by host.id with maxspan = 30s\n  [any where (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n   (dll.name : \"taskschd.dll\" or file.name : \"taskschd.dll\") and\n   process.name : (\"cscript.exe\", \"wscript.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")]\n  [registry where registry.path : \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tasks\\\\*\\\\Actions\"]\n","throttle":"no_actions","actions":[]}
{"id":"973cfcf0-2a79-11ee-8f07-79710758f25a","updated_at":"2023-07-24T23:27:03.375Z","updated_by":"burzhynskyyy","created_at":"2023-07-24T23:27:01.952Z","created_by":"burzhynskyyy","name":"Nginx error event with critical severity detected","tags":["Custom Rules","Test"],"interval":"5m","enabled":true,"description":"Зафіксовано критичну подію в журналі nginx error.","risk_score":73,"severity":"high","license":"","output_index":"","meta":{"from":"6m","kibana_siem_app_url":"https://192.168.5.97:5601/app/security"},"author":[],"false_positives":[],"from":"now-660s","rule_id":"00cf678e-963a-4fc3-b3cb-5f366ef739f4","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[],"to":"now","references":[],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"query","language":"kuery","index":["apm-*-transaction*","auditbeat-*","endgame-*","filebeat-*","logs-*","packetbeat-*","traces-apm*","winlogbeat-*","-*elastic-cloud-logs-*"],"query":"tags:\"nginx-error\" and log.level:\"crit\"","filters":[],"throttle":"no_actions","actions":[]}
{"id":"52af1050-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:31.288Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:24.230Z","created_by":"chaykovskiyv","name":"Enumerating Domain Trusts via DSQUERY.EXE [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Discovery","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the use of dsquery.exe for domain trust discovery purposes. Adversaries may use this command-line utility to enumerate trust relationships that may be used for Lateral Movement opportunities in Windows multi-domain forest environments.","risk_score":21,"severity":"low","note":"","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":["Domain administrators may use this command-line utility for legitimate information gathering purposes."],"from":"now-9m","rule_id":"58aba800-1bfb-4660-991a-9bdfb2241182","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1482/","name":"Domain Trust Discovery","id":"T1482"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0007/","name":"Discovery","id":"TA0007"}}],"to":"now","references":["https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc732952(v=ws.11)","https://posts.specterops.io/a-guide-to-attacking-domain-trusts-971e52cb2944"],"version":1,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"process where event.type == \"start\" and\n    (process.name : \"dsquery.exe\" or process.pe.original_file_name: \"dsquery.exe\") and \n    process.args : \"*objectClass=trustedDomain*\"\n","throttle":"no_actions","actions":[]}
{"id":"4b6ba0b0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.558Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.067Z","created_by":"chaykovskiyv","name":"Mimikatz Memssp Log File Detected [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Credential Access","Investigation Guide","Elastic Endgame"],"interval":"5m","enabled":true,"description":"Identifies the password log file from the default Mimikatz memssp module.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Mimikatz Memssp Log File Detected\n\n[Mimikatz](https://github.com/gentilkiwi/mimikatz) is an open-source tool used to collect, decrypt, and/or use cached credentials. This tool is commonly abused by adversaries during the post-compromise stage where adversaries have gained an initial foothold on an endpoint and are looking to elevate privileges and seek out additional authentication objects such as tokens/hashes/credentials that can then be used to laterally move and pivot across a network.\n\nThis rule looks for the creation of a file named `mimilsa.log`, which is generated when using the Mimikatz misc::memssp module, which injects a malicious Windows SSP to collect locally authenticated credentials, which includes the computer account password, running service credentials, and any accounts that logon.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (e.g., 4624) to the target host.\n- Retrieve and inspect the log file contents.\n- Search for DLL files created in the same location as the log file, and retrieve unsigned DLLs.\n  - Use the PowerShell Get-FileHash cmdlet to get the SHA-256 hash value of these files.\n    - Search for the existence of these files in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n  - Identify the process that created the DLL using file creation events.\n\n### False positive analysis\n\n- This file name `mimilsa.log` should not legitimately be created.\n\n### Related rules\n\n- Mimikatz Powershell Module Activity - ac96ceb8-4399-4191-af1d-4feeac1f1f46\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the host is a Domain Controller (DC):\n  - Activate your incident response plan for total Active Directory compromise.\n  - Review the privileges assigned to users that can access the DCs to ensure that the least privilege principle is being followed and reduce the attack surface.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reboot the host to remove the injected SSP from memory.\n- Reimage the host operating system or restore compromised files to clean versions.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"dac83a84-e724-4d10-936a-14462ae5078a","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1003/","name":"OS Credential Dumping","id":"T1003"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0006/","name":"Credential Access","id":"TA0006"}}],"to":"now","references":["https://www.elastic.co/security-labs/detect-credential-access"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*","endgame-*"],"query":"file where file.name : \"mimilsa.log\" and process.name : \"lsass.exe\"\n","throttle":"no_actions","actions":[]}
{"id":"483ca7e0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:14.216Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:06.712Z","created_by":"chaykovskiyv","name":"SUNBURST Command and Control Activity [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Command and Control","Investigation Guide"],"interval":"5m","enabled":true,"description":"The malware known as SUNBURST targets the SolarWind's Orion business software for command and control. This rule detects post-exploitation command and control activity of the SUNBURST backdoor.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating SUNBURST Command and Control Activity\n\nSUNBURST is a trojanized version of a digitally signed SolarWinds Orion plugin called SolarWinds.Orion.Core.BusinessLayer.dll. The plugin contains a backdoor that communicates via HTTP to third-party servers. After an initial dormant period of up to two weeks, SUNBURST may retrieve and execute commands that instruct the backdoor to transfer files, execute files, profile the system, reboot the system, and disable system services. The malware's network traffic attempts to blend in with legitimate SolarWinds activity by imitating the Orion Improvement Program (OIP) protocol, and the malware stores persistent state data within legitimate plugin configuration files. The backdoor uses multiple obfuscated blocklists to identify processes, services, and drivers associated with forensic and anti-virus tools.\n\nMore details on SUNBURST can be found on the [Mandiant Report](https://www.mandiant.com/resources/sunburst-additional-technical-details).\n\nThis rule identifies suspicious network connections that attempt to blend in with legitimate SolarWinds activity by imitating the Orion Improvement Program (OIP) protocol behavior.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic stack version 8.5.0. Older Elastic stacks versions will see unrendered markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine the host for derived artifacts that indicates suspicious activities:\n  - Analyze the executable involved using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"query\":\"SELECT * FROM dns_cache\", \"label\":\"Osquery - Retrieve DNS Cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\",\"label\":\"Osquery - Retrieve All Services\"}}\n      - !{osquery{\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE NOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR user_account == null)\",\"label\":\"Osquery - Retrieve Services Running on User Accounts\"}}\n      - !{osquery{\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid, services.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path = authenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\",\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity should not happen legitimately. The security team should address any potential benign true positive (B-TP), as this configuration can put the environment at risk.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Reimage the host operating system and restore compromised files to clean versions.\n- Upgrade SolarWinds systems to the latest version to eradicate the chance of reinfection by abusing the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"b9cb40ef-e2e9-44dd-8bb7-79f1b66d844e","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1071/","name":"Application Layer Protocol","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1071/001/","name":"Web Protocols","id":"T1071.001"}],"id":"T1071"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0011/","name":"Command and Control","id":"TA0011"}},{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1195/","name":"Supply Chain Compromise","subtechnique":[{"reference":"https://attack.mitre.org/techniques/T1195/002/","name":"Compromise Software Supply Chain","id":"T1195.002"}],"id":"T1195"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":["https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["logs-endpoint.events.*"],"query":"network where event.type == \"protocol\" and network.protocol == \"http\" and\n  process.name : (\"ConfigurationWizard.exe\",\n                  \"NetFlowService.exe\",\n                  \"NetflowDatabaseMaintenance.exe\",\n                  \"SolarWinds.Administration.exe\",\n                  \"SolarWinds.BusinessLayerHost.exe\",\n                  \"SolarWinds.BusinessLayerHostx64.exe\",\n                  \"SolarWinds.Collector.Service.exe\",\n                  \"SolarwindsDiagnostics.exe\") and\n  (\n    (\n      (http.request.body.content : \"*/swip/Upload.ashx*\" and http.request.body.content : (\"POST*\", \"PUT*\")) or\n      (http.request.body.content : (\"*/swip/SystemDescription*\", \"*/swip/Events*\") and http.request.body.content : (\"GET*\", \"HEAD*\"))\n    ) and\n    not http.request.body.content : \"*solarwinds.com*\"\n  )\n","throttle":"no_actions","actions":[]}
{"id":"4b6fe670-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:17.630Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:12.119Z","created_by":"chaykovskiyv","name":"Unusual File Modification by dns.exe [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Initial Access"],"interval":"5m","enabled":true,"description":"Identifies an unexpected file being modified by dns.exe, the process responsible for Windows DNS Server services, which may indicate activity related to remote code execution or other forms of exploitation.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Unusual File Write\nDetection alerts from this rule indicate potential unusual/abnormal file writes from the DNS Server service process (`dns.exe`) after exploitation from CVE-2020-1350 (SigRed) has occurred. Here are some possible avenues of investigation:\n- Post-exploitation, adversaries may write additional files or payloads to the system as additional discovery/exploitation/persistence mechanisms.\n- Any suspicious or abnormal files written from `dns.exe` should be reviewed and investigated with care.","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"d14aac01-a42d-4f6f-bf98-6b1c5c58d206","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1133/","name":"External Remote Services","id":"T1133"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0001/","name":"Initial Access","id":"TA0001"}}],"to":"now","references":["https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/","https://msrc-blog.microsoft.com/2020/07/14/july-2020-security-update-cve-2020-1350-vulnerability-in-windows-domain-name-system-dns-server/","https://www.elastic.co/security-labs/detection-rules-for-sigred-vulnerability"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"file where process.name : \"dns.exe\" and event.type in (\"creation\", \"deletion\", \"change\") and\n  not file.name : \"dns.log\" and not\n  (file.extension : (\"old\", \"temp\", \"bak\", \"dns\", \"arpa\") and file.path : \"C:\\\\Windows\\\\System32\\\\dns\\\\*\")\n","throttle":"no_actions","actions":[]}
{"id":"4f2b67d0-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:30:28.043Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:29:18.377Z","created_by":"chaykovskiyv","name":"Volume Shadow Copy Deletion via PowerShell [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Impact","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies the use of the Win32_ShadowCopy class and related cmdlets to achieve shadow copy deletion. This commonly occurs in tandem with ransomware or other destructive attacks.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating Volume Shadow Copy Deletion via PowerShell\n\nThe Volume Shadow Copy Service (VSS) is a Windows feature that enables system administrators to take snapshots of volumes that can later be restored or mounted to recover specific files or folders.\n\nA typical step in the playbook of an attacker attempting to deploy ransomware is to delete Volume Shadow Copies to ensure that victims have no alternative to paying the ransom, making any action that deletes shadow copies worth monitoring.\n\nThis rule monitors the execution of PowerShell cmdlets to interact with the Win32_ShadowCopy WMI class, retrieve shadow copy objects, and delete them.\n\n#### Possible investigation steps\n\n- Investigate the program execution chain (parent process tree).\n- Check whether the account is authorized to perform this operation.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- If unsigned files are found on the process tree, retrieve them and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Use process name, command line, and file hash to search for occurrences in other hosts.\n- Check if any files on the host machine have been encrypted.\n\n\n### False positive analysis\n\n- This rule has chances of producing benign true positives (B-TPs). If this activity is expected and noisy in your environment, consider adding exceptions — preferably with a combination of user and command line conditions.\n\n### Related rules\n\n- Volume Shadow Copy Deleted or Resized via VssAdmin - b5ea4bfe-a1b2-421f-9d47-22a75a6f2921\n- Volume Shadow Copy Deletion via PowerShell - d99a037b-c8e2-47a5-97b9-170d076827c4\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- Priority should be given due to the advanced stage of this activity on the attack.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- If data was encrypted, deleted, or modified, activate your data recovery plan.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Perform data recovery locally or restore the backups from replicated copies (cloud, other servers, etc.).\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic","Austin Songer"],"false_positives":[],"from":"now-9m","rule_id":"d71612aa-9450-45ba-b68e-1e96026f3bb8","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[{"reference":"https://attack.mitre.org/techniques/T1490/","name":"Inhibit System Recovery","id":"T1490"}],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0040/","name":"Impact","id":"TA0040"}}],"to":"now","references":["https://docs.microsoft.com/en-us/previous-versions/windows/desktop/vsswmi/win32-shadowcopy","https://powershell.one/wmi/root/cimv2/win32_shadowcopy","https://www.fortinet.com/blog/threat-research/stomping-shadow-copies-a-second-look-into-deletion-methods"],"version":103,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-endpoint.events.*","logs-windows.*"],"query":"process where event.type == \"start\" and\n  process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n  process.args : (\"*Get-WmiObject*\", \"*gwmi*\", \"*Get-CimInstance*\", \"*gcim*\") and\n  process.args : (\"*Win32_ShadowCopy*\") and\n  process.args : (\"*.Delete()*\", \"*Remove-WmiObject*\", \"*rwmi*\", \"*Remove-CimInstance*\", \"*rcim*\")\n","throttle":"no_actions","actions":[]}
{"id":"94514780-eb27-11ed-b6f4-dfeac9073248","updated_at":"2023-05-05T09:31:52.772Z","updated_by":"chaykovskiyv","created_at":"2023-05-05T09:31:14.312Z","created_by":"chaykovskiyv","name":"AdminSDHolder SDProp Exclusion Added [Duplicate]","tags":["Elastic","Host","Windows","Threat Detection","Persistence","Active Directory","Investigation Guide"],"interval":"5m","enabled":true,"description":"Identifies a modification on the dsHeuristics attribute on the bit that holds the configuration of groups excluded from the SDProp process. The SDProp compares the permissions on protected objects with those defined on the AdminSDHolder object. If the permissions on any of the protected accounts and groups do not match, the permissions on the protected accounts and groups are reset to match those of the domain's AdminSDHolder object, meaning that groups excluded will remain unchanged. Attackers can abuse this misconfiguration to maintain long-term access to privileged accounts in these groups.","risk_score":73,"severity":"high","note":"## Triage and analysis\n\n### Investigating AdminSDHolder SDProp Exclusion Added\n\nThe SDProp process compares the permissions on protected objects with those defined on the AdminSDHolder object. If the permissions on any of the protected accounts and groups do not match, it resets the permissions on the protected accounts and groups to match those defined in the domain AdminSDHolder object.\n\nThe dSHeuristics is a Unicode string attribute, in which each character in the string represents a heuristic that is used to determine the behavior of Active Directory.\n\nAdministrators can use the dSHeuristics attribute to exclude privilege groups from the SDProp process by setting the 16th bit (dwAdminSDExMask) of the string to a certain value, which represents the group(s):\n\n- For example, to exclude the Account Operators group, an administrator would modify the string, so the 16th character is set to 1 (i.e., 0000000001000001).\n\nThe usage of this exclusion can leave the accounts unprotected and facilitate the misconfiguration of privileges for the excluded groups, enabling attackers to add accounts to these groups to maintain long-term persistence with high privileges.\n\nThis rule matches changes of the dsHeuristics object where the 16th bit is set to a value other than zero.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check the value assigned to the 16th bit of the string on the `winlog.event_data.AttributeValue` field:\n    - Account Operators eq 1\n    - Server Operators eq 2\n    - Print Operators eq 4\n    - Backup Operators eq 8\n    The field value can range from 0 to f (15). If more than one group is specified, the values will be summed together; for example, Backup Operators and Print Operators will set the `c` value on the bit.\n\n### False positive analysis\n\n- While this modification can be done legitimately, it is not a best practice. Any potential benign true positive (B-TP) should be mapped and reviewed by the security team for alternatives as this weakens the security of the privileged group.\n\n### Response and remediation\n\n- The change can be reverted by setting the dwAdminSDExMask (16th bit) to 0 in dSHeuristics.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).","license":"Elastic License v2","output_index":"","timestamp_override":"event.ingested","author":["Elastic"],"false_positives":[],"from":"now-9m","rule_id":"43b209ab-6f02-4f7d-8c4f-1cbbf1a9fb2d","max_signals":100,"risk_score_mapping":[],"severity_mapping":[],"threat":[{"framework":"MITRE ATT&CK","technique":[],"tactic":{"reference":"https://attack.mitre.org/tactics/TA0003/","name":"Persistence","id":"TA0003"}}],"to":"now","references":["https://www.cert.ssi.gouv.fr/uploads/guide-ad.html#dsheuristics_bad","https://petri.com/active-directory-security-understanding-adminsdholder-object"],"version":104,"exceptions_list":[],"immutable":false,"related_integrations":[],"required_fields":[],"setup":"","type":"eql","language":"eql","index":["winlogbeat-*","logs-system.*","logs-windows.*"],"query":"any where event.action == \"Directory Service Changes\" and\n  event.code == \"5136\" and\n  winlog.event_data.AttributeLDAPDisplayName : \"dSHeuristics\" and\n  length(winlog.event_data.AttributeValue) > 15 and\n  winlog.event_data.AttributeValue regex~ \"[0-9]{15}([1-9a-f]).*\"\n","throttle":"no_actions","actions":[]}
{"_version":"WzIzMzM2MTYsMV0=","created_at":"2023-05-05T10:06:54.218Z","created_by":"chaykovskiyv","description":"Exception list containing exceptions for rule with id: 4b6f9850-eb27-11ed-b6f4-dfeac9073248","id":"8fcf76a0-eb2c-11ed-b6f4-dfeac9073248","immutable":false,"list_id":"6d0ab147-e946-46ba-8e19-aa3574407a3d","name":"Exceptions for rule - External Alerts [Duplicate]","namespace_type":"single","os_types":[],"tags":["default_rule_exception_list"],"tie_breaker_id":"729f8443-5949-4244-9d1f-3a70cfc6a955","type":"rule_default","updated_at":"2023-05-05T10:06:54.220Z","updated_by":"chaykovskiyv","version":1}
{"_version":"WzIzMzkxNzgsMV0=","comments":[],"created_at":"2023-05-05T10:27:24.257Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"m365_defender.incidentName","operator":"included","type":"match","value":"Multi-stage incident on multiple endpoints"}],"id":"6cf88510-eb2f-11ed-b6f4-dfeac9073248","item_id":"f341848e-0d19-4248-9e5e-92260736e2ac","list_id":"6d0ab147-e946-46ba-8e19-aa3574407a3d","name":"Multi-stage incident on multiple endpoints","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"8856d44b-3801-4c51-a281-92fd5b52a302","type":"simple","updated_at":"2023-05-05T10:27:24.261Z","updated_by":"chaykovskiyv"}
{"_version":"WzIzMzUxMjksMV0=","comments":[],"created_at":"2023-05-05T10:11:59.229Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"rule.name","operator":"included","type":"match","value":"ИПН и Паспорта"}],"id":"459c72d0-eb2d-11ed-b6f4-dfeac9073248","item_id":"b3583b29-be5d-45ea-acb4-24beb8e49f6e","list_id":"6d0ab147-e946-46ba-8e19-aa3574407a3d","name":"ИПН и Паспорта exception","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"56cb86fb-00ef-4655-8df5-fa39bcc2ee2b","type":"simple","updated_at":"2023-05-05T10:11:59.232Z","updated_by":"chaykovskiyv"}
{"_version":"WzIzMzQzOTQsMV0=","comments":[],"created_at":"2023-05-05T10:10:40.234Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"rule.name","operator":"included","type":"match","value":"login and pass"}],"id":"1686c4a0-eb2d-11ed-b6f4-dfeac9073248","item_id":"e0c6d7b5-df38-4fc8-9ddc-e5bfcecf2114","list_id":"6d0ab147-e946-46ba-8e19-aa3574407a3d","name":"login and pass exception","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"b54d8881-156c-498c-bad6-93fc17b14885","type":"simple","updated_at":"2023-05-05T10:10:40.237Z","updated_by":"chaykovskiyv"}
{"_version":"WzIzMzM2NDYsMV0=","comments":[],"created_at":"2023-05-05T10:06:57.034Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"rule.category","operator":"included","type":"match","value":"DataLossPrevention"}],"id":"917d26a0-eb2c-11ed-b6f4-dfeac9073248","item_id":"b8b7ad35-6d6d-48c8-9d40-f60cd1509583","list_id":"6d0ab147-e946-46ba-8e19-aa3574407a3d","name":"DataLossPrevention","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"868632c7-43cc-48a2-9a25-5c0d2cdda6cb","type":"simple","updated_at":"2023-05-05T10:06:57.072Z","updated_by":"chaykovskiyv"}
{"_version":"Wzg5NjgwNCwxXQ==","created_at":"2023-03-27T11:02:30.086Z","created_by":"chaykovskiyv","description":"Exception list containing exceptions for rule with id: fb6dfb40-b619-11ed-b6f4-dfeac9073248","id":"de084660-cc8e-11ed-b6f4-dfeac9073248","immutable":false,"list_id":"283ec564-c59a-4387-9723-a01a43a9920a","name":"Exceptions for rule - Attempts to Brute Force a Microsoft 365 User Account [Duplicate]","namespace_type":"single","os_types":[],"tags":["default_rule_exception_list"],"tie_breaker_id":"0aaf4c22-e914-4c8b-8095-7fa95f5a7c01","type":"rule_default","updated_at":"2023-03-27T11:02:30.094Z","updated_by":"chaykovskiyv","version":1}
{"_version":"WzMzMDA2OTIyLDRd","comments":[],"created_at":"2023-08-03T14:52:18.260Z","created_by":"yuliia.kozachok","description":"Exception list item","entries":[{"field":"user.id","operator":"included","type":"match","value":"cis@vuso.ua"}],"id":"57b66940-320d-11ee-8f07-79710758f25a","item_id":"d3c6ec73-b032-4bff-9d28-d75cddd69819","list_id":"283ec564-c59a-4387-9723-a01a43a9920a","name":"CIS@VUSO.UA EXCEPTION","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"f9cb1d57-2e75-4366-bbb5-89633fff95a6","type":"simple","updated_at":"2023-08-03T14:52:18.264Z","updated_by":"yuliia.kozachok"}
{"_version":"WzI1NjE3ODQ0LDRd","comments":[],"created_at":"2023-07-13T12:01:35.767Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"user.id","operator":"included","type":"match","value":"portal@vuso.ua"}],"id":"04094270-2175-11ee-8f07-79710758f25a","item_id":"f3392a41-3895-4b0c-845b-8cc0306c0d91","list_id":"283ec564-c59a-4387-9723-a01a43a9920a","name":"portal@vuso.ua exception","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"bd33d26e-c4f6-4690-a7b2-2ed43d037852","type":"simple","updated_at":"2023-07-13T12:01:35.772Z","updated_by":"chaykovskiyv"}
{"_version":"WzE1ODAyOTE2LDRd","comments":[],"created_at":"2023-06-15T08:17:13.279Z","created_by":"tyshchenkoo","description":"Exception list item","entries":[{"field":"user.id","operator":"included","type":"match","value":"support@vuso.ua"}],"id":"08339cf0-0b55-11ee-8f07-79710758f25a","item_id":"8cbbe13a-efd7-43da-b202-c19edfcd0d77","list_id":"283ec564-c59a-4387-9723-a01a43a9920a","name":"support@vuso.ua","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"f51b86e0-f24d-4d1e-afff-c802739ac2f5","type":"simple","updated_at":"2023-06-15T08:17:13.282Z","updated_by":"tyshchenkoo"}
{"_version":"WzE1NzkzMjk5LDRd","comments":[],"created_at":"2023-06-15T07:37:25.752Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"user.id","operator":"included","type":"match","value":"cis2@vuso.ua"}],"id":"79200e90-0b4f-11ee-8f07-79710758f25a","item_id":"b2eab8f4-dc5a-4c3c-b516-60a02a825a7b","list_id":"283ec564-c59a-4387-9723-a01a43a9920a","name":"cis2@vuso.ua exception","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"2c135dd6-ea0c-4f70-9454-fb4728b899c3","type":"simple","updated_at":"2023-06-15T07:37:25.757Z","updated_by":"chaykovskiyv"}
{"_version":"WzExNjk2NTI3LDRd","comments":[],"created_at":"2023-06-01T15:03:39.090Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"user.id","operator":"included","type":"match","value":"Not Available"}],"id":"7d7e9320-008d-11ee-8f07-79710758f25a","item_id":"843784e9-c38b-427f-a5b7-3fd8497bc417","list_id":"283ec564-c59a-4387-9723-a01a43a9920a","name":"user.id: Not Available exception","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"02084a96-3246-4857-9aaf-eb5d614ce162","type":"simple","updated_at":"2023-06-01T15:03:39.136Z","updated_by":"chaykovskiyv"}
{"_version":"WzMzNDIzOTgsNF0=","comments":[],"created_at":"2023-05-08T11:09:06.058Z","created_by":"tyshchenkoo","description":"Exception list item","entries":[{"field":"source.as.organization.name","operator":"included","type":"match","value":"Online Technologies LTD"},{"field":"user.name","operator":"included","type":"match","value":"velychko.l"}],"id":"bf6675b0-ed90-11ed-8f07-79710758f25a","item_id":"dc5950ef-a87d-47f0-9287-489dfd607e7e","list_id":"283ec564-c59a-4387-9723-a01a43a9920a","name":"velychko.l","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"6b2f60bf-288a-436f-a047-1d7734f93780","type":"simple","updated_at":"2023-05-08T11:09:06.065Z","updated_by":"tyshchenkoo"}
{"_version":"WzExNDg0MTMsMV0=","comments":[],"created_at":"2023-04-04T08:55:38.572Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"source.ip","operator":"included","type":"match","value":"185.112.40.226"}],"id":"788568c0-d2c6-11ed-b6f4-dfeac9073248","item_id":"9cafd21c-f737-46b2-8ff3-a8cae430ec6e","list_id":"283ec564-c59a-4387-9723-a01a43a9920a","name":"185.112.40.226","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"38deb574-7ac2-4fdf-8120-9305c7b01005","type":"simple","updated_at":"2023-04-04T08:55:38.576Z","updated_by":"chaykovskiyv"}
{"_version":"Wzg5NjgwOCwxXQ==","comments":[],"created_at":"2023-03-27T11:02:32.478Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"source.ip","operator":"included","type":"match","value":"77.88.227.42"}],"id":"df7543e0-cc8e-11ed-b6f4-dfeac9073248","item_id":"7df6c76f-7f0b-481e-a7fe-d6ab5063f667","list_id":"283ec564-c59a-4387-9723-a01a43a9920a","name":"Firebrax exception","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"05a7a16d-9857-4ccc-91c2-4a283a0741a2","type":"simple","updated_at":"2023-03-27T11:02:32.483Z","updated_by":"chaykovskiyv"}
{"_version":"WzY0MjU4ODUsNF0=","created_at":"2023-05-17T09:44:25.564Z","created_by":"chaykovskiyv","description":"Exception list containing exceptions for rule with id: fb761190-b619-11ed-b6f4-dfeac9073248","id":"68e831c0-f497-11ed-8f07-79710758f25a","immutable":false,"list_id":"b58ea034-4fa3-44da-80cc-72465759c43c","name":"Exceptions for rule - O365 Exchange Suspicious Mailbox Right Delegation [Duplicate]","namespace_type":"single","os_types":[],"tags":["default_rule_exception_list"],"tie_breaker_id":"01eabce6-02da-458e-bee8-6cdbc199b276","type":"rule_default","updated_at":"2023-05-17T09:44:25.572Z","updated_by":"chaykovskiyv","version":1}
{"_version":"Wzg1MTExNDcsNF0=","comments":[],"created_at":"2023-05-23T10:11:57.463Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"source.as.organization.name","operator":"included","type":"match","value":"MICROSOFT-CORP-MSN-AS-BLOCK"}],"id":"3ffe7a70-f952-11ed-8f07-79710758f25a","item_id":"13b3839d-0ac3-46f0-b5e8-730b9eb0a9f7","list_id":"b58ea034-4fa3-44da-80cc-72465759c43c","name":"MICROSOFT-CORP-MSN-AS-BLOCK","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"df181515-10fe-4435-a881-b650348d0d90","type":"simple","updated_at":"2023-05-23T10:11:57.466Z","updated_by":"chaykovskiyv"}
{"_version":"WzY0MjU5MDEsNF0=","comments":[],"created_at":"2023-05-17T09:44:28.274Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"user.id","operator":"included","type":"match","value":"NT AUTHORITY\\SYSTEM (Microsoft.Exchange.ServiceHost)"}],"id":"6a85b520-f497-11ed-8f07-79710758f25a","item_id":"b6ff7dd9-e7ea-4abb-9f7a-5626a8c9d6ec","list_id":"b58ea034-4fa3-44da-80cc-72465759c43c","name":"NT AUTHORITY\\SYSTEM (Microsoft.Exchange.ServiceHost)","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"2eda93ec-8dc9-4e8b-ba1f-5844d5dfb5ae","type":"simple","updated_at":"2023-05-17T09:44:28.278Z","updated_by":"chaykovskiyv"}
{"_version":"WzEwNjA3NjU2LDRd","created_at":"2023-05-29T11:40:42.155Z","created_by":"chaykovskiyv","description":"Exception list containing exceptions for rule with id: 4f1ee4b0-eb27-11ed-b6f4-dfeac9073248","id":"a43ca6c0-fe15-11ed-8f07-79710758f25a","immutable":false,"list_id":"7d488d95-bda1-4476-9d5c-fc8bf1c3a001","name":"Exceptions for rule - Scheduled Task Execution at Scale via GPO [Duplicate]","namespace_type":"single","os_types":[],"tags":["default_rule_exception_list"],"tie_breaker_id":"810041c3-3066-4a3e-a52f-4c6be67c012a","type":"rule_default","updated_at":"2023-05-29T11:40:42.163Z","updated_by":"chaykovskiyv","version":1}
{"_version":"WzEwNjA3NjgzLDRd","comments":[],"created_at":"2023-05-29T11:40:46.049Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"winlog.event_data.SubjectUserName","operator":"included","type":"match","value":"pro100thar"}],"id":"a68ed420-fe15-11ed-8f07-79710758f25a","item_id":"7b1574f1-9978-4c92-88b5-83204024572a","list_id":"7d488d95-bda1-4476-9d5c-fc8bf1c3a001","name":"pro100thar exception","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"5ce3ab26-a83e-4856-bdb4-f4864afd3a36","type":"simple","updated_at":"2023-05-29T11:40:46.067Z","updated_by":"chaykovskiyv"}
{"_version":"WzIzNTQxNzMsMV0=","created_at":"2023-05-05T11:27:03.634Z","created_by":"chaykovskiyv","description":"Exception list containing exceptions for rule with id: 4f2d1580-eb27-11ed-b6f4-dfeac9073248","id":"c2721b20-eb37-11ed-b6f4-dfeac9073248","immutable":false,"list_id":"1cb3d640-74ab-498f-9dce-9d902260b0ea","name":"Exceptions for rule - PowerShell Suspicious Discovery Related Windows API Functions [Duplicate]","namespace_type":"single","os_types":[],"tags":["default_rule_exception_list"],"tie_breaker_id":"7f35b61e-6f90-4db4-9326-53dc9c9cc56c","type":"rule_default","updated_at":"2023-05-05T11:27:03.638Z","updated_by":"chaykovskiyv","version":1}
{"_version":"Wzg0NjAxMDEsNF0=","comments":[],"created_at":"2023-05-23T06:57:30.260Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"winlog.user.name","operator":"included","type":"match","value":"scomm"}],"id":"15cc9540-f937-11ed-8f07-79710758f25a","item_id":"630d9a4f-61e8-40fd-8eaa-56b139a755af","list_id":"1cb3d640-74ab-498f-9dce-9d902260b0ea","name":"scomm exception","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"6947f0f9-6c7b-4209-ae7a-48dfe75ae93a","type":"simple","updated_at":"2023-05-23T06:57:30.264Z","updated_by":"chaykovskiyv"}
{"_version":"WzIzNTQxOTIsMV0=","comments":[],"created_at":"2023-05-05T11:27:06.071Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"file.name","operator":"included","type":"match","value":"93514365-7ff3-4f5e-9dfd-7eb9f6b779a7.ps1"}],"id":"c3e5f670-eb37-11ed-b6f4-dfeac9073248","item_id":"4bad5bcb-9e06-492f-8da8-f11ec051ea34","list_id":"1cb3d640-74ab-498f-9dce-9d902260b0ea","name":"93514365-7ff3-4f5e-9dfd-7eb9f6b779a7.ps1","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"fc7f1876-2772-44da-9f9d-4e15cde1a249","type":"simple","updated_at":"2023-05-05T11:27:06.088Z","updated_by":"chaykovskiyv"}
{"_version":"WzEwNjM1NTE5LDRd","created_at":"2023-05-29T13:33:25.065Z","created_by":"chaykovskiyv","description":"Exception list containing exceptions for rule with id: 94512070-eb27-11ed-b6f4-dfeac9073248","id":"633eab90-fe25-11ed-8f07-79710758f25a","immutable":false,"list_id":"146b4114-e1e0-4af7-9bc6-3ff64b9286fb","name":"Exceptions for rule - Scheduled Task Execution at Scale via GPO [Duplicate]","namespace_type":"single","os_types":[],"tags":["default_rule_exception_list"],"tie_breaker_id":"4dbe93d5-0cfd-4422-88d0-4a8f9cd4d96d","type":"rule_default","updated_at":"2023-05-29T13:33:25.070Z","updated_by":"chaykovskiyv","version":1}
{"_version":"WzEwNjM1NTIzLDRd","comments":[],"created_at":"2023-05-29T13:33:28.932Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"winlog.event_data.SubjectUserName","operator":"included","type":"match","value":"pro100thar"}],"id":"658ce150-fe25-11ed-8f07-79710758f25a","item_id":"b2988118-f105-4620-afb2-80bafeb3912d","list_id":"146b4114-e1e0-4af7-9bc6-3ff64b9286fb","name":"pro100thar exception","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"c208a940-dc24-47e5-b332-2ad0c43a7ce8","type":"simple","updated_at":"2023-05-29T13:33:28.937Z","updated_by":"chaykovskiyv"}
{"_version":"WzIzMjgxMjIsMV0=","created_at":"2023-05-05T09:46:18.211Z","created_by":"chaykovskiyv","description":"Exception list containing exceptions for rule with id: 50e61020-eb27-11ed-b6f4-dfeac9073248","id":"af17c330-eb29-11ed-b6f4-dfeac9073248","immutable":false,"list_id":"551d0770-b7d8-4bec-aa5b-53dc5d6a89a0","name":"Exceptions for rule - Suspicious service was installed in the system [Duplicate]","namespace_type":"single","os_types":[],"tags":["default_rule_exception_list"],"tie_breaker_id":"b122cac7-38e7-43d0-89fa-17d71487620c","type":"rule_default","updated_at":"2023-05-05T09:46:18.213Z","updated_by":"chaykovskiyv","version":1}
{"_version":"WzIzNTc1ODMsMV0=","comments":[],"created_at":"2023-05-05T09:46:20.887Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"related.user","type":"match_any","value":["RDS11$","RDS13$","RDS12$","TERMINAL-08$","TERMINAL-05$","TERMINAL-07$"],"operator":"included"}],"id":"b0b01670-eb29-11ed-b6f4-dfeac9073248","item_id":"07b374f8-322c-4dd4-8e51-9b0b98d0251d","list_id":"551d0770-b7d8-4bec-aa5b-53dc5d6a89a0","name":"Terminal exception","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"97c564d5-e42d-4b2d-b8e2-374bd7d3e4df","type":"simple","updated_at":"2023-05-05T11:38:36.172Z","updated_by":"chaykovskiyv"}
{"_version":"WzQ2ODA4MzUsNF0=","created_at":"2023-05-12T08:17:08.548Z","created_by":"chaykovskiyv","description":"Exception list containing exceptions for rule with id: 8b766810-b9dc-11ed-b6f4-dfeac9073248","id":"63563840-f09d-11ed-8f07-79710758f25a","immutable":false,"list_id":"b13dae89-da27-49e8-9ae5-9d497d8a404b","name":"Exceptions for rule - SSL Remote VPN from two countries","namespace_type":"single","os_types":[],"tags":["default_rule_exception_list"],"tie_breaker_id":"05be8b30-9bac-4a73-b616-8f77b1be0be4","type":"rule_default","updated_at":"2023-05-12T08:17:08.551Z","updated_by":"chaykovskiyv","version":1}
{"_version":"Wzk0ODQ0MTQsNF0=","comments":[],"created_at":"2023-05-26T05:39:20.736Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"destination.geo.country_name","operator":"included","type":"match","value":"Ukraine"},{"field":"source.user.name","operator":"included","type":"match","value":"tokar.o"}],"id":"a9dd4200-fb87-11ed-8f07-79710758f25a","item_id":"b3f76691-322e-4099-bb09-8cc5d7df0c75","list_id":"b13dae89-da27-49e8-9ae5-9d497d8a404b","name":"tokar.o exception","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"21788c6d-a208-4949-9b86-d01c2ee05e2f","type":"simple","updated_at":"2023-05-26T05:39:20.741Z","updated_by":"chaykovskiyv"}
{"_version":"WzY0ODg4ODEsNF0=","comments":[],"created_at":"2023-05-17T14:04:14.148Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"destination.as.organization.name","operator":"included","type":"match","value":"Cloud DNS Ltd"}],"id":"b46d7f50-f4bb-11ed-8f07-79710758f25a","item_id":"151dec65-a7b1-4472-8178-4f4549c12b2c","list_id":"b13dae89-da27-49e8-9ae5-9d497d8a404b","name":"CLOUDFLARENET","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"c2b4fb83-ef6c-492f-a9ab-3fd53005f24f","type":"simple","updated_at":"2023-05-17T14:04:14.152Z","updated_by":"chaykovskiyv"}
{"_version":"WzQ2ODA4MzgsNF0=","comments":[],"created_at":"2023-05-12T08:17:10.782Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"source.user.name","operator":"included","type":"match","value":"velychko.l"},{"field":"destination.as.organization.name","operator":"included","type":"match","value":"Online Technologies LTD"}],"id":"64ab19e0-f09d-11ed-8f07-79710758f25a","item_id":"f5d320a6-d397-4103-b27b-b3dc6b5bca17","list_id":"b13dae89-da27-49e8-9ae5-9d497d8a404b","name":"velychko.l exception","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"b44385e2-2c1e-4940-8283-f423955aa535","type":"simple","updated_at":"2023-05-12T08:17:10.786Z","updated_by":"chaykovskiyv"}
{"_version":"WzM1MDQ2OTQ2LDRd","created_at":"2023-08-09T11:16:27.010Z","created_by":"tyshchenkoo","description":"Exception list containing exceptions for rule with id: 169033c0-bc78-11ed-b6f4-dfeac9073248","id":"2ea4fe20-36a6-11ee-8f07-79710758f25a","immutable":false,"list_id":"9a69ef66-d000-41ed-a74b-600a0326ee2c","name":"Exceptions for rule - One Port Scanning Detected","namespace_type":"single","os_types":[],"tags":["default_rule_exception_list"],"tie_breaker_id":"c6b5bf02-699a-46e2-aab0-dc8ecfcaf2d9","type":"rule_default","updated_at":"2023-08-09T11:16:27.014Z","updated_by":"tyshchenkoo","version":1}
{"_version":"WzIyNzcyMDYsMV0=","created_at":"2023-05-04T10:22:39.128Z","created_by":"chaykovskiyv","description":"Exception list containing exceptions for rule with id: f0c253e0-bc7b-11ed-b6f4-dfeac9073248","id":"989b8980-ea65-11ed-b6f4-dfeac9073248","immutable":false,"list_id":"b42117f4-4a87-4e70-bdca-e8c4ac7ac897","name":"Exceptions for rule - Suspicious Remote VPN connection","namespace_type":"single","os_types":[],"tags":["default_rule_exception_list"],"tie_breaker_id":"c27f2a02-c293-4fb5-9ba9-c93987b3128b","type":"rule_default","updated_at":"2023-05-04T10:22:39.133Z","updated_by":"chaykovskiyv","version":1}
{"_version":"WzE4MjEyODM4LDRd","comments":[],"created_at":"2023-06-22T06:28:41.596Z","created_by":"analyst","description":"Exception list item","entries":[{"field":"source.user.name","operator":"included","type":"match","value":"cherkashyna.n"},{"field":"destination.geo.country_name","operator":"included","type":"match","value":"Georgia"}],"id":"07d3e3c0-10c6-11ee-8f07-79710758f25a","item_id":"33d8d5c9-72c1-4bac-b763-e9aa59edbab3","list_id":"b42117f4-4a87-4e70-bdca-e8c4ac7ac897","name":"cherkashyna.n","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"53ec57f1-a2f8-4540-81e8-355be83e37fd","type":"simple","updated_at":"2023-06-22T06:28:41.601Z","updated_by":"analyst"}
{"_version":"WzQ0MDk1MDUsNF0=","comments":[],"created_at":"2023-05-04T10:22:41.323Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"related.user","type":"match_any","value":["yushinat","yushinat@vuso.ua"],"operator":"included"},{"field":"destination.as.organization.name","type":"match","value":"LLC Donetsk Fiber-optical Network","operator":"included"},{"field":"destination.ip","type":"match","value":"91.224.16.65","operator":"included"}],"id":"99ea77b0-ea65-11ed-b6f4-dfeac9073248","item_id":"84dcb5bf-a5a7-4cb8-ac22-a4cc8bfccf73","list_id":"b42117f4-4a87-4e70-bdca-e8c4ac7ac897","name":"yushinat exception","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"8501b428-55fb-46da-8eeb-b4c1fecb5a57","type":"simple","updated_at":"2023-05-11T13:20:27.464Z","updated_by":"analyst"}
{"_version":"WzIzNTI1ODksMV0=","created_at":"2023-05-05T11:21:06.945Z","created_by":"chaykovskiyv","description":"Exception list containing exceptions for rule with id: 4b6b79a0-eb27-11ed-b6f4-dfeac9073248","id":"edd7d620-eb36-11ed-b6f4-dfeac9073248","immutable":false,"list_id":"71d0fb45-25fa-4072-8d53-6cd0d89ac827","name":"Exceptions for rule - Multiple Logon Failure from the same Source Address [Duplicate]","namespace_type":"single","os_types":[],"tags":["default_rule_exception_list"],"tie_breaker_id":"287d142a-9111-47a3-b7c9-3b14b5c69858","type":"rule_default","updated_at":"2023-05-05T11:21:06.951Z","updated_by":"chaykovskiyv","version":1}
{"_version":"WzIzNTI1OTIsMV0=","comments":[],"created_at":"2023-05-05T11:21:09.445Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"user.name","operator":"included","type":"match_any","value":["RDB-2","RDB-4"]}],"id":"ef552750-eb36-11ed-b6f4-dfeac9073248","item_id":"b38dbab1-c53a-4990-bbe0-53ecda459fa6","list_id":"71d0fb45-25fa-4072-8d53-6cd0d89ac827","name":"RDB-2,RDB-4","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"fa28edb4-d27c-44c1-8cd1-7d6596204138","type":"simple","updated_at":"2023-05-05T11:21:09.450Z","updated_by":"chaykovskiyv"}
{"_version":"WzMzNTAxMzEsNF0=","created_at":"2023-05-08T11:39:10.113Z","created_by":"chaykovskiyv","description":"Exception list containing exceptions for rule with id: 49331720-b674-11ed-b6f4-dfeac9073248","id":"f2b36820-ed94-11ed-8f07-79710758f25a","immutable":false,"list_id":"0b056f53-34ff-4759-bea1-923dead178af","name":"Exceptions for rule - Microsoft Defender 365 Incident","namespace_type":"single","os_types":[],"tags":["default_rule_exception_list"],"tie_breaker_id":"3905ead1-c8ee-4179-bd1c-c4e29205ea8c","type":"rule_default","updated_at":"2023-05-08T11:39:10.117Z","updated_by":"chaykovskiyv","version":1}
{"_version":"WzE3NTg0OTI3LDRd","comments":[],"created_at":"2023-06-20T11:04:25.733Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"related.hosts","operator":"included","type":"match","value":"ssh-linux"}],"id":"38135b50-0f5a-11ee-8f07-79710758f25a","item_id":"65d67629-660d-4114-ba54-3759119741b9","list_id":"0b056f53-34ff-4759-bea1-923dead178af","name":"ssh-linux exception","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"a0faeef3-aa96-4afd-912b-807e75111a82","type":"simple","updated_at":"2023-06-20T11:04:25.737Z","updated_by":"chaykovskiyv"}
{"_version":"WzMzNTAxMzYsNF0=","comments":[],"created_at":"2023-05-08T11:39:13.043Z","created_by":"chaykovskiyv","description":"Exception list item","entries":[{"field":"m365_defender.incidentName","operator":"included","type":"match","value":"Email reported by user as junk involving one user"}],"id":"f4725630-ed94-11ed-8f07-79710758f25a","item_id":"10d78635-0cb6-4974-951f-060f0d190416","list_id":"0b056f53-34ff-4759-bea1-923dead178af","name":"m365_defender.incidentName: \"Email reported by user as junk involving one user\"","namespace_type":"single","os_types":[],"tags":[],"tie_breaker_id":"f1e4acbe-9b21-492a-95dc-e12c104e0e0c","type":"simple","updated_at":"2023-05-08T11:39:13.046Z","updated_by":"chaykovskiyv"}
{"exported_count":456,"exported_rules_count":417,"missing_rules":[],"missing_rules_count":0,"exported_exception_list_count":12,"exported_exception_list_item_count":27,"missing_exception_list_item_count":0,"missing_exception_list_items":[],"missing_exception_lists":[],"missing_exception_lists_count":0}
